$(document).ready(function(){telepath.main.init();$(document).click(function(e){$('.tele-popup').each(function(){if($(this).hasClass('hook')){if($(e.target).parents('.tele-popup').size()==0&&$(e.target).parents('body').size()>0){$('.tele-popup').remove();}}else{$(this).addClass('hook');}});});});telepath.loader='<img class="loader" src="img/loader.gif">';telepath.data={};telepath.appFilter=[{key:-1,label:'All Applications'}];telepath.main={loadResources:function(callback){yepnope({load:["css/widgets.css","js/widgets/teleAppSelect.js","js/widgets/teleInput.js","js/widgets/telePassword.js","js/widgets/teleCheckbox.js","js/widgets/teleList.js","js/widgets/teleForm.js","js/widgets/teleTree.js","js/widgets/teleRule.js","js/widgets/teleRadios.js","js/widgets/teleBrowse.js","js/widgets/teleBrowser.js","js/widgets/teleSelect.js","js/widgets/teleMulti.js","js/widgets/teleRange.js","js/widgets/teleFile.js","js/widgets/teleSearch.js","js/widgets/teleRequest.js","js/widgets/teleCountry.js","js/lib/jquery.dropdown.js","css/jquery.dropdown.css","js/lib/bootstrap.min.js","css/bootstrap.css","js/lib/jquery.pnotify.min.js","js/lib/jquery.mousewheel.js","js/lib/jquery.mCustomScrollbar.js","css/jquery.mCustomScrollbar.css","js/lib/jquery.vmap.min.js","js/lib/jquery.vmap.world.js","js/lib/jquery.vmap.sampledata.js","css/jqvmap.css","css/config.css","js/lib/jquery.weekcalendar.js","css/jquery.weekcalendar.css","js/lib/jstree.min.js","js/lib/jstreegrid.js","css/tree.css","js/telepath.sessionflow.js?1","js/telepath.handlers.js","js/telepath.rule.js","js/telepath.dialog.js","js/telepath.ipaddress.js","js/telepath.condition.js","js/telepath.condition.select.js","js/telepath.contextmenu.js","js/telepath.logmode.js","js/telepath.config.account.js","js/telepath.config.accounts.js","js/telepath.config.action.js","js/telepath.config.actions.js","js/telepath.config.application.js?","js/telepath.config.applications.js","js/telepath.config.notifications.js","js/telepath.config.rule.js","js/telepath.config.rules.js","js/telepath.config.user.js","js/telepath.config.users.js","js/telepath.config.groups.js","js/telepath.config.system.js"],complete:function(){callback();}});},init:function(){telepath.ds.get('/parameters/get_global_headers',{},function(data){telepath.global_headers=data.items;});telepath.ds.get('/rules/get_cmds',{},function(data){telepath.rule_cmds=data.items;});telepath.ds.get('/telepath/get_app_filter',{},function(data){telepath.app_filter=data.items;});telepath.ds.get('/telepath/get_time_range',{},function(data){telepath.range=data.items;telepath.main.loadResources(function(){$.getJSON(telepath.controllerPath+'/telepath/templates',function(data){telepath.templates=data;telepath.ui.init();telepath.header.init();telepath.dashboard.init();$('.tele-nav-dashboard a').addClass('active');if(location.hash){var params=location.hash.split("/");var alerts=[];alerts["key"]=decodeURIComponent(params[2]);telepath.sessionflow.init(params[0].substr(1),params[1],alerts,"alert","");}});});});telepath.ds.get('/telepath/get_first_data_time',{},function(data){telepath.fullRangeStart=data.items;});}};telepath.ui={init:function(){$(window).resize(function(){telepath.ui.resize();});$(window).click(function(e){if($('.popover').size()>0){if($(e.target).parents('.popover').size()>0||$(e.target).hasClass('popover')){}else{$('.popover').remove();}}});var that=this;this.mainEl=$('<div>').addClass('tele-body');this.headerEl=$('<div>').addClass('tele-header');this.contentEl=$('<div>').addClass('tele-content');this.mainEl.append(this.headerEl).append(this.contentEl);$('body').append(this.mainEl);this.panels=['dashboard','cases','alerts','suspects','reports','config','search'];$.each(this.panels,function(i,panel){var panelEl=$('<div>').addClass('tele-panel').addClass('tele-panel-'+panel);that.contentEl.append(panelEl);});$('.tele-panel-dashboard').addClass('active');$(window).resize(function(){telepath.ui.resize();});telepath.ui.resize();},resize:function(){var active=$('.tele-panel.active');$.each(this.panels,function(i,x){if($(active).hasClass('tele-panel-'+x)){active=x;return false;}});$('.tele-body').height($(window).height());if(active=='dashboard'){$('.tele-content').css({height:'890px'});$('body').css({overflow:'scroll-x'});}else{$('.tele-content').css({height:$(window).height()-$('.tele-header').height()-50});}}};telepath.header={getSearchOpts:function(){},init:function(){var that=this;this.logo='<div class="tele-logo"><img src="img/logo.png" alt="Hybrid Security Telepath" /></div>';this.nav=$('<ul>').addClass('tele-nav');this.navItems=[{id:'dashboard',label:'Dashboard'},{id:'cases',label:'Cases'},{id:'alerts',label:'Alerts'},{id:'suspects',label:'Suspects'}];$.each(this.navItems,function(i,item){if(telepath.access.admin||telepath.access.perm[item.label+'_get']){var itemEl=$('<li>').addClass('tele-nav-'+item.id).append($('<a>').attr('href','#').append('<span class="tele-nav-icon">').append(item.label));};$(that.nav).append(itemEl);});this.headerRight=$('<div>').addClass('tele-header-right');this.search=$('<div>').addClass('tele-search-top');this.searchInput=$('<input>').addClass('tele-search-input');this.searchIcon=$('<a href="#">').addClass('tele-search-icon').html('Search');this.searchDD=$('<a href="#">').addClass('tele-search-dropdown').html('');this.search.append(this.searchInput).append(this.searchIcon).append(this.searchDD);this.headerRight.append(this.search);$(this.searchIcon).click(function(e){if(telepath.search.loading){return;}
telepath.search.loading=true;telepath.search.init(telepath.header.searchInput.val());telepath.ui.resize();});$(this.searchInput).keydown(function(e){if(e.keyCode==13){telepath.search.init(telepath.header.searchInput.val());telepath.ui.resize();}});$(this.searchInput).autocomplete({source:function(request,response){telepath.ds.get('/search/getAutoComplete',{search:telepath.header.searchInput.val()},function(data){if(data.items){response(data.items);}});},select:function(event,ui){if(event.keyCode==13){return}
telepath.search.init(ui.item.value);telepath.ui.resize();},open:function(event,ui){$(this).autocomplete("widget").css({"width":$('.tele-search-top').width()});},}).focus(function(){$(this).autocomplete('search',telepath.header.searchInput.val());});$.ui.autocomplete.prototype._renderItem=function(ul,item){item.label=item.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+$.ui.autocomplete.escapeRegex(telepath.header.searchInput.val())
+")(?![^<>]*>)(?![^&;]+;)","gi"),"<span style='font-weight: normal'>$1</span>");return $("<li></li>").data("item.autocomplete",item).append("<a class='text-autocomplete' style='font-weight: bold;  font-family: "+"Roboto Condensed Regular;"+"'>"+item.label+"</a>").appendTo(ul);};this.searchDD.click(function(){if($('.tele-search-filters').size()>0){$('.tele-search-filters').remove();return;}
that.searchWrap=$('<div>').addClass('tele-search-filters').addClass('tele-popup');var title=$('<div>').addClass('tele-title-1').html('What to search');that.searchWrap.append(title);that.headerRight.append(that.searchWrap);telepath.search.printTypes(that.searchWrap);});$('.tele-header').append(this.logo).append(this.nav).append(this.headerRight);telepath.header.bindHooks();$(window).resize(function(){telepath.header.resize();});telepath.header.resize();this.configDiv=$('<div>').addClass('tele-config');this.configCmd=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-config');this.configDiv.append(this.configCmd);this.configCmd.click(function(){$('.tele-panel').empty().hide();$("#file-upload").hide();$('.tele-nav a.active').removeClass('active');var id='config';telepath[id].init();$('.tele-panel-'+id).show();$(this).addClass('active');telepath.config.actions.checkNotFinishedRecord();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});this.logoutCmd=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-logout').click(function(){telepath.ds.get('/auth/logout',{},function(data){location.reload(true);},'Error logging out.');}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$('.tele-header-right').append(this.configDiv).append(this.logoutCmd);},bindHooks:function(){$('.tele-nav a').click(function(){var id=$(this).parent().attr('class').split('-');if(id[0]=='tele'&&id[1]=='nav'&&id[2]!=''){id=id[2];}else{return false;}
if(id=='dashboard'&&telepath.dashboard.loading){return;}
if(telepath[id].loading){return;}
telepath[id].loading=true;$('.tele-panel').empty().hide().removeClass('active');$("#file-upload").hide();$('.tele-panel-'+id).show().addClass('active');telepath.ui.resize();telepath[id].init();telepath.header.configCmd.removeClass('active');$('.tele-nav a.active').removeClass('active');$(this).addClass('active');setTimeout(function(){$('.tele-popup, .popover').remove();},100);telepath.config.actions.checkNotFinishedRecord();});},resize:function(){var width=$(window).width();$('.tele-logo').css({width:200,overflow:'hidden'});if(width<1300){$(this.searchInput).css({width:100});if(width<1200){if(width<1000){$('.tele-logo').css({width:65,overflow:'hidden'});$('.tele-nav li').css({margin:'0px 0px'});}else{$('.tele-nav li').css({margin:'0px 10px'});}
$('.tele-logo').css({width:65});}else{$('.tele-nav li').css({margin:'0px 25px'});}}else{$(this.search).css({input:'{padding: 5px 75px 5px 20px}'});$(this.searchInput).css({width:140});$('.tele-nav li').css({margin:'0px 25px'});}
var navMargin=(width-$('.tele-header-right').width()-$('.tele-logo').width()-$('.tele-nav').width())/2;$('.tele-nav').css('marginLeft',navMargin);if(width<801){$('.tele-nav').css('marginLeft',20);$('.tele-panel-subtitle').css('height','100px !important');$('.tele-panel-title').css('position','absolute');}}};function RangeRemove(that){numRanges=$(that).parent().parent().children('.tele-ip-wrap').length;if(numRanges>1)
{$(that).parent().remove();}}
function old_getRangeUI(data){if(!data){data='';}else{data=data.trim()}
var is_range=data.split('-').length>1;var ipWrap=$('<div>').addClass('tele-ip-wrap');var ipStart=$('<div>').addClass('tele-ip').ip({data:data.split('-')[0]});var ipDash=$('<div>').addClass('tele-ip-dash').html('_');var ipEnd=$('<div>').addClass('tele-ip').ip({data:is_range?data.split('-')[1]:''});if(!is_range){ipDash.hide();ipEnd.hide();}
var ipRemove=$('<div>').addClass('tele-ip-remove').addClass('tele-icon').addClass('tele-icon-minus').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){$(this).parent().remove();});var ipToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){ipEnd.toggle();ipDash.toggle();},flipped:is_range,});ipWrap.append(ipRemove).append(ipToggle).append(ipStart).append(ipDash).append(ipEnd);return ipWrap;}
function getRangeUI(data){if(!data){data='';}
var ipWrap=$('<div>').addClass('tele-ip-wrap');if(data=='last'){var ipAdd=$('<div>').addClass('tele-ip-add').addClass('tele-icon').addClass('tele-icon-plus').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){$(event.target).parent().before(getRangeUI());});ipWrap.append(ipAdd);}
else{var is_range=data.from!=data.to;var ipStart=$('<div>').addClass('tele-ip').ip({data:data.from});var ipDash=$('<div>').addClass('tele-ip-dash').html('_');var ipEnd=$('<div>').addClass('tele-ip').ip({data:!is_range?'':data.to});if(!is_range){ipDash.hide();ipEnd.hide();}
var ipRemove=$('<div>').addClass('tele-ip-remove').addClass('tele-icon').addClass('tele-icon-minus').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){RangeRemove(this);});var ipToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){ipEnd.toggle();ipDash.toggle();},flipped:is_range});ipWrap.append(ipRemove).append(ipToggle).append(ipStart).append(ipDash).append(ipEnd);}
return ipWrap;}
function getStatusCodeRangeUI(data){if(!data){data='';}else{data=data.trim()}
var is_range=data.split('-').length>1;var scWrap=$('<div>').addClass('tele-sc-wrap');var scStart=$('<div>').teleInput({value:data.split('-')[0],type:'number',range:{min:100,max:600},step:100,margintop:1}).addClass('tele-sc');var scDash=$('<div>').addClass('tele-sc-dash').html('_');var scEnd=$('<div>').teleInput({value:!is_range?'':data.split('-')[1],type:'number',range:{min:100,max:600},step:100,margintop:1}).addClass('tele-sc');if(!is_range){scDash.hide();scEnd.hide();}
var scToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){scEnd.toggle();scDash.toggle();},flipped:is_range});scWrap.append(scToggle).append(scStart).append(scDash).append(scEnd);return scWrap;}
function findAndRemove(array,property,value){$.each(array,function(index,result){if(result&&result[property]&&result[property]==value){array.splice(index,1);}});}
function grabNames(arr){var result='';$.each(arr,function(i,x){result=result+x.key+', ';});if(result.length>0){result=result.substr(0,result.length-2);}
return result;}
function ip2long(IP){var i=0;IP=IP.match(/^([1-9]\d*|0[0-7]*|0x[\da-f]+)(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?$/i);if(!IP){return false;}
IP[0]=0;for(i=1;i<5;i+=1){IP[0]+=!!((IP[i]||'').length);IP[i]=parseInt(IP[i])||0;}
IP.push(256,256,256,256);IP[4+IP[0]]*=Math.pow(256,4-IP[0]);if(IP[1]>=IP[5]||IP[2]>=IP[6]||IP[3]>=IP[7]||IP[4]>=IP[8]){return false;}
return IP[1]*(IP[0]===1||16777216)+IP[2]*(IP[0]<=2||65536)+IP[3]*(IP[0]<=3||256)+IP[4]*1;}
function date_format(format,timestamp){var that=this;var jsdate,f;var txt_words=['Sun','Mon','Tues','Wednes','Thurs','Fri','Satur','January','February','March','April','May','June','July','August','September','October','November','December'];var formatChr=/\\?(.?)/gi;var formatChrCb=function(t,s){return f[t]?f[t]():s;};var _pad=function(n,c){n=String(n);while(n.length<c){n='0'+n;}
return n;};f={d:function(){return _pad(f.j(),2);},D:function(){return f.l().slice(0,3);},j:function(){return jsdate.getDate();},l:function(){return txt_words[f.w()]+'day';},N:function(){return f.w()||7;},S:function(){var j=f.j();var i=j%10;if(i<=3&&parseInt((j%100)/10,10)==1){i=0;}
return['st','nd','rd'][i-1]||'th';},w:function(){return jsdate.getDay();},z:function(){var a=new Date(f.Y(),f.n()-1,f.j());var b=new Date(f.Y(),0,1);return Math.round((a-b)/864e5);},W:function(){var a=new Date(f.Y(),f.n()-1,f.j()-f.N()+3);var b=new Date(a.getFullYear(),0,4);return _pad(1+Math.round((a-b)/864e5/7),2);},F:function(){return txt_words[6+f.n()];},m:function(){return _pad(f.n(),2);},M:function(){return f.F().slice(0,3);},n:function(){return jsdate.getMonth()+1;},t:function(){return(new Date(f.Y(),f.n(),0)).getDate();},L:function(){var j=f.Y();return j%4===0&j%100!==0|j%400===0;},o:function(){var n=f.n();var W=f.W();var Y=f.Y();return Y+(n===12&&W<9?1:n===1&&W>9?-1:0);},Y:function(){return jsdate.getFullYear();},y:function(){return f.Y().toString().slice(-2);},a:function(){return jsdate.getHours()>11?'pm':'am';},A:function(){return f.a().toUpperCase();},B:function(){var H=jsdate.getUTCHours()*36e2;var i=jsdate.getUTCMinutes()*60;var s=jsdate.getUTCSeconds();return _pad(Math.floor((H+i+s+36e2)/86.4)%1e3,3);},g:function(){return f.G()%12||12;},G:function(){return jsdate.getHours();},h:function(){return _pad(f.g(),2);},H:function(){return _pad(f.G(),2);},i:function(){return _pad(jsdate.getMinutes(),2);},s:function(){return _pad(jsdate.getSeconds(),2);},u:function(){return _pad(jsdate.getMilliseconds()*1000,6);},e:function(){throw'Not supported (see source code of date() for timezone on how to add support)';},I:function(){var a=new Date(f.Y(),0);var c=Date.UTC(f.Y(),0);var b=new Date(f.Y(),6);var d=Date.UTC(f.Y(),6);return((a-c)!==(b-d))?1:0;},O:function(){var tzo=jsdate.getTimezoneOffset();var a=Math.abs(tzo);return(tzo>0?'-':'+')+_pad(Math.floor(a/60)*100+a%60,4);},P:function(){var O=f.O();return(O.substr(0,3)+':'+O.substr(3,2));},T:function(){return'UTC';},Z:function(){return-jsdate.getTimezoneOffset()*60;},c:function(){return'Y-m-d\\TH:i:sP'.replace(formatChr,formatChrCb);},r:function(){return'D, d M Y H:i:s O'.replace(formatChr,formatChrCb);},U:function(){return jsdate/1000|0;}};this.date=function(format,timestamp){that=this;jsdate=(timestamp===undefined?new Date():(timestamp instanceof Date)?new Date(timestamp):new Date(timestamp*1000));return format.replace(formatChr,formatChrCb);};return this.date(format,timestamp);}
function escapeHtml(str){var div=document.createElement('div');div.appendChild(document.createTextNode(str));return div.innerHTML;}
function unescapeHtml(escapedStr){var div=document.createElement('div');div.innerHTML=escapedStr;var child=div.childNodes[0];return child?child.nodeValue:'';}
function eliminateDuplicates(arr){var i,len=arr.length,out=[],obj={};for(i=0;i<len;i++){obj[arr[i]]=0;}
for(i in obj){out.push(i);}
return out;};telepath.ds={get:function(resource,params,success,error,flag){var dataType='json';var method='POST';$.ajax({type:method,url:telepath.controllerPath+resource,data:params,flag:flag,success:function(data){if(data.logout){window.location.reload(true);return;}
if(data.debug||data.queries){}
if(data.eval){eval(data.eval);}
if(data.console){console.log(data.console);}
if(data.success){if(typeof success=='function'){success(data,this.flag);}}
else{if(typeof error=='function'){error(data);}
if(typeof error=='string'){console.log(error);}}},error:function(xhr,textStatus,e){if(typeof error=='function'){error(textStatus);}
if(typeof error=='string'){console.log(error);}},dataType:dataType});}}
telepath.dsync={get:function(resource,params,success,error){var dataType='json';var method='POST';$.ajax({type:method,url:telepath.controllerPath+resource,data:params,async:false,success:function(data){if(data.logout){window.location.reload(true);return;}
if(data.debug||data.queries){}
if(data.eval){eval(data.eval);}
if(data.console){console.log(data.console);}
if(data.success){if(typeof success=='function'){success(data);}}
else{if(typeof error=='function'){error(data);}
if(typeof error=='string'){console.log(error);}}},error:function(xhr,textStatus,e){if(typeof error=='function'){error(textStatus);}
if(typeof error=='string'){console.log(error);}},dataType:dataType});}};$.widget("tele.infoblock",{options:{'icon':'person','title':'Andy Keren','subtitle':'Developer @ HybridSec','avatar':'img/avatar.png','score':95,'social':{'facebook':'https://www.facebook.com/andy.keren','twitter':'https://twitter.com/NASA_Johnson/','linkedin':'www.linkedin.com/groups/Web-Fraud-Prevention-4066554'},'details':{'Last Seen':'Now and again','Phone':'555-555-555','Email':'ndkeren@gmail.com','Address':'Somewhere 555 st, Let-Viva, Israel'}},_create:function(){this.element.addClass("tele-infoblock");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();var smallTitle=$('<div>').addClass('tele-infoblock-smalltitle').html('Client Details');var imageWrap=$('<div>').addClass('tele-infoblock-imagewrap');var scoreEl=$('<div>').addClass('tele-infoblock-score');var imageEl=$('<img>').addClass('tele-infoblock-image').attr('src',this.options.avatar);var blockTitle=$('<div>').addClass('tele-infoblock-title').html(this.options.title);var subTitle=$('<div>').addClass('tele-infoblock-subtitle').html(this.options.subtitle);var socialList=$('<ul>').addClass('tele-infoblock-social');var detailsTable=$('<table>').addClass('tele-infoblock-details');imageWrap.append(scoreEl).append(imageEl);$.each(this.options.social,function(network,link){var socialLi=$('<li>');var socialLink=$('<a>').attr('href',link).addClass('tele-icon').addClass('tele-icon-'+network);socialLi.append(socialLink);socialList.append(socialLi);});$.each(this.options.details,function(key,value){var detailsTr=$('<tr>');var detailKey=$('<td>').html(key+':');var detailValue=$('<td>').html('<b>'+value+'</b>');detailsTr.append(detailKey).append(detailValue);detailsTable.append(detailsTr);});this.element.append(smallTitle).append(imageWrap).append(blockTitle).append(subTitle).append(socialList).append(detailsTable);}});;$.widget("tele.popup",{options:{bindTo:false},_create:function(){this.element.addClass("tele-popup");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(!this.options.bindTo){return;}
this.element.empty();var bind=this.options.bindTo;var top=bind.offset().top;var left=$(window).width()-this.element.width()-100;this.element.css({top:top,left:left});},});;telepath.countries={a2n:function(alias){return typeof this.map[alias]!=='undefined'?this.map[alias]:'Unknown';},n2a:function(name){for(x in this.map){if(this.map[x].toLowerCase()==name.toLowerCase()){return x;}}
return'00';},map:{"AP":"Asia/Pacific ","AF":"Afghanistan","AL":"Albania","DZ":"Algeria","AS":"American Samoa","AD":"Andorra","AO":"Angola","A1":"Anonymous Proxy","AR":"Argentina","AM":"Armenia","AW":"Aruba","AU":"Australia","AT":"Austria","AZ":"Azerbaijan","BS":"Bahamas","BH":"Bahrain","BD":"Bangladesh","BB":"Barbados","BY":"Belarus","BE":"Belgium","BJ":"Benin","BM":"Bermuda","BT":"Bhutan","BO":"Bolivia","BA":"Bosnia/Herzegovina","BW":"Botswana","BV":"Bouvet Island","BR":"Brazil","IO":"Indian Ocean","BN":"Brunei Darussalam","BG":"Bulgaria","BF":"Burkina Faso","BI":"Burundi","KH":"Cambodia","CM":"Cameroon","CA":"Canada","CV":"Cape Verde","KY":"Cayman Islands","CF":"Central African Rep.","TD":"Chad","CL":"Chile","CN":"China","CO":"Colombia","KM":"Comoros","CD":"Congo","CG":"Congo","CK":"Cook Islands","CR":"Costa Rica","CI":"Cote D'Ivoire","HR":"Croatia","CU":"Cuba","CW":"Curacao","CY":"Cyprus","CZ":"Czech Republic","DK":"Denmark","DJ":"Djibouti","DM":"Dominica","DO":"Dominican Republic","EC":"Ecuador","EG":"Egypt","SV":"El Salvador","GQ":"Equatorial Guinea","ER":"Eritrea","EE":"Estonia","ET":"Ethiopia","EU":"Europe","FK":"Falkland Islands","FO":"Faroe Islands","FJ":"Fiji","FI":"Finland","FR":"France","GF":"French Guiana","PF":"French Polynesia","GA":"Gabon","GM":"Gambia","GE":"Georgia","DE":"Germany","GH":"Ghana","GI":"Gibraltar","GR":"Greece","GL":"Greenland","GD":"Grenada","GP":"Guadeloupe","GU":"Guam","GT":"Guatemala","GG":"Guernsey","GW":"Guinea-Bissau","GN":"Guinea","GY":"Guyana","HT":"Haiti","VA":"Holy See","HN":"Honduras","HK":"Hong Kong","HU":"Hungary","IS":"Iceland","IN":"India","ID":"Indonesia","IR":"Iran","IQ":"Iraq","IE":"Ireland","IM":"Isle of Man","IL":"Israel","IT":"Italy","JM":"Jamaica","JP":"Japan","JO":"Jordan","KZ":"Kazakhstan","KE":"Kenya","KI":"Kiribati","KP":"Korea","KR":"Republic of Korea","KW":"Kuwait","KG":"Kyrgyzstan","LA":"Lao","LV":"Latvia","LB":"Lebanon","LS":"Lesotho","LR":"Liberia","LY":"Libya","LI":"Liechtenstein","LT":"Lithuania","LU":"Luxembourg","MO":"Macau","MK":"Macedonia","MG":"Madagascar","MW":"Malawi","MY":"Malaysia","MV":"Maldives","ML":"Mali","MT":"Malta","MH":"Marshall Islands","MQ":"Martinique","MR":"Mauritania","MU":"Mauritius","YT":"Mayotte","MX":"Mexico","FM":"Micronesia","MD":"Moldova, Republic of","MC":"Monaco","MN":"Mongolia","ME":"Montenegro","MA":"Morocco","MZ":"Mozambique","MM":"Myanmar","NA":"Namibia","NR":"Nauru","NP":"Nepal","NL":"Netherlands","NC":"New Caledonia","NZ":"New Zealand","NI":"Nicaragua","NE":"Niger","NG":"Nigeria","NU":"Niue","MP":"Mariana Islands","NO":"Norway","KP":"North Korea","OM":"Oman","O1":"Other","PK":"Pakistan","PW":"Palau","PS":"Palestine","PA":"Panama","PG":"Papua New Guinea","PY":"Paraguay","PE":"Peru","PH":"Philippines","PN":"Pitcairn Islands","PL":"Poland","PT":"Portugal","PR":"Puerto Rico","QA":"Qatar","RE":"Reunion","RO":"Romania","RU":"Russia","RW":"Rwanda","BL":"Saint Barthelemy","SH":"Saint Helena","KN":"Saint Kitts","LC":"Saint Lucia","MF":"Saint Martin","PM":"Saint Pierre","VC":"Saint Vincent","WS":"Samoa","SM":"San Marino","ST":"Sao Tome","A2":"Satellite Provider","SA":"Saudi Arabia","SN":"Senegal","RS":"Serbia","SC":"Seychelles","SL":"Sierra Leone","SG":"Singapore","SX":"Saint Maarten","SK":"Slovakia","SI":"Slovenia","SB":"Solomon Islands","SO":"Somalia","ZA":"South Africa","GS":"South Georgia","KR":"South Korea","ES":"Spain","LK":"Sri Lanka","SD":"Sudan","SR":"Suriname","SZ":"Swaziland","SE":"Sweden","CH":"Switzerland","SY":"Syria","TW":"Taiwan","TJ":"Tajikistan","TZ":"Tanzania","TH":"Thailand","TL":"Timor-Leste","TG":"Togo","TK":"Tokelau","TO":"Tonga","TT":"Trinidad and Tobago","TN":"Tunisia","TR":"Turkey","TM":"Turkmenistan","TC":"Caicos Islands","TV":"Tuvalu","UG":"Uganda","UA":"Ukraine","AE":"United Arab Emirates","GB":"United Kingdom","US":"United States","UY":"Uruguay","UZ":"Uzbekistan","VU":"Vanuatu","VE":"Venezuela","VN":"Vietnam","YE":"Yemen","ZM":"Zambia","ZW":"Zimbabwe","00":"Unknown"}};;$.widget("tele.teleDropdown",{options:{'title':'Select','options':[],'selected':0,'updatesTitle':false,'icon':false,'callback':function(){},'height':150,'width':100},_create:function(){this.element.addClass("tele-dropdown");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.icon){this.dropdownIcon=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-'+this.options.icon);this.dropdownIcon.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.element.append(this.dropdownIcon);}
this.dropdownValue=$('<a>').attr('href','#').addClass('tele-dropdown-value').html(this.options.value);this.dropdownArrow=$('<a>').attr('href','#').addClass('tele-dropdown-arrow').html('&nbsp;');this.element.append(this.dropdownValue).append(this.dropdownArrow);this.dropdownValue.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.dropdownArrow.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});},hoverIn:function(){if(this.dropdownIcon){this.dropdownIcon.addClass('hover');}
this.dropdownValue.addClass('hover');this.dropdownArrow.addClass('hover');},hoverOut:function(){if(this.dropdownIcon){this.dropdownIcon.removeClass('hover');}
this.dropdownValue.removeClass('hover');this.dropdownArrow.removeClass('hover');},click:function(){var that=this;if($(".tele-dd-popup").css('display')=='block'){$(".tele-dd-popup").fadeOut();$(".tele-dd-popup").remove();return;}
$(".tele-dd-popup").remove();this.popup=$('<div>').addClass('tele-popup').addClass('tele-dd-popup').hide();$(this.element).append(this.popup);var top=$(this.element).offset().top+$(this.element).height()+10;var left=($(this.element).offset().left+($(this.element).width()/2))-120;this.popup.css({height:this.options.height,width:this.options.width}).fadeIn();this.list=$('<div>').addClass('tele-dd-list').css({height:this.options.height-30,overflow:'auto'});for(x in this.options.options){var conf={key:this.options.options[x].key,label:this.options.options[x].label,inputFirst:true,checked:false};var element=$('<div>').addClass('tele-dd-item').html(conf.label);element.hover(function(){this.addClass('hover');},function(){this.removeClass('hover');}).click(function(){this.options.callback(conf);});this.list.append(element);}
this.popup.append(this.list);if(this.options.callback){this.options.callback();}}});;$.widget("tele.radios",{options:{'items':[],'selected':'time','title':'','tip':false,},_create:function(){this.element.addClass("tele-radios");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();var titleEl=$('<div>').addClass('tele-radios-title').html(this.options.title);this.element.append(titleEl);$.each(this.options.items,function(i,item){var itemWrap=$('<div>').addClass('tele-radio');if(item.tip){itemWrap.attr('alt',item.tip).attr('title',item.tip);}
var itemTitle=$('<div>').addClass('tele-radio-title').html(item.title);var itemIcon=$('<div>').addClass('tele-icon').addClass('tele-icon-'+item.icon);itemWrap.hover(function(){$('.tele-radio-title, .tele-icon',this).addClass('hover');},function(){$('.tele-radio-title, .tele-icon',this).removeClass('hover');});if(item.id==that.options.selected){itemTitle.addClass('selected');itemIcon.addClass('selected');}
itemWrap.append(itemIcon).append(itemTitle);that.element.append(itemWrap);itemWrap.click(function(){that._setOption('selected',item.id);if(that.options.callback){that.options.callback(that,item.id);}});});}});;$.widget("tele.btn",{options:{'icon':false,'text':false,},_create:function(){this.element.addClass("tele-button");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.icon!==false){this.iconEl=$('<span>').addClass('tele-icon tele-icon-'+this.options.icon);this.element.append(this.iconEl);this.iconEl.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});}
if(this.options.text!==false){this.textEl=$('<span>').addClass('tele-button-text').html(this.options.text);this.textEl.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.element.append(this.textEl);}},hoverIn:function(){if(this.textEl){this.textEl.addClass('hover');}
if(this.iconEl){this.iconEl.addClass('hover');}},hoverOut:function(){if(this.textEl){this.textEl.removeClass('hover');}
if(this.iconEl){this.iconEl.removeClass('hover');}},click:function(){if(this.options.callback){this.options.callback(this,this.element);}}});;$.widget("tele.cb",{options:{'icon':'checkbox','checked':false,},_create:function(){this.element.addClass("tele-checkbox");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.icon!='checkbox'){this.element.addClass('tele-checkbox-'+this.options.icon);}
if(this.options.checked){}
this.element.click(function(){if(that.options.checked){$(this).removeClass('checked');}else{$(this).addClass('checked');}
that.options.checked=!that.options.checked;if(that.options.callback){that.options.callback(that);}});}});;telepath.search={results:{},defaults:{'application':true,'pages':true,'attributes':true,'requests':true,'suspects':true,'alerts':true,'cases':true,'request_data':true,'users':false},sort:'date',dir:false,loading:false,options:false,searchTypes:[{id:'cases',label:'Request Data',desc:'Search Cases'},{id:'alerts',label:'Applications',desc:'Search Alerts'},{id:'suspects',label:'Request Data',desc:'Search suspects'},{id:'requests',label:'Requests',desc:'Search Requests'},{id:'request_data',label:'Request Data',desc:'Search request data'},{id:'application',label:'Applications',desc:'Search domain names'},{id:'pages',label:'Applications',desc:'Search application page names'},{id:'attributes',label:'Applications',desc:'Search attribute names'},{id:'users',label:'Request Data',desc:'Search web application users'},{id:'users',label:'Request Data',desc:'Search in countries and cities'}],printTypes:function(element){var that=this;if(this.options===false){this.options=this.defaults;}
$.each(that.searchTypes,function(i,data){var wrap=$('<div>').addClass('tele-search-filter').attr('id','tele-search-filter-'+data.id);var cb=$('<div>').addClass('tele-search-filter').teleCheckbox({label:data.desc,checked:that.options[data.id]?that.options[data.id]:false,callback:function(widget){that.options[data.id]=widget.options.checked;}});wrap.append(cb);element.append(wrap);});that.buttonsEl=$('<div>').addClass('tele-form-buttons');that.applyBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');that.cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');that.buttonsEl.append(that.applyBtn).append(that.cancelBtn);element.append(that.buttonsEl);that.applyBtn.click(function(){$('.tele-search-filters').remove();});that.cancelBtn.click(function(){that.options=that.defaults;$('.tele-search-filters').remove();});},searchStr:'',init:function(searchStr){this.searchStr=searchStr;telepath.header.configCmd.removeClass('active');$('.tele-nav a.active').removeClass('active');$('.tele-panel').empty().hide().removeClass('active');$("#file-upload").hide();$('.tele-panel-search').show().addClass('active');this.container=$('.tele-panel-search');this.container.empty();this.initPanel();telepath.config.actions.checkNotFinishedRecord();},initPanel:function(){var that=this;this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html('Search results');this.container.append(this.panelTopBar);this.panelSubBar=$('<div>').addClass('tele-panel-subtitle');this.panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');this.panelTopBar.append(this.panelTopBarRight);this.container.append(this.panelSubBar);var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'},],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;telepath.search.refresh(function(){});}});var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;$('.tele-search-tab span').html('0');telepath.search.refresh(function(){});}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.search.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});this.panelTopBarRight.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);this.tabsEl=$('<div>').addClass('tabs');this.tabsUl=$('<ul>');this.tabsEl.append(this.tabsUl);var tabs=[{id:'alerts',text:'Alerts'},{id:'cases',text:'Cases'},{id:'suspects',text:'Suspects'},{id:'requests',text:'Normal'},];for(x in tabs){var tab=tabs[x];var tabEl=$('<div>').attr('id','tele-search-'+tab.id);var tabLi=$('<li>');var tabCount=$('<span>').html('0');var tabA=$('<a>').attr('href','#tele-search-'+tab.id).append(tab.text+'&nbsp;(').append(tabCount).append(')').attr('rel',tab.id).addClass('tele-search-tab');tabLi.append(tabA);this.tabsUl.append(tabLi);this.tabsEl.append(tabEl);}
this.container.append(this.tabsEl);this.tabsEl.height($(window).height()-
$('.tele-header').height()-
$('.tele-panel-topbar').height()-
$('.tele-panel-subtitle').height()-60);this.tabsEl.tabs({heightStyle:'fill',autoHeight:false,animate:false,activate:function(event,ui){var id=ui.newPanel.selector.split('-')[2];that.container=$(ui.newPanel.selector);var teleBlock=$(ui.newPanel.selector+' .tele-block');teleBlock.remove();switch(id){case'cases':that.showCasesTab(ui.newPanel.selector);break;case'alerts':that.showAlertsTab(ui.newPanel.selector);break;case'suspects':that.showSuspectsTab(ui.newPanel.selector);break;case'requests':that.showRequestsTab(ui.newPanel.selector);break;}},create:function(event,ui){}});this.tabsEl.tabs({collapsible:true,active:false});this.panelSubBar.append(this.tabsUl);this.refresh();},refresh:function(){if(!this.searchStr){$.each(['alerts','cases','suspects','requests'],function(i,type){var container=$('#tele-search-'+type);container.empty();container.append($('<p>').text("No search string defined"));});this.tabsEl.tabs({collapsible:false});return false;}
$('.ui-tabs').append(telepath.loader);var that=this;this.results={};if(this.options===false){this.options=this.defaults;}
if(telepath.countries.n2a(this.searchStr)!='00'){this.searchStr=telepath.countries.n2a(this.searchStr);$('.tele-search-input').val(this.searchStr);this.countryFlag=true;}else{this.countryFlag=false;}
var searchSettingsObj={search:this.searchStr,options:this.options,is_country:this.countryFlag,sort:this.sort,dir:this.dir};that.count=0;$.each(['alerts','cases','suspects','requests'],function(i,type){if(that.options[type]){telepath.ds.get('/search/'+type,searchSettingsObj,function(data){that.count++;that.container=$('#tele-search-'+type);that.container.empty();if(!data.items||data.items.length==0){var p=$('<p>').text("No results");that.container.append(p);if(that.count==4)
that.selectTab();return;}
that.results[type]=data.items;$('.tele-search-tab[rel="'+type+'"] span').html(data.total);if(that.count==4)
that.selectTab();},function(data){that.count++;if(that.count==4)
that.selectTab();that.container=$('#tele-search-'+type);that.container.empty();var p=$('<p>').text(data['error']);that.container.append(p);});}
else{that.count++;if(that.count==4)
that.selectTab();that.container=$('#tele-search-'+type);that.container.empty();var p=$('<p>').text("No select option "+type);that.container.append(p);}});},selectTab:function(){var that=this;that.loading=false;that.tabsEl.children('.tele-loader').remove();var found=false;$.each(['alerts','cases','suspects','requests'],function(i,type){if(!found){if(that.results[type]&&that.results[type].length>0){var select;$('.tele-'+type+'-block').empty();switch(type){case'alerts':select=0;that.showAlertsTab();break;case'cases':select=1;that.showCasesTab();break;case'suspects':select=2;that.showSuspectsTab();break;case'requests':select=3;that.showRequestsTab();break;}
that.tabsEl.tabs({active:select});found=true;}}});that.tabsEl.tabs({collapsible:false});},showCasesTab:function(){this.list=$('<div>').addClass('tele-cases-block');$('#tele-search-cases').append(this.list);this.list.teleList({data:this.results.cases,searchkey:this.searchStr,formatter:function(item){if(item._source){item=item._source}
if(!item.checkable){item.checkable=false;}
if(!item.favorites){item.favorites=false;item.favorite=false;}
var case_names='';$.each(item.cases_names,function(i,x){case_names=case_names+x.key+' ,'});case_names=case_names.substr(0,case_names.length-2);var result={raw:item,checkable:false,favorites:false,favorite:false,itemID:item.sid,icon:'case',title:case_names,count:item.count,details:[{key:'IP',value:item.ip_orig},{key:'country',value:item.country},{key:'city',value:item.city},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'actions',value:item.actions_count},]};return result;}});},showAlertsTab:function(){if(!this.results.alerts)
return;this.list=$('<div>').addClass('tele-alerts-block');$('#tele-search-alerts').append(this.list);this.list.teleList({data:this.results.alerts,searchkey:this.searchStr,formatter:function(item){return telepath.alert.rowFormatter(item);}});},showSuspectsTab:function(){if(!this.results.suspects)
return;this.list=$('<div>').addClass('tele-suspects-block');$('#tele-search-suspects').append(this.list);this.list.teleList({data:this.results.suspects,searchkey:this.searchStr,formatter:function(item){return telepath.suspects.rowFormatter(item);}});},showRequestsTab:function(){if(!this.results.requests)
return;this.list=$('<div>').addClass('tele-requests-block');$('#tele-search-requests').append(this.list);this.list.teleList({data:this.results.requests,searchkey:this.searchStr,formatter:function(item){return telepath.suspects.rowFormatter(item);}});}};$.widget("tele.listitem",{options:{itemID:0,checkable:false,checked:false,favorites:false,favorite:false,favoriteCallBack:false,count:false,time:false,timeFormat:'d/m/y g:i A',timeLabel:'',progbar:false,progbarValue:0,progbarBig:false,popup:false,icon:'alert',title:'',description:'',details:[],offset:30,raw:[],},_resize:function(){var offset=this.options.offset;$('.tele-checkbox',this.element).each(function(){offset+=$(this).outerWidth(true);});if(offset<30){offset+=20;}
var innerWidth=$(this.element).width()-offset;if(this.element.parent().parent().parent().parent().attr('class')=='tele-similarities-list tele-block'&&window.innerWidth<1250){$('.tele-listitem-inner',this.element).width($('.tele-box-right').width()-80);}
else{$('.tele-listitem-inner',this.element).width(innerWidth-15);}
var offset=15;if(this.options.progbar){if(this.options.progbarBig){offset=offset+$('.tele-listitem-bigprogbar',this.element).outerWidth()+55;}else{offset=offset+$('.tele-listitem-progbar',this.element).outerWidth()+25;}}
if(this.options.icon){offset=offset+$('.tele-listitem-icon',this.element).outerWidth();}
var infoWidth=innerWidth-offset;$('.tele-listitem-info',this.element).css({width:infoWidth});var that=this;var total=30;if($('.tele-listitem-info').width()<800){$("ul li").filter('[class*=tele-listitem-]').css({'padding-right':'5%'});}
else{$("ul li").filter('[class*=tele-listitem-]').css({'padding-right':'10%'});}
$('.tele-listitem-info li',this.element).each(function(){$(this).show();$(this).prev().css({borderRightWidth:1});total=total+$(this).outerWidth();if(total>infoWidth){if($(this).hasClass('tele-list-hosts')){var x=$(this).width();var y=total-infoWidth;$(this).width(x-y).css({'white-space':'nowrap','overflow':'hidden','text-overflow':'ellipsis','height':'15px'});var hosts=$('b',this).text();var splited=hosts.split(',');if(splited.length>1){var view=$('<a>View all '+splited.length+' hosts</a>');$('b',this).html(view);$('.tele-list-hosts a').tipsy({fallback:hosts,gravity:'sw',trigger:'hover'});}
total=total+$(this).outerWidth();if(total>infoWidth){$(this).hide();$(this).prev().css({borderRightWidth:0});}}else{$(this).hide();$(this).prev().css({borderRightWidth:0});}}else{if($(this).hasClass('tele-list-hosts')){$(this).css({'width':'auto'});}}});},_create:function(){this.element.addClass("tele-listitem");this._update();},_setOption:function(key,value){this.options[key]=value;if(key=='checked'){if(value){this.checkEl.teleCheckbox({checked:true});}else{this.checkEl.teleCheckbox({checked:false});}
return;}
this._update();},_update:function(){var that=this;this.element.empty();if(this.options.checkable){this.checkEl=$('<a>').teleCheckbox({checked:this.options.checked,callback:function(widget){that.options.checked=widget.options.checked;}});this.element.append(this.checkEl);}
if(this.options.favorites){this.favEl=$('<a>').teleCheckbox({icon:'favorites',checked:this.options.favorite,callback:function(widget){that.options.favorite=widget.options.checked;if(typeof(that.options.favoriteCallBack)=='function'){that.options.favoriteCallBack(that);}}});this.element.append(this.favEl);}
var el=$('<div>').addClass('tele-listitem-inner');this.element.append(el);if(this.options.icon){var iconEl=$('<div>').addClass('tele-listitem-icon').addClass('tele-icon-'+this.options.icon);el.append(iconEl);}
if(this.options.count){var countEl=$('<div>').addClass('tele-listitem-count').html(this.options.count);el.append(countEl);if(parseInt(this.options.count)>999){countEl.css({"fontSize":'12px',"left":'30px'});}}
if(this.options.progbar){var progbar=$('<div>')
if(this.options.progbarBig){progbar.addClass('tele-listitem-bigprogbar');}else{progbar.addClass('tele-listitem-progbar');}
this.options.progbarValue=parseFloat(this.options.progbarValue);if(this.options.progbarValue>0){if(this.options.progbarValue<=1){this.options.progbarValue=this.options.progbarValue*100;}
else{this.options.progbarValue=parseInt(this.options.progbarValue);}}
var progbarInner=$('<div>').addClass('tele-listitem-progbar-inner').css({width:this.options.progbarValue+'%'});progbar.append(progbarInner);el.append(progbar);}
if(this.options.title){var titleEl=$('<div>').addClass('tele-listitem-title').html(this.options.title).attr('title',this.options.title);el.append(titleEl);}
if(this.options.updating){var updatingEl=$('<div>').addClass('tele-listitem-updating tele-icon-ring').html('Update in progress').attr('title','Update in progress');el.append(updatingEl);}
if(this.options.description){var descEl=$('<div>').addClass('tele-title-2').html(this.options.description);el.append(descEl);}
if(this.options.details){if(this.options.details.length>0){var list=$('<ul>').addClass('tele-listitem-info');if(!this.options.title){list.addClass('no-title');}
$.each(this.options.details,function(i,detail){if(detail.key||detail.value){var li=$('<li>');switch(detail.key){case'Active':var ActIcon=$('<span>');var ActText=$('<span>');if(detail.value){ActIcon.addClass('tele-icon-active');ActText.text('Active');}else{ActIcon.addClass('tele-icon-inactive');ActText.text('Inactive');}
li.append(ActIcon).append(ActText);break;case'city':if(detail.key&&detail.key=='city'&&detail.value&&detail.value!='Unknown'){li.append(detail.key).append(':&nbsp;').append('<b>'+escapeHtml(detail.value)+'</b>');}else{li=false;}
break;case'user':if(detail.key&&detail.key=='user'&&detail.value&&detail.value!=''){var iconEl=$('<div>').addClass('tele-listitem-user-name');li.append(iconEl).append('&nbsp&nbsp;').append('<span class="tele-user">'+escapeHtml(detail.value)+'</span>');}else{li=false;}
break;case'Email':var mailTo=$('<a>').attr('href','mailto:'+escapeHtml(detail.value)).text(escapeHtml(detail.value));li.append(mailTo);break;case'country':if(detail.value=='00'){li=false;}
else if(detail.value.length==2){li.append('<span class="flag flag-'+escapeHtml(detail.value)+'"></span>');li.append('<span class="tele-country">'+telepath.countries.a2n(detail.value)+'</span>');}else{li.append(detail.key);if(detail.value){li.append(':&nbsp;');}
li.append('<b>'+escapeHtml(detail.value)+'</b>');}
break;case'alerts':if(parseInt(detail.value)>0){var iconEl=$('<div>').addClass('tele-listitem-icon').addClass('tele-icon-alert');var countEl=$('<div>').addClass('tele-listitem-count').html(detail.value);li.addClass('tele-listitem-alerts-count');li.append(iconEl).append(countEl);}else{li=false;}
break;case'actions':if(parseInt(detail.value)>0){var iconEl=$('<div>').addClass('tele-listitem-icon').addClass('tele-icon-actions');var countEl=$('<div>').addClass('tele-listitem-count').html(detail.value);li.addClass('tele-listitem-actions-count');li.append(iconEl).append(countEl);}else{li=false;}
break;case'cases':if(parseInt(detail.value)>0){var iconEl=$('<div>').addClass('tele-listitem-icon tele-icon-case');var countEl=$('<div>').addClass('tele-listitem-count').html(detail.value);li.addClass('tele-listitem-cases-count');li.append(iconEl).append(countEl);}else{li=false;}
break;default:if(detail.key){li.append(detail.key);if(detail.value){li.append(':&nbsp;');}}
if(detail.value){li.append('<b>'+escapeHtml(detail.value)+'</b>');}
break;}
if(li!==false){list.append(li);}}});el.append(list);}}
if(this.options.time!==false){var time=$('<div>').addClass('tele-listitem-time').html(date_format(this.options.timeFormat,this.options.time));if(this.options.timeLabel){time.prepend('<label>'+this.options.timeLabel+'</label>');}
el.append(time);}
this._resize();$(window).resize(function(){if(that.timer){clearTimeout(that.timer);}
that.timer=setTimeout(function(){that._resize();},50);});el.hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){if(that.options.callback){that.options.callback(that);}});},bindPopup:function(){var that=this;this.element.hover(function(){},function(){});}});;if(!telepath.listitem){telepath.listitem={};}
telepath.listitem.generic={formatter_dashboard:function(item){return telepath.listitem.generic.formatter(item,'dashboard');},formatter:function(item,mode){if(mode=='dashboard'){result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'host',value:grabNames(item.host)},]}}
else{result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'city',value:item.city},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'actions',value:item.actions_count},{key:'cases',value:row.cases_count},{key:'user',value:item.user}]}}
return result;},callbacks:{click:function(widget){$('.popover').remove();setTimeout(function(){$('.popover').remove();},1000);var parent_parent=widget.element.parent().parent(),names=(widget.options.raw.alerts_names)?widget.options.raw.alerts_names:[];telepath.sessionflow.init(widget.options.itemID,widget.options.raw.ip_orig,names,widget.options.icon,widget.options.raw.searchkey,parent_parent);},hover_in:function(el,item){if(!item){return;}
if(telepath.generic_popover_timer){clearTimeout(telepath.generic_popover_timer);}
$('.popover').remove();if(telepath.generic_popover){telepath.generic_popover.remove();}
telepath.generic_popover=$('<div>');$('body').append(telepath.generic_popover);if($(el).hasClass('tele-icon-alert')&&item.raw.alerts_count&&item.raw.alerts_count>0&&item.raw.alerts_names&&item.raw.alerts_names.length>0){var alerts_content=$('<div>').addClass('popover-content');$.each(item.raw.alerts_names,function(i,x){var row=$('<div>').addClass('tele-popover-row').append($('<div>').addClass('tele-icon').addClass('tele-icon-alert')).append($('<div>').addClass('tele-count').text(x.doc_count)).append($('<div>').addClass('tele-popover-subtitle').html(x.key));alerts_content.append(row);});$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-45,left:$(el).offset().left+40}).fadeIn().popover({title:'Alerts',html:true,}).popover('show');$('.popover').append(alerts_content);var top=($('.popover').height()/2);if(top){$('.popover').css({position:'absolute',top:$(el).offset().top-top,left:$(el).offset().left+40})}}
if($(el).hasClass('tele-icon-actions')&&item.raw.actions_count&&item.raw.actions_count>0&&item.raw.actions_names&&item.raw.actions_names.length>0){var actions_content=$('<div>').addClass('popover-content');$.each(item.raw.actions_names,function(i,x){var row=$('<div>').addClass('tele-popover-row').append($('<div>').addClass('tele-icon').addClass('tele-icon-actions')).append($('<div>').addClass('tele-count').text(x.doc_count)).append($('<div>').addClass('tele-popover-subtitle').html(x.key));actions_content.append(row);});$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-45,left:$(el).offset().left+40}).fadeIn().popover({title:'Actions',html:true,}).popover('show');$('.popover').append(actions_content);var top=($('.popover').height()/2);if(top){$('.popover').css({position:'absolute',top:$(el).offset().top-top,left:$(el).offset().left+40})}}
if($(el).hasClass('tele-icon-case')&&item.raw.cases_count&&item.raw.cases_count>0&&item.raw.cases_names&&item.raw.cases_names.length>0){var cases_content=$('<div>').addClass('popover-content');$.each(item.raw.cases_names,function(i,x){var row=$('<div>').addClass('tele-popover-row').append($('<div>').addClass('tele-icon').addClass('tele-icon-case')).append($('<div>').addClass('tele-count').text(x.doc_count)).append($('<div>').addClass('tele-popover-subtitle').html(x.key));cases_content.append(row);});$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-45,left:$(el).offset().left+40}).fadeIn().popover({title:'Cases',html:true,}).popover('show');$('.popover').append(cases_content);var top=($('.popover').height()/2);if(top){$('.popover').css({position:'absolute',top:$(el).offset().top-top,left:$(el).offset().left+40})}}
if($(el).hasClass('tele-listitem-progbar')){var left=$(el).offset().left;var placement;if(left+422>$(window).width()){left-=10;placement='left';}
else{left+=100;placement='right';}
$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-2,left:left}).fadeIn().popover({title:'Loading anomaly scores..',html:true,placement:placement,content:telepath.loader}).popover('show');telepath.ds.get('/sessionflow/get_session_stats',{sid:item.itemID},function(data){$('.popover-title:first').html('Anomaly Scores');$('.popover-content .tele-loader').after($('<div>').anomalyScore({request:data.items})).remove();});}},hover_out:function(el,item){telepath.generic_popover_timer=setTimeout(function(){$('.popover').fadeOut(function(){$('.popover').remove();});},500);},favorite:function(widget){telepath.ds.get('/cases/set_case_fav',{cid:widget.options.dataID,favorite:widget.options.favorite},function(data){});}},callbacks_case:{click:function(widget){if(telepath.access.admin||telepath.access.perm.Cases_get){$(".tele-nav-cases a").click();$('.popover').remove();telepath.casePanel.init(widget.options.dataID);}else{telepath.dialog({msg:'Access denied. No permissions to view Cases details.'});};},hover_in:function(el,opt){var cid=opt.dataID;$('.popover').remove();var that=this;if(telepath.cases.pop){telepath.cases.pop.remove();}
telepath.cases.pop=$('<div>').css({position:'absolute',top:$(el).offset().top,left:$(el).offset().left+70});$('body').append(telepath.cases.pop);$(telepath.cases.pop).popover({title:'Loading Data',html:true,content:telepath.loader}).popover('show');telepath.ds.get('/cases/get_case_stat',{cid:cid},function(data){var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'}},yaxis:{alignTicksWithAxis:true,labelWidth:30,ticks:5,color:'#446077',font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"}},selection:{mode:"x"},xaxis:{alignTicksWithAxis:true,tickColor:'#cccccc',tickLength:7,font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"},mode:"time",timezone:"browser",timeformat:"%d/%m"},grid:{borderColor:'#446077',borderWidth:1}};data=[{label:"Sessions",data:data.items,color:'#FC3D3D'}];var graphContainer=$('<div>').addClass('case-popover-graph');$('.popover-title').html('Case Activity');$('.popover-content').empty().append(graphContainer);graphContainer.flotGraph({data:data,options:options});});},hover_out:function(el,id){if(telepath.cases.timeout){clearTimeout(telepath.cases.timeout);}
if(telepath.cases.pop){telepath.cases.pop.remove();}},favorite:function(widget){telepath.ds.get('/cases/set_case_fav',{cid:widget.options.title,favorite:widget.options.favorite},function(data){});}}};$.widget("tele.toggleFlip",{options:{'left_value':'On','right_value':'Off','flipped':false,'flip':false,'disabled':false},_create:function(){this.element.addClass("tele-mini-toggle");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var toggle_left=$('<div>').addClass('tele-mini-toggle-left').html(this.options.left_value);var toggle_right=$('<div>').addClass('tele-mini-toggle-right').html(this.options.right_value);var toggle_middle=$('<div>').addClass('tele-mini-toggle-middle');var toggle_knob=$('<a>').attr('href','#').addClass('tele-mini-toggle-knob').html('&nbsp;');toggle_middle.append(toggle_knob);this.element.empty().append(toggle_left).append(toggle_middle).append(toggle_right);if(this.options.flipped){toggle_knob.addClass('active');toggle_knob.css({marginLeft:20});}
if(this.options.disabled){this.element.css({opacity:0.3});}else{toggle_knob.click(function(e){e.preventDefault();if(that.options.flipped){$(this).removeClass('active');$(this).animate({marginLeft:0},300);}else{$(this).addClass('active');$(this).animate({marginLeft:20},300);}
that.options.flipped=!that.options.flipped;if(typeof(that.options.flip)=='function'){that.options.flip(that.options.flipped);}});}}});;$.widget("tele.daterange",{options:{start:new Date().getTime(),end:new Date().getTime(),change:false,state:''},_create:function(){this.element.addClass("tele-daterange");this.createButton();},_setOption:function(key,value){this.options[key]=value;this.createButton();},_displayPopup:function(){var that=this;var el='.tele-daterange:last';if($(".tele-daterange-popup").css('display')=='block'){$(".tele-daterange-popup").fadeOut();return;}
else{$(".tele-daterange-popup").remove();$('body').append(telepath.templates['popup-daterange']);}
var top=$(el).offset().top+$(el).height()+20;var left=($(el).offset().left+($(el).width()/2))-($(".tele-daterange-popup").width()/2);$(".tele-daterange-popup").css({top:top,left:left});$(".tele-daterange-popup").fadeIn();$.datepicker._defaults.dateFormat="dd/mm/yy";$(".tele-daterange-calendar").datepicker({numberOfMonths:[1,2],beforeShowDay:function(date){if($(".tele-daterange-from").val()){var date1=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-from").val());var date2=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-to").val());}
else{var date1=new Date(telepath.range.start*1000);var date2=new Date(telepath.range.end*1000);}
return[true,date1&&((date.getTime()==date1.getTime())||(date2&&date>=date1&&date<=date2))?"dp-highlight":""];},onSelect:function(dateText,inst){var date1=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-from").val());var date2=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-to").val());var selectedDate=$.datepicker.parseDate($.datepicker._defaults.dateFormat,dateText);if(!date1||date2){$(".tele-daterange-from").val(dateText);$(".tele-daterange-from-hour").val("00:00");$(".tele-daterange-to").val("");$(".tele-daterange-to-hour").val("23:59");$(this).datepicker();}else if(selectedDate<date1){$(".tele-daterange-to").val($(".tele-daterange-from").val());$(".tele-daterange-to-hour").val($(".tele-daterange-from-hours").val());$(".tele-daterange-from").val(dateText);$(".tele-daterange-from-hour").val("00:00");$(this).datepicker();}else{$(".tele-daterange-to").val(dateText);$(".tele-daterange-to-hour").val("23:59");$(this).datepicker();}}});$(".tele-daterange-period a").click(function(){$(".tele-daterange-period a.active").removeClass('active');that.options.state=$(this).attr('class').split('-')[3];$(this).addClass('active');that.setPeriod();});function get_hour_value(element){var str=element.val();if(str==''){element.val('');return 0;}else{str=str.split(':');if(str.length==2){return(parseInt(str[0])*3600*1000)+(parseInt(str[1])*60*1000);}else{element.val('');return 0;}}}
$(".tele-daterange-buttons .tele-button-apply").click(function(){$(".tele-daterange-popup").fadeOut();if(typeof(that.options.change)=='function'){if($(".tele-daterange-period a.active").length)
telepath.range.state=$(".tele-daterange-period a.active").attr('class').split(/-| /)[3];if(telepath.range.state=='range'){var from_date=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-from").val());var to_date=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-to").val());var from_date_hour=get_hour_value($(".tele-daterange-from-hour"));var to_date_hour=get_hour_value($(".tele-daterange-to-hour"));telepath.range.start=parseInt((from_date.getTime()+from_date_hour)/1000);telepath.range.end=parseInt((to_date.getTime()+to_date_hour)/1000);telepath.ds.get('/telepath/set_time_range',{state:telepath.range.state,start:telepath.range.start,end:telepath.range.end},function(data){that.options.change(telepath.range.start,telepath.range.end);that.options.state=telepath.range.state;that.options.start=telepath.range.start;that.options.end=telepath.range.end;if(that.button){that.button.remove();}
that.createButton();});}
else{telepath.ds.get('/telepath/set_time_range',{state:telepath.range.state},function(data){that.options.state=telepath.range.state;var from_date=new Date();switch(that.options.state){case'data':telepath.range.start=telepath.fullRangeStart;break;case'year':from_date.setFullYear(from_date.getFullYear()-1);break;case'month':from_date.setMonth(from_date.getMonth()-1);break;case'week':from_date.setDate(from_date.getDate()-7);break;case'day':from_date.setDate(from_date.getDate()-1);break;case'hour':from_date.setHours(from_date.getHours()-1);break;}
if(that.options.state!='data'){telepath.range.start=parseInt(from_date.getTime()/1000);}
telepath.range.end=parseInt(new Date().getTime()/1000);that.options.start=telepath.range.start;that.options.end=telepath.range.end;that.options.change(telepath.range.start,telepath.range.end);if(that.button){that.button.remove();}
that.createButton();});}}});$(".tele-daterange-buttons .tele-button-cancel").click(function(){$(".tele-daterange-popup").fadeOut();});that._update();},_update:function(){this.updateUI();},setPeriod:function(){var that=this;var from_date=new Date();if(that.options.state=='range'){$('.tele-darerange-container').removeClass('disabled');$(".tele-daterange-to").val(date_format('d/m/Y',Date.now()/1000));$(".tele-daterange-to-hour").val(date_format('H:i',Date.now()/1000));$(".tele-daterange-from").val(date_format('d/m/Y',telepath.fullRangeStart));$(".tele-daterange-from-hour").val(date_format('H:i',telepath.fullRangeStart));}
else{$('.tele-darerange-container').addClass('disabled');$(".tele-daterange-to").val(date_format('d/m/Y',telepath.range.end));$(".tele-daterange-to-hour").val(date_format('H:i',telepath.range.end));$(".tele-daterange-from").val(date_format('d/m/Y',telepath.range.start));$(".tele-daterange-from-hour").val(date_format('H:i',telepath.range.start));}},updateUI:function(){var that=this;$(".tele-daterange-period a.active").removeClass('active')
$(".tele-daterange-period a").each(function(){if($(this).attr('class').split('-')[3]==telepath.range.state)
$(this).addClass("active");});$('.tele-darerange-container').addClass('disabled');if(telepath.range.state=='range'){$('.tele-darerange-container').removeClass('disabled');}
$(".tele-daterange-from").val(date_format('d/m/Y',this.options.start));$(".tele-daterange-from-hour").val(date_format('H:i',this.options.start));$(".tele-daterange-to").val(date_format('d/m/Y',this.options.end));$(".tele-daterange-to-hour").val(date_format('H:i',this.options.end));},createButton:function(){var that=this;if(telepath.range.state=='range'){var text=date_format('d/m/Y',this.options.start)+' - '+date_format('d/m/Y',this.options.end);}
else if(telepath.range.state=='data')
var text='All Data';else
var text='Last '+telepath.range.state[0].toUpperCase()+telepath.range.state.slice(1);this.button=$('<a>').attr('href','#').btn({icon:'daterange',text:text,callback:function(){that._displayPopup();}});this.element.append(this.button);}});;$.widget("tele.flotGraph",{options:{data:[],options:[],dashboard:false,title:false,},_create:function(){this.element.addClass("tele-graph");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.canvasOuter=$('<div>').addClass('tele-graph-canvas-outer');this.canvasInner=$('<div>').addClass('tele-graph-canvas');this.element.empty();if(this.options.title){var graphTitle=$('<div>').addClass('tele-graph-title').html(this.options.title);this.element.append(graphTitle);}
this.canvasOuter.append(this.canvasInner);this.element.append(this.canvasOuter);if(this.options.dashboard){this.filterTypes=[{type:'noncase-alerts',label:'Alerts',count:0,active:true,suffix:'Tx'},{type:'case-alerts',label:'Cases',count:0,active:true,suffix:'Tx'},{type:'suspicions',label:'Suspects',count:0,active:true,suffix:'Tx'},{type:'other-sessions',label:'Normal',count:0,active:true,suffix:'Tx'},];var totalCount=0;$.each(that.filterTypes,function(i,filter){$.each(that.options.data,function(x,data){if(data.label==filter.label){filter.count=0;$.each(data.data,function(z,count){filter.count=filter.count+parseInt(count[1]);totalCount=totalCount+parseInt(count[1]);});}});});this.dashboardGraphFilters=$('<div>').addClass('tele-dashboard-graph-filters');$('.tele-graph-canvas-outer').append(this.dashboardGraphFilters);$.each(this.filterTypes,function(i,filter){var filterWrap=$('<div>').addClass('tele-dashboard-graph-filter').addClass('tele-graph-filter-'+filter.type);var filterToggle=$('<a>').attr('href','#').addClass('tele-graph-filter-toggle').html('&nbsp;');var filterTitle=$('<div>').addClass('tele-graph-filter-title').text(filter.label);var filterPercent=$('<div>').addClass('tele-graph-filter-percent').text((totalCount>0?parseFloat(filter.count/totalCount*100).toFixed(2):0)+'%');var filterCount=$('<div>').addClass('tele-graph-filter-count').text(filter.count+' '+filter.suffix);filterWrap.append(filterToggle).append(filterTitle).append(filterPercent).append(filterCount);that.dashboardGraphFilters.append(filterWrap);filterPercent.css({marginRight:160-filterTitle.width()});filterCount.css({marginRight:160-filterTitle.width()});if(filter.active){filterToggle.addClass('active');}
filterToggle.click(function(){if($(this).hasClass('active')){$(this).removeClass('active');that.filterTypes[i].active=false;}else{$(this).addClass('active');that.filterTypes[i].active=true;}
that.updateFilters();});});this.resize();this.dashboardGraphFilters.resize(function(){that.resize();});this.updateFilters();}
this.printData=this.options.data;this.plot();},updateFilters:function(){var that=this;this.printData=[];$.each(that.filterTypes,function(i,filter){if(filter.active){$.each(that.options.data,function(x,data){if(data.label==filter.label){that.printData.push(data);}});}});this.plot();},plot:function(){this.plotObj=$.plot(this.canvasInner,this.printData,this.options.options);},resize:function(){var width=this.dashboardGraphFilters.width();$('.tele-dashboard-graph-filter').css({margin:0});var filterWidth=$('.tele-dashboard-graph-filter').outerWidth();var spare=Math.floor(Math.floor(width-(filterWidth*this.filterTypes.length))/this.filterTypes.length)-1;$('.tele-dashboard-graph-filter').css({marginRight:spare});$('.tele-graph-filter-title').css({fontSize:(width<800?'16px':'20px')});}});;$.widget("tele.vMap",{options:{'data':[],'title':false},_create:function(){this.element.addClass("tele-map");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){this.element.empty();if(this.options.title){var graphTitle=$('<div>').addClass('tele-graph-title').html(this.options.title);this.element.append(graphTitle);}
var scaleColors=['#C4E8B2','#60BB3C'];var max=0;var total=0;$.each(this.options.data,function(c_id,val){if(c_id!=='00'&&val>max){max=val;}
total+=val;});this.scaleWrap=$('<div>').addClass('tele-scale-wrap');this.scaleLeft=$('<div>').addClass('tele-scale-left').html('0');this.scaleGrad=$('<div>').addClass('tele-scale-grad');this.scaleRight=$('<div>').addClass('tele-scale-right').html(max.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+' ('+total.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+')');this.scaleWrap.append(this.scaleLeft).append(this.scaleGrad).append(this.scaleRight);this.vectorMap=$('<div>').css({clear:'both',height:300,padding:'15px 0px 0px 0px'});this.element.append(this.scaleWrap);this.element.append(this.vectorMap);var country_rate=Array();$.each(this.options.data,function(index,value){country_rate[index.toLowerCase()]=value;});this.vectorMap.vectorMap({map:'world_en',backgroundColor:'#304F68',color:'#C4E8B2',hoverOpacity:0.7,selectedColor:'#666666',enableZoom:true,showTooltip:true,values:country_rate,scaleColors:scaleColors,normalizeFunction:'polynomial',onRegionClick:function(x,y){telepath.alerts.searchString='country_code:'+y.toUpperCase();$('.tele-nav-alerts a').click();$('.jqvmap-label').remove();},onLabelShow:function(event,label,code){var row=$('<div>').addClass('tele-popover-row');var icon=$('<div>').addClass('tele-icon tele-icon-alert');var count=$('<div>').addClass('tele-count').html(telepath.dashboard.data.items.map[code.toUpperCase()]?telepath.dashboard.data.items.map[code.toUpperCase()]:0);var title=$('<span>').addClass('tele-popover-subtitle').html(telepath.countries.a2n(code.toUpperCase()));row.append(icon).append(count).append(title);label.empty();label.append(row);},});}});;$.widget("tele.anomalyScore",{options:{request:[],},_create:function(){this.element.addClass("tele-anomaly-score");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var scoreTypes=['speed','direction','query','location'];this.options.speed=this.options.request.score_landing;this.options.direction=this.options.request.score_flow;this.options.query=this.options.request.score_query;this.options.location=this.options.request.score_geo;$.each(scoreTypes,function(i,scoreType){var value=parseInt(that.options[scoreType]*100);var typeWrap=$('<div>').addClass('tele-anomaly-wrap');var typeIcon=$('<div>').addClass('tele-anomaly-icon').addClass('tele-icon-'+scoreType);var typeText=$('<div>').addClass('tele-anomaly-text').html(scoreType.charAt(0).toUpperCase()+scoreType.slice(1));var typeValue=$('<div>').addClass('tele-anomaly-value').html(value+'%');typeWrap.append(typeIcon).append(typeText).append(typeValue);if(value>25){typeIcon.addClass('active');typeText.addClass('active');typeValue.addClass('active');}
that.element.append(typeWrap);});}});;$.widget("tele.anomalyScore",{options:{request:[],},_create:function(){this.element.addClass("tele-anomaly-score");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var scoreTypes=['speed','direction','query','location'];this.options.speed=this.options.request.score_landing;this.options.direction=this.options.request.score_flow;this.options.query=this.options.request.score_query;this.options.location=this.options.request.score_geo;$.each(scoreTypes,function(i,scoreType){var value=parseInt(that.options[scoreType]*100);var typeWrap=$('<div>').addClass('tele-anomaly-wrap');var typeIcon=$('<div>').addClass('tele-anomaly-icon').addClass('tele-icon-'+scoreType);var typeText=$('<div>').addClass('tele-anomaly-text').html(scoreType.charAt(0).toUpperCase()+scoreType.slice(1));var typeValue=$('<div>').addClass('tele-anomaly-value').html(value+'%');typeWrap.append(typeIcon).append(typeText).append(typeValue);if(value>25){typeIcon.addClass('active');typeText.addClass('active');typeValue.addClass('active');}
that.element.append(typeWrap);});}});;$.widget("tele.anomalyScore",{options:{request:[],},_create:function(){this.element.addClass("tele-anomaly-score");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var scoreTypes=['speed','direction','query','location'];this.options.speed=this.options.request.score_landing;this.options.direction=this.options.request.score_flow;this.options.query=this.options.request.score_query;this.options.location=this.options.request.score_geo;$.each(scoreTypes,function(i,scoreType){var value=parseInt(that.options[scoreType]*100);var typeWrap=$('<div>').addClass('tele-anomaly-wrap');var typeIcon=$('<div>').addClass('tele-anomaly-icon').addClass('tele-icon-'+scoreType);var typeText=$('<div>').addClass('tele-anomaly-text').html(scoreType.charAt(0).toUpperCase()+scoreType.slice(1));var typeValue=$('<div>').addClass('tele-anomaly-value').html(value+'%');typeWrap.append(typeIcon).append(typeText).append(typeValue);if(value>25){typeIcon.addClass('active');typeText.addClass('active');typeValue.addClass('active');}
that.element.append(typeWrap);});}});;$.widget("tele.notifications",{options:{interval:10000},toShow:[],indexes:false,showNotifications:function(){$.each(this.toShow,function(i,notifyObject){$.pnotify(notifyObject);});this.toShow=[];this.count.html(0);},_create:function(){var that=this;this.element.addClass("tele-notify");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;telepath.ds.get('/notifications/get_syslog',{},function(data){if(data.items&&data.items.length>0){$.each(data.items,function(i,text){if(text.substr(0,3)=='CMD'){eval(text.substr(4));}else{console.log('SYSLOG:: '+text);}});}});telepath.ds.get('/notifications/get_indexes',{time:this.time},function(data){if(!that.indexes){that.indexes=data.items;}else{$.each(that.indexes,function(index_name,index_value){$.each(data.items,function(data_name,data_value){if(index_name==data_name&&data_value>index_value){var diff=data_value-index_value;var icon='';var title='';var link='';var text='';switch(index_name){case'alerts':title='New Alerts';link='<a onclick="$(\'.tele-nav-alerts a\').click()">here</a>';text=diff+' new alerts. click '+link+' to view';icon='alert';break;case'requests':title='Traffic';text='Current traffic is '+(diff*6)+' requests/min.';icon='config';that.indexes[index_name]=data_value;break;}
var nData={title:title,text:text,type:'success',delay:1000,opacity:0.95,styling:'bootstrap',icon:'tele-icon tele-icon-'+icon,};}});});if(that.count){that.count.html(that.toShow.length);}}});}});;$.widget("tele.notifications",{options:{interval:10000},toShow:[],indexes:false,showNotifications:function(){$.each(this.toShow,function(i,notifyObject){$.pnotify(notifyObject);});this.toShow=[];this.count.html(0);},_create:function(){var that=this;this.element.addClass("tele-notify");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;telepath.ds.get('/notifications/get_syslog',{},function(data){if(data.items&&data.items.length>0){$.each(data.items,function(i,text){if(text.substr(0,3)=='CMD'){eval(text.substr(4));}else{console.log('SYSLOG:: '+text);}});}});telepath.ds.get('/notifications/get_indexes',{time:this.time},function(data){if(!that.indexes){that.indexes=data.items;}else{$.each(that.indexes,function(index_name,index_value){$.each(data.items,function(data_name,data_value){if(index_name==data_name&&data_value>index_value){var diff=data_value-index_value;var icon='';var title='';var link='';var text='';switch(index_name){case'alerts':title='New Alerts';link='<a onclick="$(\'.tele-nav-alerts a\').click()">here</a>';text=diff+' new alerts. click '+link+' to view';icon='alert';break;case'requests':title='Traffic';text='Current traffic is '+(diff*6)+' requests/min.';icon='config';that.indexes[index_name]=data_value;break;}
var nData={title:title,text:text,type:'success',delay:1000,opacity:0.95,styling:'bootstrap',icon:'tele-icon tele-icon-'+icon,};}});});if(that.count){that.count.html(that.toShow.length);}}});}});;telepath.overlay={resize:function(){var newHeight=$('.tele-overlay').height()-$('.tele-overlay-header').height();if(this.minheight>0&&this.minheight>newHeight)
{newHeight=this.minheight;}
$('.tele-overlay-content').height(newHeight);$('.tele-overlay').css({marginTop:-1*($('.tele-overlay').height()/2)});},keydownHandler:function(e){if(e.keyCode==27){telepath.overlay.destroy();}},destroy:function(){$('.tele-overlay, .tele-overlay-mask').remove();$(document).unbind('keydown',telepath.overlay.keydownHandler);},init:function(icon,title,fullscreen,minheight){telepath.overlay.destroy();this.maskEl=$('<div>').addClass('tele-overlay-mask');this.overlayEl=$('<div>').addClass('tele-overlay').addClass('tele-overlay-'+icon);this.iconEl=$('<div>').addClass('tele-overlay-icon').addClass('tele-icon').addClass('tele-icon-'+icon);this.headerEl=$('<div>').addClass('tele-overlay-header');this.contentEl=$('<div>').addClass('tele-overlay-content');this.titleEl=$('<div>').addClass('tele-overlay-title').html(title);this.closeEl=$('<a>').attr('href','#').addClass('tele-overlay-close').addClass('tele-icon').addClass('tele-icon-close');this.minheight=(typeof(minheight)!=='undefined')?minheight:0;$('body').append(this.maskEl);$('body').append(this.overlayEl);this.overlayEl.append(this.iconEl).append(this.headerEl).append(this.contentEl);this.headerEl.append(this.titleEl).append(this.closeEl);this.closeEl.click(function(){telepath.overlay.destroy();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$(document).bind('keydown',telepath.overlay.keydownHandler);if(fullscreen){var height=$(window).height()-100;if(this.minheight>0&&this.minheight>height)
{height=this.minheight;}
var width=$(window).width()-100;$('.tele-overlay').css({height:height,width:width,marginLeft:-1*parseInt(width/2),marginTop:-1*parseInt(height/2)});}
$('.tele-overlay').resize(function(){telepath.overlay.resize();});telepath.overlay.resize();$(this.overlayEl).draggable({handle:this.headerEl});}};$.widget("tele.pagination",{options:{count:0,name:'Alert',current:0,callback:function(){}},_create:function(){this.element.addClass("tele-pagination");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_destroy:function(){$(document).unbind('keydown',this.keyDown);},_update:function(){var that=this;telepath.pagination=this;this.element.empty();var itemName=this.options.count>1?this.options.name+'s':this.options.name;var itemCount=(this.options.current+1)+'/'+this.options.count;this.titleEl=$('<div>').addClass('tele-pagination-title').html(itemCount+'&nbsp;'+itemName);this.prevEl=$('<div>').addClass('tele-pagination-prev').addClass('tele-icon').addClass('tele-icon-prev');this.nextEl=$('<div>').addClass('tele-pagination-next').addClass('tele-icon').addClass('tele-icon-next');this.prevEl.hover(function(){$(this).addClass('hover')},function(){$(this).removeClass('hover')});this.nextEl.hover(function(){$(this).addClass('hover')},function(){$(this).removeClass('hover')});this.element.append(this.prevEl,this.titleEl,this.nextEl);this.prevEl.click(function(){that.scrollPrev();});this.nextEl.click(function(){that.scrollNext();});this._constrain();this.titleEl.attr('unselectable','on').css('user-select','none').on('selectstart',false);$(document).unbind('keydown',this.keyDown);$(document).bind('keydown',this.keyDown);},_constrain:function(){if(this.options.current==0){this.prevEl.css({visibility:'hidden'});}else{this.prevEl.css({visibility:'visible'});}
if(this.options.current==this.options.count-1){this.nextEl.css({visibility:'hidden'});}else{this.nextEl.css({visibility:'visible'});}},scrollPrev:function(){if(this.options.current>0){this.options.current--;this._update();this.options.callback(this.options.current);}},scrollNext:function(){if(this.options.current<this.options.count-1){this.options.current++;this._update();this.options.callback(this.options.current);}},keyDown:function(e){if(e.keyCode=='37'){telepath.pagination.scrollPrev();}
if(e.keyCode=='39'){telepath.pagination.scrollNext();}}});;telepath.config={loaded:false,init:function(){this.outerContainer=$('.tele-panel-config');this.initTabs();},initTabs:function(){var that=this;$('canvas').remove();this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.outerContainer.append(this.panelTopBar);this.tabs=[];if(telepath.access.admin){this.tabs.push({icon:'accounts',text:'Telepath Users'});}
if(telepath.access.admin||telepath.access.perm.Applications_get){this.tabs.push({icon:'applications',text:'Applications'});}
if(telepath.access.admin||telepath.access.perm.Rules_get){this.tabs.push({icon:'rules',text:'Rules'});}
if(telepath.access.admin||telepath.access.perm.Workflow_get){this.tabs.push({icon:'actions',text:'Business Actions'});}
if(telepath.access.admin||telepath.access.perm.Config_get){this.tabs.push({icon:'system',text:'Advanced'});}
for(x in this.tabs){var tab=this.tabs[x];tab.callback=function(widget){$('.tele-config-tab .active').removeClass('active');$('.tele-icon',widget.element).addClass('active');$('.tele-button-text',widget.element).addClass('active');var id=widget.options.icon;that.currentPanel=id;that.container.empty();$("#file-upload").hide();$('#sort-radio').remove();telepath.config[id].container=that.container;telepath.config[id].initLayout=that.initLayout;telepath.config[id].resizeLayout=that.resizeLayout;telepath.config[id].initLayout();telepath.config[id].resizeLayout();telepath.config[id].init();$(window).resize(function(){telepath.config[id].resizeLayout();});telepath.config.actions.checkNotFinishedRecord();}
var tabBtn=$('<div>').btn(tab).addClass('tele-config-tab');this.panelTopBar.append(tabBtn);this.panelTopBar.append('<div class="tele-navsep"></div>');}
$('.tele-navsep:last',this.panelTopBar).remove();this.container=$('<div>').addClass('tele-panel-config-inner');this.outerContainer.append(this.container);this.container.append(telepath.loader);telepath.config.load();},load:function(dont_start){this.start();},start:function(){var that=this;setTimeout(function(){that.container.empty();$('.tele-button.tele-config-tab:nth-child(1) .tele-button-text').trigger('click');},500);},initLayout:function(){this.barEl=$('<div>').addClass('tele-config-bar').addClass('tele-panel-subtitle');this.barLeft=$('<div>').addClass('tele-config-bar-left');this.barRight=$('<div>').addClass('tele-config-bar-right');this.contentEl=$('<div>').addClass('tele-config-content');this.contentLeft=$('<div>').addClass('tele-config-content-left');this.contentRight=$('<div>').addClass('tele-config-content-right');this.barEl.append(this.barLeft).append(this.barRight);this.contentEl.append(this.contentLeft).append(this.contentRight);this.container.append(this.barEl).append(this.contentEl);},resizeLayout:function(){this.barEl.css({height:40,width:'100%',background:'#333333'});var height=$(window).height();var width=$(window).width();if(width<1200){if(width<1024){$('.tele-config-tab').css({margin:'5px 10px 0px 10px'});}else{$('.tele-config-tab').css({margin:'5px 20px 0px 20px'});}}else{$('.tele-config-tab').css({margin:'5px 30px 0px 30px'});}
$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-block').height(offset-20);$('.tele-block .tele-list').height(offset-50);$('.tele-list').mCustomScrollbar("update");this.contentEl.css({height:offset});if(this.contentRight.hasClass('tele-stacked')){this.contentLeft.width(width);this.contentRight.width(width);this.contentRight.css({height:offset-this.contentLeft.outerHeight()-20});}else{var magic=520;this.contentLeft.width(magic);this.contentRight.width(width-magic-20);this.contentLeft.css({height:offset});$('.tele-tree',this.contentLeft).css({height:offset}).mCustomScrollbar("update");this.contentRight.css({height:offset});}
this.barLeft.width(magic);this.barRight.width(width-magic-20);},startsWith2:function(str,prefix){if(str.length<prefix.length)
return false;for(var i=prefix.length-1;(i>=0)&&(str[i]===prefix[i]);--i){continue;}
return i<0;}};telepath.dashboard={divs:0,data:{items:{}},sort:'count',dir:false,refreshTimer:false,refreshInterval:5,reloadFlag:Date.now(),loading:false,map_mode:false,getData:function(){this.loading=true;$('.tele-panel-dashboard-refresh-button').hide();$('.tele-panel-dashboard-refresh').css('paddingRight','+=47px');setTimeout(function(){telepath.dashboard.loading=false;$('.tele-panel-dashboard-refresh-button').fadeIn();$('.tele-panel-dashboard-refresh').css('paddingRight','-=47px');},5000);var that=this;telepath.ds.get('/dashboard/get_map',{},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.map_mode=data.items.map_mode;$('.tele-panel-dashboard .tele-panel-subtitle-right .tele-mini-toggle').toggleFlip({flipped:data.items.map_mode=='traffic'});telepath.dashboard.data.items.map=data.items.map;telepath.dashboard.map.vMap({data:telepath.dashboard.data.items.map,title:data.items.map_mode=='traffic'?'Traffic over time':'Alerts over time'});$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_chart',{},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.data.items.chart=data.items.chart;telepath.dashboard.drawGraph();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_suspects',{sort:this.sort,dir:this.dir},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.data.items.suspects=data.items.suspects;telepath.dashboard.initSuspects();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_alerts',{sort:this.sort,dir:this.dir},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.data.items.alerts=data.items.alerts;telepath.dashboard.initAlerts();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_cases',{},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
var cases=[];var index;var caseCount=(data.items.cases)?data.items.cases.length:0;for(index=0;index<caseCount;++index){cases.push(data.items.cases[index]);}
telepath.dashboard.data.items.cases=cases;telepath.dashboard.initCases();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);},initCases:function(){var that=this;if(telepath.access.admin||telepath.access.perm.Cases_get){this.divs+=1;this.casesList=$('<div>').addClass('tele-dashboard-block cases');$('.tele-panel-dashboard').append(this.casesList);this.casesList.teleList({title:'Recent Cases',titleCallback:function(){$(".tele-nav-cases a").click();},data:this.data.items.cases,formatter:function(item){return telepath['case'].rowFormatter(item,'dashboard');},callbacks:telepath.listitem.generic.callbacks_case});}},initAlerts:function(){var that=this;if(telepath.access.admin||telepath.access.perm.Alerts_get){this.divs+=1;this.alertsList=$('<div>').addClass('tele-dashboard-block alerts');$('.tele-panel-dashboard').append(this.alertsList);this.alertsList.teleList({title:'Recent Alerts',titleCallback:function(){$(".tele-nav-alerts a").click();},data:this.data.items.alerts.items,formatter:function(item){item.checkable=false;return telepath.alert.rowFormatter(item,'dashboard');}});}},initSuspects:function(){var that=this;if(telepath.access.admin||telepath.access.perm.Suspects_get){this.divs+=1;this.suspectsList=$('<div>').addClass('tele-dashboard-block suspects');$('.tele-panel-dashboard').append(this.suspectsList);this.suspectsList.teleList({title:'Top Suspects',titleCallback:function(){$(".tele-nav-suspects a").click();},data:this.data.items.suspects.items,formatter:function(item){item.checkable=false;return telepath.suspects.rowFormatter(item,'dashboard');}});}},refresh:function(callback){this.init();},init:function(){var that=this;this.getData();this.resetContainer();this.showFilters();this.resize();if($('.tele-panel-dashboard').size()>0){$(window).resize(function(){that.resize();});}},drawGraph:function(){var timeformat=((telepath.range.end-telepath.range.start)/3600>48)?"%d/%m/%y":"%d/%m %h:%M:%S";var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'}},yaxis:{alignTicksWithAxis:true,labelWidth:30,ticks:5,color:'#446077',font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"}},selection:{mode:"x"},xaxis:{alignTicksWithAxis:true,tickColor:'#cccccc',tickLength:7,font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"},mode:"time",timezone:"browser",timeformat:timeformat},grid:{borderColor:'#446077',borderWidth:1,hoverable:true,clickable:true},tooltip:true,tooltipOpts:{content:"%s | date & time: %x | sessions: %y"}};var chartData=[{label:"Alerts",data:this.data.items.chart.alerts,color:'#64a5bc'},{label:"Normal",data:this.data.items.chart.sessions,color:'#986da0'},{label:"Cases",data:this.data.items.chart.cases,color:'#ff850b'},{label:"Suspects",data:this.data.items.chart.suspects,color:'#6ab789'}];this.graph.flotGraph({data:chartData,options:options,dashboard:true,title:'Overall Transactions'});},resetContainer:function(loading){this.divs=0;var that=this;$('.tele-panel-dashboard .tele-panel-subtitle-right .tele-mini-toggle').toggleFlip({flipped:telepath.dashboard.data.items.map=='traffic'});var container=$('.tele-panel-dashboard');container.empty();container.append('<div class="tele-panel-topbar"><div class="tele-panel-title">Dashboard</div><div class="tele-panel-topbar-right"></div></div>');if(!loading){container.append('<div class="tele-panel-subtitle"><div class="tele-panel-subtitle-text">Traffic and Alerts Trends</div><div class="tele-panel-subtitle-right"></div></div>');var trafficToggle=$('<div>').toggleFlip({left_value:'Alerts',right_value:'Traffic',flipped:that.map_mode=='traffic',flip:function(x,y){that.map.empty();that.map.append(telepath.loader);if(x){telepath.ds.get('/dashboard',{mode:'map_traffic'},function(data){telepath.dashboard.data.items.map=data.items.traffic;that.map.vMap({data:data.items.traffic,title:'Traffic over time'});});}else{telepath.ds.get('/dashboard',{mode:'map_alerts'},function(data){telepath.dashboard.data.items.map=data.items.map;that.map.vMap({data:data.items.map,title:'Alerts over time'});});}}});var realtimeToggle=$('<div>').toggleFlip({left_value:'Static',right_value:'Realtime',flip:function(x,y){if(x){that.graph.hide();that.graph_realtime.show();telepath.realtime.start(that.graph_realtime);$('.tele-panel-subtitle-text').html('Realtime Monitor');}else{that.graph.show();that.graph_realtime.hide();telepath.realtime.stop();$('.tele-panel-subtitle-text').html('Traffic and Alerts Trends');}}}).hide();$('.tele-panel-dashboard .tele-panel-subtitle-right').append(realtimeToggle);$('.tele-panel-dashboard .tele-panel-subtitle-right').append(trafficToggle);var graph_div=$('<div>').css("background-color","#304f68").css("width","100%");var empty_div=$('<div>').css("clear","both");this.map=$('<div>');this.graph=$('<div>');graph_div.append(this.map);graph_div.append(this.graph);graph_div.append(empty_div);container.append(graph_div);this.graph_realtime=$('<div>').addClass('tele-graph-realtime');container.append(this.graph_realtime);}else{container.append(telepath.loader);}},resize:function(){if($('.tele-panel-dashboard').children().size()==0)return;var width=$(window).width();var current_div=parseInt(100/this.divs);if(width<1025){$('.tele-map').width('100%');$('.tele-graph').width('100%');$('.tele-dashboard-block').width('100%');}else{$('.tele-map').width('33%');$('.tele-graph').width('67%');$('.tele-dashboard-block').css({'display':'inline-block'});$('.tele-dashboard-block').width(current_div+'%');$('.tele-dashboard-block.cases').css({'float':'left'});$('.tele-dashboard-block.suspects').css({'float':'right'});}},updateRefreshInterval:function(interval){if(interval){this.refreshInterval=interval;}
this.cmdRefreshValue.html(this.refreshInterval+'m');if(this.refreshTimer){clearInterval(this.refreshTimer);}
this.refreshTimer=setInterval(function(){telepath.dashboard.refresh();},this.refreshInterval*60000);},showFilters:function(){var that=this;var container=$('.tele-panel-dashboard .tele-panel-topbar-right');container.empty();var filterApps=$('<div>').appSelect({callback:function(app_id){$('.jqvmap-label').hide();$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.dashboard.refresh(function(){$('.tele-icon-loader',filterApps).addClass('tele-icon-application').removeClass('tele-icon-loader');});}});var cmdRefresh=$('<div>').addClass('tele-panel-dashboard-refresh');var cmdRefreshText=$('<a>').attr('href','#').addClass('tele-panel-dashboard-refresh-text').html('Refresh Rate');this.cmdRefreshValue=$('<a>').attr('href','#').addClass('tele-panel-dashboard-refresh-value').html(this.refreshInterval+'m');var cmdRefreshButton=$('<a>').attr('href','#').addClass('tele-panel-dashboard-refresh-button').html('&nbsp;');cmdRefresh.append(cmdRefreshText).append(this.cmdRefreshValue).append(cmdRefreshButton);cmdRefreshButton.click(function(){if(!telepath.dashboard.loading){$(this).addClass('loader');var that=this;telepath.dashboard.refresh(function(){$(that).removeClass('loader');});}});var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.dashboard.reloadFlag=Date.now();cmdRefreshButton.addClass('loader');telepath.dashboard.refresh(function(){cmdRefreshButton.removeClass('loader');});}});var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});container.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps).append('<div class="tele-navsep"></div>').append(cmdRefresh);$('.tele-panel-dashboard-refresh-value').click(function(){$('body').append('<div class="tele-popup tele-refreshrate-popup"><input class="tele-refreshrate-slider" /></div>');if($(".tele-refreshrate-popup").css('display')=='block'){$(".tele-refreshrate-popup").fadeOut('fast',function(){$(this).remove();});return;}
var top=$(this).offset().top+$(this).height()+20;var left=($(this).offset().left+($(this).width()/2))-($(".tele-daterange-popup").width()/2)-150;$(".tele-refreshrate-popup").css({top:top,left:left});$(".tele-refreshrate-popup").fadeIn();that.refresh_slider=$(".tele-refreshrate-slider").slider({orientation:"horizontal",max:60,min:1,value:parseInt(telepath.dashboard.refreshInterval),}).on('slide',function(ev){var value=telepath.dashboard.refresh_slider.val();telepath.dashboard.updateRefreshInterval(value);});});}}
telepath.realtime={container:false,timer:false,count:0,options:{legend:{show:true,color:'yellow',labelBoxBorderColor:"white",position:"sw",backgroundColor:'white',backgroundOpacity:1,margin:10},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'},color:'yellow'},xaxis:{mode:"time",tickFormatter:function(v,axis){var date=new Date(v);var hours=date.getHours()<10?"0"+date.getHours():date.getHours();var minutes=date.getMinutes()<10?"0"+date.getMinutes():date.getMinutes();var seconds=date.getSeconds()<10?"0"+date.getSeconds():date.getSeconds();return hours+":"+minutes+":"+seconds;},axisLabel:"Time",axisLabelUseCanvas:true,axisLabelFontSizePixels:12,axisLabelFontFamily:'Verdana, Arial',axisLabelPadding:10},yaxes:[{axisLabel:"Dropped",axisLabelUseCanvas:true,axisLabelFontColor:'#cecece',font:{family:'Arial',color:'white',size:11,weight:"normal"},axisLabelPadding:6,min:0},{position:"right",axisLabel:"Requests",axisLabelUseCanvas:true,axisLabelFontColor:'#cecece',font:{family:'Arial',color:'white',size:11,weight:"normal"},axisLabelPadding:6},{position:"right",axisLabel:"Packets",axisLabelUseCanvas:true,axisLabelFontColor:'#cecece',font:{family:'Arial',color:'white',size:11,weight:"normal"},axisLabelPadding:14}],grid:{borderColor:'#446077',borderWidth:1},},offsets:{init:false,packets:0,loss:0,requests:0},start:function(container){this.container=container;var totalPoints=60;var updateInterval=1000;var now=new Date().getTime()-(totalPoints*updateInterval);this.data={packets:[],loss:[],requests:[]};for(var i=0;i<totalPoints;i++){var temp=[now+=updateInterval,0];this.data.packets.push(temp);this.data.loss.push(temp);this.data.requests.push(temp);}
var dataset=[{label:"Packets:",data:this.data.packets,lines:{fill:true,lineWidth:1.2},color:"#6ab789"},{label:"Dropped:",data:this.data.loss,lines:{lineWidth:1.2},color:"#64a5bc",yaxis:3},{label:"Requests:",data:this.data.requests,color:"#986da0",bars:{show:true},yaxis:2}];$.plot($(this.container),dataset,this.options);this.timer=setInterval(this.getData,updateInterval);},stop:function(){clearInterval(this.timer);this.container.empty();},tick:function(){telepath.realtime.count=telepath.realtime.count+1;},getData:function(){$.ajaxSetup({cache:false});$.ajax({url:telepath.controllerPath+"/realtime/index",dataType:'json',success:function(_data){_data['capture.kernel_packets']=parseInt(_data['capture.kernel_packets']);_data['capture.kernel_drops']=parseInt(_data['capture.kernel_drops']);if(!telepath.realtime.offsets.init){telepath.realtime.offsets.packets=_data['capture.kernel_packets'];telepath.realtime.offsets.loss=_data['capture.kernel_drops'];telepath.realtime.offsets.requests=_data['cmd_set'];telepath.realtime.offsets.init=true;return;}
telepath.realtime.data.packets.shift();telepath.realtime.data.loss.shift();telepath.realtime.data.requests.shift();var now=new Date().getTime();telepath.realtime.data.packets.push([now,_data['capture.kernel_packets']-telepath.realtime.offsets.packets]);telepath.realtime.data.loss.push([now,_data['capture.kernel_drops']-telepath.realtime.offsets.loss]);telepath.realtime.data.requests.push([now,_data.cmd_set-telepath.realtime.offsets.requests]);var dataset=[{label:"Dropped",data:telepath.realtime.data.loss,lines:{lineWidth:1.2},color:"#640000"},{label:"Packets",data:telepath.realtime.data.packets,lines:{fill:true,lineWidth:1.2},color:"#986da0",yaxis:3},{label:"Requests",data:telepath.realtime.data.requests,color:"#6ab789",yaxis:2}];$.plot($(telepath.realtime.container),dataset,telepath.realtime.options);telepath.realtime.offsets.packets=_data['capture.kernel_packets'];telepath.realtime.offsets.loss=_data['capture.kernel_drops'];telepath.realtime.offsets.requests=_data['cmd_set'];},error:function(){}});$.ajaxSetup({cache:true});}};telepath['case']={rowFormatter:function(item,mode){if(item._source){item=item._source}
item.data=item.case_data.details;var details=[];$.each(item.data,function(i,condition){details.push({key:condition.type,value:telepath.formatConditionBrief(false,condition)});});if(!item.checkable){item.checkable=false;}
if(!item.favorites){item.favorites=false;item.favorite=false;}
if(mode=='dashboard'){var result={details:details,dataID:item.name,icon:'case',title:item.name,count:item.count,time:item.last_time,favorite:item.favorite};}else{var result={checkable:item.checkable,favorites:item.favorites,favorite:item.favorite,dataID:item.name,icon:'case',title:item.name,count:item.count,updating:item.case_data.updating,details:details,time:item.last_time};}
return result;}}
telepath.caseOverlay={addCase:function(){this.initUI({id:'new',case_data:{case_name:'New Case',details:[]}});},editCase:function(data){this.initUI(data);},initUI:function(data){var that=this;this.data=data;telepath.overlay.init('case-edit',data.case_data.case_name);$('.tele-overlay').height(860).trigger('resize');var caseName=$('<div>').teleInput({label:'Name',value:data.id=='new'?'':data.case_data.case_name,disabled:data.id=='new'?false:true});telepath.overlay.contentEl.append(caseName);var title=$('<div>').addClass('tele-title-1').text('Traffic matching following conditions will be aggregated into this case');telepath.overlay.contentEl.append(title);var cond=$('<div>').conditionList({data:data.case_data.details});telepath.overlay.contentEl.append(cond);var btnContain=$('<div>').addClass('tele-button-container');var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');btnContain.append(saveBtn).append(cancelBtn);telepath.overlay.contentEl.append(btnContain);saveBtn.click(function(){var json=cond.data('tele-conditionList').getJSON();var name=caseName.data('tele-teleInput').input.val();caseName.removeClass('error');if(name.length==0||name.length>32){caseName.addClass('error');return;}
if(json.length==0){telepath.dialog({title:'Case Editor',msg:'Must have at least one condition'});return;}
$('.tele-icon-case-edit').append(telepath.loader).css({backgroundColor:'#555'});if(that.data.id=='new'){telepath.ds.get('/cases/add_case',{name:name,case_data:JSON.stringify(json)},function(data){if(data.items.existing){telepath.dialog({title:'Case Editor',msg:'Already have a case with this name'});return;}
telepath.overlay.destroy();telepath.cases.refresh(function(){});telepath.ds.get('/cases/flag_requests_by_cases',{case:[name],range:false,method:'add'},function(data){telepath.cases.refresh(function(){});});});}else{telepath.ds.get('/cases/set_case',{name:name,case_data:JSON.stringify(json)},function(data){if(data.existing){telepath.dialog({title:'Case Editor',msg:'Already have a case with this name'});return;}
telepath.overlay.destroy();telepath.cases.init();telepath.ds.get('/cases/flag_requests_by_cases',{case:[name],range:false,method:'update'},function(data){telepath.cases.refresh(function(){});});});}});cancelBtn.click(function(){telepath.overlay.destroy();});}}
telepath.casePanel={data:{},sort:'date',dir:false,init:function(caseID){$('.tele-panel-case').remove();this.container=$('<div>').addClass('tele-panel-case');$('.tele-panel-cases').append(this.container);$('.tele-panel-cases-inner').hide();this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html('Loading Case # '+caseID);this.container.append(this.panelTopBar);this.container.append(telepath.loader);this.getData(caseID);},refresh:function(callback){$(".tele-case-graph, .tele-wrapper, .tele-panel-subtitle, .tele-infoblock, .mCustomScrollbar, .tele-loader",this.container).remove();this.container.append(telepath.loader);telepath.ds.get('/cases/get_case',{start:telepath.range.start,end:telepath.range.end,apps:telepath.appFilter,sort:this.sort,dir:this.dir,cid:this.caseID},function(data){telepath.casePanel.loadData(data);if(typeof(callback)=='function'){callback();}});},getData:function(caseID){this.caseID=caseID;this.refresh();},loadData:function(data){var that=this;this.data=data;$('.tele-loader',this.container).remove();this.panelTopBar.empty();this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html(this.data['case']['case_data']['case_name']+' | '+this.data.count+' Sessions');this.favEl=$('<a>').cb({icon:'favorites',checked:data['case']['favorite']=='1',callback:function(widget){telepath.ds.get('/cases/set_case_fav',{cid:that.caseID,favorite:widget.options.checked},function(data){});}});this.panelTopBar.prepend(this.favEl);this.caseDesc=$('<div>').addClass('tele-panel-description');$.each(data['case']['case_data']['details'],function(i,condition){var cTitle=$('<span>').html(condition.type+':&nbsp;');var cData=$('<span>').html(telepath.formatConditionBrief(false,condition));that.caseDesc.append(cTitle).append(cData).append('<span>&nbsp;|&nbsp;</span>');});$('span:last',that.caseDesc).remove();this.goBack=$('<a>').attr('href','#').addClass('tele-panel-case-close').html('|&nbsp;Back to all cases');this.panelTopBar.append(this.goBack);this.editCase=$('<div>').btn({icon:'caseConfig',text:'Edit Case',callback:function(){telepath.caseOverlay.editCase(that['data']['case']);}});this.panelTopBar.append(this.editCase);var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'},],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});this.panelTopBar.append('<div class="tele-navsep"></div>');this.panelTopBar.append(sortRadios);this.panelTopBar.append(this.caseDesc);this.goBack.click(function(){$('.tele-panel-case').remove();telepath.cases.init();});var chartData=[{label:"random",data:this.data.chart,color:'#5191D1'}];var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'}},yaxis:{alignTicksWithAxis:true,labelWidth:30,ticks:5,color:'#446077',font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"}},selection:{mode:"x"},xaxis:{alignTicksWithAxis:true,tickColor:'#cccccc',tickLength:7,font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"},mode:"time",timezone:"browser",timeformat:"%d/%m"},grid:{borderColor:'#446077',borderWidth:1}};var caseGraph=$('<div>').addClass('tele-case-graph');var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;that.refresh();}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.cases.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});this.container.append(caseGraph);caseGraph.flotGraph({data:chartData,options:options});var graphTitle=$('<div>').addClass('tele-graph-title').html('Case Sessions');caseGraph.prepend(graphTitle).prepend(filterDateRange).prepend('<div class="tele-navsep"></div>').prepend(filterApps);this.panelSubBar=$('<div>').addClass('tele-panel-subtitle');this.container.append(this.panelSubBar);var checkallEl=$('<a>').cb({callback:function(e){$('.tele-panel-cases .tele-list li.tele-listitem').listitem("option","checked",e.options.checked);}});this.panelSubBar.append(checkallEl);this.list=$('<div>').addClass('tele-case-alerts-block');this.listWrap=$('<div>').addClass('tele-wrapper').append(this.list).css({display:'inline-block',float:'left'}).width('65%');this.container.append(this.listWrap);this.list.teleList({data:this.data.items,formatter:function(row){return that.formatter(row);}});this.similarsList=$('<div>').addClass('tele-case-similar-block');this.similarsListWrap=$('<div>').addClass('tele-wrapper').append(this.similarsList).css({display:'inline-block',float:'left'}).width('35%');this.container.append(this.similarsListWrap);if(this.data.similars){this.similarsList.teleList({title:'Related Sessions',data:this.data.similars.items,formatter:function(row){return that.formatter(row);}});}
$(window).resize(function(){that._resize()});},formatter:function(item){var that=this;var result={};result.title=item.title!=''?item.title:item.display_path;result.progbar=true;result.time=item.date;result.timeFormat='h:i A';result.offset=20;result.icon='case';result.count=item.count;result.itemID=item.sid;result.details=[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'city',value:item.city},{key:'user',value:item.user_id},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'user',value:item.user}];result.raw=item;var alert=item.alert_count>0;result.progbarValue=parseInt(item.avg_score);if(alert!==false){result.icon='alert';result.description=alert.name;result.progbarValue=alert.numeric_score;}else{if(item.avg_score>85){result.icon='suspect_red';}}
return result;},_resize:function(){var height=$(window).height();$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-case-graph').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-panel-case .tele-block').height(offset-40);$('.tele-panel-case .tele-block .tele-list').height(offset-70);$('.tele-panel-case .tele-case-alerts-block .tele-list').mCustomScrollbar("update");$('.tele-panel-case .tele-case-similar-block .tele-list').mCustomScrollbar("update");}};telepath.cases={sort:'date',dir:false,data:[],searchString:'',loading:false,init:function(){this.drawUI();this.refresh();},refresh:function(callback){this.container=$('.tele-panel-cases .tele-panel-cases-inner');$('.tele-block, .tele-loader',this.container).remove();this.container.append(telepath.loader);var that=this;telepath.ds.get('/cases/get_cases',{search:this.searchString,sort:this.sort,dir:this.dir},function(data){that.loading=false;var cases=[]
var index=0;for(index=0;index<data.items.length;++index){if(data.items[index].name)
{cases.push(data.items[index]);}}
that.setData(cases);if(typeof(callback)=='function'){callback();}});},setData:function(data){this.container=$('.tele-panel-cases .tele-panel-cases-inner');var that=this;this.data=data;$('.tele-block, .tele-loader',this.container).remove();this.list=$('<div>');this.container.append(this.list);this.list.teleList({data:this.data,formatter:function(item){item.checkable=true;item.favorites=true;item.favorite=item.case_data.favorite=='1';return telepath['case'].rowFormatter(item);},callbacks:telepath.listitem.generic.callbacks_case});this.panelTitle.html(this.data.length+' Cases');setTimeout(function(){that._resize();},0);$(window).resize(function(){that._resize()});},_resize:function(){if($('.tele-panel-cases').children().size()==0)return;var height=$(window).height();$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-panel-cases .tele-block').height(offset-20);$('.tele-panel-cases .tele-block .tele-list').height(offset-50);$('.tele-panel-cases .tele-list').mCustomScrollbar("update");},drawUI:function(){var that=this;$('.tele-panel-cases').empty();var container=$('<div>').addClass('tele-panel-cases-inner');$('.tele-panel-cases').append(container);var panelTopBar=$('<div>').addClass('tele-panel-topbar');var panelSubBar=$('<div>').addClass('tele-panel-subtitle');var panelTitle=$('<div>').addClass('tele-panel-title');var panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');panelTopBar.append(panelTitle).append(panelTopBarRight);this.panelTitle=panelTitle;var addBtn=$('<div>').btn({icon:'plus',text:'New Case',callback:function(){if(telepath.access.admin||telepath.access.perm.Cases_add){telepath.caseOverlay.addCase();}else{telepath.dialog({msg:'Access denied. No permissions to add new Case group.'});};}});this.panelTitle.after(addBtn);container.append(panelTopBar);container.append(panelSubBar);var checkallEl=$('<a>').teleCheckbox({callback:function(e){if(that.list){that.list.data('tele-teleList').toggleAll(e.options.checked);}}});panelSubBar.append(checkallEl);var deleteBtn=$('<div>').btn({icon:'delete',text:'Delete',callback:function(){if(that.list){var selected=that.list.data('tele-teleList').getSelected();if(selected.length==0){telepath.dialog({msg:'No Case selected.'});}else{if(telepath.access.admin||telepath.access.perm.Cases_del){telepath.dialog({type:'dialog',title:'Confirm',msg:'Remove '+selected.length+' case(s)?',callback:function(){telepath.ds.get('/cases/del_cases',{cids:selected},function(data){that.setData(data.items);telepath.ds.get('/cases/flag_requests_by_cases',{case:selected,range:false,method:'delete',repeat:false},function(data){});});}});}else{telepath.dialog({msg:'Access denied. No permissions to delete Cases.'});};}}}});panelSubBar.append(deleteBtn);var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'name',icon:'arrow',tip:'ABC'},{id:'count',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.loading){return}
that.loading=true;if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});var container=$('.tele-panel-cases .tele-panel-topbar-right');var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;telepath.cases.refresh(function(){});}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.cases.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});container.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);}};telepath.alert={grabNames:function(arr){var result='';$.each(arr,function(i,x){result=result+x.key+', ';});if(result.length>0){result=result.substr(0,result.length-2);}
return result;},rowFormatter:function(row,mode){if(row._source){row=row._source}
if(mode=='dashboard'){var identification=(row.user!=''?{key:'user',value:row.user}:{key:'IP',value:row.ip_orig});return{raw:row,itemID:row.sid,icon:'alert',checkable:row.checkable,count:row.alerts_count,progbar:true,progbarValue:row.ip_score,time:row.date,title:telepath.alert.grabNames(row.alerts_names),details:[identification,{key:'country',value:row.country},{key:'host',value:telepath.alert.grabNames(row.host)},]}}else{return{raw:row,itemID:row.sid,icon:'alert',checkable:row.checkable,count:row.alerts_count,progbar:true,progbarValue:row.ip_score,time:row.date,title:telepath.alert.grabNames(row.alerts_names),details:[{key:'IP',value:row.ip_orig},{key:'country',value:row.country},{key:'city',value:row.city},{key:'host',value:telepath.alert.grabNames(row.host)},{key:'actions',value:row.actions_count},{key:'cases',value:row.cases_count},{key:'user',value:row.user}]}};},filters:{H:true,P:true,G:true,J:true,X:true,},getSeverity:function(numeric_score){var result=$('<div>').addClass('tele-severity');if(numeric_score>0&&numeric_score<70){result.addClass('tele-severity-low').text('Low');}
if(numeric_score>=70&&numeric_score<90){result.addClass('tele-severity-medium').text('Medium');}
if(numeric_score>=90&&numeric_score<100){result.addClass('tele-severity-critical').text('Critical');}
result.append('&nbsp;<span>('+numeric_score+')</span>');return result;},lookupAction:function(business_id){for(x in telepath.actionList){if(telepath.actionList[x].id=business_id){return telepath.actionList[x].name;}}
return'Browsing';},lookupRequest:function(RID){for(x in this.data.requests){var req=this.data.requests[x];if(req.RID==RID){return req;}}
return false;},lookupAlert:function(RID){for(x in this.data.alerts){var alert=this.data.alerts[x];if(alert.RID==RID){return alert;}}
return this.data.alerts[0];},data:[],updateSelected:function(){$('.selected',this.actionsContainer).removeClass('selected');var newSelected=$("li:nth-child("+(this.selectedIndex+1)+")",this.actionsContainer);$('.tele-listitem-inner',newSelected).addClass('selected');var dataID=newSelected.listitem('option','dataID');this.expandRequest(dataID);$(this.actionsContainer).mCustomScrollbar("scrollTo","li:nth-child("+(this.selectedIndex+1)+")");},scrollUp:function(){if(this.selectedIndex>0){this.selectedIndex--;}
this.updateSelected();},scrollDown:function(){if(this.selectedIndex<this.data.requests.length){this.selectedIndex++;}
this.updateSelected();},keyDown:function(e){if(e.keyCode=='38'){e.preventDefault();telepath.alert.scrollUp();}
if(e.keyCode=='40'){e.preventDefault();telepath.alert.scrollDown();}},destroy:function(){$(document).unbind('overlay_destroy',telepath.alert.destroy);$(document).unbind('keydown',telepath.alert.keyDown);},initTools:function(){this.archiveAlert=$('<div>').btn({icon:'archive',text:'Archive Alert',callback:function(){}});this.overlay.headerEl.append(this.archiveAlert);this.overlay.headerEl.append('<div class="tele-navsep"></div>');this.moveTo=$('<div>').dropdown({icon:'moveTo',value:'Move To',callback:function(){}});this.overlay.headerEl.append(this.moveTo);this.overlay.headerEl.append('<div class="tele-navsep"></div>');this.editRule=$('<div>').btn({icon:'edit',text:'Edit Rule',callback:function(){}});this.overlay.headerEl.append(this.editRule);},initSingle:function(RID){$(document).unbind('keydown',telepath.alert.keyDown);$(document).bind('keydown',telepath.alert.keyDown);$(document).bind('overlay_destroy',telepath.alert.destroy);telepath.overlay.init('alerts','Loading ...');this.overlay=telepath.overlay;this.initTools();telepath.ds.get('/alerts/get_alert',{RID:RID},function(data){telepath.alert.showAlert(data.items);});},init:function(alertID,index){$(document).unbind('keydown',telepath.alert.keyDown);$(document).bind('keydown',telepath.alert.keyDown);$(document).bind('overlay_destroy',telepath.alert.destroy);telepath.overlay.init('alerts','Loading ...');this.overlay=telepath.overlay;this.loadAlert(alertID);this.pagination=$('<div>').pagination({current:index,count:telepath.alerts.data.alerts.length,name:'Alert',callback:function(itemIndex){var alertID=telepath.alerts.data.alerts[itemIndex].id;telepath.alert.loadAlert(alertID);}});this.overlay.headerEl.append(this.pagination);this.overlay.headerEl.append('<div class="tele-navsep"></div>');this.initTools();},loadAlert:function(alertID){this.alertID=alertID;this.overlay.titleEl.html('Loading alert #'+this.alertID);this.overlay.contentEl.empty().append(telepath.loader);var alertItem=false;for(x in telepath.alerts.data.alerts){if(telepath.alerts.data.alerts[x].id==alertID){alertItem=telepath.alerts.data.alerts[x];break;}}
if(!alertItem){return;}
telepath.ds.get('/alerts/get_alert',{SID:alertItem.SID,epoch:alertItem.date},function(data){telepath.alert.showAlert(data.items);});},formatData:function(item){var that=this;var result={};result.title=item.title!=''?item.title:item.display_path;result.progbar=true;result.time=item.date;result.timeFormat='h:i A';result.offset=20;result.icon='suspect';result.dataID=item.sid;$.each(telepath.alert.data.alerts,function(i,alert){if(alert.RID==item.RID){result.icon='suspect_red';}});result.progbarValue=item.ip_score;result.callback=function(widget,el){$('.selected',that.actionsContainer).removeClass('selected');$('.tele-listitem-inner',widget.element).addClass('selected');that.expandRequest(widget.options.dataID);};return result;},showAlert:function(data){var container=this.overlay.contentEl;container.empty();var that=this;this.selectedIndex=0;telepath.alert.data=data;this.alertLeft=$('<div>').addClass('tele-alert-left');this.alertMid=$('<div>').addClass('tele-alert-mid');this.alertRight=$('<div>').addClass('tele-alert-right');container.append(this.alertLeft).append(this.alertMid).append(this.alertRight);this.overlay.titleEl.html('Alert #'+this.alertID);var reqStats={'All':data.requests.length,'Alerts':data.alerts.length,'Actions':0}
$.each(data.requests,function(i,request){if(request.business_id&&request.business_status&&request.business_status=='2'){reqStats['Actions']++;}});var statsEl=$('<div>').addClass('tele-alert-stats');$.each(reqStats,function(key,stat){var statEl=$('<div>').addClass('tele-alert-stat');var statKey=$('<div>').addClass('tele-alert-stat-key').html(key);var statValue=$('<div>').addClass('tele-alert-stat-value').html(stat);statEl.append(statKey).append(statValue);statsEl.append(statEl);});this.alertLeft.append(statsEl);var durationEl=$('<div>').addClass('tele-alert-duration');var durationStartEl=$('<div>').addClass('tele-alert-duration-start');var durationStartLbl=$('<div>').addClass('tele-alert-duration-lbl').html('Started:');var durationStartVal=$('<div>').addClass('tele-alert-duration-val').html(date_format('d/m/y | h:i A',data.requests[0].date));var durationEndEl=$('<div>').addClass('tele-alert-duration-end');var durationEndLbl=$('<div>').addClass('tele-alert-duration-lbl').html('Ended:');var durationEndVal=$('<div>').addClass('tele-alert-duration-val').html(date_format('d/m/y | h:i A',data.requests[data.requests.length-1].date));durationStartEl.append(durationStartLbl).append(durationStartVal);durationEndEl.append(durationEndLbl).append(durationEndVal);durationEl.append(durationStartEl).append(durationEndEl);this.alertLeft.append(durationEl);this.actionsContainer=$('<div>').addClass('tele-alert-actions');this.alertLeft.append(this.actionsContainer);this.requestDetails=$('<div>').addClass('tele-alert-details').addClass('tele-popup');this.alertMid.prepend(this.requestDetails);this.lastAction=-1;this.printed=0;for(x in data.requests){var req=data.requests[x];if(req.business_id!=this.lastAction){this.actionContainer=$('<div>').addClass('tele-alert-action');this.actionContainerIcon=$('<div>').addClass('tele-alert-action-icon').addClass('tele-icon').addClass('tele-icon-suspect');this.actionContainerTitle=$('<div>').addClass('tele-alert-action-title').text(this.lookupAction(req.business_id));this.newList=$('<ul class="tele-list">');this.actionContainer.append(this.actionContainerIcon).append(this.actionContainerTitle).append(this.newList);$(this.actionsContainer).append(this.actionContainer);this.lastAction=req.business_id;}
var item=this.formatData(req);var newListItem=$('<li>').attr('id','alert-item-'+x);this.newList.append(newListItem);newListItem.listitem(item);this.printed++;}
$(this.actionsContainer).mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:150,callbacks:{onTotalScrollOffset:50,onTotalScroll:function(){return;var newMax=that.printed+9;var offset=0;for(x in data.requests){if(offset<that.printed+1){offset++;continue;}
var req=that.formatData(data.requests[x]);var newListItem=$('<li>').attr('id','alert-item-'+x);$(that.newList).append(newListItem);newListItem.listitem(req);if(that.printed>newMax){break;}
that.printed++;}
that.updateSelected();$(that.actionsContainer).mCustomScrollbar("update");}}});this.updateSelected();},expandRequest:function(RID){var that=this;this.requestDetails.empty();this.requestDetails.append(RID);this.requestDetails.append(telepath.loader);var req=this.lookupRequest(RID);if(req){this.requestInfo=req;}else{return;}
telepath.ds.get('/similarities/',{param_type:'request',param_id:RID},function(data){that.similaritiesList=$('<div>');that.similaritiesList.teleList({title:'Similar Requests',titleCallback:function(){},data:data.items,formatter:function(item){return{icon:'suspect',time:item.date,itemID:item.RID,progbar:true,progbarValue:parseInt(item.ip_score*100),details:[{key:'country',value:item.country},{key:'IP',value:item.IP}]};},callbacks:{click:function(widget){},hover_in:function(el,item){},hover_out:function(el,item){}}}).appendTo(that.requestDetails);});telepath.ds.get('/alerts/get_session_flow_params',{sid:req.SID,rids:RID,epoch:req.date},function(data){that.expandRequestData(data);});},expandRequestData:function(data){$('.loader',this.requestDetails).remove();this.requestData=data.items;this.printParams();},printParams:function(container){var container=this.requestDetails;container.empty();this.printParamsFilters(container);this.printAlertDetails(container);this.printParamsTable(container);this.printAlertInfo(this.alertRight);},printParamsFilters:function(container){var that=this;this.filtersContainer=$('<div>').addClass('tele-alert-filters');container.append(this.filtersContainer);var filters=[{type:'H',label:'Headers'},{type:'G',label:'Get'},{type:'P',label:'Post'},{type:'J',label:'Json'},{type:'X',label:'XML'}];$.each(filters,function(i,filter){var filter_el=$('<div>').teleCheckbox({checked:telepath.alert.filters[filter.type],label:filter.label,inputFirst:true,callback:function(widget){telepath.alert.filters[filter.type]=widget.options.checked;that.printParams();}});that.filtersContainer.append(filter_el);});},printAlertDetails:function(container){this.alertDetails=$('<div>').addClass('tele-alert-details-info');container.append(this.alertDetails);this.alertDetailsTitle=$('<div>').addClass('tele-alert-details-info-title').text(this.lookupAction(this.requestInfo.business_id));this.alertDetailsTimeWrap=$('<div>').addClass('tele-alert-details-info-time-wrap');this.alertDetailsTimeLabel=$('<div>').addClass('tele-alert-details-info-time-label').text('Request time:');this.alertDetailsTime=$('<div>').addClass('tele-alert-details-info-time').text(date_format('d/m/y | H:i:s',this.requestInfo.date));this.alertDetailsTimeWrap.append(this.alertDetailsTimeLabel).append(this.alertDetailsTime);var severityPercent=parseInt(this.requestData.avg_score*100)+'%';this.alertSeverityWrap=$('<div>').addClass('tele-alert-severity-wrap');this.alertSeverityLabel=$('<div>').addClass('tele-alert-severity-label').text('Severity');this.alertSeverityPercent=$('<div>').addClass('tele-alert-severity-percent').text(severityPercent);this.alertSeverityProgBar=$('<div>').addClass('tele-alert-severity-progbar');this.alertSeverityProgValue=$('<div>').addClass('tele-alert-severity-progbar-value').css({width:severityPercent});this.alertSeverityWrap.append(this.alertSeverityLabel).append(this.alertSeverityPercent).append(this.alertSeverityProgBar);this.alertSeverityProgBar.append(this.alertSeverityProgValue);this.alertDetails.append(this.alertSeverityWrap).append(this.alertDetailsTitle).append(this.alertDetailsTimeWrap);},printAlertInfo:function(container){container.empty();var alert=this.lookupAlert(this.requestInfo.RID);this.alertInfo=$('<div>').addClass('tele-alert-info');this.alertInfoTitle=$('<div>').addClass('tele-alert-info-title').text('Alert Info');this.alertInfoLabel=$('<div>').addClass('tele-alert-info-label').text('Description:');this.alertInfoDesc=$('<div>').addClass('tele-alert-info-description').text(alert.description);this.alertInfoTable=$('<div>').addClass('tele-alert-info-table');function getRow(lbl,data){var row=$('<tr>');var td_1=$('<td>').html(lbl).addClass('tele-alert-info-key');var td_2=$('<td>').html(data).addClass('tele-alert-info-value');row.append(td_1).append(td_2);return row;}
var table=this.alertInfoTable;table.append(getRow('Time:',date_format('d/m/y | H:i:s',alert.date)));table.append(getRow('Severity:',this.getSeverity(alert.numeric_score)));table.append(getRow('Applications:',this.requestInfo.app_domain));table.append(getRow('IP:',alert.ip));table.append(getRow('Location:','<span class="flag flag-'+this.requestInfo.country+'"></span>'+'<span class="tele-country">'+telepath.countries.a2n(this.requestInfo.country)+'</span>'));if(alert.user&&alert.user!=''){table.append(getRow('User:',alert.user));}
this.alertInfo.append(this.alertInfoTitle).append(this.alertInfoLabel).append(this.alertInfoDesc).append(this.alertInfoTable);container.append(this.alertInfo);},printParamsTable:function(container){var tableWrap=$('<div>').addClass('tele-alert-params-table-wrap');var table=$('<table>').addClass('tele-alert-params-table');$.each(this.requestData.params,function(i,param){var param_display=telepath.alert.filters[param.att_source];if(param_display){var row=$('<tr>');var param_name=param.att_alias!=''?param.att_alias:param.name;var col_name=$('<td>').addClass('tele-param-name').html(param.att_name);var col_data=$('<td>').addClass('tele-param-data').html(param.data);var col_score=$('<td>').addClass('tele-param-score').html(parseInt(param.attribute_score_normal)+'%');if(parseInt(param.attribute_score_normal)){col_score.addClass('severe');col_data.addClass('severe');}
row.append(col_name).append(col_data).append(col_score);table.append(row);}});container.append(tableWrap);tableWrap.append(table);$(tableWrap).mCustomScrollbar();}};;telepath.alerts={sort:'date',dir:false,data:[],searchString:'',filter:[],allData:true,loading:false,init:function(){var that=this;var container=$('.tele-panel-alerts');container.empty();var panelTopBar=$('<div>').addClass('tele-panel-topbar');var panelSubBar=$('<div>').addClass('tele-panel-subtitle');var panelTitle=$('<div>').addClass('tele-panel-title');var panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');panelTopBar.append(panelTitle).append(panelTopBarRight);panelTitle.html('Loading Alerts');this.panelTitle=panelTitle;container.append(panelTopBar).append(panelSubBar)
var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'},],selected:this.sort,callback:function(e,id){if(that.loading){return}
that.loading=true;if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});var searchAlerts=$('<div>').teleSearch({callback:function(e,txt){telepath.alerts.searchString=txt;}});var resetInput=$('<a>').addClass('icon-delete-input2').attr('id','remove-button').click(function(){$('.tele-panel-alerts .tele-search-input').val('');telepath.alerts.searchString='';telepath.alerts.refresh();});panelSubBar.append(searchAlerts);var container=$('.tele-panel-alerts .tele-panel-topbar-right');container.empty();var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;telepath.alerts.refresh();}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.alerts.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});container.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);var typingTimer;var doneTypingInterval=1000;$('.tele-panel-alerts .tele-search-input').keyup('input',function(){clearTimeout(typingTimer);if($('.tele-panel-alerts .tele-search-input').val()){typingTimer=setTimeout(function(){telepath.alerts.searchString=$('.tele-panel-alerts .tele-search-input').val();that.input();},doneTypingInterval);}});$(".tele-search").on("click",'.icon-delete-input2',function(event){clearTimeout(typingTimer);that.searchString='';$(".tele-panel-alerts .tele-search-input").prop("value",telepath.alerts.searchString);that.input();});if(telepath.alerts.searchString){$('.tele-panel-alerts .tele-search-input').prop("value",telepath.alerts.searchString);that.input();}
else{telepath.alerts.refresh();}},input:function(){var that=this;var icon=$("#search-button");if(telepath.alerts.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.refresh()},refresh:function(callback){var container=$('.tele-panel-alerts');$('.tele-alerts-block, .tele-alert-graphs-block, .tele-loader',container).remove();container.append(telepath.loader);telepath.ds.get('/alerts/index',{sort:this.sort,dir:this.dir,search:this.searchString,filters:this.filter},function(data){telepath.alerts.loading=false;telepath.alerts.setData(data.items);if(callback&&typeof(callback)=='function'){callback();}});},setData:function(data){telepath.alerts.data=data;var that=this;var container=$('.tele-panel-alerts');this.container=container;$('.tele-alerts-block, .tele-alert-graphs-block, .tele-loader',container).remove();if(data.alerts.total==0){this.panelTitle.html('No Data');return;}
this.list=$('<div>').addClass('tele-alerts-block');this.container.append(this.list);this.list.teleList({data:this.data.alerts.items,searchkey:telepath.alerts.searchString,formatter:function(item){return telepath.alert.rowFormatter(item);},callbacks:{scroll:function(offset,callback){telepath.ds.get('/alerts/index',{sort:telepath.alerts.sort,dir:telepath.alerts.dir,search:telepath.alerts.searchString,offset:offset,filters:that.filter},function(data){callback(data);});}}});this.panelTitle.html(data.alerts.count+' Sessions');if(parseInt(data.alerts.count)==0){return;}
var graphsBlock=$('<div class="tele-alert-graphs-block">').css({marginTop:20});$(container).append(graphsBlock);var graphOverTimeContainer=$('<div>').addClass('tele-alert-graph-overtime');var graphOverTimeTitle=$('<h2>').html('Alerts over time');var graphOverTimeCanvas=$('<div>').addClass('tele-alert-graph-overtime-canvas');graphOverTimeContainer.append(graphOverTimeTitle).append(graphOverTimeCanvas);var graphDistributionContainer=$('<div>').addClass('tele-alert-graph-distribution');var graphDistributionTitle=$('<h2>').html('Alert distribution');this.graphDistributionCanvas=$('<div>').addClass('tele-alert-graph-distribution-canvas');var showPercent=$('<div>').attr('id','alert-distribution-showPercent');var graphDistributionLegend=$('<div>').attr('id','alert-distribution-legend');var newToggle=$('<div>').toggleFlip({left_value:'Type',right_value:'Business Action',flip:function(x){if(!x){$("#alert-distribution-showPercent").empty();telepath.alerts.show_alert_distribution();}else{$("#alert-distribution-showPercent").empty();telepath.alerts.show_action_distribution();}}});graphDistributionContainer.append(graphDistributionTitle).append(newToggle).append(showPercent).append(graphDistributionLegend).append(this.graphDistributionCanvas);graphsBlock.append(graphOverTimeContainer).append(graphDistributionContainer);var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#fff'}},yaxis:{ticks:5,color:'#D6D6D6',font:{color:'#cccccc',size:11,weight:"bold"}},selection:{mode:"x"},xaxis:{font:{color:'#cccccc',size:11,weight:"bold"},mode:'time',timezone:"browser",timeformat:"%d/%m/%y"},grid:{borderColor:'#D6D6D6',borderWidth:0,clickable:true,hoverable:true,autoHighlight:true},tooltip:true,tooltipOpts:{content:"date: %x | alerts: %y"}};var chart_data=[{label:"random",data:this.data.time_chart,color:'#FC3D3D'}];graphOverTimeCanvas.flotGraph({data:chart_data,options:options});telepath.alerts.show_alert_distribution();$(graphsBlock).mCustomScrollbar({advanced:{updateOnContentResize:true},scrollButtons:{enable:false},});$(window).unbind('resize',that._resize);$(window).bind('resize',that._resize);$(window).trigger('resize');},show_alert_distribution:function(){var that=this;this.graphDistributionCanvas.empty();var pie_data=this.data.distribution_chart;var dataTotal=0;$.each(pie_data,function(i,row){dataTotal+=parseInt(row.data);});var options={series:{pie:{show:true,radius:0.5,innerRadius:0.4,margin:100,label:{show:false,radius:0.3,formatter:function(lbl,obj){var count=parseInt(obj.data[0][1]);var percent=parseInt(count/dataTotal*100)+'%';var pieTemp=$('<div>');var pieLabel=$('<div>').addClass('tele-pie-label').html(lbl);var piePercent=$('<div>').addClass('tele-pie-percent').html(percent).css('color',obj.color);var pieCount=$('<div>').addClass('tele-pie-count').html(count+' alerts');pieTemp.append(pieLabel).append(piePercent).append(pieCount);return pieTemp.html();}}}},grid:{hoverable:true,clickable:true},legend:{show:true,position:"nw",margin:([50,100]),sorted:"ascending",},};if(window.innerWidth<1200){options.series.pie.margin=[50,0];options.legend.margin=([50,400])}
function pieHover(event,pos,obj)
{if(!obj)
return;percent=parseFloat(obj.series.percent).toFixed(2);$("#alert-distribution-showPercent").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');$('.tele-graph-canvas .flot-overlay').css({"cursor":"pointer"})}
function pieClick(event,pos,obj){if(!obj)
return;if(obj.series.label){that.filter=[];that.filter.push(obj.series.label);if(that.data.distribution_chart.length!=that.filter.length){that.allData=false;}}
that.refresh()}
function legendClick(){$('.legend tr').on('click',function(){if(that.allData){that.filter=[];$.each(that.data.distribution_chart,function(i,val){that.filter.push(val.label);})}
var item=$(this).children('.legendLabel').text();if(($.inArray(item,that.filter)!=-1)){that.filter.splice($.inArray(item,that.filter),1);that.allData=false;}else{that.filter.push(item);that.filter=$.grep(that.filter,function(n,i){var item=$.grep(that.data.distribution_chart,function(item){return item.label==n;});return item.length>0;});if(that.data.distribution_chart.length==that.filter.length){that.allData=true;}}
that.refresh()});}
function set_legend(){$('.legend tr').css({"cursor":"pointer"});if(that.filter.length>0&&that.allData==false){$.each($('.legend tr'),function(i,val){if($.inArray(val.children[1].innerText,that.filter)==-1){$(this).children(".legendColorBox").children().html('<div style="width:4px;height:0;border:5px solid #999;overflow:hidden; "></div>');$(this).css({"opacity":"0.5"});}})}}
setTimeout(function(){telepath.alerts.graphDistributionCanvas.flotGraph({data:pie_data,options:options});$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plothover',pieHover);$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plotclick',pieClick);legendClick();set_legend();this._resize();},100);},show_action_distribution:function(){this.graphDistributionCanvas.empty();var pie_data=this.data.action_distribution_chart;var dataTotal=0;$.each(pie_data,function(i,row){dataTotal+=parseInt(row.data);});var options={series:{pie:{show:true,radius:0.5,innerRadius:0.4,margin:100,label:{show:false,radius:0.3,formatter:function(lbl,obj){var count=parseInt(obj.data[0][1]);var percent=parseInt(count/dataTotal*100)+'%';var pieTemp=$('<div>');var pieLabel=$('<div>').addClass('tele-pie-label').html(lbl);var piePercent=$('<div>').addClass('tele-pie-percent').html(percent).css('color',obj.color);var pieCount=$('<div>').addClass('tele-pie-count').html(count+' alerts');pieTemp.append(pieLabel).append(piePercent).append(pieCount);return pieTemp.html();}}}},grid:{hoverable:true,clickable:true},legend:{show:true,position:"nw",margin:([50,100]),sorted:"ascending",},};if(window.innerWidth<1200){options.series.pie.margin=[50,0];options.legend.margin=([50,400])}
function pieHover(event,pos,obj)
{if(!obj)
return;percent=parseFloat(obj.series.percent).toFixed(2);$("#alert-distribution-showPercent").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');$('.tele-graph-canvas .flot-overlay').css({"cursor":"pointer"})}
function pieClick(event,pos,obj){if(!obj)
return;if(obj.series.label){that.filter=[];that.filter.push(obj.series.label)}
that.refresh()}
function legendClick(){$('.legend tr').on('click',function(){var item=$(this).children('.legendLabel').text();if(($.inArray(item,that.filter)!=-1)){that.filter.splice($.inArray(item,that.filter),1);}else{that.filter.push(item)}
that.refresh()});}
function set_legend(){$('.legend tr').css({"cursor":"pointer"});if(that.filter.length>0){$.each($('.legend tr'),function(i,val){if($.inArray(val.children[1].innerText,that.filter)==-1){$(this).children(".legendColorBox").children().html('<div style="width:4px;height:0;border:5px solid #999;overflow:hidden; "></div>');$(this).css({"opacity":"0.5"});}})}
else{$.each(that.data.distribution_chart,function(i,val){that.filter.push(val.label);})}}
setTimeout(function(){telepath.alerts.graphDistributionCanvas.flotGraph({data:pie_data,options:options});$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plothover',pieHover);$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plotclick',pieClick);legendClick();set_legend();this._resize();},100);},_resize:function(){var that=this;if($('.tele-panel-alerts').children().size()==0)return;var height=$(window).height();var width=$(window).width()-10;$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();var magic=500;if(width<1200){if(width<1024){magic=300;}else{magic=400;}}else{magic=600;}
$('.tele-panel-alerts .tele-alert-graphs-block',this.list).width(magic);$('.tele-panel-alerts .tele-block').width(width-magic-15);$('.tele-panel-alerts .tele-block .tele-list').width(width-magic-25).height(offset-50).mCustomScrollbar("update");$('.tele-panel-alerts .tele-alert-graphs-block').height(offset-50).mCustomScrollbar("update");if(window.innerWidth<1200){this.graph=$('.tele-alert-graph-distribution-canvas.tele-graph');this.legendHeight=$('.legend table').height();this.pieGraphHeight=$('.tele-alert-graph-distribution-canvas.tele-graph .tele-graph-canvas-outer').height();this.graph.height(that.pieGraphHeight+that.legendHeight-50);}}};telepath.suspects={sort:'date',dir:false,data:[],total:0,searchString:'',loading:false,rowFormatter:function(item,mode){if(mode=='dashboard'){var identification=(item.user!=''?{key:'user',value:item.user}:{key:'IP',value:item.ip_orig});result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'host',value:grabNames(item.host)},identification]}}
else{result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'city',value:item.city},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'actions',value:item.actions_count},{key:'cases',value:item.cases_count},{key:'user',value:item.user}]}}
return result;},init:function(){var that=this;this.container=$('.tele-panel-suspects');this.container.empty();this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html('Loading Suspects');this.container.append(this.panelTopBar);this.panelSubBar=$('<div>').addClass('tele-panel-subtitle');this.panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');this.panelTopBar.append(this.panelTopBarRight);this.container.append(this.panelSubBar);var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.suspects.refresh(function(){});}});var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.loading){return}
that.loading=true;if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});this.panelTopBarRight.append(sortRadios).append('<div class="tele-navsep"></div>');var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.suspects.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});this.panelTopBarRight.append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);var searchSuspects=$('<div>').teleSearch({callback:function(e,txt){telepath.suspects.searchString=txt;}});var resetInput=$('<a>').addClass('icon-delete-input2').attr('id','remove-button').click(function(){$('.tele-panel-suspects .tele-search-input').val('');telepath.suspects.searchString='';telepath.suspects.refresh();});this.panelSubBar.append(searchSuspects);this.refresh();var typingTimer;var doneTypingInterval=1000;$(".tele-panel-suspects .tele-search-input").keyup('input',function(){clearTimeout(typingTimer);if($('.tele-panel-suspects .tele-search-input').val()){typingTimer=setTimeout(function(){that.searchString=$('.tele-panel-suspects .tele-search-input').val();that.input();},doneTypingInterval);}});$("#search-button").on("click",function(event){that.searchString='';$(".tele-panel-suspects .tele-search-input").prop("value",that.searchString);that.input();});if(that.searchString)
{$('.tele-panel-suspects .tele-search-input').prop("value",that.searchString);that.input();}},input:function(){var that=this;var icon=$("#search-button");if(that.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.refresh()},refresh:function(callback){$('.tele-block, .tele-loader',this.container).remove();this.container.append(telepath.loader);var that=this;telepath.ds.get('/suspects/index',{sort:this.sort,dir:this.dir,search:this.searchString},function(data){that.loading=false
that.count=data.count;that.data=data.items;telepath.suspects.loadData();if(typeof(callback)=='function'){callback();}});},_resize:function(){if($('.tele-panel-suspects').children().size()==0)return;var height=$(window).height();$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-panel-suspects .tele-block').height(offset-20);$('.tele-panel-suspects .tele-block .tele-list').height(offset-50);$('.tele-list').mCustomScrollbar("update");},loadData:function(){var that=this;$('.tele-block, .tele-loader',this.container).remove();this.suspectsList=$('<div>');this.container.append(this.suspectsList);this.suspectsList.teleList({context:"panel",data:this.data,searchkey:telepath.suspects.searchString,formatter:function(item){return telepath.suspects.rowFormatter(item);},callbacks:{scroll:function(offset,callback){telepath.ds.get('/suspects/index',{sort:telepath.suspects.sort,dir:telepath.suspects.dir,search:telepath.suspects.searchString,offset:offset,},function(data){callback(data);});}}});this.panelTitle.html(this.count+' Sessions');setTimeout(function(){that._resize();},0);$(window).resize(function(){that._resize()});}};telepath.reports={init:function(){this.container=$('.tele-panel-reports');this.container.append('<h1 style="padding: 50px; font-size: 24px; font-weight: bold;">Under Construction</h1>');}}