$(document).ready(function(){telepath.main.init();$(document).click(function(e){$('.tele-popup').each(function(){if($(this).hasClass('hook')){if($(e.target).parents('.tele-popup').size()==0&&$(e.target).parents('body').size()>0){$('.tele-popup').remove();}}else{$(this).addClass('hook');}});});});telepath.loader='<img class="loader" src="img/loader.gif">';telepath.data={};telepath.appFilter=[{key:-1,label:'All Applications'}];telepath.main={init:function(){telepath.ds.get('/parameters/get_global_headers',{},function(data){telepath.global_headers=data.items;});telepath.ds.get('/rules/get_cmds',{},function(data){telepath.rule_cmds=data.items;});telepath.ds.get('/telepath/get_app_filter',{},function(data){telepath.app_filter=data.items;});telepath.ds.get('/telepath/get_time_range',{},function(data){telepath.range=data.items;$.getJSON(telepath.controllerPath+'/telepath/templates',function(data){telepath.templates=data;telepath.ui.init();telepath.header.init();telepath.dashboard.init();$('.tele-nav-dashboard a').addClass('active');if(location.hash){var params=location.hash.split("/");var alerts=[];alerts["key"]=decodeURIComponent(params[2]);telepath.sessionflow.init(params[0].substr(1),params[1],alerts,"alert","");}});});telepath.ds.get('/telepath/get_first_data_time',{},function(data){telepath.fullRangeStart=data.items;});}};telepath.ui={init:function(){$(window).resize(function(){telepath.ui.resize();});$(window).click(function(e){if($('.popover').size()>0){if($(e.target).parents('.popover').size()>0||$(e.target).hasClass('popover')){}else{$('.popover').remove();}}});var that=this;this.mainEl=$('<div>').addClass('tele-body');this.headerEl=$('<div>').addClass('tele-header');this.contentEl=$('<div>').addClass('tele-content');this.mainEl.append(this.headerEl).append(this.contentEl);$('body').append(this.mainEl);this.panels=['dashboard','cases','alerts','suspects','reports','config','search'];$.each(this.panels,function(i,panel){var panelEl=$('<div>').addClass('tele-panel').addClass('tele-panel-'+panel);that.contentEl.append(panelEl);});$('.tele-panel-dashboard').addClass('active');$(window).resize(function(){telepath.ui.resize();});telepath.ui.resize();},resize:function(){var active=$('.tele-panel.active');$.each(this.panels,function(i,x){if($(active).hasClass('tele-panel-'+x)){active=x;return false;}});$('.tele-body').height($(window).height());if(active=='dashboard'){$('.tele-content').css({height:'890px'});$('body').css({overflow:'scroll-x'});}else{$('.tele-content').css({height:$(window).height()-$('.tele-header').height()-50});}}};telepath.header={getSearchOpts:function(){},init:function(){var that=this;this.logo='<div class="tele-logo"><img src="img/logo.png" alt="Hybrid Security Telepath" /></div>';this.nav=$('<ul>').addClass('tele-nav');this.navItems=[{id:'dashboard',label:'Dashboard'},{id:'cases',label:'Cases'},{id:'alerts',label:'Alerts'},{id:'suspects',label:'Suspects'}];$.each(this.navItems,function(i,item){if(telepath.access.admin||telepath.access.perm[item.label+'_get']){var itemEl=$('<li>').addClass('tele-nav-'+item.id).append($('<a>').attr('href','#').append('<span class="tele-nav-icon">').append(item.label));};$(that.nav).append(itemEl);});this.headerRight=$('<div>').addClass('tele-header-right');this.search=$('<div>').addClass('tele-search-top');this.searchInput=$('<input>').addClass('tele-search-input');this.searchIcon=$('<a href="#">').addClass('tele-search-icon').html('Search');this.searchDD=$('<a href="#">').addClass('tele-search-dropdown').html('');this.search.append(this.searchInput).append(this.searchIcon).append(this.searchDD);this.headerRight.append(this.search);$(this.searchIcon).click(function(e){if(telepath.search.loading){return;}
telepath.search.loading=true;telepath.search.init(telepath.header.searchInput.val());telepath.ui.resize();});$(this.searchInput).keydown(function(e){if(e.keyCode==13){telepath.search.init(telepath.header.searchInput.val());telepath.ui.resize();}});$(this.searchInput).autocomplete({source:function(request,response){telepath.ds.get('/search/getAutoComplete',{search:telepath.header.searchInput.val()},function(data){if(data.items){response(data.items);}});},select:function(event,ui){if(event.keyCode==13){return}
telepath.search.init(ui.item.value);telepath.ui.resize();},open:function(event,ui){$(this).autocomplete("widget").css({"width":$('.tele-search-top').width()});},}).focus(function(){$(this).autocomplete('search',telepath.header.searchInput.val());});$.ui.autocomplete.prototype._renderItem=function(ul,item){item.label=item.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+$.ui.autocomplete.escapeRegex(telepath.header.searchInput.val())
+")(?![^<>]*>)(?![^&;]+;)","gi"),"<span style='font-weight: normal'>$1</span>");return $("<li></li>").data("item.autocomplete",item).append("<a class='text-autocomplete' style='font-weight: bold;  font-family: "+"Roboto Condensed Regular;"+"'>"+item.label+"</a>").appendTo(ul);};this.searchDD.click(function(){if($('.tele-search-filters').size()>0){$('.tele-search-filters').remove();return;}
that.searchWrap=$('<div>').addClass('tele-search-filters').addClass('tele-popup');var title=$('<div>').addClass('tele-title-1').html('What to search');that.searchWrap.append(title);that.headerRight.append(that.searchWrap);telepath.search.printTypes(that.searchWrap);});$('.tele-header').append(this.logo).append(this.nav).append(this.headerRight);telepath.header.bindHooks();$(window).resize(function(){telepath.header.resize();});telepath.header.resize();this.configDiv=$('<div>').addClass('tele-config');this.configCmd=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-config');this.configDiv.append(this.configCmd);this.configCmd.click(function(){$('.tele-panel').empty().hide();$("#file-upload").hide();$('.tele-nav a.active').removeClass('active');var id='config';telepath[id].init();$('.tele-panel-'+id).show();$(this).addClass('active');telepath.config.actions.checkNotFinishedRecord();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});this.logoutCmd=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-logout').click(function(){telepath.ds.get('/auth/logout',{},function(data){location.reload(true);},'Error logging out.');}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$('.tele-header-right').append(this.configDiv).append(this.logoutCmd);},bindHooks:function(){$('.tele-nav a').click(function(){var id=$(this).parent().attr('class').split('-');if(id[0]=='tele'&&id[1]=='nav'&&id[2]!=''){id=id[2];}else{return false;}
if(id=='dashboard'&&telepath.dashboard.loading){return;}
if(telepath[id].loading){return;}
telepath[id].loading=true;$('.tele-panel').empty().hide().removeClass('active');$("#file-upload").hide();$('.tele-panel-'+id).show().addClass('active');telepath.ui.resize();telepath[id].init();telepath.header.configCmd.removeClass('active');$('.tele-nav a.active').removeClass('active');$(this).addClass('active');setTimeout(function(){$('.tele-popup, .popover').remove();},100);telepath.config.actions.checkNotFinishedRecord();});},resize:function(){var width=$(window).width();$('.tele-logo').css({width:200,overflow:'hidden'});if(width<1300){$(this.searchInput).css({width:100});if(width<1200){if(width<1000){$('.tele-logo').css({width:65,overflow:'hidden'});$('.tele-nav li').css({margin:'0px 0px'});}else{$('.tele-nav li').css({margin:'0px 10px'});}
$('.tele-logo').css({width:65});}else{$('.tele-nav li').css({margin:'0px 25px'});}}else{$(this.search).css({input:'{padding: 5px 75px 5px 20px}'});$(this.searchInput).css({width:140});$('.tele-nav li').css({margin:'0px 25px'});}
var navMargin=(width-$('.tele-header-right').width()-$('.tele-logo').width()-$('.tele-nav').width())/2;$('.tele-nav').css('marginLeft',navMargin);if(width<801){$('.tele-nav').css('marginLeft',20);$('.tele-panel-subtitle').css('height','100px !important');$('.tele-panel-title').css('position','absolute');}}};function RangeRemove(that){numRanges=$(that).parent().parent().children('.tele-ip-wrap').length;if(numRanges>1)
{$(that).parent().remove();}}
function old_getRangeUI(data){if(!data){data='';}else{data=data.trim()}
var is_range=data.split('-').length>1;var ipWrap=$('<div>').addClass('tele-ip-wrap');var ipStart=$('<div>').addClass('tele-ip').ip({data:data.split('-')[0]});var ipDash=$('<div>').addClass('tele-ip-dash').html('_');var ipEnd=$('<div>').addClass('tele-ip').ip({data:is_range?data.split('-')[1]:''});if(!is_range){ipDash.hide();ipEnd.hide();}
var ipRemove=$('<div>').addClass('tele-ip-remove').addClass('tele-icon').addClass('tele-icon-minus').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){$(this).parent().remove();});var ipToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){ipEnd.toggle();ipDash.toggle();},flipped:is_range,});ipWrap.append(ipRemove).append(ipToggle).append(ipStart).append(ipDash).append(ipEnd);return ipWrap;}
function getRangeUI(data){if(!data){data='';}
var ipWrap=$('<div>').addClass('tele-ip-wrap');if(data=='last'){var ipAdd=$('<div>').addClass('tele-ip-add').addClass('tele-icon').addClass('tele-icon-plus').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){$(event.target).parent().before(getRangeUI());});ipWrap.append(ipAdd);}
else{var is_range=data.from!=data.to;var ipStart=$('<div>').addClass('tele-ip').ip({data:data.from});var ipDash=$('<div>').addClass('tele-ip-dash').html('_');var ipEnd=$('<div>').addClass('tele-ip').ip({data:!is_range?'':data.to});if(!is_range){ipDash.hide();ipEnd.hide();}
var ipRemove=$('<div>').addClass('tele-ip-remove').addClass('tele-icon').addClass('tele-icon-minus').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){RangeRemove(this);});var ipToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){ipEnd.toggle();ipDash.toggle();},flipped:is_range});ipWrap.append(ipRemove).append(ipToggle).append(ipStart).append(ipDash).append(ipEnd);}
return ipWrap;}
function getStatusCodeRangeUI(data){if(!data){data='';}else{data=data.trim()}
var is_range=data.split('-').length>1;var scWrap=$('<div>').addClass('tele-sc-wrap');var scStart=$('<div>').teleInput({value:data.split('-')[0],type:'number',range:{min:100,max:600},step:100,margintop:1}).addClass('tele-sc');var scDash=$('<div>').addClass('tele-sc-dash').html('_');var scEnd=$('<div>').teleInput({value:!is_range?'':data.split('-')[1],type:'number',range:{min:100,max:600},step:100,margintop:1}).addClass('tele-sc');if(!is_range){scDash.hide();scEnd.hide();}
var scToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){scEnd.toggle();scDash.toggle();},flipped:is_range});scWrap.append(scToggle).append(scStart).append(scDash).append(scEnd);return scWrap;}
function findAndRemove(array,property,value){$.each(array,function(index,result){if(result&&result[property]&&result[property]==value){array.splice(index,1);}});}
function grabNames(arr){var result='';$.each(arr,function(i,x){result=result+x.key+', ';});if(result.length>0){result=result.substr(0,result.length-2);}
return result;}
function ip2long(IP){var i=0;IP=IP.match(/^([1-9]\d*|0[0-7]*|0x[\da-f]+)(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?$/i);if(!IP){return false;}
IP[0]=0;for(i=1;i<5;i+=1){IP[0]+=!!((IP[i]||'').length);IP[i]=parseInt(IP[i])||0;}
IP.push(256,256,256,256);IP[4+IP[0]]*=Math.pow(256,4-IP[0]);if(IP[1]>=IP[5]||IP[2]>=IP[6]||IP[3]>=IP[7]||IP[4]>=IP[8]){return false;}
return IP[1]*(IP[0]===1||16777216)+IP[2]*(IP[0]<=2||65536)+IP[3]*(IP[0]<=3||256)+IP[4]*1;}
function date_format(format,timestamp){var that=this;var jsdate,f;var txt_words=['Sun','Mon','Tues','Wednes','Thurs','Fri','Satur','January','February','March','April','May','June','July','August','September','October','November','December'];var formatChr=/\\?(.?)/gi;var formatChrCb=function(t,s){return f[t]?f[t]():s;};var _pad=function(n,c){n=String(n);while(n.length<c){n='0'+n;}
return n;};f={d:function(){return _pad(f.j(),2);},D:function(){return f.l().slice(0,3);},j:function(){return jsdate.getDate();},l:function(){return txt_words[f.w()]+'day';},N:function(){return f.w()||7;},S:function(){var j=f.j();var i=j%10;if(i<=3&&parseInt((j%100)/10,10)==1){i=0;}
return['st','nd','rd'][i-1]||'th';},w:function(){return jsdate.getDay();},z:function(){var a=new Date(f.Y(),f.n()-1,f.j());var b=new Date(f.Y(),0,1);return Math.round((a-b)/864e5);},W:function(){var a=new Date(f.Y(),f.n()-1,f.j()-f.N()+3);var b=new Date(a.getFullYear(),0,4);return _pad(1+Math.round((a-b)/864e5/7),2);},F:function(){return txt_words[6+f.n()];},m:function(){return _pad(f.n(),2);},M:function(){return f.F().slice(0,3);},n:function(){return jsdate.getMonth()+1;},t:function(){return(new Date(f.Y(),f.n(),0)).getDate();},L:function(){var j=f.Y();return j%4===0&j%100!==0|j%400===0;},o:function(){var n=f.n();var W=f.W();var Y=f.Y();return Y+(n===12&&W<9?1:n===1&&W>9?-1:0);},Y:function(){return jsdate.getFullYear();},y:function(){return f.Y().toString().slice(-2);},a:function(){return jsdate.getHours()>11?'pm':'am';},A:function(){return f.a().toUpperCase();},B:function(){var H=jsdate.getUTCHours()*36e2;var i=jsdate.getUTCMinutes()*60;var s=jsdate.getUTCSeconds();return _pad(Math.floor((H+i+s+36e2)/86.4)%1e3,3);},g:function(){return f.G()%12||12;},G:function(){return jsdate.getHours();},h:function(){return _pad(f.g(),2);},H:function(){return _pad(f.G(),2);},i:function(){return _pad(jsdate.getMinutes(),2);},s:function(){return _pad(jsdate.getSeconds(),2);},u:function(){return _pad(jsdate.getMilliseconds()*1000,6);},e:function(){throw'Not supported (see source code of date() for timezone on how to add support)';},I:function(){var a=new Date(f.Y(),0);var c=Date.UTC(f.Y(),0);var b=new Date(f.Y(),6);var d=Date.UTC(f.Y(),6);return((a-c)!==(b-d))?1:0;},O:function(){var tzo=jsdate.getTimezoneOffset();var a=Math.abs(tzo);return(tzo>0?'-':'+')+_pad(Math.floor(a/60)*100+a%60,4);},P:function(){var O=f.O();return(O.substr(0,3)+':'+O.substr(3,2));},T:function(){return'UTC';},Z:function(){return-jsdate.getTimezoneOffset()*60;},c:function(){return'Y-m-d\\TH:i:sP'.replace(formatChr,formatChrCb);},r:function(){return'D, d M Y H:i:s O'.replace(formatChr,formatChrCb);},U:function(){return jsdate/1000|0;}};this.date=function(format,timestamp){that=this;jsdate=(timestamp===undefined?new Date():(timestamp instanceof Date)?new Date(timestamp):new Date(timestamp*1000));return format.replace(formatChr,formatChrCb);};return this.date(format,timestamp);}
function escapeHtml(str){var div=document.createElement('div');div.appendChild(document.createTextNode(str));return div.innerHTML;}
function unescapeHtml(escapedStr){var div=document.createElement('div');div.innerHTML=escapedStr;var child=div.childNodes[0];return child?child.nodeValue:'';}
function eliminateDuplicates(arr){var i,len=arr.length,out=[],obj={};for(i=0;i<len;i++){obj[arr[i]]=0;}
for(i in obj){out.push(i);}
return out;};telepath.ds={get:function(resource,params,success,error,flag){var dataType='json';var method='POST';$.ajax({type:method,url:telepath.controllerPath+resource,data:params,flag:flag,success:function(data){if(data.logout){window.location.reload(true);return;}
if(data.debug||data.queries){}
if(data.eval){eval(data.eval);}
if(data.console){console.log(data.console);}
if(data.success){if(typeof success=='function'){success(data,this.flag);}}
else{if(typeof error=='function'){error(data);}
if(typeof error=='string'){console.log(error);}}},error:function(xhr,textStatus,e){if(typeof error=='function'){error(textStatus);}
if(typeof error=='string'){console.log(error);}},dataType:dataType});}}
telepath.dsync={get:function(resource,params,success,error){var dataType='json';var method='POST';$.ajax({type:method,url:telepath.controllerPath+resource,data:params,async:false,success:function(data){if(data.logout){window.location.reload(true);return;}
if(data.debug||data.queries){}
if(data.eval){eval(data.eval);}
if(data.console){console.log(data.console);}
if(data.success){if(typeof success=='function'){success(data);}}
else{if(typeof error=='function'){error(data);}
if(typeof error=='string'){console.log(error);}}},error:function(xhr,textStatus,e){if(typeof error=='function'){error(textStatus);}
if(typeof error=='string'){console.log(error);}},dataType:dataType});}};$.widget("tele.infoblock",{options:{'icon':'person','title':'Andy Keren','subtitle':'Developer @ HybridSec','avatar':'img/avatar.png','score':95,'social':{'facebook':'https://www.facebook.com/andy.keren','twitter':'https://twitter.com/NASA_Johnson/','linkedin':'www.linkedin.com/groups/Web-Fraud-Prevention-4066554'},'details':{'Last Seen':'Now and again','Phone':'555-555-555','Email':'ndkeren@gmail.com','Address':'Somewhere 555 st, Let-Viva, Israel'}},_create:function(){this.element.addClass("tele-infoblock");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();var smallTitle=$('<div>').addClass('tele-infoblock-smalltitle').html('Client Details');var imageWrap=$('<div>').addClass('tele-infoblock-imagewrap');var scoreEl=$('<div>').addClass('tele-infoblock-score');var imageEl=$('<img>').addClass('tele-infoblock-image').attr('src',this.options.avatar);var blockTitle=$('<div>').addClass('tele-infoblock-title').html(this.options.title);var subTitle=$('<div>').addClass('tele-infoblock-subtitle').html(this.options.subtitle);var socialList=$('<ul>').addClass('tele-infoblock-social');var detailsTable=$('<table>').addClass('tele-infoblock-details');imageWrap.append(scoreEl).append(imageEl);$.each(this.options.social,function(network,link){var socialLi=$('<li>');var socialLink=$('<a>').attr('href',link).addClass('tele-icon').addClass('tele-icon-'+network);socialLi.append(socialLink);socialList.append(socialLi);});$.each(this.options.details,function(key,value){var detailsTr=$('<tr>');var detailKey=$('<td>').html(key+':');var detailValue=$('<td>').html('<b>'+value+'</b>');detailsTr.append(detailKey).append(detailValue);detailsTable.append(detailsTr);});this.element.append(smallTitle).append(imageWrap).append(blockTitle).append(subTitle).append(socialList).append(detailsTable);}});;$.widget("tele.popup",{options:{bindTo:false},_create:function(){this.element.addClass("tele-popup");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(!this.options.bindTo){return;}
this.element.empty();var bind=this.options.bindTo;var top=bind.offset().top;var left=$(window).width()-this.element.width()-100;this.element.css({top:top,left:left});},});;telepath.countries={a2n:function(alias){return typeof this.map[alias]!=='undefined'?this.map[alias]:'Unknown';},n2a:function(name){for(x in this.map){if(this.map[x].toLowerCase()==name.toLowerCase()){return x;}}
return'00';},map:{"AP":"Asia/Pacific ","AF":"Afghanistan","AL":"Albania","DZ":"Algeria","AS":"American Samoa","AD":"Andorra","AO":"Angola","A1":"Anonymous Proxy","AR":"Argentina","AM":"Armenia","AW":"Aruba","AU":"Australia","AT":"Austria","AZ":"Azerbaijan","BS":"Bahamas","BH":"Bahrain","BD":"Bangladesh","BB":"Barbados","BY":"Belarus","BE":"Belgium","BJ":"Benin","BM":"Bermuda","BT":"Bhutan","BO":"Bolivia","BA":"Bosnia/Herzegovina","BW":"Botswana","BV":"Bouvet Island","BR":"Brazil","IO":"Indian Ocean","BN":"Brunei Darussalam","BG":"Bulgaria","BF":"Burkina Faso","BI":"Burundi","KH":"Cambodia","CM":"Cameroon","CA":"Canada","CV":"Cape Verde","KY":"Cayman Islands","CF":"Central African Rep.","TD":"Chad","CL":"Chile","CN":"China","CO":"Colombia","KM":"Comoros","CD":"Congo","CG":"Congo","CK":"Cook Islands","CR":"Costa Rica","CI":"Cote D'Ivoire","HR":"Croatia","CU":"Cuba","CW":"Curacao","CY":"Cyprus","CZ":"Czech Republic","DK":"Denmark","DJ":"Djibouti","DM":"Dominica","DO":"Dominican Republic","EC":"Ecuador","EG":"Egypt","SV":"El Salvador","GQ":"Equatorial Guinea","ER":"Eritrea","EE":"Estonia","ET":"Ethiopia","EU":"Europe","FK":"Falkland Islands","FO":"Faroe Islands","FJ":"Fiji","FI":"Finland","FR":"France","GF":"French Guiana","PF":"French Polynesia","GA":"Gabon","GM":"Gambia","GE":"Georgia","DE":"Germany","GH":"Ghana","GI":"Gibraltar","GR":"Greece","GL":"Greenland","GD":"Grenada","GP":"Guadeloupe","GU":"Guam","GT":"Guatemala","GG":"Guernsey","GW":"Guinea-Bissau","GN":"Guinea","GY":"Guyana","HT":"Haiti","VA":"Holy See","HN":"Honduras","HK":"Hong Kong","HU":"Hungary","IS":"Iceland","IN":"India","ID":"Indonesia","IR":"Iran","IQ":"Iraq","IE":"Ireland","IM":"Isle of Man","IL":"Israel","IT":"Italy","JM":"Jamaica","JP":"Japan","JO":"Jordan","KZ":"Kazakhstan","KE":"Kenya","KI":"Kiribati","KP":"Korea","KR":"Republic of Korea","KW":"Kuwait","KG":"Kyrgyzstan","LA":"Lao","LV":"Latvia","LB":"Lebanon","LS":"Lesotho","LR":"Liberia","LY":"Libya","LI":"Liechtenstein","LT":"Lithuania","LU":"Luxembourg","MO":"Macau","MK":"Macedonia","MG":"Madagascar","MW":"Malawi","MY":"Malaysia","MV":"Maldives","ML":"Mali","MT":"Malta","MH":"Marshall Islands","MQ":"Martinique","MR":"Mauritania","MU":"Mauritius","YT":"Mayotte","MX":"Mexico","FM":"Micronesia","MD":"Moldova, Republic of","MC":"Monaco","MN":"Mongolia","ME":"Montenegro","MA":"Morocco","MZ":"Mozambique","MM":"Myanmar","NA":"Namibia","NR":"Nauru","NP":"Nepal","NL":"Netherlands","NC":"New Caledonia","NZ":"New Zealand","NI":"Nicaragua","NE":"Niger","NG":"Nigeria","NU":"Niue","MP":"Mariana Islands","NO":"Norway","KP":"North Korea","OM":"Oman","O1":"Other","PK":"Pakistan","PW":"Palau","PS":"Palestine","PA":"Panama","PG":"Papua New Guinea","PY":"Paraguay","PE":"Peru","PH":"Philippines","PN":"Pitcairn Islands","PL":"Poland","PT":"Portugal","PR":"Puerto Rico","QA":"Qatar","RE":"Reunion","RO":"Romania","RU":"Russia","RW":"Rwanda","BL":"Saint Barthelemy","SH":"Saint Helena","KN":"Saint Kitts","LC":"Saint Lucia","MF":"Saint Martin","PM":"Saint Pierre","VC":"Saint Vincent","WS":"Samoa","SM":"San Marino","ST":"Sao Tome","A2":"Satellite Provider","SA":"Saudi Arabia","SN":"Senegal","RS":"Serbia","SC":"Seychelles","SL":"Sierra Leone","SG":"Singapore","SX":"Saint Maarten","SK":"Slovakia","SI":"Slovenia","SB":"Solomon Islands","SO":"Somalia","ZA":"South Africa","GS":"South Georgia","KR":"South Korea","ES":"Spain","LK":"Sri Lanka","SD":"Sudan","SR":"Suriname","SZ":"Swaziland","SE":"Sweden","CH":"Switzerland","SY":"Syria","TW":"Taiwan","TJ":"Tajikistan","TZ":"Tanzania","TH":"Thailand","TL":"Timor-Leste","TG":"Togo","TK":"Tokelau","TO":"Tonga","TT":"Trinidad and Tobago","TN":"Tunisia","TR":"Turkey","TM":"Turkmenistan","TC":"Caicos Islands","TV":"Tuvalu","UG":"Uganda","UA":"Ukraine","AE":"United Arab Emirates","GB":"United Kingdom","US":"United States","UY":"Uruguay","UZ":"Uzbekistan","VU":"Vanuatu","VE":"Venezuela","VN":"Vietnam","YE":"Yemen","ZM":"Zambia","ZW":"Zimbabwe","00":"Unknown"}};;$.widget("tele.teleDropdown",{options:{'title':'Select','options':[],'selected':0,'updatesTitle':false,'icon':false,'callback':function(){},'height':150,'width':100},_create:function(){this.element.addClass("tele-dropdown");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.icon){this.dropdownIcon=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-'+this.options.icon);this.dropdownIcon.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.element.append(this.dropdownIcon);}
this.dropdownValue=$('<a>').attr('href','#').addClass('tele-dropdown-value').html(this.options.value);this.dropdownArrow=$('<a>').attr('href','#').addClass('tele-dropdown-arrow').html('&nbsp;');this.element.append(this.dropdownValue).append(this.dropdownArrow);this.dropdownValue.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.dropdownArrow.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});},hoverIn:function(){if(this.dropdownIcon){this.dropdownIcon.addClass('hover');}
this.dropdownValue.addClass('hover');this.dropdownArrow.addClass('hover');},hoverOut:function(){if(this.dropdownIcon){this.dropdownIcon.removeClass('hover');}
this.dropdownValue.removeClass('hover');this.dropdownArrow.removeClass('hover');},click:function(){var that=this;if($(".tele-dd-popup").css('display')=='block'){$(".tele-dd-popup").fadeOut();$(".tele-dd-popup").remove();return;}
$(".tele-dd-popup").remove();this.popup=$('<div>').addClass('tele-popup').addClass('tele-dd-popup').hide();$(this.element).append(this.popup);var top=$(this.element).offset().top+$(this.element).height()+10;var left=($(this.element).offset().left+($(this.element).width()/2))-120;this.popup.css({height:this.options.height,width:this.options.width}).fadeIn();this.list=$('<div>').addClass('tele-dd-list').css({height:this.options.height-30,overflow:'auto'});for(x in this.options.options){var conf={key:this.options.options[x].key,label:this.options.options[x].label,inputFirst:true,checked:false};var element=$('<div>').addClass('tele-dd-item').html(conf.label);element.hover(function(){this.addClass('hover');},function(){this.removeClass('hover');}).click(function(){this.options.callback(conf);});this.list.append(element);}
this.popup.append(this.list);if(this.options.callback){this.options.callback();}}});;$.widget("tele.radios",{options:{'items':[],'selected':'time','title':'','tip':false,},_create:function(){this.element.addClass("tele-radios");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();var titleEl=$('<div>').addClass('tele-radios-title').html(this.options.title);this.element.append(titleEl);$.each(this.options.items,function(i,item){var itemWrap=$('<div>').addClass('tele-radio');if(item.tip){itemWrap.attr('alt',item.tip).attr('title',item.tip);}
var itemTitle=$('<div>').addClass('tele-radio-title').html(item.title);var itemIcon=$('<div>').addClass('tele-icon').addClass('tele-icon-'+item.icon);itemWrap.hover(function(){$('.tele-radio-title, .tele-icon',this).addClass('hover');},function(){$('.tele-radio-title, .tele-icon',this).removeClass('hover');});if(item.id==that.options.selected){itemTitle.addClass('selected');itemIcon.addClass('selected');}
itemWrap.append(itemIcon).append(itemTitle);that.element.append(itemWrap);itemWrap.click(function(){that._setOption('selected',item.id);if(that.options.callback){that.options.callback(that,item.id);}});});}});;$.widget("tele.btn",{options:{'icon':false,'text':false,},_create:function(){this.element.addClass("tele-button");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.icon!==false){this.iconEl=$('<span>').addClass('tele-icon tele-icon-'+this.options.icon);this.element.append(this.iconEl);this.iconEl.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});}
if(this.options.text!==false){this.textEl=$('<span>').addClass('tele-button-text').html(this.options.text);this.textEl.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.element.append(this.textEl);}},hoverIn:function(){if(this.textEl){this.textEl.addClass('hover');}
if(this.iconEl){this.iconEl.addClass('hover');}},hoverOut:function(){if(this.textEl){this.textEl.removeClass('hover');}
if(this.iconEl){this.iconEl.removeClass('hover');}},click:function(){if(this.options.callback){this.options.callback(this,this.element);}}});;$.widget("tele.cb",{options:{'icon':'checkbox','checked':false,},_create:function(){this.element.addClass("tele-checkbox");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.icon!='checkbox'){this.element.addClass('tele-checkbox-'+this.options.icon);}
if(this.options.checked){}
this.element.click(function(){if(that.options.checked){$(this).removeClass('checked');}else{$(this).addClass('checked');}
that.options.checked=!that.options.checked;if(that.options.callback){that.options.callback(that);}});}});;telepath.search={results:{},defaults:{'application':true,'pages':true,'attributes':true,'requests':true,'suspects':true,'alerts':true,'cases':true,'request_data':true,'users':false},sort:'date',dir:false,loading:false,options:false,searchTypes:[{id:'cases',label:'Request Data',desc:'Search Cases'},{id:'alerts',label:'Applications',desc:'Search Alerts'},{id:'suspects',label:'Request Data',desc:'Search suspects'},{id:'requests',label:'Requests',desc:'Search Requests'},{id:'request_data',label:'Request Data',desc:'Search request data'},{id:'application',label:'Applications',desc:'Search domain names'},{id:'pages',label:'Applications',desc:'Search application page names'},{id:'attributes',label:'Applications',desc:'Search attribute names'},{id:'users',label:'Request Data',desc:'Search web application users'},{id:'users',label:'Request Data',desc:'Search in countries and cities'}],printTypes:function(element){var that=this;if(this.options===false){this.options=this.defaults;}
$.each(that.searchTypes,function(i,data){var wrap=$('<div>').addClass('tele-search-filter').attr('id','tele-search-filter-'+data.id);var cb=$('<div>').addClass('tele-search-filter').teleCheckbox({label:data.desc,checked:that.options[data.id]?that.options[data.id]:false,callback:function(widget){that.options[data.id]=widget.options.checked;}});wrap.append(cb);element.append(wrap);});that.buttonsEl=$('<div>').addClass('tele-form-buttons');that.applyBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');that.cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');that.buttonsEl.append(that.applyBtn).append(that.cancelBtn);element.append(that.buttonsEl);that.applyBtn.click(function(){$('.tele-search-filters').remove();});that.cancelBtn.click(function(){that.options=that.defaults;$('.tele-search-filters').remove();});},searchStr:'',init:function(searchStr){this.searchStr=searchStr;telepath.header.configCmd.removeClass('active');$('.tele-nav a.active').removeClass('active');$('.tele-panel').empty().hide().removeClass('active');$("#file-upload").hide();$('.tele-panel-search').show().addClass('active');this.container=$('.tele-panel-search');this.container.empty();this.initPanel();telepath.config.actions.checkNotFinishedRecord();},initPanel:function(){var that=this;this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html('Search results');this.container.append(this.panelTopBar);this.panelSubBar=$('<div>').addClass('tele-panel-subtitle');this.panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');this.panelTopBar.append(this.panelTopBarRight);this.container.append(this.panelSubBar);var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'},],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;telepath.search.refresh(function(){});}});var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;$('.tele-search-tab span').html('0');telepath.search.refresh(function(){});}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.search.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});this.panelTopBarRight.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);this.tabsEl=$('<div>').addClass('tabs');this.tabsUl=$('<ul>');this.tabsEl.append(this.tabsUl);var tabs=[{id:'alerts',text:'Alerts'},{id:'cases',text:'Cases'},{id:'suspects',text:'Suspects'},{id:'requests',text:'Normal'},];for(x in tabs){var tab=tabs[x];var tabEl=$('<div>').attr('id','tele-search-'+tab.id);var tabLi=$('<li>');var tabCount=$('<span>').html('0');var tabA=$('<a>').attr('href','#tele-search-'+tab.id).append(tab.text+'&nbsp;(').append(tabCount).append(')').attr('rel',tab.id).addClass('tele-search-tab');tabLi.append(tabA);this.tabsUl.append(tabLi);this.tabsEl.append(tabEl);}
this.container.append(this.tabsEl);this.tabsEl.height($(window).height()-
$('.tele-header').height()-
$('.tele-panel-topbar').height()-
$('.tele-panel-subtitle').height()-60);this.tabsEl.tabs({heightStyle:'fill',autoHeight:false,animate:false,activate:function(event,ui){var id=ui.newPanel.selector.split('-')[2];that.container=$(ui.newPanel.selector);var teleBlock=$(ui.newPanel.selector+' .tele-block');teleBlock.remove();switch(id){case'cases':that.showCasesTab(ui.newPanel.selector);break;case'alerts':that.showAlertsTab(ui.newPanel.selector);break;case'suspects':that.showSuspectsTab(ui.newPanel.selector);break;case'requests':that.showRequestsTab(ui.newPanel.selector);break;}},create:function(event,ui){}});this.tabsEl.tabs({collapsible:true,active:false});this.panelSubBar.append(this.tabsUl);this.refresh();},refresh:function(){if(!this.searchStr){$.each(['alerts','cases','suspects','requests'],function(i,type){var container=$('#tele-search-'+type);container.empty();container.append($('<p>').text("No search string defined"));});this.tabsEl.tabs({collapsible:false});return false;}
$('.ui-tabs').append(telepath.loader);var that=this;this.results={};if(this.options===false){this.options=this.defaults;}
if(telepath.countries.n2a(this.searchStr)!='00'){this.searchStr=telepath.countries.n2a(this.searchStr);$('.tele-search-input').val(this.searchStr);this.countryFlag=true;}else{this.countryFlag=false;}
var searchSettingsObj={search:this.searchStr,options:this.options,is_country:this.countryFlag,sort:this.sort,dir:this.dir};that.count=0;$.each(['alerts','cases','suspects','requests'],function(i,type){if(that.options[type]){telepath.ds.get('/search/'+type,searchSettingsObj,function(data){that.count++;that.container=$('#tele-search-'+type);that.container.empty();if(!data.items||data.items.length==0){var p=$('<p>').text("No results");that.container.append(p);if(that.count==4)
that.selectTab();return;}
that.results[type]=data.items;$('.tele-search-tab[rel="'+type+'"] span').html(data.total);if(that.count==4)
that.selectTab();},function(data){that.count++;if(that.count==4)
that.selectTab();that.container=$('#tele-search-'+type);that.container.empty();var p=$('<p>').text(data['error']);that.container.append(p);});}
else{that.count++;if(that.count==4)
that.selectTab();that.container=$('#tele-search-'+type);that.container.empty();var p=$('<p>').text("No select option "+type);that.container.append(p);}});},selectTab:function(){var that=this;that.loading=false;that.tabsEl.children('.tele-loader').remove();var found=false;$.each(['alerts','cases','suspects','requests'],function(i,type){if(!found){if(that.results[type]&&that.results[type].length>0){var select;$('.tele-'+type+'-block').empty();switch(type){case'alerts':select=0;that.showAlertsTab();break;case'cases':select=1;that.showCasesTab();break;case'suspects':select=2;that.showSuspectsTab();break;case'requests':select=3;that.showRequestsTab();break;}
that.tabsEl.tabs({active:select});found=true;}}});that.tabsEl.tabs({collapsible:false});},showCasesTab:function(){this.list=$('<div>').addClass('tele-cases-block');$('#tele-search-cases').append(this.list);this.list.teleList({data:this.results.cases,searchkey:this.searchStr,formatter:function(item){if(item._source){item=item._source}
if(!item.checkable){item.checkable=false;}
if(!item.favorites){item.favorites=false;item.favorite=false;}
var case_names='';$.each(item.cases_names,function(i,x){case_names=case_names+x.key+' ,'});case_names=case_names.substr(0,case_names.length-2);var result={raw:item,checkable:false,favorites:false,favorite:false,itemID:item.sid,icon:'case',title:case_names,count:item.count,details:[{key:'IP',value:item.ip_orig},{key:'country',value:item.country},{key:'city',value:item.city},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'actions',value:item.actions_count},]};return result;}});},showAlertsTab:function(){if(!this.results.alerts)
return;this.list=$('<div>').addClass('tele-alerts-block');$('#tele-search-alerts').append(this.list);this.list.teleList({data:this.results.alerts,searchkey:this.searchStr,formatter:function(item){return telepath.alert.rowFormatter(item);}});},showSuspectsTab:function(){if(!this.results.suspects)
return;this.list=$('<div>').addClass('tele-suspects-block');$('#tele-search-suspects').append(this.list);this.list.teleList({data:this.results.suspects,searchkey:this.searchStr,formatter:function(item){return telepath.suspects.rowFormatter(item);}});},showRequestsTab:function(){if(!this.results.requests)
return;this.list=$('<div>').addClass('tele-requests-block');$('#tele-search-requests').append(this.list);this.list.teleList({data:this.results.requests,searchkey:this.searchStr,formatter:function(item){return telepath.suspects.rowFormatter(item);}});}};$.widget("tele.listitem",{options:{itemID:0,checkable:false,checked:false,favorites:false,favorite:false,favoriteCallBack:false,count:false,time:false,timeFormat:'d/m/y g:i A',timeLabel:'',progbar:false,progbarValue:0,progbarBig:false,popup:false,icon:'alert',title:'',description:'',details:[],offset:30,raw:[],},_resize:function(){var offset=this.options.offset;$('.tele-checkbox',this.element).each(function(){offset+=$(this).outerWidth(true);});if(offset<30){offset+=20;}
var innerWidth=$(this.element).width()-offset;if(this.element.parent().parent().parent().parent().attr('class')=='tele-similarities-list tele-block'&&window.innerWidth<1250){$('.tele-listitem-inner',this.element).width($('.tele-box-right').width()-80);}
else{$('.tele-listitem-inner',this.element).width(innerWidth-15);}
var offset=15;if(this.options.progbar){if(this.options.progbarBig){offset=offset+$('.tele-listitem-bigprogbar',this.element).outerWidth()+55;}else{offset=offset+$('.tele-listitem-progbar',this.element).outerWidth()+25;}}
if(this.options.icon){offset=offset+$('.tele-listitem-icon',this.element).outerWidth();}
var infoWidth=innerWidth-offset;$('.tele-listitem-info',this.element).css({width:infoWidth});var that=this;var total=30;if($('.tele-listitem-info').width()<800){$("ul li").filter('[class*=tele-listitem-]').css({'padding-right':'5%'});}
else{$("ul li").filter('[class*=tele-listitem-]').css({'padding-right':'10%'});}
$('.tele-listitem-info li',this.element).each(function(){$(this).show();$(this).prev().css({borderRightWidth:1});total=total+$(this).outerWidth();if(total>infoWidth){if($(this).hasClass('tele-list-hosts')){var x=$(this).width();var y=total-infoWidth;$(this).width(x-y).css({'white-space':'nowrap','overflow':'hidden','text-overflow':'ellipsis','height':'15px'});var hosts=$('b',this).text();var splited=hosts.split(',');if(splited.length>1){var view=$('<a>View all '+splited.length+' hosts</a>');$('b',this).html(view);$('.tele-list-hosts a').tipsy({fallback:hosts,gravity:'sw',trigger:'hover'});}
total=total+$(this).outerWidth();if(total>infoWidth){$(this).hide();$(this).prev().css({borderRightWidth:0});}}else{$(this).hide();$(this).prev().css({borderRightWidth:0});}}else{if($(this).hasClass('tele-list-hosts')){$(this).css({'width':'auto'});}}});},_create:function(){this.element.addClass("tele-listitem");this._update();},_setOption:function(key,value){this.options[key]=value;if(key=='checked'){if(value){this.checkEl.teleCheckbox({checked:true});}else{this.checkEl.teleCheckbox({checked:false});}
return;}
this._update();},_update:function(){var that=this;this.element.empty();if(this.options.checkable){this.checkEl=$('<a>').teleCheckbox({checked:this.options.checked,callback:function(widget){that.options.checked=widget.options.checked;}});this.element.append(this.checkEl);}
if(this.options.favorites){this.favEl=$('<a>').teleCheckbox({icon:'favorites',checked:this.options.favorite,callback:function(widget){that.options.favorite=widget.options.checked;if(typeof(that.options.favoriteCallBack)=='function'){that.options.favoriteCallBack(that);}}});this.element.append(this.favEl);}
var el=$('<div>').addClass('tele-listitem-inner');this.element.append(el);if(this.options.icon){var iconEl=$('<div>').addClass('tele-listitem-icon').addClass('tele-icon-'+this.options.icon);el.append(iconEl);}
if(this.options.count){var countEl=$('<div>').addClass('tele-listitem-count').html(this.options.count);el.append(countEl);if(parseInt(this.options.count)>999){countEl.css({"fontSize":'12px',"left":'30px'});}}
if(this.options.progbar){var progbar=$('<div>')
if(this.options.progbarBig){progbar.addClass('tele-listitem-bigprogbar');}else{progbar.addClass('tele-listitem-progbar');}
this.options.progbarValue=parseFloat(this.options.progbarValue);if(this.options.progbarValue>0){if(this.options.progbarValue<=1){this.options.progbarValue=this.options.progbarValue*100;}
else{this.options.progbarValue=parseInt(this.options.progbarValue);}}
var progbarInner=$('<div>').addClass('tele-listitem-progbar-inner').css({width:this.options.progbarValue+'%'});progbar.append(progbarInner);el.append(progbar);}
if(this.options.title){var titleEl=$('<div>').addClass('tele-listitem-title').html(this.options.title).attr('title',this.options.title);el.append(titleEl);}
if(this.options.updating){var updatingEl=$('<div>').addClass('tele-listitem-updating tele-icon-ring').html('Update in progress').attr('title','Update in progress');el.append(updatingEl);}
if(this.options.description){var descEl=$('<div>').addClass('tele-title-2').html(this.options.description);el.append(descEl);}
if(this.options.details){if(this.options.details.length>0){var list=$('<ul>').addClass('tele-listitem-info');if(!this.options.title){list.addClass('no-title');}
$.each(this.options.details,function(i,detail){if(detail.key||detail.value){var li=$('<li>');switch(detail.key){case'Active':var ActIcon=$('<span>');var ActText=$('<span>');if(detail.value){ActIcon.addClass('tele-icon-active');ActText.text('Active');}else{ActIcon.addClass('tele-icon-inactive');ActText.text('Inactive');}
li.append(ActIcon).append(ActText);break;case'city':if(detail.key&&detail.key=='city'&&detail.value&&detail.value!='Unknown'){li.append(detail.key).append(':&nbsp;').append('<b>'+escapeHtml(detail.value)+'</b>');}else{li=false;}
break;case'user':if(detail.key&&detail.key=='user'&&detail.value&&detail.value!=''){var iconEl=$('<div>').addClass('tele-listitem-user-name');li.append(iconEl).append('&nbsp&nbsp;').append('<span class="tele-user">'+escapeHtml(detail.value)+'</span>');}else{li=false;}
break;case'Email':var mailTo=$('<a>').attr('href','mailto:'+escapeHtml(detail.value)).text(escapeHtml(detail.value));li.append(mailTo);break;case'country':if(detail.value=='00'){li=false;}
else if(detail.value.length==2){li.append('<span class="flag flag-'+escapeHtml(detail.value)+'"></span>');li.append('<span class="tele-country">'+telepath.countries.a2n(detail.value)+'</span>');}else{li.append(detail.key);if(detail.value){li.append(':&nbsp;');}
li.append('<b>'+escapeHtml(detail.value)+'</b>');}
break;case'alerts':if(parseInt(detail.value)>0){var iconEl=$('<div>').addClass('tele-listitem-icon').addClass('tele-icon-alert');var countEl=$('<div>').addClass('tele-listitem-count').html(detail.value);li.addClass('tele-listitem-alerts-count');li.append(iconEl).append(countEl);}else{li=false;}
break;case'actions':if(parseInt(detail.value)>0){var iconEl=$('<div>').addClass('tele-listitem-icon').addClass('tele-icon-actions');var countEl=$('<div>').addClass('tele-listitem-count').html(detail.value);li.addClass('tele-listitem-actions-count');li.append(iconEl).append(countEl);}else{li=false;}
break;case'cases':if(parseInt(detail.value)>0){var iconEl=$('<div>').addClass('tele-listitem-icon tele-icon-case');var countEl=$('<div>').addClass('tele-listitem-count').html(detail.value);li.addClass('tele-listitem-cases-count');li.append(iconEl).append(countEl);}else{li=false;}
break;default:if(detail.key){li.append(detail.key);if(detail.value){li.append(':&nbsp;');}}
if(detail.value){li.append('<b>'+escapeHtml(detail.value)+'</b>');}
break;}
if(li!==false){list.append(li);}}});el.append(list);}}
if(this.options.time!==false){var time=$('<div>').addClass('tele-listitem-time').html(date_format(this.options.timeFormat,this.options.time));if(this.options.timeLabel){time.prepend('<label>'+this.options.timeLabel+'</label>');}
el.append(time);}
this._resize();$(window).resize(function(){if(that.timer){clearTimeout(that.timer);}
that.timer=setTimeout(function(){that._resize();},50);});el.hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){if(that.options.callback){that.options.callback(that);}});},bindPopup:function(){var that=this;this.element.hover(function(){},function(){});}});;if(!telepath.listitem){telepath.listitem={};}
telepath.listitem.generic={formatter_dashboard:function(item){return telepath.listitem.generic.formatter(item,'dashboard');},formatter:function(item,mode){if(mode=='dashboard'){result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'host',value:grabNames(item.host)},]}}
else{result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'city',value:item.city},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'actions',value:item.actions_count},{key:'cases',value:row.cases_count},{key:'user',value:item.user}]}}
return result;},callbacks:{click:function(widget){$('.popover').remove();setTimeout(function(){$('.popover').remove();},1000);var parent_parent=widget.element.parent().parent(),names=(widget.options.raw.alerts_names)?widget.options.raw.alerts_names:[];telepath.sessionflow.init(widget.options.itemID,widget.options.raw.ip_orig,names,widget.options.icon,widget.options.raw.searchkey,parent_parent);},hover_in:function(el,item){if(!item){return;}
if(telepath.generic_popover_timer){clearTimeout(telepath.generic_popover_timer);}
$('.popover').remove();if(telepath.generic_popover){telepath.generic_popover.remove();}
telepath.generic_popover=$('<div>');$('body').append(telepath.generic_popover);if($(el).hasClass('tele-icon-alert')&&item.raw.alerts_count&&item.raw.alerts_count>0&&item.raw.alerts_names&&item.raw.alerts_names.length>0){var alerts_content=$('<div>').addClass('popover-content');$.each(item.raw.alerts_names,function(i,x){var row=$('<div>').addClass('tele-popover-row').append($('<div>').addClass('tele-icon').addClass('tele-icon-alert')).append($('<div>').addClass('tele-count').text(x.doc_count)).append($('<div>').addClass('tele-popover-subtitle').html(x.key));alerts_content.append(row);});$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-45,left:$(el).offset().left+40}).fadeIn().popover({title:'Alerts',html:true,}).popover('show');$('.popover').append(alerts_content);var top=($('.popover').height()/2);if(top){$('.popover').css({position:'absolute',top:$(el).offset().top-top,left:$(el).offset().left+40})}}
if($(el).hasClass('tele-icon-actions')&&item.raw.actions_count&&item.raw.actions_count>0&&item.raw.actions_names&&item.raw.actions_names.length>0){var actions_content=$('<div>').addClass('popover-content');$.each(item.raw.actions_names,function(i,x){var row=$('<div>').addClass('tele-popover-row').append($('<div>').addClass('tele-icon').addClass('tele-icon-actions')).append($('<div>').addClass('tele-count').text(x.doc_count)).append($('<div>').addClass('tele-popover-subtitle').html(x.key));actions_content.append(row);});$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-45,left:$(el).offset().left+40}).fadeIn().popover({title:'Actions',html:true,}).popover('show');$('.popover').append(actions_content);var top=($('.popover').height()/2);if(top){$('.popover').css({position:'absolute',top:$(el).offset().top-top,left:$(el).offset().left+40})}}
if($(el).hasClass('tele-icon-case')&&item.raw.cases_count&&item.raw.cases_count>0&&item.raw.cases_names&&item.raw.cases_names.length>0){var cases_content=$('<div>').addClass('popover-content');$.each(item.raw.cases_names,function(i,x){var row=$('<div>').addClass('tele-popover-row').append($('<div>').addClass('tele-icon').addClass('tele-icon-case')).append($('<div>').addClass('tele-count').text(x.doc_count)).append($('<div>').addClass('tele-popover-subtitle').html(x.key));cases_content.append(row);});$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-45,left:$(el).offset().left+40}).fadeIn().popover({title:'Cases',html:true,}).popover('show');$('.popover').append(cases_content);var top=($('.popover').height()/2);if(top){$('.popover').css({position:'absolute',top:$(el).offset().top-top,left:$(el).offset().left+40})}}
if($(el).hasClass('tele-listitem-progbar')){var left=$(el).offset().left;var placement;if(left+422>$(window).width()){left-=10;placement='left';}
else{left+=100;placement='right';}
$(telepath.generic_popover).css({position:'absolute',top:$(el).offset().top-2,left:left}).fadeIn().popover({title:'Loading anomaly scores..',html:true,placement:placement,content:telepath.loader}).popover('show');telepath.ds.get('/sessionflow/get_session_stats',{sid:item.itemID},function(data){$('.popover-title:first').html('Anomaly Scores');$('.popover-content .tele-loader').after($('<div>').anomalyScore({request:data.items})).remove();});}},hover_out:function(el,item){telepath.generic_popover_timer=setTimeout(function(){$('.popover').fadeOut(function(){$('.popover').remove();});},500);},favorite:function(widget){telepath.ds.get('/cases/set_case_fav',{cid:widget.options.dataID,favorite:widget.options.favorite},function(data){});}},callbacks_case:{click:function(widget){if(telepath.access.admin||telepath.access.perm.Cases_get){$(".tele-nav-cases a").click();$('.popover').remove();telepath.casePanel.init(widget.options.dataID);}else{telepath.dialog({msg:'Access denied. No permissions to view Cases details.'});};},hover_in:function(el,opt){var cid=opt.dataID;$('.popover').remove();var that=this;if(telepath.cases.pop){telepath.cases.pop.remove();}
telepath.cases.pop=$('<div>').css({position:'absolute',top:$(el).offset().top,left:$(el).offset().left+70});$('body').append(telepath.cases.pop);$(telepath.cases.pop).popover({title:'Loading Data',html:true,content:telepath.loader}).popover('show');telepath.ds.get('/cases/get_case_stat',{cid:cid},function(data){var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'}},yaxis:{alignTicksWithAxis:true,labelWidth:30,ticks:5,color:'#446077',font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"}},selection:{mode:"x"},xaxis:{alignTicksWithAxis:true,tickColor:'#cccccc',tickLength:7,font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"},mode:"time",timezone:"browser",timeformat:"%d/%m"},grid:{borderColor:'#446077',borderWidth:1}};data=[{label:"Sessions",data:data.items,color:'#FC3D3D'}];var graphContainer=$('<div>').addClass('case-popover-graph');$('.popover-title').html('Case Activity');$('.popover-content').empty().append(graphContainer);graphContainer.flotGraph({data:data,options:options});});},hover_out:function(el,id){if(telepath.cases.timeout){clearTimeout(telepath.cases.timeout);}
if(telepath.cases.pop){telepath.cases.pop.remove();}},favorite:function(widget){telepath.ds.get('/cases/set_case_fav',{cid:widget.options.title,favorite:widget.options.favorite},function(data){});}}};$.widget("tele.toggleFlip",{options:{'left_value':'On','right_value':'Off','flipped':false,'flip':false,'disabled':false},_create:function(){this.element.addClass("tele-mini-toggle");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var toggle_left=$('<div>').addClass('tele-mini-toggle-left').html(this.options.left_value);var toggle_right=$('<div>').addClass('tele-mini-toggle-right').html(this.options.right_value);var toggle_middle=$('<div>').addClass('tele-mini-toggle-middle');var toggle_knob=$('<a>').attr('href','#').addClass('tele-mini-toggle-knob').html('&nbsp;');toggle_middle.append(toggle_knob);this.element.empty().append(toggle_left).append(toggle_middle).append(toggle_right);if(this.options.flipped){toggle_knob.addClass('active');toggle_knob.css({marginLeft:20});}
if(this.options.disabled){this.element.css({opacity:0.3});}else{toggle_knob.click(function(e){e.preventDefault();if(that.options.flipped){$(this).removeClass('active');$(this).animate({marginLeft:0},300);}else{$(this).addClass('active');$(this).animate({marginLeft:20},300);}
that.options.flipped=!that.options.flipped;if(typeof(that.options.flip)=='function'){that.options.flip(that.options.flipped);}});}}});;$.widget("tele.daterange",{options:{start:new Date().getTime(),end:new Date().getTime(),change:false,state:''},_create:function(){this.element.addClass("tele-daterange");this.createButton();},_setOption:function(key,value){this.options[key]=value;this.createButton();},_displayPopup:function(){var that=this;var el='.tele-daterange:last';if($(".tele-daterange-popup").css('display')=='block'){$(".tele-daterange-popup").fadeOut();return;}
else{$(".tele-daterange-popup").remove();$('body').append(telepath.templates['popup-daterange']);}
var top=$(el).offset().top+$(el).height()+20;var left=($(el).offset().left+($(el).width()/2))-($(".tele-daterange-popup").width()/2);$(".tele-daterange-popup").css({top:top,left:left});$(".tele-daterange-popup").fadeIn();$.datepicker._defaults.dateFormat="dd/mm/yy";$(".tele-daterange-calendar").datepicker({numberOfMonths:[1,2],beforeShowDay:function(date){if($(".tele-daterange-from").val()){var date1=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-from").val());var date2=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-to").val());}
else{var date1=new Date(telepath.range.start*1000);var date2=new Date(telepath.range.end*1000);}
return[true,date1&&((date.getTime()==date1.getTime())||(date2&&date>=date1&&date<=date2))?"dp-highlight":""];},onSelect:function(dateText,inst){var date1=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-from").val());var date2=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-to").val());var selectedDate=$.datepicker.parseDate($.datepicker._defaults.dateFormat,dateText);if(!date1||date2){$(".tele-daterange-from").val(dateText);$(".tele-daterange-from-hour").val("00:00");$(".tele-daterange-to").val("");$(".tele-daterange-to-hour").val("23:59");$(this).datepicker();}else if(selectedDate<date1){$(".tele-daterange-to").val($(".tele-daterange-from").val());$(".tele-daterange-to-hour").val($(".tele-daterange-from-hours").val());$(".tele-daterange-from").val(dateText);$(".tele-daterange-from-hour").val("00:00");$(this).datepicker();}else{$(".tele-daterange-to").val(dateText);$(".tele-daterange-to-hour").val("23:59");$(this).datepicker();}}});$(".tele-daterange-period a").click(function(){$(".tele-daterange-period a.active").removeClass('active');that.options.state=$(this).attr('class').split('-')[3];$(this).addClass('active');that.setPeriod();});function get_hour_value(element){var str=element.val();if(str==''){element.val('');return 0;}else{str=str.split(':');if(str.length==2){return(parseInt(str[0])*3600*1000)+(parseInt(str[1])*60*1000);}else{element.val('');return 0;}}}
$(".tele-daterange-buttons .tele-button-apply").click(function(){$(".tele-daterange-popup").fadeOut();if(typeof(that.options.change)=='function'){if($(".tele-daterange-period a.active").length)
telepath.range.state=$(".tele-daterange-period a.active").attr('class').split(/-| /)[3];if(telepath.range.state=='range'){var from_date=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-from").val());var to_date=$.datepicker.parseDate($.datepicker._defaults.dateFormat,$(".tele-daterange-to").val());var from_date_hour=get_hour_value($(".tele-daterange-from-hour"));var to_date_hour=get_hour_value($(".tele-daterange-to-hour"));telepath.range.start=parseInt((from_date.getTime()+from_date_hour)/1000);telepath.range.end=parseInt((to_date.getTime()+to_date_hour)/1000);telepath.ds.get('/telepath/set_time_range',{state:telepath.range.state,start:telepath.range.start,end:telepath.range.end},function(data){that.options.change(telepath.range.start,telepath.range.end);that.options.state=telepath.range.state;that.options.start=telepath.range.start;that.options.end=telepath.range.end;if(that.button){that.button.remove();}
that.createButton();});}
else{telepath.ds.get('/telepath/set_time_range',{state:telepath.range.state},function(data){that.options.state=telepath.range.state;var from_date=new Date();switch(that.options.state){case'data':telepath.range.start=telepath.fullRangeStart;break;case'year':from_date.setFullYear(from_date.getFullYear()-1);break;case'month':from_date.setMonth(from_date.getMonth()-1);break;case'week':from_date.setDate(from_date.getDate()-7);break;case'day':from_date.setDate(from_date.getDate()-1);break;case'hour':from_date.setHours(from_date.getHours()-1);break;}
if(that.options.state!='data'){telepath.range.start=parseInt(from_date.getTime()/1000);}
telepath.range.end=parseInt(new Date().getTime()/1000);that.options.start=telepath.range.start;that.options.end=telepath.range.end;that.options.change(telepath.range.start,telepath.range.end);if(that.button){that.button.remove();}
that.createButton();});}}});$(".tele-daterange-buttons .tele-button-cancel").click(function(){$(".tele-daterange-popup").fadeOut();});that._update();},_update:function(){this.updateUI();},setPeriod:function(){var that=this;var from_date=new Date();if(that.options.state=='range'){$('.tele-darerange-container').removeClass('disabled');$(".tele-daterange-to").val(date_format('d/m/Y',Date.now()/1000));$(".tele-daterange-to-hour").val(date_format('H:i',Date.now()/1000));$(".tele-daterange-from").val(date_format('d/m/Y',telepath.fullRangeStart));$(".tele-daterange-from-hour").val(date_format('H:i',telepath.fullRangeStart));}
else{$('.tele-darerange-container').addClass('disabled');$(".tele-daterange-to").val(date_format('d/m/Y',telepath.range.end));$(".tele-daterange-to-hour").val(date_format('H:i',telepath.range.end));$(".tele-daterange-from").val(date_format('d/m/Y',telepath.range.start));$(".tele-daterange-from-hour").val(date_format('H:i',telepath.range.start));}},updateUI:function(){var that=this;$(".tele-daterange-period a.active").removeClass('active')
$(".tele-daterange-period a").each(function(){if($(this).attr('class').split('-')[3]==telepath.range.state)
$(this).addClass("active");});$('.tele-darerange-container').addClass('disabled');if(telepath.range.state=='range'){$('.tele-darerange-container').removeClass('disabled');}
$(".tele-daterange-from").val(date_format('d/m/Y',this.options.start));$(".tele-daterange-from-hour").val(date_format('H:i',this.options.start));$(".tele-daterange-to").val(date_format('d/m/Y',this.options.end));$(".tele-daterange-to-hour").val(date_format('H:i',this.options.end));},createButton:function(){var that=this;if(telepath.range.state=='range'){var text=date_format('d/m/Y',this.options.start)+' - '+date_format('d/m/Y',this.options.end);}
else if(telepath.range.state=='data')
var text='All Data';else
var text='Last '+telepath.range.state[0].toUpperCase()+telepath.range.state.slice(1);this.button=$('<a>').attr('href','#').btn({icon:'daterange',text:text,callback:function(){that._displayPopup();}});this.element.append(this.button);}});;$.widget("tele.flotGraph",{options:{data:[],options:[],dashboard:false,title:false,},_create:function(){this.element.addClass("tele-graph");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.canvasOuter=$('<div>').addClass('tele-graph-canvas-outer');this.canvasInner=$('<div>').addClass('tele-graph-canvas');this.element.empty();if(this.options.title){var graphTitle=$('<div>').addClass('tele-graph-title').html(this.options.title);this.element.append(graphTitle);}
this.canvasOuter.append(this.canvasInner);this.element.append(this.canvasOuter);if(this.options.dashboard){this.filterTypes=[{type:'noncase-alerts',label:'Alerts',count:0,active:true,suffix:'Tx'},{type:'case-alerts',label:'Cases',count:0,active:true,suffix:'Tx'},{type:'suspicions',label:'Suspects',count:0,active:true,suffix:'Tx'},{type:'other-sessions',label:'Normal',count:0,active:true,suffix:'Tx'},];var totalCount=0;$.each(that.filterTypes,function(i,filter){$.each(that.options.data,function(x,data){if(data.label==filter.label){filter.count=0;$.each(data.data,function(z,count){filter.count=filter.count+parseInt(count[1]);totalCount=totalCount+parseInt(count[1]);});}});});this.dashboardGraphFilters=$('<div>').addClass('tele-dashboard-graph-filters');$('.tele-graph-canvas-outer').append(this.dashboardGraphFilters);$.each(this.filterTypes,function(i,filter){var filterWrap=$('<div>').addClass('tele-dashboard-graph-filter').addClass('tele-graph-filter-'+filter.type);var filterToggle=$('<a>').attr('href','#').addClass('tele-graph-filter-toggle').html('&nbsp;');var filterTitle=$('<div>').addClass('tele-graph-filter-title').text(filter.label);var filterPercent=$('<div>').addClass('tele-graph-filter-percent').text((totalCount>0?parseFloat(filter.count/totalCount*100).toFixed(2):0)+'%');var filterCount=$('<div>').addClass('tele-graph-filter-count').text(filter.count+' '+filter.suffix);filterWrap.append(filterToggle).append(filterTitle).append(filterPercent).append(filterCount);that.dashboardGraphFilters.append(filterWrap);filterPercent.css({marginRight:160-filterTitle.width()});filterCount.css({marginRight:160-filterTitle.width()});if(filter.active){filterToggle.addClass('active');}
filterToggle.click(function(){if($(this).hasClass('active')){$(this).removeClass('active');that.filterTypes[i].active=false;}else{$(this).addClass('active');that.filterTypes[i].active=true;}
that.updateFilters();});});this.resize();this.dashboardGraphFilters.resize(function(){that.resize();});this.updateFilters();}
this.printData=this.options.data;this.plot();},updateFilters:function(){var that=this;this.printData=[];$.each(that.filterTypes,function(i,filter){if(filter.active){$.each(that.options.data,function(x,data){if(data.label==filter.label){that.printData.push(data);}});}});this.plot();},plot:function(){this.plotObj=$.plot(this.canvasInner,this.printData,this.options.options);},resize:function(){var width=this.dashboardGraphFilters.width();$('.tele-dashboard-graph-filter').css({margin:0});var filterWidth=$('.tele-dashboard-graph-filter').outerWidth();var spare=Math.floor(Math.floor(width-(filterWidth*this.filterTypes.length))/this.filterTypes.length)-1;$('.tele-dashboard-graph-filter').css({marginRight:spare});$('.tele-graph-filter-title').css({fontSize:(width<800?'16px':'20px')});}});;$.widget("tele.vMap",{options:{'data':[],'title':false},_create:function(){this.element.addClass("tele-map");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){this.element.empty();if(this.options.title){var graphTitle=$('<div>').addClass('tele-graph-title').html(this.options.title);this.element.append(graphTitle);}
var scaleColors=['#C4E8B2','#60BB3C'];var max=0;var total=0;$.each(this.options.data,function(c_id,val){if(c_id!=='00'&&val>max){max=val;}
total+=val;});this.scaleWrap=$('<div>').addClass('tele-scale-wrap');this.scaleLeft=$('<div>').addClass('tele-scale-left').html('0');this.scaleGrad=$('<div>').addClass('tele-scale-grad');this.scaleRight=$('<div>').addClass('tele-scale-right').html(max.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+' ('+total.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+')');this.scaleWrap.append(this.scaleLeft).append(this.scaleGrad).append(this.scaleRight);this.vectorMap=$('<div>').css({clear:'both',height:300,padding:'15px 0px 0px 0px'});this.element.append(this.scaleWrap);this.element.append(this.vectorMap);var country_rate=Array();$.each(this.options.data,function(index,value){country_rate[index.toLowerCase()]=value;});this.vectorMap.vectorMap({map:'world_en',backgroundColor:'#304F68',color:'#C4E8B2',hoverOpacity:0.7,selectedColor:'#666666',enableZoom:true,showTooltip:true,values:country_rate,scaleColors:scaleColors,normalizeFunction:'polynomial',onRegionClick:function(x,y){telepath.alerts.searchString='country_code:'+y.toUpperCase();$('.tele-nav-alerts a').click();$('.jqvmap-label').remove();},onLabelShow:function(event,label,code){var row=$('<div>').addClass('tele-popover-row');var icon=$('<div>').addClass('tele-icon tele-icon-alert');var count=$('<div>').addClass('tele-count').html(telepath.dashboard.data.items.map[code.toUpperCase()]?telepath.dashboard.data.items.map[code.toUpperCase()]:0);var title=$('<span>').addClass('tele-popover-subtitle').html(telepath.countries.a2n(code.toUpperCase()));row.append(icon).append(count).append(title);label.empty();label.append(row);},});}});;$.widget("tele.anomalyScore",{options:{request:[],},_create:function(){this.element.addClass("tele-anomaly-score");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var scoreTypes=['speed','direction','query','location'];this.options.speed=this.options.request.score_landing;this.options.direction=this.options.request.score_flow;this.options.query=this.options.request.score_query;this.options.location=this.options.request.score_geo;$.each(scoreTypes,function(i,scoreType){var value=parseInt(that.options[scoreType]*100);var typeWrap=$('<div>').addClass('tele-anomaly-wrap');var typeIcon=$('<div>').addClass('tele-anomaly-icon').addClass('tele-icon-'+scoreType);var typeText=$('<div>').addClass('tele-anomaly-text').html(scoreType.charAt(0).toUpperCase()+scoreType.slice(1));var typeValue=$('<div>').addClass('tele-anomaly-value').html(value+'%');typeWrap.append(typeIcon).append(typeText).append(typeValue);if(value>25){typeIcon.addClass('active');typeText.addClass('active');typeValue.addClass('active');}
that.element.append(typeWrap);});}});;$.widget("tele.anomalyScore",{options:{request:[],},_create:function(){this.element.addClass("tele-anomaly-score");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var scoreTypes=['speed','direction','query','location'];this.options.speed=this.options.request.score_landing;this.options.direction=this.options.request.score_flow;this.options.query=this.options.request.score_query;this.options.location=this.options.request.score_geo;$.each(scoreTypes,function(i,scoreType){var value=parseInt(that.options[scoreType]*100);var typeWrap=$('<div>').addClass('tele-anomaly-wrap');var typeIcon=$('<div>').addClass('tele-anomaly-icon').addClass('tele-icon-'+scoreType);var typeText=$('<div>').addClass('tele-anomaly-text').html(scoreType.charAt(0).toUpperCase()+scoreType.slice(1));var typeValue=$('<div>').addClass('tele-anomaly-value').html(value+'%');typeWrap.append(typeIcon).append(typeText).append(typeValue);if(value>25){typeIcon.addClass('active');typeText.addClass('active');typeValue.addClass('active');}
that.element.append(typeWrap);});}});;$.widget("tele.anomalyScore",{options:{request:[],},_create:function(){this.element.addClass("tele-anomaly-score");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var scoreTypes=['speed','direction','query','location'];this.options.speed=this.options.request.score_landing;this.options.direction=this.options.request.score_flow;this.options.query=this.options.request.score_query;this.options.location=this.options.request.score_geo;$.each(scoreTypes,function(i,scoreType){var value=parseInt(that.options[scoreType]*100);var typeWrap=$('<div>').addClass('tele-anomaly-wrap');var typeIcon=$('<div>').addClass('tele-anomaly-icon').addClass('tele-icon-'+scoreType);var typeText=$('<div>').addClass('tele-anomaly-text').html(scoreType.charAt(0).toUpperCase()+scoreType.slice(1));var typeValue=$('<div>').addClass('tele-anomaly-value').html(value+'%');typeWrap.append(typeIcon).append(typeText).append(typeValue);if(value>25){typeIcon.addClass('active');typeText.addClass('active');typeValue.addClass('active');}
that.element.append(typeWrap);});}});;$.widget("tele.notifications",{options:{interval:10000},toShow:[],indexes:false,showNotifications:function(){$.each(this.toShow,function(i,notifyObject){$.pnotify(notifyObject);});this.toShow=[];this.count.html(0);},_create:function(){var that=this;this.element.addClass("tele-notify");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;telepath.ds.get('/notifications/get_syslog',{},function(data){if(data.items&&data.items.length>0){$.each(data.items,function(i,text){if(text.substr(0,3)=='CMD'){eval(text.substr(4));}else{console.log('SYSLOG:: '+text);}});}});telepath.ds.get('/notifications/get_indexes',{time:this.time},function(data){if(!that.indexes){that.indexes=data.items;}else{$.each(that.indexes,function(index_name,index_value){$.each(data.items,function(data_name,data_value){if(index_name==data_name&&data_value>index_value){var diff=data_value-index_value;var icon='';var title='';var link='';var text='';switch(index_name){case'alerts':title='New Alerts';link='<a onclick="$(\'.tele-nav-alerts a\').click()">here</a>';text=diff+' new alerts. click '+link+' to view';icon='alert';break;case'requests':title='Traffic';text='Current traffic is '+(diff*6)+' requests/min.';icon='config';that.indexes[index_name]=data_value;break;}
var nData={title:title,text:text,type:'success',delay:1000,opacity:0.95,styling:'bootstrap',icon:'tele-icon tele-icon-'+icon,};}});});if(that.count){that.count.html(that.toShow.length);}}});}});;$.widget("tele.notifications",{options:{interval:10000},toShow:[],indexes:false,showNotifications:function(){$.each(this.toShow,function(i,notifyObject){$.pnotify(notifyObject);});this.toShow=[];this.count.html(0);},_create:function(){var that=this;this.element.addClass("tele-notify");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;telepath.ds.get('/notifications/get_syslog',{},function(data){if(data.items&&data.items.length>0){$.each(data.items,function(i,text){if(text.substr(0,3)=='CMD'){eval(text.substr(4));}else{console.log('SYSLOG:: '+text);}});}});telepath.ds.get('/notifications/get_indexes',{time:this.time},function(data){if(!that.indexes){that.indexes=data.items;}else{$.each(that.indexes,function(index_name,index_value){$.each(data.items,function(data_name,data_value){if(index_name==data_name&&data_value>index_value){var diff=data_value-index_value;var icon='';var title='';var link='';var text='';switch(index_name){case'alerts':title='New Alerts';link='<a onclick="$(\'.tele-nav-alerts a\').click()">here</a>';text=diff+' new alerts. click '+link+' to view';icon='alert';break;case'requests':title='Traffic';text='Current traffic is '+(diff*6)+' requests/min.';icon='config';that.indexes[index_name]=data_value;break;}
var nData={title:title,text:text,type:'success',delay:1000,opacity:0.95,styling:'bootstrap',icon:'tele-icon tele-icon-'+icon,};}});});if(that.count){that.count.html(that.toShow.length);}}});}});;telepath.overlay={resize:function(){var newHeight=$('.tele-overlay').height()-$('.tele-overlay-header').height();if(this.minheight>0&&this.minheight>newHeight)
{newHeight=this.minheight;}
$('.tele-overlay-content').height(newHeight);$('.tele-overlay').css({marginTop:-1*($('.tele-overlay').height()/2)});},keydownHandler:function(e){if(e.keyCode==27){telepath.overlay.destroy();}},destroy:function(){$('.tele-overlay, .tele-overlay-mask').remove();$(document).unbind('keydown',telepath.overlay.keydownHandler);},init:function(icon,title,fullscreen,minheight){telepath.overlay.destroy();this.maskEl=$('<div>').addClass('tele-overlay-mask');this.overlayEl=$('<div>').addClass('tele-overlay').addClass('tele-overlay-'+icon);this.iconEl=$('<div>').addClass('tele-overlay-icon').addClass('tele-icon').addClass('tele-icon-'+icon);this.headerEl=$('<div>').addClass('tele-overlay-header');this.contentEl=$('<div>').addClass('tele-overlay-content');this.titleEl=$('<div>').addClass('tele-overlay-title').html(title);this.closeEl=$('<a>').attr('href','#').addClass('tele-overlay-close').addClass('tele-icon').addClass('tele-icon-close');this.minheight=(typeof(minheight)!=='undefined')?minheight:0;$('body').append(this.maskEl);$('body').append(this.overlayEl);this.overlayEl.append(this.iconEl).append(this.headerEl).append(this.contentEl);this.headerEl.append(this.titleEl).append(this.closeEl);this.closeEl.click(function(){telepath.overlay.destroy();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$(document).bind('keydown',telepath.overlay.keydownHandler);if(fullscreen){var height=$(window).height()-100;if(this.minheight>0&&this.minheight>height)
{height=this.minheight;}
var width=$(window).width()-100;$('.tele-overlay').css({height:height,width:width,marginLeft:-1*parseInt(width/2),marginTop:-1*parseInt(height/2)});}
$('.tele-overlay').resize(function(){telepath.overlay.resize();});telepath.overlay.resize();$(this.overlayEl).draggable({handle:this.headerEl});}};$.widget("tele.pagination",{options:{count:0,name:'Alert',current:0,callback:function(){}},_create:function(){this.element.addClass("tele-pagination");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_destroy:function(){$(document).unbind('keydown',this.keyDown);},_update:function(){var that=this;telepath.pagination=this;this.element.empty();var itemName=this.options.count>1?this.options.name+'s':this.options.name;var itemCount=(this.options.current+1)+'/'+this.options.count;this.titleEl=$('<div>').addClass('tele-pagination-title').html(itemCount+'&nbsp;'+itemName);this.prevEl=$('<div>').addClass('tele-pagination-prev').addClass('tele-icon').addClass('tele-icon-prev');this.nextEl=$('<div>').addClass('tele-pagination-next').addClass('tele-icon').addClass('tele-icon-next');this.prevEl.hover(function(){$(this).addClass('hover')},function(){$(this).removeClass('hover')});this.nextEl.hover(function(){$(this).addClass('hover')},function(){$(this).removeClass('hover')});this.element.append(this.prevEl,this.titleEl,this.nextEl);this.prevEl.click(function(){that.scrollPrev();});this.nextEl.click(function(){that.scrollNext();});this._constrain();this.titleEl.attr('unselectable','on').css('user-select','none').on('selectstart',false);$(document).unbind('keydown',this.keyDown);$(document).bind('keydown',this.keyDown);},_constrain:function(){if(this.options.current==0){this.prevEl.css({visibility:'hidden'});}else{this.prevEl.css({visibility:'visible'});}
if(this.options.current==this.options.count-1){this.nextEl.css({visibility:'hidden'});}else{this.nextEl.css({visibility:'visible'});}},scrollPrev:function(){if(this.options.current>0){this.options.current--;this._update();this.options.callback(this.options.current);}},scrollNext:function(){if(this.options.current<this.options.count-1){this.options.current++;this._update();this.options.callback(this.options.current);}},keyDown:function(e){if(e.keyCode=='37'){telepath.pagination.scrollPrev();}
if(e.keyCode=='39'){telepath.pagination.scrollNext();}}});;telepath.config={loaded:false,init:function(){this.outerContainer=$('.tele-panel-config');this.initTabs();},initTabs:function(){var that=this;$('canvas').remove();this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.outerContainer.append(this.panelTopBar);this.tabs=[];if(telepath.access.admin){this.tabs.push({icon:'accounts',text:'Telepath Users'});}
if(telepath.access.admin||telepath.access.perm.Applications_get){this.tabs.push({icon:'applications',text:'Applications'});}
if(telepath.access.admin||telepath.access.perm.Rules_get){this.tabs.push({icon:'rules',text:'Rules'});}
if(telepath.access.admin||telepath.access.perm.Workflow_get){this.tabs.push({icon:'actions',text:'Business Actions'});}
if(telepath.access.admin||telepath.access.perm.Config_get){this.tabs.push({icon:'system',text:'Advanced'});}
for(x in this.tabs){var tab=this.tabs[x];tab.callback=function(widget){$('.tele-config-tab .active').removeClass('active');$('.tele-icon',widget.element).addClass('active');$('.tele-button-text',widget.element).addClass('active');var id=widget.options.icon;that.currentPanel=id;that.container.empty();$("#file-upload").hide();$('#sort-radio').remove();telepath.config[id].container=that.container;telepath.config[id].initLayout=that.initLayout;telepath.config[id].resizeLayout=that.resizeLayout;telepath.config[id].initLayout();telepath.config[id].resizeLayout();telepath.config[id].init();$(window).resize(function(){telepath.config[id].resizeLayout();});telepath.config.actions.checkNotFinishedRecord();}
var tabBtn=$('<div>').btn(tab).addClass('tele-config-tab');this.panelTopBar.append(tabBtn);this.panelTopBar.append('<div class="tele-navsep"></div>');}
$('.tele-navsep:last',this.panelTopBar).remove();this.container=$('<div>').addClass('tele-panel-config-inner');this.outerContainer.append(this.container);this.container.append(telepath.loader);telepath.config.load();},load:function(dont_start){this.start();},start:function(){var that=this;setTimeout(function(){that.container.empty();$('.tele-button.tele-config-tab:nth-child(1) .tele-button-text').trigger('click');},500);},initLayout:function(){this.barEl=$('<div>').addClass('tele-config-bar').addClass('tele-panel-subtitle');this.barLeft=$('<div>').addClass('tele-config-bar-left');this.barRight=$('<div>').addClass('tele-config-bar-right');this.contentEl=$('<div>').addClass('tele-config-content');this.contentLeft=$('<div>').addClass('tele-config-content-left');this.contentRight=$('<div>').addClass('tele-config-content-right');this.barEl.append(this.barLeft).append(this.barRight);this.contentEl.append(this.contentLeft).append(this.contentRight);this.container.append(this.barEl).append(this.contentEl);},resizeLayout:function(){this.barEl.css({height:40,width:'100%',background:'#333333'});var height=$(window).height();var width=$(window).width();if(width<1200){if(width<1024){$('.tele-config-tab').css({margin:'5px 10px 0px 10px'});}else{$('.tele-config-tab').css({margin:'5px 20px 0px 20px'});}}else{$('.tele-config-tab').css({margin:'5px 30px 0px 30px'});}
$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-block').height(offset-20);$('.tele-block .tele-list').height(offset-50);$('.tele-list').mCustomScrollbar("update");this.contentEl.css({height:offset});if(this.contentRight.hasClass('tele-stacked')){this.contentLeft.width(width);this.contentRight.width(width);this.contentRight.css({height:offset-this.contentLeft.outerHeight()-20});}else{var magic=520;this.contentLeft.width(magic);this.contentRight.width(width-magic-20);this.contentLeft.css({height:offset});$('.tele-tree',this.contentLeft).css({height:offset}).mCustomScrollbar("update");this.contentRight.css({height:offset});}
this.barLeft.width(magic);this.barRight.width(width-magic-20);},startsWith2:function(str,prefix){if(str.length<prefix.length)
return false;for(var i=prefix.length-1;(i>=0)&&(str[i]===prefix[i]);--i){continue;}
return i<0;}};telepath.dashboard={divs:0,data:{items:{}},sort:'count',dir:false,refreshTimer:false,refreshInterval:5,reloadFlag:Date.now(),loading:false,map_mode:false,getData:function(){this.loading=true;$('.tele-panel-dashboard-refresh-button').hide();$('.tele-panel-dashboard-refresh').css('paddingRight','+=47px');setTimeout(function(){telepath.dashboard.loading=false;$('.tele-panel-dashboard-refresh-button').fadeIn();$('.tele-panel-dashboard-refresh').css('paddingRight','-=47px');},5000);var that=this;telepath.ds.get('/dashboard/get_map',{},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.map_mode=data.items.map_mode;$('.tele-panel-dashboard .tele-panel-subtitle-right .tele-mini-toggle').toggleFlip({flipped:data.items.map_mode=='traffic'});telepath.dashboard.data.items.map=data.items.map;telepath.dashboard.map.vMap({data:telepath.dashboard.data.items.map,title:data.items.map_mode=='traffic'?'Traffic over time':'Alerts over time'});$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_chart',{},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.data.items.chart=data.items.chart;telepath.dashboard.drawGraph();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_suspects',{sort:this.sort,dir:this.dir},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.data.items.suspects=data.items.suspects;telepath.dashboard.initSuspects();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_alerts',{sort:this.sort,dir:this.dir},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
telepath.dashboard.data.items.alerts=data.items.alerts;telepath.dashboard.initAlerts();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);telepath.ds.get('/dashboard/get_cases',{},function(data,flag){if(flag&&telepath.dashboard.reloadFlag&&flag!=telepath.dashboard.reloadFlag)
{return;}
var cases=[];var index;var caseCount=(data.items.cases)?data.items.cases.length:0;for(index=0;index<caseCount;++index){cases.push(data.items.cases[index]);}
telepath.dashboard.data.items.cases=cases;telepath.dashboard.initCases();$(window).trigger('resize');},null,telepath.dashboard.reloadFlag);},initCases:function(){var that=this;if(telepath.access.admin||telepath.access.perm.Cases_get){this.divs+=1;this.casesList=$('<div>').addClass('tele-dashboard-block cases');$('.tele-panel-dashboard').append(this.casesList);this.casesList.teleList({title:'Recent Cases',titleCallback:function(){$(".tele-nav-cases a").click();},data:this.data.items.cases,formatter:function(item){return telepath['case'].rowFormatter(item,'dashboard');},callbacks:telepath.listitem.generic.callbacks_case});}},initAlerts:function(){var that=this;if(telepath.access.admin||telepath.access.perm.Alerts_get){this.divs+=1;this.alertsList=$('<div>').addClass('tele-dashboard-block alerts');$('.tele-panel-dashboard').append(this.alertsList);this.alertsList.teleList({title:'Recent Alerts',titleCallback:function(){$(".tele-nav-alerts a").click();},data:this.data.items.alerts.items,formatter:function(item){item.checkable=false;return telepath.alert.rowFormatter(item,'dashboard');}});}},initSuspects:function(){var that=this;if(telepath.access.admin||telepath.access.perm.Suspects_get){this.divs+=1;this.suspectsList=$('<div>').addClass('tele-dashboard-block suspects');$('.tele-panel-dashboard').append(this.suspectsList);this.suspectsList.teleList({title:'Top Suspects',titleCallback:function(){$(".tele-nav-suspects a").click();},data:this.data.items.suspects.items,formatter:function(item){item.checkable=false;return telepath.suspects.rowFormatter(item,'dashboard');}});}},refresh:function(callback){this.init();},init:function(){var that=this;this.getData();this.resetContainer();this.showFilters();this.resize();if($('.tele-panel-dashboard').size()>0){$(window).resize(function(){that.resize();});}},drawGraph:function(){var timeformat=((telepath.range.end-telepath.range.start)/3600>48)?"%d/%m/%y":"%d/%m %h:%M:%S";var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'}},yaxis:{alignTicksWithAxis:true,labelWidth:30,ticks:5,color:'#446077',font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"}},selection:{mode:"x"},xaxis:{alignTicksWithAxis:true,tickColor:'#cccccc',tickLength:7,font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"},mode:"time",timezone:"browser",timeformat:timeformat},grid:{borderColor:'#446077',borderWidth:1,hoverable:true,clickable:true},tooltip:true,tooltipOpts:{content:"%s | date & time: %x | sessions: %y"}};var chartData=[{label:"Alerts",data:this.data.items.chart.alerts,color:'#64a5bc'},{label:"Normal",data:this.data.items.chart.sessions,color:'#986da0'},{label:"Cases",data:this.data.items.chart.cases,color:'#ff850b'},{label:"Suspects",data:this.data.items.chart.suspects,color:'#6ab789'}];this.graph.flotGraph({data:chartData,options:options,dashboard:true,title:'Overall Transactions'});},resetContainer:function(loading){this.divs=0;var that=this;$('.tele-panel-dashboard .tele-panel-subtitle-right .tele-mini-toggle').toggleFlip({flipped:telepath.dashboard.data.items.map=='traffic'});var container=$('.tele-panel-dashboard');container.empty();container.append('<div class="tele-panel-topbar"><div class="tele-panel-title">Dashboard</div><div class="tele-panel-topbar-right"></div></div>');if(!loading){container.append('<div class="tele-panel-subtitle"><div class="tele-panel-subtitle-text">Traffic and Alerts Trends</div><div class="tele-panel-subtitle-right"></div></div>');var trafficToggle=$('<div>').toggleFlip({left_value:'Alerts',right_value:'Traffic',flipped:that.map_mode=='traffic',flip:function(x,y){that.map.empty();that.map.append(telepath.loader);if(x){telepath.ds.get('/dashboard',{mode:'map_traffic'},function(data){telepath.dashboard.data.items.map=data.items.traffic;that.map.vMap({data:data.items.traffic,title:'Traffic over time'});});}else{telepath.ds.get('/dashboard',{mode:'map_alerts'},function(data){telepath.dashboard.data.items.map=data.items.map;that.map.vMap({data:data.items.map,title:'Alerts over time'});});}}});var realtimeToggle=$('<div>').toggleFlip({left_value:'Static',right_value:'Realtime',flip:function(x,y){if(x){that.graph.hide();that.graph_realtime.show();telepath.realtime.start(that.graph_realtime);$('.tele-panel-subtitle-text').html('Realtime Monitor');}else{that.graph.show();that.graph_realtime.hide();telepath.realtime.stop();$('.tele-panel-subtitle-text').html('Traffic and Alerts Trends');}}}).hide();$('.tele-panel-dashboard .tele-panel-subtitle-right').append(realtimeToggle);$('.tele-panel-dashboard .tele-panel-subtitle-right').append(trafficToggle);var graph_div=$('<div>').css("background-color","#304f68").css("width","100%");var empty_div=$('<div>').css("clear","both");this.map=$('<div>');this.graph=$('<div>');graph_div.append(this.map);graph_div.append(this.graph);graph_div.append(empty_div);container.append(graph_div);this.graph_realtime=$('<div>').addClass('tele-graph-realtime');container.append(this.graph_realtime);}else{container.append(telepath.loader);}},resize:function(){if($('.tele-panel-dashboard').children().size()==0)return;var width=$(window).width();var current_div=parseInt(100/this.divs);if(width<1025){$('.tele-map').width('100%');$('.tele-graph').width('100%');$('.tele-dashboard-block').width('100%');}else{$('.tele-map').width('33%');$('.tele-graph').width('67%');$('.tele-dashboard-block').css({'display':'inline-block'});$('.tele-dashboard-block').width(current_div+'%');$('.tele-dashboard-block.cases').css({'float':'left'});$('.tele-dashboard-block.suspects').css({'float':'right'});}},updateRefreshInterval:function(interval){if(interval){this.refreshInterval=interval;}
this.cmdRefreshValue.html(this.refreshInterval+'m');if(this.refreshTimer){clearInterval(this.refreshTimer);}
this.refreshTimer=setInterval(function(){telepath.dashboard.refresh();},this.refreshInterval*60000);},showFilters:function(){var that=this;var container=$('.tele-panel-dashboard .tele-panel-topbar-right');container.empty();var filterApps=$('<div>').appSelect({callback:function(app_id){$('.jqvmap-label').hide();$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.dashboard.refresh(function(){$('.tele-icon-loader',filterApps).addClass('tele-icon-application').removeClass('tele-icon-loader');});}});var cmdRefresh=$('<div>').addClass('tele-panel-dashboard-refresh');var cmdRefreshText=$('<a>').attr('href','#').addClass('tele-panel-dashboard-refresh-text').html('Refresh Rate');this.cmdRefreshValue=$('<a>').attr('href','#').addClass('tele-panel-dashboard-refresh-value').html(this.refreshInterval+'m');var cmdRefreshButton=$('<a>').attr('href','#').addClass('tele-panel-dashboard-refresh-button').html('&nbsp;');cmdRefresh.append(cmdRefreshText).append(this.cmdRefreshValue).append(cmdRefreshButton);cmdRefreshButton.click(function(){if(!telepath.dashboard.loading){$(this).addClass('loader');var that=this;telepath.dashboard.refresh(function(){$(that).removeClass('loader');});}});var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.dashboard.reloadFlag=Date.now();cmdRefreshButton.addClass('loader');telepath.dashboard.refresh(function(){cmdRefreshButton.removeClass('loader');});}});var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});container.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps).append('<div class="tele-navsep"></div>').append(cmdRefresh);$('.tele-panel-dashboard-refresh-value').click(function(){$('body').append('<div class="tele-popup tele-refreshrate-popup"><input class="tele-refreshrate-slider" /></div>');if($(".tele-refreshrate-popup").css('display')=='block'){$(".tele-refreshrate-popup").fadeOut('fast',function(){$(this).remove();});return;}
var top=$(this).offset().top+$(this).height()+20;var left=($(this).offset().left+($(this).width()/2))-($(".tele-daterange-popup").width()/2)-150;$(".tele-refreshrate-popup").css({top:top,left:left});$(".tele-refreshrate-popup").fadeIn();that.refresh_slider=$(".tele-refreshrate-slider").slider({orientation:"horizontal",max:60,min:1,value:parseInt(telepath.dashboard.refreshInterval),}).on('slide',function(ev){var value=telepath.dashboard.refresh_slider.val();telepath.dashboard.updateRefreshInterval(value);});});}}
telepath.realtime={container:false,timer:false,count:0,options:{legend:{show:true,color:'yellow',labelBoxBorderColor:"white",position:"sw",backgroundColor:'white',backgroundOpacity:1,margin:10},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'},color:'yellow'},xaxis:{mode:"time",tickFormatter:function(v,axis){var date=new Date(v);var hours=date.getHours()<10?"0"+date.getHours():date.getHours();var minutes=date.getMinutes()<10?"0"+date.getMinutes():date.getMinutes();var seconds=date.getSeconds()<10?"0"+date.getSeconds():date.getSeconds();return hours+":"+minutes+":"+seconds;},axisLabel:"Time",axisLabelUseCanvas:true,axisLabelFontSizePixels:12,axisLabelFontFamily:'Verdana, Arial',axisLabelPadding:10},yaxes:[{axisLabel:"Dropped",axisLabelUseCanvas:true,axisLabelFontColor:'#cecece',font:{family:'Arial',color:'white',size:11,weight:"normal"},axisLabelPadding:6,min:0},{position:"right",axisLabel:"Requests",axisLabelUseCanvas:true,axisLabelFontColor:'#cecece',font:{family:'Arial',color:'white',size:11,weight:"normal"},axisLabelPadding:6},{position:"right",axisLabel:"Packets",axisLabelUseCanvas:true,axisLabelFontColor:'#cecece',font:{family:'Arial',color:'white',size:11,weight:"normal"},axisLabelPadding:14}],grid:{borderColor:'#446077',borderWidth:1},},offsets:{init:false,packets:0,loss:0,requests:0},start:function(container){this.container=container;var totalPoints=60;var updateInterval=1000;var now=new Date().getTime()-(totalPoints*updateInterval);this.data={packets:[],loss:[],requests:[]};for(var i=0;i<totalPoints;i++){var temp=[now+=updateInterval,0];this.data.packets.push(temp);this.data.loss.push(temp);this.data.requests.push(temp);}
var dataset=[{label:"Packets:",data:this.data.packets,lines:{fill:true,lineWidth:1.2},color:"#6ab789"},{label:"Dropped:",data:this.data.loss,lines:{lineWidth:1.2},color:"#64a5bc",yaxis:3},{label:"Requests:",data:this.data.requests,color:"#986da0",bars:{show:true},yaxis:2}];$.plot($(this.container),dataset,this.options);this.timer=setInterval(this.getData,updateInterval);},stop:function(){clearInterval(this.timer);this.container.empty();},tick:function(){telepath.realtime.count=telepath.realtime.count+1;},getData:function(){$.ajaxSetup({cache:false});$.ajax({url:telepath.controllerPath+"/realtime/index",dataType:'json',success:function(_data){_data['capture.kernel_packets']=parseInt(_data['capture.kernel_packets']);_data['capture.kernel_drops']=parseInt(_data['capture.kernel_drops']);if(!telepath.realtime.offsets.init){telepath.realtime.offsets.packets=_data['capture.kernel_packets'];telepath.realtime.offsets.loss=_data['capture.kernel_drops'];telepath.realtime.offsets.requests=_data['cmd_set'];telepath.realtime.offsets.init=true;return;}
telepath.realtime.data.packets.shift();telepath.realtime.data.loss.shift();telepath.realtime.data.requests.shift();var now=new Date().getTime();telepath.realtime.data.packets.push([now,_data['capture.kernel_packets']-telepath.realtime.offsets.packets]);telepath.realtime.data.loss.push([now,_data['capture.kernel_drops']-telepath.realtime.offsets.loss]);telepath.realtime.data.requests.push([now,_data.cmd_set-telepath.realtime.offsets.requests]);var dataset=[{label:"Dropped",data:telepath.realtime.data.loss,lines:{lineWidth:1.2},color:"#640000"},{label:"Packets",data:telepath.realtime.data.packets,lines:{fill:true,lineWidth:1.2},color:"#986da0",yaxis:3},{label:"Requests",data:telepath.realtime.data.requests,color:"#6ab789",yaxis:2}];$.plot($(telepath.realtime.container),dataset,telepath.realtime.options);telepath.realtime.offsets.packets=_data['capture.kernel_packets'];telepath.realtime.offsets.loss=_data['capture.kernel_drops'];telepath.realtime.offsets.requests=_data['cmd_set'];},error:function(){}});$.ajaxSetup({cache:true});}};telepath['case']={rowFormatter:function(item,mode){if(item._source){item=item._source}
item.data=item.case_data.details;var details=[];$.each(item.data,function(i,condition){details.push({key:condition.type,value:telepath.formatConditionBrief(false,condition)});});if(!item.checkable){item.checkable=false;}
if(!item.favorites){item.favorites=false;item.favorite=false;}
if(mode=='dashboard'){var result={details:details,dataID:item.name,icon:'case',title:item.name,count:item.count,time:item.last_time,favorite:item.favorite};}else{var result={checkable:item.checkable,favorites:item.favorites,favorite:item.favorite,dataID:item.name,icon:'case',title:item.name,count:item.count,updating:item.case_data.updating,details:details,time:item.last_time};}
return result;}}
telepath.caseOverlay={addCase:function(){this.initUI({id:'new',case_data:{case_name:'New Case',details:[]}});},editCase:function(data){this.initUI(data);},initUI:function(data){var that=this;this.data=data;telepath.overlay.init('case-edit',data.case_data.case_name);$('.tele-overlay').height(860).trigger('resize');var caseName=$('<div>').teleInput({label:'Name',value:data.id=='new'?'':data.case_data.case_name,disabled:data.id=='new'?false:true});telepath.overlay.contentEl.append(caseName);var title=$('<div>').addClass('tele-title-1').text('Traffic matching following conditions will be aggregated into this case');telepath.overlay.contentEl.append(title);var cond=$('<div>').conditionList({data:data.case_data.details});telepath.overlay.contentEl.append(cond);var btnContain=$('<div>').addClass('tele-button-container');var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');btnContain.append(saveBtn).append(cancelBtn);telepath.overlay.contentEl.append(btnContain);saveBtn.click(function(){var json=cond.data('tele-conditionList').getJSON();var name=caseName.data('tele-teleInput').input.val();caseName.removeClass('error');if(name.length==0||name.length>32){caseName.addClass('error');return;}
if(json.length==0){telepath.dialog({title:'Case Editor',msg:'Must have at least one condition'});return;}
$('.tele-icon-case-edit').append(telepath.loader).css({backgroundColor:'#555'});if(that.data.id=='new'){telepath.ds.get('/cases/add_case',{name:name,case_data:JSON.stringify(json)},function(data){if(data.items.existing){telepath.dialog({title:'Case Editor',msg:'Already have a case with this name'});return;}
telepath.overlay.destroy();telepath.cases.refresh(function(){});telepath.ds.get('/cases/flag_requests_by_cases',{case:[name],range:false,method:'add'},function(data){telepath.cases.refresh(function(){});});});}else{telepath.ds.get('/cases/set_case',{name:name,case_data:JSON.stringify(json)},function(data){if(data.existing){telepath.dialog({title:'Case Editor',msg:'Already have a case with this name'});return;}
telepath.overlay.destroy();telepath.cases.init();telepath.ds.get('/cases/flag_requests_by_cases',{case:[name],range:false,method:'update'},function(data){telepath.cases.refresh(function(){});});});}});cancelBtn.click(function(){telepath.overlay.destroy();});}}
telepath.casePanel={data:{},sort:'date',dir:false,init:function(caseID){$('.tele-panel-case').remove();this.container=$('<div>').addClass('tele-panel-case');$('.tele-panel-cases').append(this.container);$('.tele-panel-cases-inner').hide();this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html('Loading Case # '+caseID);this.container.append(this.panelTopBar);this.container.append(telepath.loader);this.getData(caseID);},refresh:function(callback){$(".tele-case-graph, .tele-wrapper, .tele-panel-subtitle, .tele-infoblock, .mCustomScrollbar, .tele-loader",this.container).remove();this.container.append(telepath.loader);telepath.ds.get('/cases/get_case',{start:telepath.range.start,end:telepath.range.end,apps:telepath.appFilter,sort:this.sort,dir:this.dir,cid:this.caseID},function(data){telepath.casePanel.loadData(data);if(typeof(callback)=='function'){callback();}});},getData:function(caseID){this.caseID=caseID;this.refresh();},loadData:function(data){var that=this;this.data=data;$('.tele-loader',this.container).remove();this.panelTopBar.empty();this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html(this.data['case']['case_data']['case_name']+' | '+this.data.count+' Sessions');this.favEl=$('<a>').cb({icon:'favorites',checked:data['case']['favorite']=='1',callback:function(widget){telepath.ds.get('/cases/set_case_fav',{cid:that.caseID,favorite:widget.options.checked},function(data){});}});this.panelTopBar.prepend(this.favEl);this.caseDesc=$('<div>').addClass('tele-panel-description');$.each(data['case']['case_data']['details'],function(i,condition){var cTitle=$('<span>').html(condition.type+':&nbsp;');var cData=$('<span>').html(telepath.formatConditionBrief(false,condition));that.caseDesc.append(cTitle).append(cData).append('<span>&nbsp;|&nbsp;</span>');});$('span:last',that.caseDesc).remove();this.goBack=$('<a>').attr('href','#').addClass('tele-panel-case-close').html('|&nbsp;Back to all cases');this.panelTopBar.append(this.goBack);this.editCase=$('<div>').btn({icon:'caseConfig',text:'Edit Case',callback:function(){telepath.caseOverlay.editCase(that['data']['case']);}});this.panelTopBar.append(this.editCase);var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'},],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});this.panelTopBar.append('<div class="tele-navsep"></div>');this.panelTopBar.append(sortRadios);this.panelTopBar.append(this.caseDesc);this.goBack.click(function(){$('.tele-panel-case').remove();telepath.cases.init();});var chartData=[{label:"random",data:this.data.chart,color:'#5191D1'}];var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#446077'}},yaxis:{alignTicksWithAxis:true,labelWidth:30,ticks:5,color:'#446077',font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"}},selection:{mode:"x"},xaxis:{alignTicksWithAxis:true,tickColor:'#cccccc',tickLength:7,font:{family:'Arial',color:'#cccccc',size:11,weight:"normal"},mode:"time",timezone:"browser",timeformat:"%d/%m"},grid:{borderColor:'#446077',borderWidth:1}};var caseGraph=$('<div>').addClass('tele-case-graph');var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;that.refresh();}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.cases.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});this.container.append(caseGraph);caseGraph.flotGraph({data:chartData,options:options});var graphTitle=$('<div>').addClass('tele-graph-title').html('Case Sessions');caseGraph.prepend(graphTitle).prepend(filterDateRange).prepend('<div class="tele-navsep"></div>').prepend(filterApps);this.panelSubBar=$('<div>').addClass('tele-panel-subtitle');this.container.append(this.panelSubBar);var checkallEl=$('<a>').cb({callback:function(e){$('.tele-panel-cases .tele-list li.tele-listitem').listitem("option","checked",e.options.checked);}});this.panelSubBar.append(checkallEl);this.list=$('<div>').addClass('tele-case-alerts-block');this.listWrap=$('<div>').addClass('tele-wrapper').append(this.list).css({display:'inline-block',float:'left'}).width('65%');this.container.append(this.listWrap);this.list.teleList({data:this.data.items,formatter:function(row){return that.formatter(row);}});this.similarsList=$('<div>').addClass('tele-case-similar-block');this.similarsListWrap=$('<div>').addClass('tele-wrapper').append(this.similarsList).css({display:'inline-block',float:'left'}).width('35%');this.container.append(this.similarsListWrap);if(this.data.similars){this.similarsList.teleList({title:'Related Sessions',data:this.data.similars.items,formatter:function(row){return that.formatter(row);}});}
$(window).resize(function(){that._resize()});},formatter:function(item){var that=this;var result={};result.title=item.title!=''?item.title:item.display_path;result.progbar=true;result.time=item.date;result.timeFormat='h:i A';result.offset=20;result.icon='case';result.count=item.count;result.itemID=item.sid;result.details=[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'city',value:item.city},{key:'user',value:item.user_id},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'user',value:item.user}];result.raw=item;var alert=item.alert_count>0;result.progbarValue=parseInt(item.avg_score);if(alert!==false){result.icon='alert';result.description=alert.name;result.progbarValue=alert.numeric_score;}else{if(item.avg_score>85){result.icon='suspect_red';}}
return result;},_resize:function(){var height=$(window).height();$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-case-graph').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-panel-case .tele-block').height(offset-40);$('.tele-panel-case .tele-block .tele-list').height(offset-70);$('.tele-panel-case .tele-case-alerts-block .tele-list').mCustomScrollbar("update");$('.tele-panel-case .tele-case-similar-block .tele-list').mCustomScrollbar("update");}};telepath.cases={sort:'date',dir:false,data:[],searchString:'',loading:false,init:function(){this.drawUI();this.refresh();},refresh:function(callback){this.container=$('.tele-panel-cases .tele-panel-cases-inner');$('.tele-block, .tele-loader',this.container).remove();this.container.append(telepath.loader);var that=this;telepath.ds.get('/cases/get_cases',{search:this.searchString,sort:this.sort,dir:this.dir},function(data){that.loading=false;var cases=[]
var index=0;for(index=0;index<data.items.length;++index){if(data.items[index].name)
{cases.push(data.items[index]);}}
that.setData(cases);if(typeof(callback)=='function'){callback();}});},setData:function(data){this.container=$('.tele-panel-cases .tele-panel-cases-inner');var that=this;this.data=data;$('.tele-block, .tele-loader',this.container).remove();this.list=$('<div>');this.container.append(this.list);this.list.teleList({data:this.data,formatter:function(item){item.checkable=true;item.favorites=true;item.favorite=item.case_data.favorite=='1';return telepath['case'].rowFormatter(item);},callbacks:telepath.listitem.generic.callbacks_case});this.panelTitle.html(this.data.length+' Cases');setTimeout(function(){that._resize();},0);$(window).resize(function(){that._resize()});},_resize:function(){if($('.tele-panel-cases').children().size()==0)return;var height=$(window).height();$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-panel-cases .tele-block').height(offset-20);$('.tele-panel-cases .tele-block .tele-list').height(offset-50);$('.tele-panel-cases .tele-list').mCustomScrollbar("update");},drawUI:function(){var that=this;$('.tele-panel-cases').empty();var container=$('<div>').addClass('tele-panel-cases-inner');$('.tele-panel-cases').append(container);var panelTopBar=$('<div>').addClass('tele-panel-topbar');var panelSubBar=$('<div>').addClass('tele-panel-subtitle');var panelTitle=$('<div>').addClass('tele-panel-title');var panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');panelTopBar.append(panelTitle).append(panelTopBarRight);this.panelTitle=panelTitle;var addBtn=$('<div>').btn({icon:'plus',text:'New Case',callback:function(){if(telepath.access.admin||telepath.access.perm.Cases_add){telepath.caseOverlay.addCase();}else{telepath.dialog({msg:'Access denied. No permissions to add new Case group.'});};}});this.panelTitle.after(addBtn);container.append(panelTopBar);container.append(panelSubBar);var checkallEl=$('<a>').teleCheckbox({callback:function(e){if(that.list){that.list.data('tele-teleList').toggleAll(e.options.checked);}}});panelSubBar.append(checkallEl);var deleteBtn=$('<div>').btn({icon:'delete',text:'Delete',callback:function(){if(that.list){var selected=that.list.data('tele-teleList').getSelected();if(selected.length==0){telepath.dialog({msg:'No Case selected.'});}else{if(telepath.access.admin||telepath.access.perm.Cases_del){telepath.dialog({type:'dialog',title:'Confirm',msg:'Remove '+selected.length+' case(s)?',callback:function(){telepath.ds.get('/cases/del_cases',{cids:selected},function(data){that.setData(data.items);telepath.ds.get('/cases/flag_requests_by_cases',{case:selected,range:false,method:'delete',repeat:false},function(data){});});}});}else{telepath.dialog({msg:'Access denied. No permissions to delete Cases.'});};}}}});panelSubBar.append(deleteBtn);var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'name',icon:'arrow',tip:'ABC'},{id:'count',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.loading){return}
that.loading=true;if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});var container=$('.tele-panel-cases .tele-panel-topbar-right');var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;telepath.cases.refresh(function(){});}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.cases.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});container.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);}};telepath.alert={grabNames:function(arr){var result='';$.each(arr,function(i,x){result=result+x.key+', ';});if(result.length>0){result=result.substr(0,result.length-2);}
return result;},rowFormatter:function(row,mode){if(row._source){row=row._source}
if(mode=='dashboard'){var identification=(row.user!=''?{key:'user',value:row.user}:{key:'IP',value:row.ip_orig});return{raw:row,itemID:row.sid,icon:'alert',checkable:row.checkable,count:row.alerts_count,progbar:true,progbarValue:row.ip_score,time:row.date,title:telepath.alert.grabNames(row.alerts_names),details:[identification,{key:'country',value:row.country},{key:'host',value:telepath.alert.grabNames(row.host)},]}}else{return{raw:row,itemID:row.sid,icon:'alert',checkable:row.checkable,count:row.alerts_count,progbar:true,progbarValue:row.ip_score,time:row.date,title:telepath.alert.grabNames(row.alerts_names),details:[{key:'IP',value:row.ip_orig},{key:'country',value:row.country},{key:'city',value:row.city},{key:'host',value:telepath.alert.grabNames(row.host)},{key:'actions',value:row.actions_count},{key:'cases',value:row.cases_count},{key:'user',value:row.user}]}};},filters:{H:true,P:true,G:true,J:true,X:true,},getSeverity:function(numeric_score){var result=$('<div>').addClass('tele-severity');if(numeric_score>0&&numeric_score<70){result.addClass('tele-severity-low').text('Low');}
if(numeric_score>=70&&numeric_score<90){result.addClass('tele-severity-medium').text('Medium');}
if(numeric_score>=90&&numeric_score<100){result.addClass('tele-severity-critical').text('Critical');}
result.append('&nbsp;<span>('+numeric_score+')</span>');return result;},lookupAction:function(business_id){for(x in telepath.actionList){if(telepath.actionList[x].id=business_id){return telepath.actionList[x].name;}}
return'Browsing';},lookupRequest:function(RID){for(x in this.data.requests){var req=this.data.requests[x];if(req.RID==RID){return req;}}
return false;},lookupAlert:function(RID){for(x in this.data.alerts){var alert=this.data.alerts[x];if(alert.RID==RID){return alert;}}
return this.data.alerts[0];},data:[],updateSelected:function(){$('.selected',this.actionsContainer).removeClass('selected');var newSelected=$("li:nth-child("+(this.selectedIndex+1)+")",this.actionsContainer);$('.tele-listitem-inner',newSelected).addClass('selected');var dataID=newSelected.listitem('option','dataID');this.expandRequest(dataID);$(this.actionsContainer).mCustomScrollbar("scrollTo","li:nth-child("+(this.selectedIndex+1)+")");},scrollUp:function(){if(this.selectedIndex>0){this.selectedIndex--;}
this.updateSelected();},scrollDown:function(){if(this.selectedIndex<this.data.requests.length){this.selectedIndex++;}
this.updateSelected();},keyDown:function(e){if(e.keyCode=='38'){e.preventDefault();telepath.alert.scrollUp();}
if(e.keyCode=='40'){e.preventDefault();telepath.alert.scrollDown();}},destroy:function(){$(document).unbind('overlay_destroy',telepath.alert.destroy);$(document).unbind('keydown',telepath.alert.keyDown);},initTools:function(){this.archiveAlert=$('<div>').btn({icon:'archive',text:'Archive Alert',callback:function(){}});this.overlay.headerEl.append(this.archiveAlert);this.overlay.headerEl.append('<div class="tele-navsep"></div>');this.moveTo=$('<div>').dropdown({icon:'moveTo',value:'Move To',callback:function(){}});this.overlay.headerEl.append(this.moveTo);this.overlay.headerEl.append('<div class="tele-navsep"></div>');this.editRule=$('<div>').btn({icon:'edit',text:'Edit Rule',callback:function(){}});this.overlay.headerEl.append(this.editRule);},initSingle:function(RID){$(document).unbind('keydown',telepath.alert.keyDown);$(document).bind('keydown',telepath.alert.keyDown);$(document).bind('overlay_destroy',telepath.alert.destroy);telepath.overlay.init('alerts','Loading ...');this.overlay=telepath.overlay;this.initTools();telepath.ds.get('/alerts/get_alert',{RID:RID},function(data){telepath.alert.showAlert(data.items);});},init:function(alertID,index){$(document).unbind('keydown',telepath.alert.keyDown);$(document).bind('keydown',telepath.alert.keyDown);$(document).bind('overlay_destroy',telepath.alert.destroy);telepath.overlay.init('alerts','Loading ...');this.overlay=telepath.overlay;this.loadAlert(alertID);this.pagination=$('<div>').pagination({current:index,count:telepath.alerts.data.alerts.length,name:'Alert',callback:function(itemIndex){var alertID=telepath.alerts.data.alerts[itemIndex].id;telepath.alert.loadAlert(alertID);}});this.overlay.headerEl.append(this.pagination);this.overlay.headerEl.append('<div class="tele-navsep"></div>');this.initTools();},loadAlert:function(alertID){this.alertID=alertID;this.overlay.titleEl.html('Loading alert #'+this.alertID);this.overlay.contentEl.empty().append(telepath.loader);var alertItem=false;for(x in telepath.alerts.data.alerts){if(telepath.alerts.data.alerts[x].id==alertID){alertItem=telepath.alerts.data.alerts[x];break;}}
if(!alertItem){return;}
telepath.ds.get('/alerts/get_alert',{SID:alertItem.SID,epoch:alertItem.date},function(data){telepath.alert.showAlert(data.items);});},formatData:function(item){var that=this;var result={};result.title=item.title!=''?item.title:item.display_path;result.progbar=true;result.time=item.date;result.timeFormat='h:i A';result.offset=20;result.icon='suspect';result.dataID=item.sid;$.each(telepath.alert.data.alerts,function(i,alert){if(alert.RID==item.RID){result.icon='suspect_red';}});result.progbarValue=item.ip_score;result.callback=function(widget,el){$('.selected',that.actionsContainer).removeClass('selected');$('.tele-listitem-inner',widget.element).addClass('selected');that.expandRequest(widget.options.dataID);};return result;},showAlert:function(data){var container=this.overlay.contentEl;container.empty();var that=this;this.selectedIndex=0;telepath.alert.data=data;this.alertLeft=$('<div>').addClass('tele-alert-left');this.alertMid=$('<div>').addClass('tele-alert-mid');this.alertRight=$('<div>').addClass('tele-alert-right');container.append(this.alertLeft).append(this.alertMid).append(this.alertRight);this.overlay.titleEl.html('Alert #'+this.alertID);var reqStats={'All':data.requests.length,'Alerts':data.alerts.length,'Actions':0}
$.each(data.requests,function(i,request){if(request.business_id&&request.business_status&&request.business_status=='2'){reqStats['Actions']++;}});var statsEl=$('<div>').addClass('tele-alert-stats');$.each(reqStats,function(key,stat){var statEl=$('<div>').addClass('tele-alert-stat');var statKey=$('<div>').addClass('tele-alert-stat-key').html(key);var statValue=$('<div>').addClass('tele-alert-stat-value').html(stat);statEl.append(statKey).append(statValue);statsEl.append(statEl);});this.alertLeft.append(statsEl);var durationEl=$('<div>').addClass('tele-alert-duration');var durationStartEl=$('<div>').addClass('tele-alert-duration-start');var durationStartLbl=$('<div>').addClass('tele-alert-duration-lbl').html('Started:');var durationStartVal=$('<div>').addClass('tele-alert-duration-val').html(date_format('d/m/y | h:i A',data.requests[0].date));var durationEndEl=$('<div>').addClass('tele-alert-duration-end');var durationEndLbl=$('<div>').addClass('tele-alert-duration-lbl').html('Ended:');var durationEndVal=$('<div>').addClass('tele-alert-duration-val').html(date_format('d/m/y | h:i A',data.requests[data.requests.length-1].date));durationStartEl.append(durationStartLbl).append(durationStartVal);durationEndEl.append(durationEndLbl).append(durationEndVal);durationEl.append(durationStartEl).append(durationEndEl);this.alertLeft.append(durationEl);this.actionsContainer=$('<div>').addClass('tele-alert-actions');this.alertLeft.append(this.actionsContainer);this.requestDetails=$('<div>').addClass('tele-alert-details').addClass('tele-popup');this.alertMid.prepend(this.requestDetails);this.lastAction=-1;this.printed=0;for(x in data.requests){var req=data.requests[x];if(req.business_id!=this.lastAction){this.actionContainer=$('<div>').addClass('tele-alert-action');this.actionContainerIcon=$('<div>').addClass('tele-alert-action-icon').addClass('tele-icon').addClass('tele-icon-suspect');this.actionContainerTitle=$('<div>').addClass('tele-alert-action-title').text(this.lookupAction(req.business_id));this.newList=$('<ul class="tele-list">');this.actionContainer.append(this.actionContainerIcon).append(this.actionContainerTitle).append(this.newList);$(this.actionsContainer).append(this.actionContainer);this.lastAction=req.business_id;}
var item=this.formatData(req);var newListItem=$('<li>').attr('id','alert-item-'+x);this.newList.append(newListItem);newListItem.listitem(item);this.printed++;}
$(this.actionsContainer).mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:150,callbacks:{onTotalScrollOffset:50,onTotalScroll:function(){return;var newMax=that.printed+9;var offset=0;for(x in data.requests){if(offset<that.printed+1){offset++;continue;}
var req=that.formatData(data.requests[x]);var newListItem=$('<li>').attr('id','alert-item-'+x);$(that.newList).append(newListItem);newListItem.listitem(req);if(that.printed>newMax){break;}
that.printed++;}
that.updateSelected();$(that.actionsContainer).mCustomScrollbar("update");}}});this.updateSelected();},expandRequest:function(RID){var that=this;this.requestDetails.empty();this.requestDetails.append(RID);this.requestDetails.append(telepath.loader);var req=this.lookupRequest(RID);if(req){this.requestInfo=req;}else{return;}
telepath.ds.get('/similarities/',{param_type:'request',param_id:RID},function(data){that.similaritiesList=$('<div>');that.similaritiesList.teleList({title:'Similar Requests',titleCallback:function(){},data:data.items,formatter:function(item){return{icon:'suspect',time:item.date,itemID:item.RID,progbar:true,progbarValue:parseInt(item.ip_score*100),details:[{key:'country',value:item.country},{key:'IP',value:item.IP}]};},callbacks:{click:function(widget){},hover_in:function(el,item){},hover_out:function(el,item){}}}).appendTo(that.requestDetails);});telepath.ds.get('/alerts/get_session_flow_params',{sid:req.SID,rids:RID,epoch:req.date},function(data){that.expandRequestData(data);});},expandRequestData:function(data){$('.loader',this.requestDetails).remove();this.requestData=data.items;this.printParams();},printParams:function(container){var container=this.requestDetails;container.empty();this.printParamsFilters(container);this.printAlertDetails(container);this.printParamsTable(container);this.printAlertInfo(this.alertRight);},printParamsFilters:function(container){var that=this;this.filtersContainer=$('<div>').addClass('tele-alert-filters');container.append(this.filtersContainer);var filters=[{type:'H',label:'Headers'},{type:'G',label:'Get'},{type:'P',label:'Post'},{type:'J',label:'Json'},{type:'X',label:'XML'}];$.each(filters,function(i,filter){var filter_el=$('<div>').teleCheckbox({checked:telepath.alert.filters[filter.type],label:filter.label,inputFirst:true,callback:function(widget){telepath.alert.filters[filter.type]=widget.options.checked;that.printParams();}});that.filtersContainer.append(filter_el);});},printAlertDetails:function(container){this.alertDetails=$('<div>').addClass('tele-alert-details-info');container.append(this.alertDetails);this.alertDetailsTitle=$('<div>').addClass('tele-alert-details-info-title').text(this.lookupAction(this.requestInfo.business_id));this.alertDetailsTimeWrap=$('<div>').addClass('tele-alert-details-info-time-wrap');this.alertDetailsTimeLabel=$('<div>').addClass('tele-alert-details-info-time-label').text('Request time:');this.alertDetailsTime=$('<div>').addClass('tele-alert-details-info-time').text(date_format('d/m/y | H:i:s',this.requestInfo.date));this.alertDetailsTimeWrap.append(this.alertDetailsTimeLabel).append(this.alertDetailsTime);var severityPercent=parseInt(this.requestData.avg_score*100)+'%';this.alertSeverityWrap=$('<div>').addClass('tele-alert-severity-wrap');this.alertSeverityLabel=$('<div>').addClass('tele-alert-severity-label').text('Severity');this.alertSeverityPercent=$('<div>').addClass('tele-alert-severity-percent').text(severityPercent);this.alertSeverityProgBar=$('<div>').addClass('tele-alert-severity-progbar');this.alertSeverityProgValue=$('<div>').addClass('tele-alert-severity-progbar-value').css({width:severityPercent});this.alertSeverityWrap.append(this.alertSeverityLabel).append(this.alertSeverityPercent).append(this.alertSeverityProgBar);this.alertSeverityProgBar.append(this.alertSeverityProgValue);this.alertDetails.append(this.alertSeverityWrap).append(this.alertDetailsTitle).append(this.alertDetailsTimeWrap);},printAlertInfo:function(container){container.empty();var alert=this.lookupAlert(this.requestInfo.RID);this.alertInfo=$('<div>').addClass('tele-alert-info');this.alertInfoTitle=$('<div>').addClass('tele-alert-info-title').text('Alert Info');this.alertInfoLabel=$('<div>').addClass('tele-alert-info-label').text('Description:');this.alertInfoDesc=$('<div>').addClass('tele-alert-info-description').text(alert.description);this.alertInfoTable=$('<div>').addClass('tele-alert-info-table');function getRow(lbl,data){var row=$('<tr>');var td_1=$('<td>').html(lbl).addClass('tele-alert-info-key');var td_2=$('<td>').html(data).addClass('tele-alert-info-value');row.append(td_1).append(td_2);return row;}
var table=this.alertInfoTable;table.append(getRow('Time:',date_format('d/m/y | H:i:s',alert.date)));table.append(getRow('Severity:',this.getSeverity(alert.numeric_score)));table.append(getRow('Applications:',this.requestInfo.app_domain));table.append(getRow('IP:',alert.ip));table.append(getRow('Location:','<span class="flag flag-'+this.requestInfo.country+'"></span>'+'<span class="tele-country">'+telepath.countries.a2n(this.requestInfo.country)+'</span>'));if(alert.user&&alert.user!=''){table.append(getRow('User:',alert.user));}
this.alertInfo.append(this.alertInfoTitle).append(this.alertInfoLabel).append(this.alertInfoDesc).append(this.alertInfoTable);container.append(this.alertInfo);},printParamsTable:function(container){var tableWrap=$('<div>').addClass('tele-alert-params-table-wrap');var table=$('<table>').addClass('tele-alert-params-table');$.each(this.requestData.params,function(i,param){var param_display=telepath.alert.filters[param.att_source];if(param_display){var row=$('<tr>');var param_name=param.att_alias!=''?param.att_alias:param.name;var col_name=$('<td>').addClass('tele-param-name').html(param.att_name);var col_data=$('<td>').addClass('tele-param-data').html(param.data);var col_score=$('<td>').addClass('tele-param-score').html(parseInt(param.attribute_score_normal)+'%');if(parseInt(param.attribute_score_normal)){col_score.addClass('severe');col_data.addClass('severe');}
row.append(col_name).append(col_data).append(col_score);table.append(row);}});container.append(tableWrap);tableWrap.append(table);$(tableWrap).mCustomScrollbar();}};;telepath.alerts={sort:'date',dir:false,data:[],searchString:'',filter:[],allData:true,loading:false,init:function(){var that=this;var container=$('.tele-panel-alerts');container.empty();var panelTopBar=$('<div>').addClass('tele-panel-topbar');var panelSubBar=$('<div>').addClass('tele-panel-subtitle');var panelTitle=$('<div>').addClass('tele-panel-title');var panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');panelTopBar.append(panelTitle).append(panelTopBarRight);panelTitle.html('Loading Alerts');this.panelTitle=panelTitle;container.append(panelTopBar).append(panelSubBar)
var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'},],selected:this.sort,callback:function(e,id){if(that.loading){return}
that.loading=true;if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});var searchAlerts=$('<div>').teleSearch({callback:function(e,txt){telepath.alerts.searchString=txt;}});var resetInput=$('<a>').addClass('icon-delete-input2').attr('id','remove-button').click(function(){$('.tele-panel-alerts .tele-search-input').val('');telepath.alerts.searchString='';telepath.alerts.refresh();});panelSubBar.append(searchAlerts);var container=$('.tele-panel-alerts .tele-panel-topbar-right');container.empty();var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.range.start=start;telepath.range.end=end;telepath.alerts.refresh();}});var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.alerts.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});container.append(sortRadios).append('<div class="tele-navsep"></div>').append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);var typingTimer;var doneTypingInterval=1000;$('.tele-panel-alerts .tele-search-input').keyup('input',function(){clearTimeout(typingTimer);if($('.tele-panel-alerts .tele-search-input').val()){typingTimer=setTimeout(function(){telepath.alerts.searchString=$('.tele-panel-alerts .tele-search-input').val();that.input();},doneTypingInterval);}});$(".tele-search").on("click",'.icon-delete-input2',function(event){clearTimeout(typingTimer);that.searchString='';$(".tele-panel-alerts .tele-search-input").prop("value",telepath.alerts.searchString);that.input();});if(telepath.alerts.searchString){$('.tele-panel-alerts .tele-search-input').prop("value",telepath.alerts.searchString);that.input();}
else{telepath.alerts.refresh();}},input:function(){var that=this;var icon=$("#search-button");if(telepath.alerts.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.refresh()},refresh:function(callback){var container=$('.tele-panel-alerts');$('.tele-alerts-block, .tele-alert-graphs-block, .tele-loader',container).remove();container.append(telepath.loader);telepath.ds.get('/alerts/index',{sort:this.sort,dir:this.dir,search:this.searchString,filters:this.filter},function(data){telepath.alerts.loading=false;telepath.alerts.setData(data.items);if(callback&&typeof(callback)=='function'){callback();}});},setData:function(data){telepath.alerts.data=data;var that=this;var container=$('.tele-panel-alerts');this.container=container;$('.tele-alerts-block, .tele-alert-graphs-block, .tele-loader',container).remove();if(data.alerts.total==0){this.panelTitle.html('No Data');return;}
this.list=$('<div>').addClass('tele-alerts-block');this.container.append(this.list);this.list.teleList({data:this.data.alerts.items,searchkey:telepath.alerts.searchString,formatter:function(item){return telepath.alert.rowFormatter(item);},callbacks:{scroll:function(offset,callback){telepath.ds.get('/alerts/index',{sort:telepath.alerts.sort,dir:telepath.alerts.dir,search:telepath.alerts.searchString,offset:offset,filters:that.filter},function(data){callback(data);});}}});this.panelTitle.html(data.alerts.count+' Sessions');if(parseInt(data.alerts.count)==0){return;}
var graphsBlock=$('<div class="tele-alert-graphs-block">').css({marginTop:20});$(container).append(graphsBlock);var graphOverTimeContainer=$('<div>').addClass('tele-alert-graph-overtime');var graphOverTimeTitle=$('<h2>').html('Alerts over time');var graphOverTimeCanvas=$('<div>').addClass('tele-alert-graph-overtime-canvas');graphOverTimeContainer.append(graphOverTimeTitle).append(graphOverTimeCanvas);var graphDistributionContainer=$('<div>').addClass('tele-alert-graph-distribution');var graphDistributionTitle=$('<h2>').html('Total Events');this.graphDistributionCanvas=$('<div>').addClass('tele-alert-graph-distribution-canvas');var showPercent=$('<div>').attr('id','alert-distribution-showPercent');var graphDistributionLegend=$('<div>').attr('id','alert-distribution-legend');var newToggle=$('<div>').toggleFlip({left_value:'Alerts',right_value:'Business Actions',flip:function(x){if(!x){$("#alert-distribution-showPercent").empty();telepath.alerts.show_alert_distribution();}else{$("#alert-distribution-showPercent").empty();telepath.alerts.show_action_distribution();}}});graphDistributionContainer.append(graphDistributionTitle).append(newToggle).append(showPercent).append(graphDistributionLegend).append(this.graphDistributionCanvas);graphsBlock.append(graphOverTimeContainer).append(graphDistributionContainer);var options={legend:{show:false},series:{lines:{show:true,fill:true},points:{show:true,fillColor:'#fff'}},yaxis:{ticks:5,color:'#D6D6D6',font:{color:'#cccccc',size:11,weight:"bold"}},selection:{mode:"x"},xaxis:{font:{color:'#cccccc',size:11,weight:"bold"},mode:'time',timezone:"browser",timeformat:"%d/%m/%y"},grid:{borderColor:'#D6D6D6',borderWidth:0,clickable:true,hoverable:true,autoHighlight:true},tooltip:true,tooltipOpts:{content:"date: %x | alerts: %y"}};var chart_data=[{label:"random",data:this.data.time_chart,color:'#FC3D3D'}];graphOverTimeCanvas.flotGraph({data:chart_data,options:options});telepath.alerts.show_alert_distribution();$(graphsBlock).mCustomScrollbar({advanced:{updateOnContentResize:true},scrollButtons:{enable:false},});$(window).unbind('resize',that._resize);$(window).bind('resize',that._resize);$(window).trigger('resize');},show_alert_distribution:function(){var that=this;this.graphDistributionCanvas.empty();var pie_data=this.data.distribution_chart;var dataTotal=0;$.each(pie_data,function(i,row){dataTotal+=parseInt(row.data);});var options={series:{pie:{show:true,radius:0.5,innerRadius:0.4,margin:100,label:{show:false,radius:0.3,formatter:function(lbl,obj){var count=parseInt(obj.data[0][1]);var percent=parseInt(count/dataTotal*100)+'%';var pieTemp=$('<div>');var pieLabel=$('<div>').addClass('tele-pie-label').html(lbl);var piePercent=$('<div>').addClass('tele-pie-percent').html(percent).css('color',obj.color);var pieCount=$('<div>').addClass('tele-pie-count').html(count+' alerts');pieTemp.append(pieLabel).append(piePercent).append(pieCount);return pieTemp.html();}}}},grid:{hoverable:true,clickable:true},legend:{show:true,position:"nw",margin:([50,100]),sorted:"ascending",},};if(window.innerWidth<1200){options.series.pie.margin=[50,0];options.legend.margin=([50,400])}
function pieHover(event,pos,obj)
{if(!obj)
return;percent=parseFloat(obj.series.percent).toFixed(2);$("#alert-distribution-showPercent").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');$('.tele-graph-canvas .flot-overlay').css({"cursor":"pointer"})}
function pieClick(event,pos,obj){if(!obj)
return;if(obj.series.label){that.filter=[];that.filter.push(obj.series.label);if(that.data.distribution_chart.length!=that.filter.length){that.allData=false;}}
that.refresh()}
function legendClick(){$('.legend tr').on('click',function(){if(that.allData){that.filter=[];$.each(that.data.distribution_chart,function(i,val){that.filter.push(val.label);})}
var item=$(this).children('.legendLabel').text();if(($.inArray(item,that.filter)!=-1)){that.filter.splice($.inArray(item,that.filter),1);that.allData=false;}else{that.filter.push(item);that.filter=$.grep(that.filter,function(n,i){var item=$.grep(that.data.distribution_chart,function(item){return item.label==n;});return item.length>0;});if(that.data.distribution_chart.length==that.filter.length){that.allData=true;}}
that.refresh()});}
function set_legend(){$('.legend tr').css({"cursor":"pointer"});if(that.filter.length>0&&that.allData==false){$.each($('.legend tr'),function(i,val){if($.inArray(val.children[1].innerText,that.filter)==-1){$(this).children(".legendColorBox").children().html('<div style="width:4px;height:0;border:5px solid #999;overflow:hidden; "></div>');$(this).css({"opacity":"0.5"});}})}}
setTimeout(function(){telepath.alerts.graphDistributionCanvas.flotGraph({data:pie_data,options:options});$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plothover',pieHover);$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plotclick',pieClick);legendClick();set_legend();this._resize();},100);},show_action_distribution:function(){this.graphDistributionCanvas.empty();var pie_data=this.data.action_distribution_chart;var dataTotal=0;$.each(pie_data,function(i,row){dataTotal+=parseInt(row.data);});var options={series:{pie:{show:true,radius:0.5,innerRadius:0.4,margin:100,label:{show:false,radius:0.3,formatter:function(lbl,obj){var count=parseInt(obj.data[0][1]);var percent=parseInt(count/dataTotal*100)+'%';var pieTemp=$('<div>');var pieLabel=$('<div>').addClass('tele-pie-label').html(lbl);var piePercent=$('<div>').addClass('tele-pie-percent').html(percent).css('color',obj.color);var pieCount=$('<div>').addClass('tele-pie-count').html(count+' alerts');pieTemp.append(pieLabel).append(piePercent).append(pieCount);return pieTemp.html();}}}},grid:{hoverable:true,clickable:true},legend:{show:true,position:"nw",margin:([50,100]),sorted:"ascending",},};if(window.innerWidth<1200){options.series.pie.margin=[50,0];options.legend.margin=([50,400])}
function pieHover(event,pos,obj)
{if(!obj)
return;percent=parseFloat(obj.series.percent).toFixed(2);$("#alert-distribution-showPercent").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');$('.tele-graph-canvas .flot-overlay').css({"cursor":"pointer"})}
function pieClick(event,pos,obj){if(!obj)
return;if(obj.series.label){that.filter=[];that.filter.push(obj.series.label)}
that.refresh()}
function legendClick(){$('.legend tr').on('click',function(){var item=$(this).children('.legendLabel').text();if(($.inArray(item,that.filter)!=-1)){that.filter.splice($.inArray(item,that.filter),1);}else{that.filter.push(item)}
that.refresh()});}
function set_legend(){$('.legend tr').css({"cursor":"pointer"});if(that.filter.length>0){$.each($('.legend tr'),function(i,val){if($.inArray(val.children[1].innerText,that.filter)==-1){$(this).children(".legendColorBox").children().html('<div style="width:4px;height:0;border:5px solid #999;overflow:hidden; "></div>');$(this).css({"opacity":"0.5"});}})}
else{$.each(that.data.distribution_chart,function(i,val){that.filter.push(val.label);})}}
setTimeout(function(){telepath.alerts.graphDistributionCanvas.flotGraph({data:pie_data,options:options});$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plothover',pieHover);$(".tele-alert-graph-distribution-canvas .tele-graph-canvas").bind('plotclick',pieClick);legendClick();set_legend();this._resize();},100);},_resize:function(){var that=this;if($('.tele-panel-alerts').children().size()==0)return;var height=$(window).height();var width=$(window).width()-10;$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();var magic=500;if(width<1200){if(width<1024){magic=300;}else{magic=400;}}else{magic=600;}
$('.tele-panel-alerts .tele-alert-graphs-block',this.list).width(magic);$('.tele-panel-alerts .tele-block').width(width-magic-15);$('.tele-panel-alerts .tele-block .tele-list').width(width-magic-25).height(offset-50).mCustomScrollbar("update");$('.tele-panel-alerts .tele-alert-graphs-block').height(offset-50).mCustomScrollbar("update");if(window.innerWidth<1200){this.graph=$('.tele-alert-graph-distribution-canvas.tele-graph');this.legendHeight=$('.legend table').height();this.pieGraphHeight=$('.tele-alert-graph-distribution-canvas.tele-graph .tele-graph-canvas-outer').height();this.graph.height(that.pieGraphHeight+that.legendHeight-50);}}};telepath.suspects={sort:'date',dir:false,data:[],total:0,searchString:'',loading:false,rowFormatter:function(item,mode){if(mode=='dashboard'){var identification=(item.user!=''?{key:'user',value:item.user}:{key:'IP',value:item.ip_orig});result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'host',value:grabNames(item.host)},identification]}}
else{result={raw:item,icon:'suspect',time:item.ts,progbar:true,itemID:item.sid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,count:item.count,progbarValue:item.ip_score,time:item.date,details:[{key:'country',value:item.country},{key:'IP',value:item.ip_orig},{key:'city',value:item.city},{key:'host',value:grabNames(item.host)},{key:'alerts',value:item.alerts_count},{key:'actions',value:item.actions_count},{key:'cases',value:item.cases_count},{key:'user',value:item.user}]}}
return result;},init:function(){var that=this;this.container=$('.tele-panel-suspects');this.container.empty();this.panelTopBar=$('<div>').addClass('tele-panel-topbar');this.panelTitle=$('<div>').addClass('tele-panel-title');this.panelTopBar.append(this.panelTitle);this.panelTitle.html('Loading Suspects');this.container.append(this.panelTopBar);this.panelSubBar=$('<div>').addClass('tele-panel-subtitle');this.panelTopBarRight=$('<div>').addClass('tele-panel-topbar-right');this.panelTopBar.append(this.panelTopBarRight);this.container.append(this.panelSubBar);var filterDateRange=$('<div>').daterange({start:telepath.range.start,end:telepath.range.end,change:function(start,end){telepath.suspects.refresh(function(){});}});var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'date',icon:'time',tip:'Time'},{id:'count',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.loading){return}
that.loading=true;if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.refresh();}});this.panelTopBarRight.append(sortRadios).append('<div class="tele-navsep"></div>');var filterApps=$('<div>').appSelect({callback:function(app_id){$('.tele-icon-application',filterApps).removeClass('tele-icon-application').addClass('tele-icon-loader');telepath.suspects.refresh(function(){$('.tele-icon-loader',filterApps).removeClass('tele-icon-loader').addClass('tele-icon-application');});}});this.panelTopBarRight.append(filterDateRange).append('<div class="tele-navsep"></div>').append(filterApps);var searchSuspects=$('<div>').teleSearch({callback:function(e,txt){telepath.suspects.searchString=txt;}});var resetInput=$('<a>').addClass('icon-delete-input2').attr('id','remove-button').click(function(){$('.tele-panel-suspects .tele-search-input').val('');telepath.suspects.searchString='';telepath.suspects.refresh();});this.panelSubBar.append(searchSuspects);this.refresh();var typingTimer;var doneTypingInterval=1000;$(".tele-panel-suspects .tele-search-input").keyup('input',function(){clearTimeout(typingTimer);if($('.tele-panel-suspects .tele-search-input').val()){typingTimer=setTimeout(function(){that.searchString=$('.tele-panel-suspects .tele-search-input').val();that.input();},doneTypingInterval);}});$("#search-button").on("click",function(event){that.searchString='';$(".tele-panel-suspects .tele-search-input").prop("value",that.searchString);that.input();});if(that.searchString)
{$('.tele-panel-suspects .tele-search-input').prop("value",that.searchString);that.input();}},input:function(){var that=this;var icon=$("#search-button");if(that.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.refresh()},refresh:function(callback){$('.tele-block, .tele-loader',this.container).remove();this.container.append(telepath.loader);var that=this;telepath.ds.get('/suspects/index',{sort:this.sort,dir:this.dir,search:this.searchString},function(data){that.loading=false
that.count=data.count;that.data=data.items;telepath.suspects.loadData();if(typeof(callback)=='function'){callback();}});},_resize:function(){if($('.tele-panel-suspects').children().size()==0)return;var height=$(window).height();$('.tele-body').css({height:height});var offset=height-
$('.tele-header').outerHeight()-
$('.tele-panel-topbar').outerHeight()-
$('.tele-panel-subtitle').outerHeight();$('.tele-panel-suspects .tele-block').height(offset-20);$('.tele-panel-suspects .tele-block .tele-list').height(offset-50);$('.tele-list').mCustomScrollbar("update");},loadData:function(){var that=this;$('.tele-block, .tele-loader',this.container).remove();this.suspectsList=$('<div>');this.container.append(this.suspectsList);this.suspectsList.teleList({context:"panel",data:this.data,searchkey:telepath.suspects.searchString,formatter:function(item){return telepath.suspects.rowFormatter(item);},callbacks:{scroll:function(offset,callback){telepath.ds.get('/suspects/index',{sort:telepath.suspects.sort,dir:telepath.suspects.dir,search:telepath.suspects.searchString,offset:offset,},function(data){callback(data);});}}});this.panelTitle.html(this.count+' Sessions');setTimeout(function(){that._resize();},0);$(window).resize(function(){that._resize()});}};telepath.reports={init:function(){this.container=$('.tele-panel-reports');this.container.append('<h1 style="padding: 50px; font-size: 24px; font-weight: bold;">Under Construction</h1>');}};$.widget("tele.appSelect",{options:{title:'Select',options:[],selected:0,updatesTitle:false,icon:'application',callback:function(){},value:false},_create:function(){this.element.addClass("tele-dropdown");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.dropdownIcon=$('<a>').attr('href','#').addClass('tele-icon').addClass('tele-icon-'+this.options.icon);if(!this.options.value){this.options.value=telepath.appFilter;}
var appName;var all_apps=false;if(telepath.app_filter.length>0){for(x in telepath.app_filter){if(telepath.appFilter[x]=='All'){appName='All Applications';all_apps=true;}}}else{appName='All Applications';all_apps=true;}
if(!all_apps){if(telepath.app_filter.length>1){appName=telepath.app_filter.length+' Applications';}else{appName=telepath.app_filter[0];}}
this.dropdownValue=$('<a>').attr('href','#').addClass('tele-dropdown-value').html(appName);this.dropdownArrow=$('<a>').attr('href','#').addClass('tele-dropdown-arrow').html('&nbsp;');this.element.empty();this.element.append(this.dropdownIcon).append(this.dropdownValue).append(this.dropdownArrow);this.dropdownIcon.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.dropdownValue.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});this.dropdownArrow.hover(function(){that.hoverIn();},function(){that.hoverOut();}).click(function(){that.click()});},hoverIn:function(){this.dropdownIcon.addClass('hover');this.dropdownValue.addClass('hover');this.dropdownArrow.addClass('hover');},hoverOut:function(){this.dropdownIcon.removeClass('hover');this.dropdownValue.removeClass('hover');this.dropdownArrow.removeClass('hover');},click:function(){var that=this;if($(".tele-appselect-popup").css('display')=='block'){$(".tele-appselect-popup").fadeOut();$(".tele-appselect-popup").remove();return;}
$(".tele-appselect-popup").remove();this.popup=$('<div>').addClass('tele-popup').addClass('tele-appselect-popup').hide();$('body').append(this.popup);var top=$(this.element).offset().top+$(this.element).height()+10;var left=($(this.element).offset().left+($(this.element).width()/2))-120;this.popup.css({top:top,left:left,width:230,paddingBottom:10}).fadeIn();var data=[];if(telepath.app_filter&&telepath.app_filter.length>0){$.each(telepath.app_filter,function(i,x){data.push({text:x});});}else{data.push({text:''});}
var filterApps=$('<div>').teleSelect({type:'subdomain',values:data,click:function(){}});this.popup.append(filterApps);$(filterApps).mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:150});var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var btnContain=$('<div>').addClass('tele-button-container');btnContain.append(saveBtn);this.popup.append(btnContain);btnContain.css({position:'static',margin:'0'});saveBtn.click(function(){var result=[];$('input',that.popup).each(function(){if($(this).val()!=''){result.push($(this).val());}});result=eliminateDuplicates(result);that.popup.remove();telepath.ds.get('/telepath/set_app_filter',{apps:result},function(data){if(that.options.callback){telepath.app_filter=result;that._update();that.options.callback();}});});}});;$.widget("tele.teleInput",{options:{'label':false,'value':'','pass':false,'labelCSS':{},'link':false,'disabled':false,'type':false,'range':false},_create:function(){this.element.addClass("tele-input");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();if(this.options.label){this.label=$('<label>').addClass('tele-input-label').html(this.options.label);this.element.append(this.label);this.label.css(this.options.labelCSS);}
var tpl=this.options.pass?' type="password"':'';if(this.options.link){this.link=$('<a>').addClass('tele-input-input').attr('href',escapeHtml(this.options.value)).attr('target','_blank').html(escapeHtml(this.options.value));this.element.append(this.link);}else if(this.options.type){var type='type="'+this.options.type+'" ';if(this.options.range){type+='min="'+this.options.range.min+'" max="'+this.options.range.max+'"';}
this.input=$('<input '+type+'>').addClass('tele-input-input').val(escapeHtml(this.options.value));if(this.options.step){this.input.attr('step',this.options.step);}
if(this.options.disabled)
this.input.attr('disabled','disabled');this.element.append(this.input);}else{this.input=$('<input'+tpl+'>').addClass('tele-input-input').val(escapeHtml(this.options.value));if(this.options.step){this.input.attr('step',this.options.step);}
if(this.options.disabled)
this.input.attr('disabled','disabled');this.element.append(this.input);}
if(this.options.suffix){this.suffix=$('<label>').addClass('tele-input-suffix').html(this.options.suffix);this.element.append(this.suffix);}
if(this.options.width){this.input.css({width:this.options.width});}
if(this.options.margintop){this.input.css({'margin-top':this.options.margintop});}
if(this.options.marginleft){this.input.css({'margin-left':this.options.marginleft});}}});;$.widget("tele.telePassword",{options:{'label':false,},_create:function(){this.element.addClass("tele-password");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();if(this.options.label){this.label=$('<label>').addClass('tele-input-label').html(this.options.label);this.element.append(this.label);}
this.input_1=$('<input type="password">').addClass('tele-input-input').addClass('tele-input-password');this.input_2=$('<input type="password">').addClass('tele-input-input').addClass('tele-input-password');this.element.append(this.input_1).append(this.input_2);}});;$.widget("tele.teleCheckbox",{options:{'label':false,'checked':false,'icon':'checkbox','inputFirst':true,'dataID':false},_create:function(){this.element.addClass("tele-checkbox");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();this.input=$('<div>').addClass('tele-checkbox-'+this.options.icon);if(this.options.inputFirst){this.element.append(this.input);}
if(this.options.dataID){this.input.attr('dataID',this.options.dataID);}
if(this.options.label){this.label=$('<label>').addClass('tele-input-label').html(this.options.label);this.element.append(this.label);}else{this.element.addClass('no-label');}
if(!this.options.inputFirst){this.element.append(this.input);}
if(this.options.checked){this.input.addClass('checked');}
this.input.click(function(){if(that.options.checked){$(this).removeClass('checked');}else{$(this).addClass('checked');}
that.options.checked=!that.options.checked;if(that.options.callback){that.options.callback(that);}});}});;$.widget("tele.teleList",{toggleAll:function(value){$.each(this.items,function(i,item){var widget=$(item).listitem("option","checked",value);});},getSelected:function(){var selected=[];$.each(this.items,function(i,item){var widget=$(item).data('tele-listitem');var checked=widget.options.checked;if(checked){selected.push(widget.options.dataID);}});return selected;},filter:function(value){$.each(this.items,function(i,item){if($(item).data('tele-listitem').options.title==value){$(item).toggle();}});},options:{title:false,titleCallback:false,data:false,formatter:false,searchkey:'',clickable:true,callbacks:{}},_create:function(){var that=this;this.element.addClass("tele-block");if(this.options.title){this.title=$('<div class="tele-block-title">').html(this.options.title);this.element.append(this.title);if(typeof(this.options.titleCallback)=='function'){this.title.css({cursor:'pointer'}).click(this.options.titleCallback);}}else{this.element.addClass("no-title");}
this.list=$('<ul class="tele-list">');if(this.options.height){this.list.css({height:this.options.height});}
this.element.append(this.list);this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},appendItem:function(item){var that=this;var newItem=$('<li>');if($('.mCSB_container',that.list).size()>0){$('.mCSB_container',that.list).append(newItem);}else{that.list.append(newItem);}
var formattedItem=that.options.formatter(item);formattedItem.callback=that.options.callbacks.click;if(typeof(that.options.callbacks.favorite)=='function'){formattedItem.favoriteCallBack=that.options.callbacks.favorite;}
newItem.listitem(formattedItem);$('.tele-listitem-icon, .tele-listitem-progbar, .tele-listitem-count',newItem).hover(function(){$('.popover').remove();if(that.timer){clearTimeout(that.timer);}
if($(this).hasClass('tele-listitem-count')){var el=$(this).prev();}
else{var el=this;}
that.timer=setTimeout(function(){that.options.callbacks.hover_in(el,$(el).data('formattedItem'));},500);},function(){if(that.timer){clearTimeout(that.timer);}
that.options.callbacks.hover_out(this,formattedItem);}).data('formattedItem',formattedItem);if(this.options.clickable){$('.tele-listitem-info li b, .tele-country, .tele-user',newItem).css('cursor','url(img/search_icon.png), pointer');$('.tele-listitem-info li b, .tele-country, .tele-user',newItem).hover(function(){$(this).css('color','#4174a7');},function(){$(this).css('color','#333333');});$('.tele-listitem-info li b, .tele-country, .tele-user',newItem).click(function(){var search=$(this).text();telepath.header.searchInput.val(search);telepath.search.init(search);});}
that.items.push(newItem);},_update:function(){var that=this;this.items=[];if(!this.options.callbacks.hover_in){this.options.callbacks.hover_in=telepath.listitem.generic.callbacks.hover_in;}
if(!this.options.callbacks.hover_out){this.options.callbacks.hover_out=telepath.listitem.generic.callbacks.hover_out;}
if(!this.options.callbacks.click){this.options.callbacks.click=telepath.listitem.generic.callbacks.click;}
if(!this.options.formatter){this.options.formatter=telepath.listitem.generic.formatter;}
for(x in this.options.data){var item=this.options.data[x];item.searchkey=this.options.searchkey;this.appendItem(item);}
$(this.list).mCustomScrollbar({callbacks:{onTotalScroll:function(){if(that.loading){return;}
that.loading=true;$('.mCSB_container',that.list).append($(telepath.loader).css({float:'left',clear:'both','bottom':30,position:'absolute'}));if(typeof(that.options.callbacks.scroll)=='function'){that.options.callbacks.scroll(that.items.length,function(data){that.loading=false;$('.tele-loader',that.list).remove();for(x in data.items){var item=data.items[x];that.appendItem(item);}});}},},onTotalScrollOffset:200,alwaysTriggerOffsets:false,advanced:{updateOnContentResize:true}});$(this.list).trigger('teleList.afterUpdate');}});;$.widget("tele.teleForm",{options:{title:false,items:false,buttons:true,data:{},callback:function(){},cancel:function(){}},_create:function(){this.element.addClass("tele-form");if(this.options.title){this.title=$('<div class="tele-form-title">').html(this.options.title);this.element.append(this.title);}else{this.element.addClass("no-title");}
this.container=$('<div class="tele-form-inner">');this.element.append(this.container);this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.container.empty();this.items=[];$.each(this.options.items,function(i,item){var item_container=$('<div>').addClass('tele-form-item');var item_element=$('<div>');switch(item.type){case'html':item_container.append(item.value);break;case'checkbox':item_element.teleCheckbox({label:item.label,checked:that.options.data[item.dataIndex]?that.options.data[item.dataIndex]:false});item.data=item_element.data('tele-teleCheckbox');if(item.dataIndex){item_element.attr('rel',item.dataIndex);}
break;case'password':item_element.telePassword({label:item.label,});item.data=item_element.data('tele-telePassword');break;case'text':default:item_element.teleInput({label:item.label,value:that.options.data[item.dataIndex]?that.options.data[item.dataIndex]:''});if(item.dataIndex){item_element.attr('rel',item.dataIndex);}
item.data=item_element.data('tele-teleInput');}
if(item.type!='html'){item_container.append(item_element);}
that.container.append(item_container);});if(this.options.buttons){this.buttonsEl=$('<div>').addClass('tele-form-buttons');this.applyBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');this.cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');this.buttonsEl.append(this.applyBtn).append(this.cancelBtn);this.container.append(this.buttonsEl);this.applyBtn.click(that.validate(that));this.cancelBtn.click(that.options.cancel(that));}},validate:function(that){that.options.callback();}});;$.widget("tele.teleTree",{options:{type:'rules',callback:function(e,data){},grid:{columns:[{width:415},{value:function(node){return $('<div>').btn({icon:'delete',callback:function(tree){$nodeParent=tree.element.parent().parent().parent('.jstree-node');if(node.type=='group'){telepath.config.rule.delRule(node.name,node.category);}
if(node.type=='category'){telepath.config.rules.delCategory(node.name);}}});},width:40}],resizable:true},searchString:''},_create:function(){this.element.addClass("tele-tree");this._update();},_setOption:function(key,value){this.options[key]=value;},expand:function(obj,callback){var that=this;var treeType=this.options.type;var nodeType=obj.data&&obj.data.type?obj.data.type:'root';var postData={};var postUrl='';if(telepath.config.rules.searchString){nodeType='search';}
switch(treeType){case'rules':switch(nodeType){default:case'root':postUrl='/rules/expand_root';postData.type='category';break;case'category':postUrl='/rules/expand_category';postData.type='group';postData.id=obj.data.id;break;case'search':postUrl='/rules/searchRules';postData.search=telepath.config.rules.searchString;}
break;}
telepath.ds.get(postUrl,postData,function(data){var treeData=[];if(nodeType=='search'){var child={};$.each(data.items,function(i,item){var obj={children:[],text:i,data:{id:i,type:'category',name:i,category:item[0].category}};$.each(item,function(j,row){child={children:false,text:row.name,data:{id:row.id,type:'group',name:row.name,category:row.category}};obj.children.push(child)});treeData.push(obj)});}
else{$.each(data.items,function(i,row){var obj={children:true,text:row.name,data:{id:row.id,type:postData.type,name:row.name,category:row.category}};if(that.options.type=="rules"){telepath.config.rules.categories=data.items;}
if(postData.type=='group'){obj.children=false;}
treeData.push(obj);});}
callback.call(that,treeData);});},_update:function(){var that=this;this.teleTree=$('<div>');this.element.append(this.teleTree);this.teleTree.jstree({core:{data:function(obj,callback){that.expand(obj,callback);}},plugins:["json_data","wholerow","theme","grid"],grid:that.options.grid,}).on('changed.jstree',function(e,data){data.instance.element.find('.jstree-wholerow').css('background-color','#FFFFFF');data.instance.element.find('.jstree-wholerow-hovered').css("background-color","rgba(189, 189, 189, 0.85)");that.options.callback(e,data);}).on('loaded.jstree',function(){if(telepath.config.rules.searchString){that.teleTree.jstree('open_all');}});$(this.element).mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:150,advanced:{updateOnContentResize:true}});},});;$.widget("tele.teleRule",{options:{data:[],},_create:function(){this.element.addClass("tele-ruletype-select");this.criterias=0;this._update();return this;},_setOption:function(key,value){this.options[key]=value;this._update();},getValues:function(){$('.tele-ruletype-accordion',this.element).data('uiAccordion').active.trigger('click');var ruleData=[];$('.tele-ruletype-accordion').hide();$('.tele-ruletype-accordion').data('uiAccordion').headers.each(function(){$(this).triggerHandler('click');$(this).triggerHandler('click');});$('.tele-ruletype-accordion').data('uiAccordion').headers.each(function(){var data=false;data=$(this).data('ruleData');if(data){var json=JSON.parse(data);if(!$.isEmptyObject(json)){ruleData.push(data);}}});$('.tele-ruletype-accordion').show();return ruleData;},addCriteria:function(type,data){var that=this;var headerEl=$('<h3>').text(that.ruleTypes[type].title).css('text-transform','capitalize').addClass('tele-ruletype-'+type).data('ruleData',JSON.stringify(data));var iconEl=$('<div>').addClass('tele-icon').addClass('tele-icon-'+type+'-rule');var containerEl=$('<div>').attr('rel',type);var briefEl=$('<span>').addClass('brief').html(that.ruleTypes[type].desc);that.accordion.append(headerEl).append(containerEl);if(!this.options.data["builtin_rule"])
{var delCriteria=$('<div>').addClass('tele-icon tele-icon-delete').click(function(){headerEl.remove();containerEl.remove();}).h();headerEl.prepend(iconEl).append(briefEl).append(delCriteria);}else{headerEl.prepend(iconEl).append(briefEl);}
that.accordion.accordion('destroy').accordion({heightStyle:'fill',collapsible:true,active:false,autoHeight:false,animate:false,select:function(event,ui){},beforeActivate:function(event,ui){if(ui.oldHeader&&ui.oldPanel){var json=that.buildJSON(ui.oldPanel);if(!json){return false;}else{}
$(ui.oldHeader).data('ruleData',JSON.stringify(json));}
var container=$(ui.newPanel);if(container.length>0&&!container.hasClass('loaded')&&ui.newPanel){var type=ui.newPanel.attr('rel');var json_string=$(ui.newHeader).data('ruleData');var data=[];if(json_string&&json_string!=''){data=JSON.parse(json_string);}
that.editor(type,container,data);container.addClass('loaded');}}});if(this.options.data["builtin_rule"])
{$(iconEl).click();}},_update:function(){var that=this;this.element.empty();this.ruleTypes={'parameter':{title:'Parameter',desc:'Inspect specific parameter.'},'pattern':{title:'Pattern',desc:'Detect repetitive patterns over a predefined period of time.',},'behaviour':{title:'Behaviour',desc:'Inspect one aspect of the web user\'s behavior such as: landing speed, path, geographic location and so on.',},'geographic':{title:'Geographic',desc:'Geographic aspect.',},'aspect':{title:'Bot Intelligence',desc:'Bot Intelligence.',}};if(!this.options.data["builtin_rule"])
{this.buttonsWrap=$('<div>').addClass('tele-ruletype-buttons');this.element.append(this.buttonsWrap);}
this.accordion=$('<div>').addClass('tele-ruletype-accordion');this.element.append(this.accordion);var mapping={'P':'parameter','p':'pattern','b':'behaviour','g':'geographic','B':'aspect'};if(!this.options.data["builtin_rule"])
{$.each(this.ruleTypes,function(type,data){var extra=$('<div>').addClass('tele-ruletype-button').hover(function(){$('*',this).addClass('hover');},function(){$('*',this).removeClass('hover');});var button=$('<a>').html(data.title).click(function(){that.addCriteria(type,[]);}).append($('<div>').addClass('tele-icon tele-icon-plus').h());that.buttonsWrap.append(extra.append(button));});}
else{this.accordion.addClass('small');}
this.accordion.accordion();$.each(this.options.data.criteria,function(i,val){if(mapping[val.kind]){that.addCriteria(mapping[val.kind],val);}});},buildJSON:function(c){json={};$('*',c).removeClass('error');var type=$(c).attr('rel');switch(type){case'parameter':json.kind='P';var method=$('.tele-parameter-type .tele-radio-knob',c).parent().attr('rel');switch(method){case'Parameter':$('.tele-browse input',c).removeClass('error');var param=$('.tele-browse input',c).data('selected');if(typeof(param)=='string'){param=JSON.parse(param);}
if($('.tele-overlay-dialog').is(':visible')){return;}
if(!param){telepath.dialog({title:'Rule Editor',msg:'You must browse for a parameter.'});$('.tele-browse input',c).addClass('error');return false;}
if(param.type=='page'){json.type='specific';}else{if(param.type=='param'){if(param.global){json.type='inclusive';json.inclusive={"paramname":param.paramname}}else{json.type='specific';json.specific={"domain":param.domain,"pagename":param.pagename,"paramname":param.paramname}}}}
json.subtype=$('.tele-string-inspection .tele-radio-knob',c).parent().attr('rel');switch(json.subtype){case'heuristic':break;case'regex':case'stringmatch':json.negate=$('.tele-rule-string-inspection .tele-checkbox .checked',c).size()>0;json.str_match=$('.tele-rule-string-inspection .tele-input-str-'+json.subtype+' input',c).val();if(json.str_match==''){telepath.dialog({title:'Rule Editor',msg:'You must specify match pattern / regex'});$('.tele-rule-string-inspection input').addClass('error');return false;}
break;case'fuzzylength':json.length=$('.tele-rule-string-inspection .tele-rule-dropdown').val();break;case'exactlength':json.length=$('#rule-slider-length').data('value');break;case'rangelength':json.length=$('#rule-slider-between',c).data('sliderValue').join('-');break;case'distance':json.distance=$('#rule-slider-similarity').data('value');break;}
break;case'Request':json.method='';$('.tele-rule-request-wrap .checked',c).each(function(){json.method=json.method+$(this).parent().text().substr(0,1)+',';});json.method=json.method.substr(0,json.method.length-1);if(json.method.length<1){json.method='Request';}
json.subtype=$('.tele-string-inspection .tele-radio-knob',c).parent().attr('rel');json.negate=$('.tele-rule-string-inspection .tele-checkbox-str-'+json.subtype+' .checked',c).size()>0;json.str_match=$('.tele-rule-string-inspection .tele-input-str-'+json.subtype+' input',c).val();if($('.tele-overlay-dialog').is(':visible')){return;}
if(json.str_match==''){telepath.dialog({title:'Rule Editor',msg:'You must specify match pattern / regex'});$('.tele-rule-string-inspection input').addClass('error');return false;}
json.type='global';break;case'Response':json.method=$('.tele-response-settings .tele-radio-knob',c).parent().attr('rel');var message;if(json.method=='StatusCode'){json.subtype='code';json.negate=false;var is_range=$('.tele-mini-toggle',c).data('tele-toggleFlip').options.flipped;var sc_start=$('.tele-sc:first input',c).val();var sc_end=$('.tele-sc:last input',c).val();json.str_match='';if(is_range){if(sc_start&&sc_end&&sc_start<sc_end){json.str_match=sc_start+'-'+sc_end;}}else{if(sc_start){json.str_match=sc_start;}}
message='You must specify a status code';}
else{json.subtype=$('.tele-string-inspection .tele-radio-knob',c).parent().attr('rel');json.negate=$('.tele-rule-string-inspection .tele-checkbox-str-'+json.subtype+' .checked',c).size()>0;json.str_match=$('.tele-rule-string-inspection .tele-input-str-'+json.subtype+' input',c).val();message='You must specify match pattern / regex';}
if($('.tele-overlay-dialog').is(':visible')){return;}
if(json.str_match==''){telepath.dialog({title:'Rule Editor',msg:message});$('.tele-rule-string-inspection input').addClass('error');return false;}
json.type='global';break;case'Uri':json.subtype=$('.tele-string-inspection .tele-radio-knob',c).parent().attr('rel');json.negate=$('.tele-rule-string-inspection .tele-checkbox-str-'+json.subtype+' .checked',c).size()>0;json.str_match=$('.tele-rule-string-inspection .tele-input-str-'+json.subtype+' input',c).val();if($('.tele-overlay-dialog').is(':visible')){return;}
if(json.str_match==''){telepath.dialog({title:'Rule Editor',msg:'You must specify match pattern / regex'});$('.tele-rule-string-inspection input').addClass('error');return false;}
json.method=method;json.type='global';break;}
break;case'pattern':json.kind='p';json.type=$('.tele-rule-anchor',c).data('tele-tele-radios').options.checked;json.time=parseInt($('.tele-pattern-time input',c).val())||0;json.count=parseInt($('.tele-pattern-count input',c).val())||0;if($('.tele-overlay-dialog').is(':visible')){return;}
if(json.time<1){telepath.dialog({title:'Rule Editor',msg:'Invalid time window'});$('.tele-pattern-time input',c).addClass('error');return;}
if(json.count<2){telepath.dialog({title:'Rule Editor',msg:'Invalid count parameter'});$('.tele-pattern-count input',c).addClass('error');return;}
switch(json.type){case'IP':break;case'SID':break;case'User':break;case'Other':$('.tele-browse-other input',c).removeClass('error');var param=$('.tele-browse-other input',c).data('selected');if(typeof(param)=='string'){param=JSON.parse(param);}
if($('.tele-overlay-dialog').is(':visible')){return;}
if(!param){telepath.dialog({title:'Rule Editor',msg:'You must select anchor parameter for type: Other'});$('.tele-browse-other input',c).addClass('error');return false;}
if(param.type=='page'){}else{if(param.type=='param'){if(param.global){json.Other={"paramname":param.paramname}}else{json.Other={"domain":param.domain,"pagename":param.pagename,"paramname":param.paramname}}}}
break;}
json.subtype=$('.tele-rule-bind',c).data('tele-tele-radios').options.checked;switch(json.subtype){case'user':break;case'action':var action_data=$('.tele-pattern-changing .tele-multi input').data('teleSelect');if($('.tele-overlay-dialog').is(':visible')){return;}
if($.isEmptyObject(action_data)){telepath.dialog({title:'Rule Editor',msg:'You must browse for repeating business action'});$('.tele-pattern-changing .tele-multi input',c).addClass('error');return false;}else{json.domain=action_data.raw.application;json.action_name=action_data.raw.action_name;}
break;case'page':var param=$('.tele-browse-page input',c).data('selected');if(typeof(param)=='string'){param=JSON.parse(param);}
else{telepath.dialog({title:'Rule Editor',msg:'You must browse for changing page'});$('.tele-browse-page input',c).addClass('error');return false;}
if(param.type=='page'){json.domain=param.domain;json.pagename=param.pagename;}
break;case'parameter':var param=$('.tele-browse-param input',c).data('selected');if(typeof(param)=='string'){param=JSON.parse(param);}
else{telepath.dialog({title:'Rule Editor',msg:'You must browse for changing parameter'});$('.tele-browse-param input',c).addClass('error');return false;}
if(param.type=='page'){}else{if(param.type=='param'){if(param.global){json.paramname=param.paramname;}else{json.domain=param.domain;json.pagename=param.pagename;json.paramname=param.paramname;}}}
break;}
break;case'behaviour':json.kind='b';json.type=$('.tele-behavior-type',c).val();json.personal=$('.tele-personal-behavior .checked',c).size()>0;break;case'geographic':json.kind='g';json.type=$(".tele-geo-type .tele-radio-knob",c).parent().attr('rel');switch(json.type){case'velocity':var range=$('.tele-geo-ts').val();var count=$('.tele-geo-ts-count input').val();var distance=$('.rule-slider-length input').val();if($('.tele-overlay-dialog').is(':visible')){return;}
if(distance<1){telepath.dialog({title:'Rule Editor',msg:'You must specify valid distance'});$('.rule-slider-length input').addClass('error');return false;}
json.distance=parseInt(distance);if(count<1){telepath.dialog({title:'Rule Editor',msg:'You must specify valid count'});$('.tele-geo-ts-count input').addClass('error');return false;}
switch(range){case's':json.ts=parseInt(count);break;case'm':json.ts=parseInt(count)*60;break;case'h':json.ts=parseInt(count)*3600;break;}
break;case'inside':case'outside':var selected="";if($('.tele-overlay-dialog').is(':visible')){return;}
if($('.tele-country-list .checked',c).size()==0){$('.tele-country-list').addClass('error');telepath.dialog({title:'Rule Editor',msg:'No countries selected'});return false;}
$('.tele-country-list .checked',c).each(function(){if($(this).attr('dataid')){selected=selected+$(this).attr('dataid')+',';}});selected=selected.substr(0,selected.length-1);json.location=selected;break;}
break;case'aspect':json.kind='B';json.type=$(".tele-rule-dropdown",c).val();break;}
json.enable=$('.tele-rule-toggle .checked',c).size()>0;json.aggregate=parseInt($('.tele-rule-trigger input',c).val());if(json.aggregate<1){$('.tele-rule-trigger input',c).addClass('error');telepath.dialog({title:'Rule Editor',msg:'You must specify aggregation count.'});return false;}
return json;},editor:function(type,container,data){container.addClass('loaded');var that=this;if(!data||data.length==0){data={enable:true,score:95,aggregate:1};}
var triggerWrap=$('<div>').addClass('tele-rule-trigger-wrap');this.ruleToggle=$('<div>').teleCheckbox({label:'Enabled',checked:data.enable}).addClass('tele-rule-toggle');this.ruleTriggerAlert=$('<div>').teleInput({label:'Trigger alert after',suffix:'criteria matches per session',width:30,value:data.aggregate}).addClass('tele-rule-trigger');triggerWrap.append(this.ruleToggle).append(this.ruleTriggerAlert);container.append(triggerWrap);var ruleInner=$('<div>').addClass('tele-rule-inner');container.append(ruleInner);if(this.options.data["builtin_rule"])
{$(ruleInner).hide();$(this.ruleTriggerAlert).hide();}
switch(type){case'parameter':var paramWRAP=$('<div>').addClass('tele-rule-param-wrap').hide();var requestWRAP=$('<div>').addClass('tele-rule-request-wrap').hide();var statusCodeWRAP=$('<div>').addClass('tele-rule-codeStatus-wrap').hide();var toggleType=$('<div>').teleRadios({radios:[{key:'Parameter',label:'Parameter'},{key:'Request',label:'Request'},{key:'Response',label:'Response'},{key:'Uri',label:'URI'}],callback:function(radio){if(radio.key=='Request'||radio.key=='Response'||radio.key=='Uri'){inspectionType.children('.tele-radio-wrap').hide();inspectionType.find('.tele-radio-radio[rel="regex"]').parent().show();inspectionType.find('.tele-radio-radio[rel="regex"]').click();inspectionType.find('.tele-radio-radio[rel="stringmatch"]').parent().show();if(radio.key=='Request'||radio.key=='Uri'){statusCodeWRAP.hide();controlsWrap.show();inspectionType.show();}
if(radio.key=='Response'||radio.key=='Uri'){requestWRAP.hide();}else{requestWRAP.show();}
if(radio.key=='Response'){responseSettings.show();if(responseSettings.find('.tele-radio-knob').parent().attr('rel')=='StatusCode'){statusCodeWRAP.show();controlsWrap.hide();inspectionType.hide();}else{statusCodeWRAP.hide();controlsWrap.show();inspectionType.show();}}
else{responseSettings.hide();}
paramWRAP.hide();}else{inspectionType.children('.tele-radio-wrap').show();requestWRAP.hide();controlsWrap.show();inspectionType.show();responseSettings.hide();statusCodeWRAP.hide();paramWRAP.show();}}}).addClass('tele-parameter-type');var controlsWrap=$('<div>').addClass('tele-rule-string-inspection');var r_regex_control=$('<div>').addClass('rules_string_control_bool');var r_regex_input=$('<div style="width:200px">').teleInput({value:''}).addClass('tele-input-str-regex');var r_regex_check=$('<div>').teleCheckbox({label:'Not',checked:false}).addClass('tele-checkbox-str-regex');r_regex_control.append(r_regex_input).append(r_regex_check)
var r_contains_control=$('<div>').addClass('rules_string_control_bool');var r_contains_input=$('<div style="width:200px">').teleInput({value:''}).addClass('tele-input-str-stringmatch');;var r_contains_check=$('<div>').teleCheckbox({label:'Not',checked:false}).addClass('tele-checkbox-str-stringmatch');r_contains_control.append(r_contains_input).append(r_contains_check)
var r_fuzzy_opt=['short','long','both'];var r_fuzzy_list=$('<select>').addClass('tele-rule-dropdown');$.each(r_fuzzy_opt,function(i,opt){var option='<option value="'+opt+'">'+opt.charAt(0).toUpperCase()+opt.slice(1)+'</option>';r_fuzzy_list.append(option);});var r_len_slider_div=$('<div>');var r_len_input=$('<b>1</b><input id="rule-slider-length" type="text" style="width:200px" data-slider-min="1" data-slider-max="100" data-slider-step="1" data-slider-value="1" data-slider-tooltip="show"/> <b>100</b>');r_len_slider_div.append(r_len_input);var r_bet_slider_div=$('<div>');var r_bet_input=$('<b>1</b><input id="rule-slider-between" data-slider-id="betSlider" type="text" style="width:200px" data-slider-min="1" data-slider-max="10" data-slider-step="1" data-slider-value="[2,5]" data-slider-tooltip="show"/> <b>10</b>');r_bet_slider_div.append(r_bet_input);var r_sim_slider_div=$('<div>');var r_sim_input=$('<b>1</b><input id="rule-slider-similarity" data-slider-id="simSlider" type="text" style="width:200px" data-slider-min="1" data-slider-max="3" data-slider-step="1" data-slider-value="1" data-slider-tooltip="show"/> <b>3</b>');r_sim_slider_div.append(r_sim_input);controlsWrap.append(r_regex_control).append(r_contains_control).append(r_fuzzy_list).append(r_len_slider_div).append(r_bet_slider_div).append(r_sim_slider_div);var inspectionType=$('<div>').teleRadios({checked:'heuristic',radios:[{key:'heuristic',label:'Heuristic',checked:true},{key:'regex',label:'Regex'},{key:'stringmatch',label:'String Contains'},{key:'fuzzylength',label:'Fuzzy Length'},{key:'exactlength',label:'Length'},{key:'rangelength',label:'Length Between'},{key:'distance',label:'String appear similar by'},],callback:function(radio){r_regex_input.hide();r_regex_check.hide();r_contains_input.hide();r_contains_check.hide();r_fuzzy_list.hide();r_len_slider_div.hide();r_bet_slider_div.hide();r_sim_slider_div.hide();switch(radio.key){case'heuristic':r_regex_input.show();r_regex_check.show();break;case'regex':r_regex_input.show();r_regex_check.show();break;case'stringmatch':r_contains_input.show();r_contains_check.show();break;case'fuzzylength':r_fuzzy_list.show();break;case'exactlength':r_len_slider_div.show()
break;case'rangelength':r_bet_slider_div.show();break;case'distance':r_sim_slider_div.show();break;}}}).addClass('tele-string-inspection');var browseOpt={mode:'param',type:'param'}
if(data.type){if(data.type=='inclusive'&&data.inclusive){browseOpt.global=true;browseOpt.paramname=data.inclusive.paramname;}
if(data.type=='specific'&&data.specific){browseOpt.global=false;browseOpt.paramname=data.specific.paramname;browseOpt.pagename=data.specific.pagename;browseOpt.domain=data.specific.domain;}}
var paramBrowse=$('<div>').teleBrowse(browseOpt);paramWRAP.append(paramBrowse);this.requestPOST=$('<div>').teleCheckbox({label:'POST'});this.requestGET=$('<div>').teleCheckbox({label:'GET'});this.requestHEADER=$('<div>').teleCheckbox({label:'HEADER'});requestWRAP.append(this.requestPOST).append(this.requestGET).append(this.requestHEADER);var responseSettings=$('<div>').teleRadios({checked:'Title',radios:[{key:'Title',label:'Title',},{key:'StatusCode',label:'Status Code'},{key:'Body',label:'Body'}],callback:function(radio){if(radio.key=='StatusCode'){controlsWrap.hide();inspectionType.hide();statusCodeWRAP.show();}
else{statusCodeWRAP.hide();controlsWrap.show();inspectionType.show();}}}).addClass('tele-response-settings');statusCodeWRAP.append(getStatusCodeRangeUI(''));var inspectionTitle=$('<div>').addClass('tele-title-1').html('String Inspection').hide();var toggleReqTitle=$('<div>').addClass('tele-title-1').html('Parameter').hide();ruleInner.append(toggleReqTitle).append(toggleType).append(paramWRAP).append(requestWRAP).append(responseSettings).append(inspectionTitle).append(inspectionType).append(statusCodeWRAP).append(controlsWrap);if(data){if(!data.method){data.method=''}
switch(data.method){case'':$('.tele-parameter-type [rel="Parameter"]',container).trigger('click');break;case'Title':$('.tele-parameter-type [rel="Response"]',container).trigger('click');$('.tele-response-settings [rel="Title"]',container).trigger('click');break;case'StatusCode':$('.tele-parameter-type [rel="Response"]',container).trigger('click');$('.tele-response-settings [rel="StatusCode"]',container).trigger('click');break;case'Body':$('.tele-parameter-type [rel="Response"]',container).trigger('click');$('.tele-response-settings [rel="Body"]',container).trigger('click');break;case'Uri':$('.tele-parameter-type [rel="Uri"]',container).trigger('click');break;default:$('.tele-parameter-type [rel="Request"]',container).trigger('click');if(data.method.length>0){data.method=data.method.split(',');$.each(data.method,function(i,method){switch(method){case'P':$('.tele-checkbox-checkbox',that.requestPOST).trigger('click');break;case'G':$('.tele-checkbox-checkbox',that.requestGET).trigger('click');break;case'H':$('.tele-checkbox-checkbox',that.requestHEADER).trigger('click');break;}});}
break;}
if(data.subtype){switch(data.subtype){case'stringmatch':inspectionType.find('.tele-radio-radio[rel="stringmatch"]').click();$('input',r_contains_input).val(data.str_match);if(data.not_signal){$('.tele-checkbox-checkbox',r_contains_check).click();}
break;case'regex':inspectionType.find('.tele-radio-radio[rel="regex"]').click();$('input',r_regex_input).val(data.str_match);if(data.not_signal){$('.tele-checkbox-checkbox',r_regex_check).click();}
break;case'code':statusCodeWRAP.empty();statusCodeWRAP.append(getStatusCodeRangeUI(data.str_match));break;case'fuzzylength':inspectionType.find('.tele-radio-radio[rel="fuzzylength"]').click();r_fuzzy_list.val(data.str_length);break;case'exactlength':inspectionType.find('.tele-radio-radio[rel="exactlength"]').click();$('input',r_len_input).attr('value',data.str_length);break;case'rangelength':inspectionType.find('.tele-radio-radio[rel="rangelength"]').click();var tmp=data.str_length.split("-");$('input',r_bet_input).attr('value',data.str_length);break;case'distance':inspectionType.find('.tele-radio-radio[rel="distance"]').click();$('input',r_sim_input).attr('value',data.str_length);break;default:inspectionType.find('.tele-radio-radio[rel="heuristic"]').click();break;}}else{inspectionType.find('.tele-radio-radio[rel="heuristic"]').click();}}
break;case'pattern':var patTitle=$('<div>').addClass('tele-title-1').html('Anchor');var changingWindow=$('<div>').addClass('tele-pattern-changing');var browseOpt={mode:'param',label:'Other (parameter)',type:'param'};if(data.type=='Other'&&data.Other){browseOpt=$.extend(browseOpt,data.Other);browseOpt.global=!data.Other.domain;}
var otherBrowse=$('<div>').teleBrowse(browseOpt).hide().addClass('tele-browse-other');var browseOpt={mode:'page',label:'Repeating Page',type:'page'};if(data.subtype=='page'&&data.pagename&&data.domain){browseOpt.pagename=data.pagename;browseOpt.domain=data.domain;}
var pageBrowse=$('<div>').teleBrowse(browseOpt).hide().addClass('tele-browse-page');var browseOpt={mode:'param',label:'Changing parameter'};if(data.subtype=='parameter'&&data.paramname){browseOpt.paramname=data.paramname;if(data.pagename){browseOpt.pagename=data.pagename;browseOpt.domain=data.domain;browseOpt.global=false;}else{browseOpt.global=true;}}
var paramBrowse=$('<div>').teleBrowse(browseOpt).hide().addClass('tele-browse-param');if(!data.action_name&&!data.domain){var action_data=[{}];}
else{var action_data=[{text:data.domain+' :: '+data.action_name,raw:{application:data.domain,action_name:data.action_name}}];}
var actionSelect=$('<div>').teleSelect({type:'action',values:action_data,click:function(){}}).hide();$('input',actionSelect).css({width:300});$('.tele-multi-control',actionSelect).hide();changingWindow.append(otherBrowse).append(pageBrowse).append(paramBrowse).append(actionSelect);var patAnchor=$('<div>').teleRadios({radios:[{key:'IP',label:'IP Address'},{key:'SID',label:'Session ID'},{key:'User',label:'User'},{key:'Other',label:'Other'}],callback:function(radio){otherBrowse.hide();switch(radio.key){case'IP':case'SID':case'User':break;case'Other':otherBrowse.show();break;}}}).addClass('tele-rule-anchor');var patLinked=$('<div>').teleRadios({radios:[{key:'page',label:'Page'},{key:'parameter',label:'Changing Parameter'},{key:'action',label:'Repeating Business Action'},{key:'user',label:'Changing Username'},],callback:function(radio){pageBrowse.hide();paramBrowse.hide();actionSelect.hide();switch(radio.key){case'page':pageBrowse.show();break;case'parameter':paramBrowse.show();break;case'action':actionSelect.show();break;}}}).addClass('tele-rule-bind');var patWindowWrap=$('<div>').addClass('tele-rule-pattern-window');var patCount=$('<div>').teleInput({label:'Count',value:data.count?data.count:3}).addClass('tele-pattern-count');var patWindow=$('<div>').teleInput({label:'Window',value:data.time?data.time:60}).addClass('tele-pattern-time');var patGaps=['Seconds','Minutes','Hours'];var patGap=$('<select>').addClass('tele-rule-dropdown');$.each(patGaps,function(i,opt){patGap.append('<option value="'+opt+'">'+opt+'</option>');});patWindowWrap.append(patCount).append(patWindow).append(patGap);ruleInner.append(patTitle).append(patAnchor).append(patLinked).append(changingWindow).append(patWindowWrap);if(!data.type){data.type='IP';}
$('.tele-rule-anchor [rel="'+data.type+'"]').click();if(!data.subtype){data.subtype='user';}
$('.tele-rule-bind [rel="'+data.subtype+'"]').click();break;case'behaviour':var behavTitle=$('<div>').addClass('tele-title-1').html('Aspects are different characteristics of web users\' behavior');var behaviorTypes=[{k:'average',v:'Average'},{k:'query',v:'Query'},{k:'landing',v:'Speed'},{k:'geo',v:'Location'},{k:'flow',v:'Direction'},{k:'presence',v:'Structure'}];var behavSelect=$('<select>').addClass('tele-rule-dropdown').addClass('tele-behavior-type');var behavTitle2=$('<div>').addClass('tele-title-2').html('Select aspect type');if(!data.type){data.type='average';}
$.each(behaviorTypes,function(i,opt){var selected=data.type==opt.k?'selected':'';behavSelect.append('<option '+selected+' value="'+opt.k+'">'+opt.v+'</option>');});this.personalBehavior=$('<div>').teleCheckbox({label:'Personal',checked:data.personal?true:false}).addClass('tele-personal-behavior');ruleInner.append(behavTitle).append(behavTitle2).append(behavSelect).append(this.personalBehavior);break;case'geographic':var geoTitle=$('<div>').addClass('tele-title-2').html('Select geographic type');var geoCountries=$('<div>').teleCountry().hide();var geoVelocity=$('<div>').addClass('tele-velocity-wrap');var velocityTimeScopes=[{k:'s',v:'Seconds'},{k:'m',v:'Minutes'},{k:'h',v:'Hours'}];var velocityTimeSelect=$('<select>').addClass('tele-geo-ts');$.each(velocityTimeScopes,function(i,opt){velocityTimeSelect.append('<option value="'+opt.k+'">'+opt.v+'</option>');});if(!data.ts){data.ts=60;}
if(data.ts%60==0&&data.ts!=60){if(data.ts%3600==0){velocityTimeSelect.val('h');data.ts=data.ts/3600}
else{velocityTimeSelect.val('m');data.ts=data.ts/60}}
var g_time_input=$('<div>').teleInput({label:'KM in',width:30,value:data.ts}).addClass('tele-geo-ts-count').css({'margin-right':'5px'});$('input',g_time_input);if(!data.distance){data.distance=1}
var g_radius_slider_div=$('<div>');var g_radius_slider=$('<div>').teleInput({width:30,value:data.distance}).addClass('rule-slider-length');$('input',g_radius_slider);g_radius_slider_div.append(g_radius_slider);geoVelocity.append(g_radius_slider_div).append(g_time_input).append(velocityTimeSelect);var geoType=$('<div>');container.append(geoTitle);container.append(geoType);container.append(geoVelocity);container.append(geoCountries);geoType.teleRadios({radios:[{key:'velocity',label:'Geographic velocity'},{key:'inside',label:'Within selected countries'},{key:'outside',label:'Outside selected countries'},],callback:function(radio){switch(radio.key){case'velocity':geoCountries.hide();geoVelocity.show();break;case'inside':case'outside':geoCountries.show();geoVelocity.hide();break;}}}).addClass('tele-geo-type');if(!data.type){data.type='velocity';}
$('.tele-geo-type [rel="'+data.type+'"]').click();if(data.location&&data.location!=''){var country_list=data.location.split(',');$.each(country_list,function(i,iso){$('.tele-country-list [dataid="'+iso+'"]').click();});}
break;case'aspect':var botTitle=$('<div>').addClass('tele-title-2').html('Bot Type');var botTypes=[{k:'Known-Bot',v:'Known-Bot'},{k:'Tor',v:'Tor'}];var botSelect=$('<select>').addClass('tele-rule-dropdown');if(!data.type){data.type='Known-Bot';}
$.each(botTypes,function(i,opt){var selected=data.type==opt.k?'selected':'';botSelect.append('<option '+selected+' value="'+opt.k+'">'+opt.v+'</option>');});ruleInner.append(botTitle).append(botSelect);if(data&&data.aspect){botSelect.val(data.aspect);}
break;}
if(data){if(data.numeric_score){ruleScore.data('tele-teleInput').option('value',data.numeric_score);}
if(data.seq_index){triggerRule.data('tele-teleInput').option('value',parseInt(data.seq_index)+1);}
if(data.appearance){triggerAlert.data('tele-teleInput').option('value',data.appearance);}}
$('#rule-slider-length').slider({tooltip:'always'});$('#rule-slider-between').slider({tooltip:'always'});$('#rule-slider-similarity').slider({tooltip:'always'});}});;$.widget("tele.teleRadios",{options:{radios:[],callback:function(){},checked:false},_create:function(){this.element.addClass("tele-radios");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.title){$('<div>').html(this.options.title).addClass('tele-title-1').appendTo(this.element);}
this.radios=[];$.each(this.options.radios,function(i,radio){var radioWrap=$('<div>').addClass('tele-radio-wrap');var radioLabel=$('<div>').addClass('tele-radio-label').html(radio.label);var radioInput=$('<div>').addClass('tele-radio-radio').attr('rel',radio.key);radioWrap.click(function(){$('.tele-radio-knob',that.element).remove();$('.tele-radio-radio',this).append('<div class="tele-radio-knob"></div>');that.options.callback(radio);that.options.checked=radio.key;}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});radioWrap.append(radioInput).append(radioLabel);that.element.append(radioWrap);that.radios.push(radioWrap);if(radio.checked||radio.key==that.options.checked){radioInput.addClass('checked');radioWrap.click();}});}});;$.widget("tele.teleBrowse",{options:{callback:function(node){},label:false,mode:'page',value:'',id:false,dataID:false,domain:false,pagename:false,paramname:false,global:false,filename:false},_create:function(){this.element.addClass("tele-browse");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();if(!this.options.label){this.options.label=this.options.mode=='param'?'Select Parameter':'Select Page';}
this.input=$('<div>').teleInput({label:this.options.label,value:this.options.value})
this.button=$('<div>').btn({text:'Browse',callback:function(){that.openBrowser();}});this.element.append(this.input).append(this.button);output={type:this.options.mode};if(this.options.domain){output.domain=this.options.domain;}
if(this.options.pagename){output.pagename=this.options.pagename;}
if(this.options.paramname){output.paramname=this.options.paramname;}
if(this.options.global){output.global=this.options.global;}
if(output.paramname||output.pagename){$('input',this.input).val(output.paramname!=''?output.paramname:output.pagename).data('selected',JSON.stringify(output));}},openBrowser:function(){var that=this;$('.tele-overlay-mask-dialog').remove();$('.tele-overlay-dialog').remove();this.maskEl=$('<div>').addClass('tele-overlay-mask').addClass('tele-overlay-mask-dialog');this.overlayEl=$('<div>').addClass('tele-overlay').addClass('tele-overlay-dialog');this.overlayEl.css({height:470,width:500});this.headerEl=$('<div>').addClass('tele-overlay-header');this.contentEl=$('<div>').addClass('tele-overlay-content');this.titleEl=$('<div>').addClass('tele-overlay-title').html(this.options.label);this.closeEl=$('<a>').attr('href','#').addClass('tele-overlay-close').addClass('tele-icon').addClass('tele-icon-close');this.textEl=$('<div>').addClass('tele-dialog-text').html('Some Text');$('body').append(this.maskEl);$('body').append(this.overlayEl);this.overlayEl.append(this.headerEl).append(this.contentEl);this.headerEl.append(this.titleEl).append(this.closeEl);this.closeEl.click(function(){that.maskEl.remove();that.overlayEl.remove();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$(this.overlayEl).draggable({handle:this.headerEl});this.browserEL=$('<div>');this.contentEl.append(this.browserEL);this.browserEL.teleBrowser({callback:function(e,data){if(data&&data.node){if(that.options.mode==data.node.data.type){var output={type:data.node.data.type};switch(data.node.data.type){case'page':output.domain=data.node.data.host;output.pagename=data.node.data.path;break;case'param':output.paramname=data.node.data.name;if(data.node.data.global){output.global=true;}else{var parent=data.instance.get_node(data.node.parent);if(parent.data)
{output.domain=parent.data.host;output.pagename=parent.data.path;}}
break;}
window.d=data;that.maskEl.remove();that.overlayEl.remove();var selected_value=(that.options.mode=='page')?data.node.data.path:data.node.text;$('input',that.input).val(selected_value).data('selected',JSON.stringify(output));that.options.dataID=data.node.data.id;that.options.callback(data.node.data.id);that.options.filename=selected_value;that.options.text=data.node.text;}}},mode:that.options.mode});}});;$.widget("tele.teleBrowser",{searchText:'',options:{mode:'page',root:{type:'root',id:-1},callback:function(e,data){},grid:{columns:[{width:380}],resizable:true}},_create:function(){this.element.addClass("tele-browser");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},expand:function(obj,callback,widget){var that=this;if(widget&&widget.options&&widget.options.root&&widget.options.root.type=='application'&&obj.id=='#'){telepath.ds.get('/applications/get_page',{host:widget.options.root.id,path:"",mode:that.options.mode},function(data){var host='';var treeData=[];if(obj&&obj.data&&obj.data.host)
{host=obj.data.host;}else{host=that.options.root.id;}
if(data.items){$.each(data.items,function(i,item){if(item.type!='page'&&item.type!='dir')
{item.type='param';}
treeData.push({children:false,text:escapeHtml(item.name),icon:'tele-icon-'+item.type,data:item});});}
callback.call(that,treeData);});return;}
var searchTerm=$('input',window.teleBrowseSearch).val();if(searchTerm!=''&&$('input',window.teleBrowseSearch).attr('complete')!='true'){telepath.ds.get('/applications/get_search',{search:searchTerm,mode:that.options.mode},function(data){var treeData=telepath.config.applications.formatSearchData(data.items,that.options.mode);callback.call(that,treeData);$('input',window.teleBrowseSearch).attr('complete','true');});return;}
if(obj.id=='#'){telepath.ds.get('/applications/get_expand',{size:9999},function(data){var treeData=telepath.config.applications.formatData(data.items.data,false);function enable_expand(treeData){$.each(treeData,function(i,row){if(row.children&&row.children.length>0){enable_expand(row.children);}else{row.children=true;}});}
enable_expand(treeData);if(that.options.mode=='param'){treeData.unshift({icon:'tele-icon-global',text:'Global Headers',children:true,data:{'type':'global'}});}
callback.call(that,treeData);});}else{if(obj.data.type=='global'){var treeData=[];$.each(telepath.global_headers,function(i,x){treeData.push({children:false,text:x,icon:'tele-icon-param',data:{type:'param',global:true,name:x}});});callback.call(that,treeData);return;}
if(obj.data.type=='app'){if(!obj.data.host){obj.data.host=obj.data.text;}
telepath.ds.get('/applications/get_app_pages',{host:obj.data.host},function(data){var treeData=telepath.config.applications.formatDataPages(data.items,'/',obj.data.host);function enable_expand(treeData){$.each(treeData,function(i,row){if(row.children&&row.children.length>0){enable_expand(row.children);}else{if(that.options.mode=='page')
row.children=false;else
row.children=true;}});}
enable_expand(treeData);callback.call(that,treeData);});}
if(obj.data.type=='page'&&that.options.mode!='page'){telepath.ds.get('/applications/get_page',{host:obj.data.host,path:obj.data.path,mode:that.options.mode},function(data){var treeData=[];if(data.items.length==0){treeData.push({children:false,text:"No parameters",icon:'tele-icon-param'});}
else if(data.items){$.each(data.items,function(i,item){item.type='param';treeData.push({children:false,text:escapeHtml(item.name),icon:'tele-icon-param',data:item});});}
callback.call(that,treeData);});}}},_update:function(){var that=this;this.search=$('<div>').teleSearch({callback:function(val){$('input',window.teleBrowseSearch).attr('complete','false');that.teleTree.data('jstree').close_all();that.teleTree.data('jstree').refresh();that.searchText=val;}});window.teleBrowseSearch=this.search;this.element.parent().parent().find('.tele-overlay-header').append(this.search);this.teleTree=$('<div>');this.treeCont=$('<div>').css({clear:'both',height:400,overflow:'auto'});this.treeCont.append(this.teleTree);this.element.append(this.treeCont);this.teleTree.jstree({core:{check_callback:true,data:function(obj,callback){that.expand(obj,callback,that);},reopen:true,progressive_render:true},plugins:["json_data","wholerow","theme","contextmenu"],contextmenu:{items:telepath.contextMenu}}).on('changed.jstree',function(e,data){that.options.callback(e,data);}).on('hover_node.jstree',function(e,data){$('#'+data.node.id).addClass('hover');}).on('dehover_node.jstree',function(e,data){$('#'+data.node.id).removeClass('hover');}).on('open_node.jstree close_node.jstree',function(e,data){if(e.type==="open_node"){}});$(this.treeCont).mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:150,advanced:{updateOnContentResize:true}});}});;$.fn.h=function(){this.hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});return this;};telepath.loader='<div class="tele-loader"></div>';telepath.autocomplete={disabled:false,get:function(element,type,value){$('.tele-loader',element.parent()).remove();$('.tele-autocomplete-select','body').remove();if(this.disabled){return;}
if(typeof(value)=='undefined'){value=$(element).val();if(value==''||value=='All'){$(element).attr('placeholder','All');$(element).data('tele-select',{});}}
$(element).css({backgroundColor:'#cecece'});element.parent().append(telepath.loader);var url='';switch(type){case'page':url='/applications/get_autocomplete_page';break;case'application':url='/applications/get_autocomplete';break;case'subdomain':url='/applications/get_subdomain_autocomplete';break;case'action':url='/actions/get_action_autocomplete';break;}
telepath.ds.get(url,{text:value},function(data){$('.tele-loader',element.parent()).remove();$(element).css({backgroundColor:'white'});if(data.items){telepath.autocomplete.render(element,data.items);}},'Failed autocomplete');},render:function(element,items){var container=element.parent();var resultsEl=$('<div>').addClass('tele-autocomplete-select');var offset=element.offset();$('body').click(function(e){if($(e.target).parents('.tele-autocomplete-select').size()==0){$('.tele-autocomplete-select').remove();}});$('.tele-autocomplete-select','body').remove();resultsEl.css({position:'absolute',top:offset.top+24,left:offset.left,width:element.outerWidth()-2}).appendTo('body');$.each(items,function(i,item){var resultEl=$('<div>').addClass('tele-autocomplete-item').text(item.key).data('tele-select',item).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});if(item.root){resultEl.addClass('rootdomain');}else{resultEl.addClass('subdomain');}
resultEl.click(function(){telepath.autocomplete.disabled=true;element.val(item.key);element.data('tele-select',item);$('.tele-autocomplete-select','body').remove();setTimeout(function(){telepath.autocomplete.disabled=false;},1500);$(element).parents('.tele-multi').data('tele-teleSelect').options.click();}).h();resultsEl.append(resultEl);});}}
$.widget("tele.teleSelect",{items:[],result:function(){var result=[];$('.tele-multi-input input',this.element).each(function(){result.push($(this).data('tele-select'));});return result;},options:{type:'application',constrain:5,click:function(){},template:function(element,value){element.addClass('tele-multi-input');var that=this;var input=$('<input>');if(value.text=='All'){input.attr("placeholder",value.text);}
else{input.val(value.text);}
input.data('tele-select',value);var dd_arrow=$('<div>');element.append(input);element.append(dd_arrow);input.on('keypress',function(){if(window.autocompleteTimer){clearTimeout(window.autocompleteTimer);}
window.autocompleteTimer=setTimeout(function(){telepath.autocomplete.get(input,that.type);},500);value.text=input.val();input.data('tele-select',value);});input.on('change',function(){if(window.autocompleteTimer){clearTimeout(window.autocompleteTimer);}
window.autocompleteTimer=setTimeout(function(){telepath.autocomplete.get(input,that.type);},500);value.text=input.val();input.val('');input.data('tele-select',value);});input.on('click',function(){if($(this).val()=='All'){$(this).select();setTimeout(function(){telepath.autocomplete.get(input,that.type,'');},500);}else{setTimeout(function(){telepath.autocomplete.get(input,that.type);},500);}});dd_arrow.on('click',function(){input.trigger('click');});},values:[]},_create:function(){this.element.addClass("tele-multi");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;var tpl_add='';var tpl_close='';if(this.options.label){var label=$('<div>').addClass('tele-label').html(this.options.label);this.element.append(label);}
if(this.options.values){$.each(this.options.values,function(i,val){var container=$('<div>').addClass('tele-multi-value');var controls=$('<div>').addClass('tele-multi-control');var cmd_delete=$('<div>').addClass('tele-icon tele-icon-minus').html(tpl_close).h();var el=$('<div>');that.options.template(el,val);cmd_delete.click(function(){container.remove();that.constrain();});controls.append(cmd_delete);container.append(el).append(controls);that.element.append(container);that.items.push(container);});}
var container=$('<div>').addClass('tele-multi-value');var controls=$('<div>').addClass('tele-multi-control');this.cmd_create=$('<div>').addClass('tele-icon tele-icon-plus').html(tpl_add).h();controls.append(this.cmd_create);container.append(controls);that.element.append(container);this.cmd_create.click(function(){var container=$('<div>').addClass('tele-multi-value');var controls=$('<div>').addClass('tele-multi-control');var cmd_delete=$('<div>').addClass('tele-icon tele-icon-minus').html(tpl_close).h();var el=$('<div>');that.options.template(el,{text:'',root:true});controls.append(cmd_delete);cmd_delete.click(function(){container.remove();that.constrain();});container.append(el).append(controls);that.cmd_create.parent().parent().before(container);that.constrain();}).h();$('.tele-icon',this.element).h();},constrain:function(){if($('.tele-multi-value',this.element).size()>this.options.constrain){this.cmd_create.hide();}else{this.cmd_create.show();}
if($('.tele-multi-value',this.element).size()<2){this.cmd_create.click();}}});;$.widget("tele.teleMulti",{options:{template:function(element,value){element.teleInput({value:value});},values:[]},_create:function(){this.element.addClass("tele-multi");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.title){var title=$('<div>').addClass('tele-title-1').html(this.options.title);this.element.append(title);}
if(this.options.values){$.each(this.options.values,function(i,val){var container=$('<div>').addClass('tele-multi-value');var controls=$('<div>').addClass('tele-multi-control');var cmd_delete=$('<div>').addClass('tele-icon tele-icon-delete');var el=$('<div>');that.options.template(el,val);cmd_delete.click(function(){container.remove();});controls.append(cmd_delete);container.append(el).append(controls);that.element.append(container);});}
var container=$('<div>').addClass('tele-multi-value');var controls=$('<div>').addClass('tele-multi-control');var cmd_create=$('<div>').addClass('tele-icon tele-icon-plus').h();controls.append(cmd_create);container.append(controls);that.element.append(container);cmd_create.click(function(){var container=$('<div>').addClass('tele-multi-value');var controls=$('<div>').addClass('tele-multi-control');var cmd_delete=$('<div>').addClass('tele-icon tele-icon-delete').h();var el=$('<div>');that.options.template(el,'');controls.append(cmd_delete);cmd_delete.click(function(){container.remove();});container.append(el).append(controls);cmd_create.parent().parent().before(container);});}});;$.widget("tele.teleRange",{options:{label:false,options:{range:true,min:0,max:100}},_create:function(){this.element.addClass("tele-range");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},update_range:function(event,ui){if(ui.values){$(event.target).parent().find('.tele-range-from').html(ui.values[0]);$(event.target).parent().find('.tele-range-to').html(ui.values[1]);}else{if(ui.value){$(event.target).parent().find('.tele-range-to').html(ui.value);}}},_update:function(){var that=this;this.element.empty();if(this.options.label){this.label=$('<label>').addClass('tele-input-label').html(this.options.label);this.element.append(this.label);}else{this.element.addClass('no-label');}
this.range_from=$('<div>').addClass('tele-range-from').html(this.options.options.min);this.range_to=$('<div>').addClass('tele-range-to').html(this.options.options.max);if(!this.options.options.range){this.range_from.hide();this.range_to.html(this.options.options.value);}
this.options.options.slide=that.update_range;this.options.options.change=that.update_range;this.range=$('<div>').slider(this.options.options);this.element.append(this.range_from);this.element.append(this.range);this.element.append(this.range_to);if(this.options.suffix){this.suffix=$('<label>').addClass('tele-input-suffix').html(this.options.suffix);this.element.append(this.suffix);}}});;$.widget("tele.teleFile",{options:{label:false,type:'file',data:''},_create:function(){this.element.addClass("tele-file");this.element.addClass("tele-browse");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();this.input=$('<div>').teleInput({label:this.options.label,value:this.options.value}).click(function(){that.file.click();});this.button=$('<div>').btn({text:'Browse',callback:function(){that.file.click();}});this.file=$('<input type="file">').css('opacity','0');this.element.append(this.input).append(this.button).append(this.file);this.file.change(function(e){var files=this.files;if(!files.length){$('input',that.input).css({borderColor:'red'});return false;}
var file=files[0];window.file=file;that.input.teleInput('option','value',file.name+' ('+parseInt(file.size/1024)+'KB)');var type=that.options.type;if(type=='certificate'||type=='privatekey'){if(file.size>1024*10){$('input',that.input).css({borderColor:'red'});$('input',that.input).css({borderColor:'red'}).val('');if(type=='privatekey'){telepath.dialog({type:'alert',title:'Telepath',msg:'Not a valid Private Key file'});}
if(type=='certificate'){telepath.dialog({type:'alert',title:'Telepath',msg:'Not a valid Certificate file'});}
$('input',that.input).data('file','');return false;}else{var reader=new FileReader();reader.onloadend=function(evt){if(evt.target.readyState==FileReader.DONE){var data=evt.target.result;if(type=='privatekey'&&data.toUpperCase().indexOf('PRIVATE KEY')==-1){$('input',that.input).css({borderColor:'red'}).val('');telepath.dialog({type:'alert',title:'Telepath',msg:'Not a valid Private Key file'});$('input',that.input).data('file','');return false;}else{$('input',that.input).data('file',data);}
if(type=='certificate'&&data.toUpperCase().indexOf('CERTIFICATE')==-1){$('input',that.input).css({borderColor:'red'});$('input',that.input).css({borderColor:'red'}).val('');telepath.dialog({type:'alert',title:'Telepath',msg:'Not a valid Certificate file'});$('input',that.input).data('file','');return false;}else{$('input',that.input).data('file',data);}
that.data=data;}};reader.readAsBinaryString(file);}}});}});;$.widget("tele.teleSearch",{options:{callback:function(){}},_create:function(){this.element.addClass("tele-search");this._update();},rewrite:function(text){$.each(telepath.countries.map,function(k,val){if(val.toLowerCase()==text.toLowerCase()){text='country_code:'+k.toLowerCase();}});return text;},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();var inputEl=$('<input type="text">').addClass('tele-search-input');var buttonEl=$('<a>').attr('href','#').addClass('tele-search-button').attr('id','search-button');this.element.append(inputEl).append(buttonEl);buttonEl.click(function(e){var term=that.rewrite(inputEl.val());that.options.callback(e,term);});$(inputEl).keydown(function(e){if(e.keyCode==13){var term=that.rewrite(inputEl.val());that.options.callback(e,term);}});},});;$.widget("tele.teleRequest",{options:{data:[],},_create:function(){this.element.addClass('tele-request').addClass('tele-rounded-box');this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;if(this.options.data.pagename){this.options.data.uri=this.options.data.pagename;}
if(this.options.data.params){this.options.data.parameters=this.options.data.params;}
this.pagePath=$('<div>').addClass('tele-request-page-path').html(this.options.data.uri).attr('title',this.options.data.uri);this.requestDelete=$('<div>').btn({icon:'delete',callback:function(){$('.popover').remove();that.element.remove();}});var has_params=false;if(this.options.data.parameters){has_params=true;}
this.element.append(this.pageTitle).append(this.pagePath).append(this.requestDelete).append(this.requestEdit);if(has_params){this.element.hover(function(){$(this).addClass('hover');that.showParameters();},function(){$(this).removeClass('hover');that.hideParameters();}).click(function(){that.showParameters();});}else{this.element.append('<span style="font-size: 11px; margin-left: 27px; color: blue; clear: both; float: left;">No parameters</span>');}},showParameters:function(){var that=this;$('.popover').remove();this.hideParameters();this.pop=$('<div>').css({position:'absolute',top:$(this.element).offset().top+20,left:$(this.element).offset().left+600});$('body').append(this.pop);var title=(this.options.data.title&&this.options.data.title!='')?this.options.data.title:this.options.data.uri;var content=$('<div>');if(this.options.data.parameters){$.each(this.options.data.parameters,function(i,param){var paramContainer=$('<div>').addClass('tele-request-param');var paramEdit=$('<div>').btn({icon:'delete',callback:function(){that.removeParameter(param.name);that.showParameters();}});var paramName_value=escapeHtml(param.name);var paramName=$('<div title='+paramName_value+'>').addClass('tele-request-param-name').html(paramName_value);if(param.value){param.data=escapeHtml(param.value);}
var paramValue=$('<div>').addClass('tele-request-param-value').html(param.data);var paramValueEdit=$('<div>').btn({icon:'edit',callback:function(){var edit=$('<div>').teleInput({value:param.data!='*'?param.data:''});paramValue.empty();paramValue.append(edit);$('input',edit).css({width:125}).focus().blur(function(){var value=$(this).val();$(this).remove();paramValue.empty();paramValue.html(value);that.updateParameter(param.name,value);});}});paramContainer.append(paramEdit).append(paramName).append(paramValue).append(paramValueEdit);content.append(paramContainer);});}
$(this.pop).popover({title:title,html:true,content:content}).popover('show');$('.popover').addClass('tele-params-popover');},hideParameters:function(){if(this.pop){this.pop.remove();}},removeParameter:function(name){for(var x in this.options.data.parameters){if(this.options.data.parameters[x].name==name){this.options.data.parameters.splice(x,1);}}},updateParameter:function(name,value){for(var x in this.options.data.parameters){if(this.options.data.parameters[x].name==name){this.options.data.parameters[x].data=value;this.options.data.parameters[x].value=value;}}}});;$.widget("tele.teleCountry",{options:{data:{value:[]}},_create:function(){this.element.addClass('tele-country-widget');this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},getSelected:function(){var result='';$('.tele-checkbox-checkbox.checked').each(function(){if($(this).attr('dataid')){result=result+$(this).attr('dataid')+',';}});return result.substr(0,result.length-1);},_update:function(){var that=this;var autoComplete=$('<div>');this.element.append(autoComplete);autoComplete.teleInput({label:"Search countries:",labelCSS:{width:120}});$('input',autoComplete).keyup(function(){var search=$(this).val().toLowerCase();if(search==''){$(this).parents('div').find('.tele-country-list li').show();return;}
$(this).parents('div').find('.tele-country-list li').each(function(){if($(this).text().toLowerCase().indexOf(search)>-1){$(this).show();}else{$(this).hide();}});});var cList=$('<ul>').addClass('tele-country-list');this.element.append(cList);that.options.selected=[];$.each(telepath.countries.map,function(code,text){var checked=false;for(x in that.options.values){if(that.options.values[x]==code){checked=true;}}
that.options.selected.push({dataID:code,checked:checked});});$.each(telepath.countries.map,function(code,text){var checked=false;for(x in that.options.values){if(that.options.values[x]==code){checked=true;}}
var listEl=$('<li>').hover(function(){$(this).addClass('hover')},function(){$(this).removeClass('hover')}).addClass('tele-country-letter-'+code.substr(0,1).toUpperCase());var cbEl=$('<span>').teleCheckbox({checked:checked,inputFirst:true,dataID:code,label:'<span class="flag flag-'+code+'"></span><span class="text">'+text+'</span>',callback:function(){var dataID=this.dataID;var checked=this.checked;$.each(that.options.selected,function(i,selection){if(selection.dataID==dataID){that.options.selected[i].checked=checked;}});}});listEl.append(cbEl);cList.append(listEl);});cList.mCustomScrollbar({scrollButtons:{enable:false},advanced:{updateOnContentResize:true}});}});;telepath.sessionflow={RID:0,RIDS:[],list:false,searchkey:'',selectedIndex:0,similarities:[],currentUID:-1,reloadFlag:Date.now(),alertsList:false,session:{requests:[],alerts:[],flows:[]},resizeMid:function(){var height=$(this.overlay.contentEl).height();var items=$('.tele-request-details',this.boxMid).size();height=height-100;if(height<300)
{height=300;}
if(items==2){height=(height/2)-120;$('.tele-alert-params-table-wrap .mCustomScrollBox').css({maxHeight:height});}
$('.tele-alert-params-table-wrap .mCustomScrollBox').css({maxHeight:(height-100)});$('.tele-alert-params-table-wrap').each(function(){$(this).mCustomScrollbar('update');});},printRequestScores:function(data,container){this.requestScoreEl=$('<div>').anomalyScore({request:data});container.append(this.requestScoreEl);},showSimilarities:function(data){var that=this;this.similarities=data;this.similaritiesList=$('<div>').appendTo(this.boxRight).addClass('tele-similarities-list');var height=this.overlay.contentEl.height()-this.requestScoreEl.outerHeight()-$('.tele-alert-info-table',this.overlay.contentEl).outerHeight()-2*20-75;if(this.width<1250){var height=this.overlay.contentEl.height()-this.requestScoreEl.outerHeight()-$('.tele-alert-info-table',this.overlay.contentEl).outerHeight()-2*20-75-75;this.similaritiesList.css({'height':height});}
else{this.similaritiesList.css({width:380,'height':height});}
this.similaritiesList.on('teleList.afterUpdate',function(){$(this).trigger('resize');});this.similaritiesList.teleList({data:data.hits.hits,title:'Similar Requests',height:height,clickable:false,formatter:function(row){return telepath.sessionflow.formatData(row);},callbacks:{click:function(widget){that.requestData=widget.options.raw;$(widget.element).parent().find('.tele-listitem-inner.selected').removeClass('selected');$('.tele-listitem-inner',widget.element).addClass('selected');if(that.similarityDetails){that.similarityDetails.remove();}
$('.tele-similarity-details').remove();that.similarityDetails=$('<div>').addClass('tele-request-details tele-similarity-details').addClass('tele-popup-2').css({marginTop:20});if(that.width<1250){$('.tele-similarities-list.tele-block').before(that.similarityDetails.hide().fadeIn());}
else{that.boxMid.append(that.similarityDetails);}
var wrap=$('<div>').addClass('tele-alert-details-info');that.requestData.score_average=parseFloat(that.requestData.score_average);if(that.requestData.score_average>0&&that.requestData.score_average<=1){that.requestData.score_average=that.requestData.score_average*100;}
var severityPercent=parseInt(that.requestData.score_average)+'%';that.alertSeverityWrap=$('<div>').addClass('tele-alert-severity-wrap');that.alertSeverityLabel=$('<div>').addClass('tele-alert-severity-label').text('Severity');that.alertSeverityPercent=$('<div>').addClass('tele-alert-severity-percent').text(severityPercent);that.alertSeverityProgBar=$('<div>').addClass('tele-alert-severity-progbar');that.alertSeverityProgValue=$('<div>').addClass('tele-alert-severity-progbar-value').css({width:severityPercent});that.alertSeverityWrap.append(that.alertSeverityLabel).append(that.alertSeverityPercent).append(that.alertSeverityProgBar);that.alertSeverityProgBar.append(that.alertSeverityProgValue);wrap.append(that.alertSeverityWrap);var title=$('<div>').addClass('tele-alert-details-info-title');that.printLink(that.requestData,title);wrap.append(title);that.similarityDetails.append(wrap);that.printParamsTable(that.similarityDetails);that.resizeMid();},hover_in:function(el,item){$('.popover').remove();var that=this;var RID=item.dataID;var similarity=telepath.sessionflow.lookupSimilarity(RID);if(similarity===false){return;}
function getRow(lbl,data){var row=$('<tr>');var td_1=$('<td>').html(lbl).addClass('tele-alert-info-key');var td_2=$('<td>').html(data).addClass('tele-alert-info-value');row.append(td_1).append(td_2);return row;}
similarity._source._score=similarity._score;similarity=similarity._source;var table=$('<table>').addClass('tele-alert-info-table');table.append(getRow('Time:',date_format('d/m/y | H:i:s',similarity.ts)));table.append(getRow('Application:',escapeHtml(similarity.host)));table.append(getRow('IP:',similarity.ip_orig));table.append(getRow('Location:',(similarity.country_code!='00'?'<span class="flag flag-'+similarity.country_code+'"></span>':'')+'<span class="tele-country">'+telepath.countries.a2n(similarity.country_code)+'</span>'));if(similarity.username){table.append(getRow('User:',escapeHtml(similarity.username)));}
table.append(getRow('Similarity:',similarity._score.toFixed(2)+'%'));telepath.sessionflow.pop=$('<div>').css({position:'absolute',top:$(el).offset().top,left:$(el).offset().left+70});$('body').append(telepath.sessionflow.pop);$(telepath.sessionflow.pop).popover({title:similarity.orig_ip,html:true,content:'<table cellspacing="10">'+table.html()+'</table>',}).popover('show');},hover_out:function(el,item){if(telepath.sessionflow.pop){telepath.sessionflow.pop.remove();}}}});this.similaritiesList.css("height","300px !important");this.similaritiesList.trigger('resize');$(window).resize(function(){that._resize()});},_resize:function(){if(this.overlay.contentEl.height())
{var height=this.overlay.contentEl.height()-this.requestScoreEl.outerHeight()-$('.tele-alert-info-table',this.overlay.contentEl).outerHeight()-2*20-55;$('.tele-similarities-list .tele-block').height(height-20);$('.tele-similarities-list .tele-list').mCustomScrollbar("update");}},init:function(SID,IP,alerts_names,state,searchkey,list){this.session=false;this.SID=SID;this.IP=IP;this.alerts_names=alerts_names;this.searchkey=searchkey;this.list=list;this.suspect='';this.range=true;if(searchkey&&state=='suspect')
{this.filter='Search';this.suspect='Suspect';}else if(searchkey)
{this.filter='Search';}
else if(state&&state=='alert'){this.filter='Alerts';}else if(state&&state=='suspect'){this.filter='Suspect';this.suspect='Suspect';}else if(state&&state=='case'){this.range=false;this.filter='All';}else{this.filter='All';}
if(telepath.access.admin||telepath.access.perm.Sessionflow_get){this.buildUI();this.loadSession(this.SID);}else{telepath.dialog({msg:'Access denied. No permissions to view Session Flow.'});};},loadSession:function(){this.mode='session';var that=this;this.container.empty().append(telepath.loader);that.session={};telepath.ds.get('/sessionflow/get_session_stats',{sid:that.SID,searchkey:that.searchkey,state:that.suspect},function(data){that.session.stats=data.items;telepath.ds.get('/sessionflow/get_sessionflow',{sid:that.SID,filter:that.filter,searchkey:that.searchkey,alerts:that.alerts_names,ip:that.IP,range:that.range},function(data){that.session.items=data.items;that.showSession();});});},buildUI:function(){var that=this;$(document).unbind('keydown',telepath.sessionflow.keyDown);$(document).bind('keydown',telepath.sessionflow.keyDown);$(document).bind('overlay_destroy',telepath.alert.destroy);telepath.overlay.init('alerts','Loading Sessionflow',true,500);this.overlay=telepath.overlay;this.container=this.overlay.contentEl;if(this.list){var total=0;var index=0;$('.tele-listitem',this.list).each(function(){var itemRID=$(this).data('tele-listitem').options.itemID;if(itemRID==that.RID){index=total;}
that.RIDS.push(itemRID);total++;});this.pagination=$('<div>').pagination({current:index,count:total,name:that.alertsList?'Alert':'Session',callback:function(itemIndex){that.SID=that.RIDS[itemIndex];that.loadSession();}});this.overlay.headerEl.append(this.pagination);}},showSession:function(){var that=this;this.container.empty();this.selectedIndex=0;for(x in that.session.requests){var request=that.session.requests[x];if(request.RID==that.RID){this.selectedIndex=parseInt(x);break;}
for(y in that.session.flows){var flow=that.session.flows[y];if(flow.RID==request.RID){that.session.requests[x].business_id=flow.business_id;that.session.requests[x].business_status=flow.business_status;}}}
this.boxLeft=$('<div>').addClass('tele-box-left');this.boxMid=$('<div>').addClass('tele-box-mid');this.boxRight=$('<div>').addClass('tele-box-right');this.width=window.innerWidth;if(this.width<1250){var width=this.overlay.contentEl.width();this.container.append(this.boxLeft,this.boxRight);var height=this.overlay.contentEl.height()-70;var mid_width=width-$(this.boxLeft).outerWidth()-50;this.boxRight.css({'height':height}).width(mid_width)
$('.tele-box-right').mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:200,advanced:{updateOnContentResize:true},});}
else{var width=this.overlay.contentEl.width();this.container.append(this.boxLeft,this.boxMid,this.boxRight);var mid_width=width-$(this.boxLeft).outerWidth()-$(this.boxRight).outerWidth()-50;this.boxMid.width(mid_width);}
var count_all=this.session.stats.total;var count_alerts=this.session.stats.alerts_count;var count_actions=this.session.stats.actions_count;var search_count=this.session.stats.search_count;var suspect_count=this.session.stats.suspect_count;var statsEl=$('<div>').addClass('tele-alert-stats');$.each({'All':count_all,'Search':search_count,'Alerts':count_alerts,'Actions':count_actions,Suspect:suspect_count},function(key,stat){if(stat>0)
{var stat_filter=$('<div>').addClass('tele-alert-stat-key').html(key).click(function(){telepath.sessionflow.filter=key;telepath.sessionflow.loadSession();$('.tele-alert-stat-key').removeClass('active');$(this).addClass('active');});if(telepath.sessionflow.filter==key){stat_filter.addClass('active');}
statsEl.append($('<div>').addClass('tele-alert-stat').append(stat_filter).append($('<div>').addClass('tele-alert-stat-value').html(stat)));}});this.boxLeft.append(statsEl);this.actionsContainer=$('<div>').addClass('tele-requests-list');this.boxLeft.append(this.actionsContainer);this.requestDetails=$('<div>').addClass('tele-request-details').addClass('tele-popup-2');if(this.width<1250){this.boxRight.append(this.requestDetails)}
else{this.boxMid.prepend(this.requestDetails);}
this.lastAction=-1;this.printed=0;for(x in that.session.items){var req=that.session.items[x];that.appendItem(req);}
if(this.width<1250){var height=this.container.height()-statsEl.height()-70;}
else{var height=this.container.height()-statsEl.height()-100;}
$(this.actionsContainer).css({'height':height});$(this.actionsContainer).mCustomScrollbar({callbacks:{onTotalScroll:function(){if(that.loading){return;}
that.loading=true;$('.mCSB_container',that.actionsContainer).append($(telepath.loader).css({float:'left',clear:'both','bottom':30,position:'absolute'}));var offset=that.session.items.length;telepath.ds.get('/sessionflow/get_sessionflow',{sid:that.SID,filter:that.filter,offset:offset,range:that.range},function(data){that.loading=false;$('.tele-loader',that.actionsContainer).remove();if(data.items.length>0){$.each(data.items,function(i,item){that.session.items.push(item);that.appendItem(item);});}});},},onTotalScrollOffset:200,alwaysTriggerOffsets:false,advanced:{updateOnContentResize:true}});this.updateSelected();this.overlay.titleEl.html('Session Flow');},appendItem:function(req){if(this.lastAction==-1||(req.business_actions&&(req.business_actions[0].name!=this.lastAction||req.business_actions[0].status==2))||(!req.business_actions&&this.lastAction!=-1&&this.lastAction!='Browsing')){var action_name=req.business_actions?req.business_actions[0].name:'Browsing';this.actionContainer=$('<div>').addClass('tele-alert-action');this.actionContainerIcon=$('<div>').addClass('tele-alert-action-icon').addClass('tele-icon').addClass('tele-icon-suspect');this.actionContainerTitle=$('<div>').addClass('tele-alert-action-title').text(action_name);this.newList=$('<ul class="tele-list">');this.actionContainer.append(this.actionContainerIcon).append(this.actionContainerTitle).append(this.newList);if($('.mCSB_container',this.actionsContainer).size()>0){$('.mCSB_container',this.actionsContainer).append(this.actionContainer);}else{this.actionsContainer.append(this.actionContainer);}
this.lastAction=action_name;}
var item=this.formatData(req);var newListItem=$('<li>').attr('id','alert-item-'+x);this.newList.append(newListItem);newListItem.listitem(item);this.printed++;},rowFormatter:function(item){return{icon:'alert',time:item.ts,progbar:true,itemID:item.uid,progbarBig:item.progbarBig,checkable:item.checkable,checked:item.checked,progbarValue:item.score_average,title:item.uri,details:[{key:'country',value:item.country_code},{key:'IP',value:item.orig_ip},{key:'city',value:item.city},]};},filters:{H:true,P:true,G:true,J:true,X:true,},getSeverity:function(numeric_score){var result=$('<div>').addClass('tele-severity');if(numeric_score>0&&numeric_score<70){result.addClass('tele-severity-low').text('Low');}
if(numeric_score>=70&&numeric_score<90){result.addClass('tele-severity-medium').text('Medium');}
if(numeric_score>=90&&numeric_score<100){result.addClass('tele-severity-critical').text('Critical');}
result.append('&nbsp;<span>('+numeric_score+')</span>');return result;},lookupAction:function(business_id){for(x in telepath.actionList){if(telepath.actionList[x].id=business_id){return telepath.actionList[x].name;}}
return'Browsing';},lookupSimilarity:function(RID){for(x in this.similarities.hits.hits){var req=this.similarities.hits.hits[x];if(req._id==RID){return req;}}
return false;},lookupRequest:function(RID){for(x in this.session.items){var req=this.session.items[x];if(req.uid==RID){return req;}}
for(x in this.similarities){var req=this.similarities[x];if(req.uid==RID){return req;}}
return false;},updateSelected:function(){$('.selected',this.actionsContainer).removeClass('selected');var newSelected=$("li:nth-child("+(this.selectedIndex+1)+")",this.actionsContainer);$('.tele-listitem-inner',newSelected).addClass('selected');if(newSelected.data('tele-listitem')&&newSelected.data('tele-listitem').options){var dataID=newSelected.data('tele-listitem').options.dataID;}else{newSelected=$("li:nth-child(1)",this.actionsContainer);var dataID=newSelected.data('tele-listitem').options.dataID;}
this.expandRequest(dataID);$(this.actionsContainer).mCustomScrollbar("scrollTo","li:nth-child("+(this.selectedIndex+1)+")");},scrollUp:function(){if(this.selectedIndex>0){this.selectedIndex--;}
this.updateSelected();},scrollDown:function(){if(this.selectedIndex<this.session.items.length){this.selectedIndex++;}
this.updateSelected();},keyDown:function(e){if(e.keyCode=='38'){e.preventDefault();telepath.sessionflow.scrollUp();}
if(e.keyCode=='40'){e.preventDefault();telepath.sessionflow.scrollDown();}},destroy:function(){$(document).unbind('overlay_destroy',telepath.alert.destroy);$(document).unbind('keydown',telepath.alert.keyDown);},initAlertTools:function(){this.archiveAlert=$('<div>').btn({icon:'archive',text:'Archive Alert',callback:function(){}});this.moveTo=$('<div>').teleDropdown({icon:'moveTo',value:'Move To',callback:function(){}});this.editRule=$('<div>').btn({icon:'editRule',text:'Edit Rule',callback:function(){}});var wrap=$('<div>').addClass('tele-overlay-tools');wrap.append('<div class="tele-navsep"></div>').append(this.archiveAlert).append('<div class="tele-navsep"></div>').append(this.moveTo).append('<div class="tele-navsep"></div>').append(this.editRule);this.overlay.headerEl.append(wrap);},initRequestTools:function(){this.harmfulBtn=$('<div>').btn({icon:'harmful',text:'Mark as Harmful',callback:function(){}});this.safeBtn=$('<div>').btn({icon:'safe',text:'Not harmful',callback:function(){}});this.archiveBtn=$('<div>').btn({icon:'archive',text:'Archive',callback:function(){}});var wrap=$('<div>').addClass('tele-overlay-tools');wrap.append('<div class="tele-navsep"></div>').append(this.harmfulBtn).append('<div class="tele-navsep"></div>').append(this.safeBtn).append('<div class="tele-navsep"></div>').append(this.archiveBtn);this.overlay.headerEl.append(wrap);},formatData:function(item){var that=this;if(item._id){item._source.uid=item._id}
if(item._source){item=item._source}
var result={};try{result.title=item.title?item.title:item.uri;}catch(e){result.title='';}
result.progbar=true;result.time=item.ts;result.timeFormat='h:i A';result.offset=20;result.icon='suspect';result.dataID=item.uid;result.raw=item;var alert=item.alerts_count>0;result.progbarValue=item.score_average;if(alert!==false){result.icon='alert';alert=item.alerts[0];result.description=alert.name;result.progbarValue=item.score_average;}else{if(item.avg_score>85){result.icon='suspect_red';}}
result.callback=function(widget,el){$('.selected',that.actionsContainer).removeClass('selected');$('.tele-listitem-inner',widget.element).addClass('selected');that.expandRequest(widget.options.dataID);};return result;},showAlert:function(data){},expandRequest:function(uid){if(this.currentUID==uid){var ch=this.requestDetails.children();if(ch.length>0)
{return;}}else{this.currentUID=uid;}
var that=this;this.requestDetails.empty();this.requestDetails.append(telepath.loader);var req=this.lookupRequest(uid);if(req){this.requestInfo=req;}else{return;}
this.boxRight.empty();this.printRequestScores(req,this.boxRight);var alert=req.alerts_count>0;$('.tele-overlay-tools',this.overlay.headerEl).remove();this.printRequestInfo(this.boxRight);if(this.width<1250){this.boxRight.append(this.requestDetails)
this.boxRight.css({"overflow-y":"scroll"})}
telepath.sessionflow.reloadFlag=Date.now();telepath.ds.get('/similarities/',{param_type:'request',uid:uid},function(data,flag){if(flag&&telepath.sessionflow.reloadFlag&&flag!=telepath.sessionflow.reloadFlag)
{return;}
that.showSimilarities(data);},null,telepath.sessionflow.reloadFlag);$('.tele-similarity-details').remove();telepath.ds.get('/sessionflow/get_sessionflow_params',{uid:uid},function(data,flag){if(flag&&telepath.sessionflow.reloadFlag&&flag!=telepath.sessionflow.reloadFlag)
{return;}
that.expandRequestData(data.items);},null,telepath.sessionflow.reloadFlag);},expandRequestData:function(data){$('.loader',this.requestDetails).remove();this.requestData=data;this.updateTitle(this.requestData);this.printParams();},updateTitle:function(request){},printParams:function(container){var container=this.requestDetails;container.empty();this.printParamsFilters(container);this.printAlertDetails(container);this.printParamsTable(container);},printParamsFilters:function(container){var that=this;this.filtersContainer=$('<div>').addClass('tele-alert-filters');container.append(this.filtersContainer);var filters=[{type:'H',label:'Headers'},{type:'G',label:'Get'},{type:'P',label:'Post'},{type:'J',label:'Json'},{type:'X',label:'XML'}];$.each(filters,function(i,filter){var filter_el=$('<div>').teleCheckbox({checked:telepath.alert.filters[filter.type],label:filter.label,inputFirst:true,alertObj:that,callback:function(widget){telepath.alert.filters[filter.type]=widget.options.checked;this.alertObj.printParams();$('.tele-listitem-inner.selected').click();}});that.filtersContainer.append(filter_el);});},printLink:function(request,container){var path='http://'+request.host+request.uri;var get_params={};$.each(request.parameters,function(i,param){if(param.type=='G'){get_params[param.name]=param.value;}});if(!$.isEmptyObject(get_params)){path+='?'+$.param(get_params);}
var link=$('<a>').attr('target','_blank').text(path).attr('href',escapeHtml(path)).attr('title',path);var action=request.business_id?this.lookupAction(request.business_id):'Browsing';container.append(link);container.append('&nbsp;('+action+')');},printAlertDetails:function(container){this.alertDetails=$('<div>').addClass('tele-alert-details-info');container.append(this.alertDetails);this.alertDetailsTitle=$('<div>').addClass('tele-alert-details-info-title');this.printLink(this.requestInfo,this.alertDetailsTitle);this.alertDetailsTimeWrap=$('<div>').addClass('tele-alert-details-info-time-wrap');this.alertDetailsTimeLabel=$('<div>').addClass('tele-alert-details-info-time-label').text('Request time:');this.alertDetailsTime=$('<div>').addClass('tele-alert-details-info-time').text(date_format('d/m/y | H:i:s',this.requestInfo.ts));this.alertDetailsTimeWrap.append(this.alertDetailsTimeLabel).append(this.alertDetailsTime);this.alertDetailsResponseWrap=$('<div>').addClass('tele-alert-details-info-response-wrap');this.alertDetailsResponseLabel=$('<div>').addClass('tele-alert-details-info-response-label').text('Response Status:');this.alertDetailsResponse=$('<div>').addClass('tele-alert-details-info-response').text(this.requestInfo.status_code);this.alertDetailsResponseWrap.append(this.alertDetailsResponseLabel).append(this.alertDetailsResponse);var severityPercent=parseInt(this.requestData.score_average*100)+'%';this.alertSeverityWrap=$('<div>').addClass('tele-alert-severity-wrap');this.alertSeverityLabel=$('<div>').addClass('tele-alert-severity-label').text('Severity');this.alertSeverityPercent=$('<div>').addClass('tele-alert-severity-percent').text(severityPercent);this.alertSeverityProgBar=$('<div>').addClass('tele-alert-severity-progbar');this.alertSeverityProgValue=$('<div>').addClass('tele-alert-severity-progbar-value').css({width:severityPercent});this.alertSeverityWrap.append(this.alertSeverityLabel).append(this.alertSeverityPercent).append(this.alertSeverityProgBar);this.alertSeverityProgBar.append(this.alertSeverityProgValue);this.alertDetails.append(this.alertSeverityWrap).append(this.alertDetailsTitle).append(this.alertDetailsTimeWrap).append(this.alertDetailsResponseWrap);},printRequestInfo:function(container){this.alertInfo=$('<div>').addClass('tele-alert-info');this.alertInfoTable=$('<div>').addClass('tele-alert-info-table');function getRow(lbl,data){var row=$('<tr>');var td_1=$('<td>').html(lbl).addClass('tele-alert-info-key');var td_2=$('<td>').html(data).addClass('tele-alert-info-value');row.append(td_1).append(td_2);return row;}
var table=this.alertInfoTable;table.append(getRow('Session Start:',date_format('d/m/y | H:i:s',this.session.stats.session_start)));table.append(getRow('Session End:',date_format('d/m/y | H:i:s',this.session.stats.session_end)));table.append(getRow('Application:',escapeHtml(this.requestInfo.host)));table.append(getRow('IP:',this.requestInfo.ip_orig));table.append(getRow('Location:',(this.requestInfo.country_code!='00'?'<span class="flag flag-'+this.requestInfo.country_code+'"></span>':'')+'<span class="tele-country">'+telepath.countries.a2n(this.requestInfo.country_code)+'</span>'));if(this.requestInfo.username){table.append(getRow('User:',escapeHtml(this.requestInfo.username)));}
$('tr:nth-child(n+3) .tele-alert-info-value',table).hover(function(){var search=$(this).text();if(search!='Unknown'){$(this).css('cursor','url(img/search_icon.png), pointer');$(this).css('color','#4174a7');}},function(){$(this).css('color','#333333');});$('tr:nth-child(n+3) .tele-alert-info-value',table).click(function(){var search=$(this).text();if(search!='Unknown'){telepath.overlay.destroy();telepath.header.searchInput.val(search);telepath.search.init(search);}});container.append(this.alertInfoTable);},printParamsTable:function(container){var tableWrap=$('<div>').addClass('tele-alert-params-table-wrap');var table=$('<table>').addClass('tele-alert-params-table');var tableWidth=(parseInt(this.boxMid.css('width'))-50);$.each(this.requestData.parameters,function(i,param){var param_display=telepath.alert.filters[param.type];if(param_display){var row=$('<tr>');var col_name=$('<td>').addClass('tele-param-name').html(escapeHtml(param.name)).attr('title',unescapeHtml(escapeHtml(param.name)));var col_data=$('<td>').addClass('tele-param-data').html(escapeHtml(param.value));var col_score=$('<td>').addClass('tele-param-score').html(parseInt(param.score_data)+'%');if(parseInt(param.score_data)>30){row.css({"color":"red"})}
row.append(col_name).append(col_data).append(col_score);table.append(row);}});container.append(tableWrap);tableWrap.append(table);}};var context_confirm=function(title,text,yesCallback,skipConfirm){if(skipConfirm){yesCallback();return;}
telepath.dialog({type:'dialog',title:title,msg:text,callback:yesCallback});}
var context_prompt=function(title,description,yesCallback,defaultValue){telepath.dialog({type:'prompt',value:defaultValue,title:title,msg:description,callback:yesCallback});}
telepath.handlers={param:{aliasAdd:function(record_id,callback){context_prompt('Param Alias','Enter new alias',function(text){telepath.ds.get('/parameters/set_parameter_alias',{'att_id':record_id,'att_alias':text},function(data){callback(data);},'Error setting parameter alias.');});},aliasRemove:function(record_id,callback){context_confirm('Param Alias','Remove alias?',function(){telepath.ds.get('/parameters/set_parameter_alias',{'att_id':record_id,'att_alias':''},function(data){callback(data);},'Error removing parameter alias.');});},aliasEdit:function(record_id,old_value,callback){context_prompt('Param Alias','Change alias',function(text){telepath.ds.get('/parameters/set_parameter_alias',{'att_id':record_id,'att_alias':text},function(data){callback(data);},'Error removing parameter alias.');},old_value);},maskAdd:function(record_id,record_name,callback){context_confirm('Parameter Settings','Mask "'+record_name+'" Param?',function(){telepath.ds.get('/parameters/set_parameter_config',{'att_id':record_id,'att_mask':'1'},function(data){callback(data);},'Error setting parameter mask.');});},maskRemove:function(record_id,record_name,callback){context_confirm('Parameter Settings','UnMask '+record_name+' Param?',function(){telepath.ds.get('/parameters/set_parameter_config',{'att_id':record_id,'att_mask':'0'},function(data){callback(data);},'Error removing parameter mask.');});}},page:{aliasAdd:function(record_id,callback){context_prompt('Page Alias','Enter new alias',function(text){telepath.ds.get('/pages/set_page_alias',{'page_id':record_id,'page_alias':text,},function(data){callback(data);},'Error setting page alias.');});},aliasRemove:function(record_id,callback){context_confirm('Page Alias','Remove alias?',function(){telepath.ds.get('/pages/set_page_alias',{'page_id':record_id,'page_alias':'',},function(data){callback(data);},'Error removing page alias.');});},aliasEdit:function(record_id,old_value,callback){context_prompt('Page Alias','Change alias',function(text){telepath.ds.get('/pages/set_page_alias',{'page_id':record_id,'page_alias':text,},function(data){callback(data);},'Error changing page alias.');},old_value);}},app:{aliasAdd:function(record_id,callback){context_prompt('Application Name','Enter new name',function(text){telepath.ds.get('/applications/set_application_alias',{'app_id':record_id,'app_alias':text,},function(data){callback(data);},'Error setting application name.');});},aliasRemove:function(record_id,callback){context_confirm('Application Name','Remove name?',function(){telepath.ds.get('/applications/set_application_alias',{'app_id':record_id,'app_alias':'',},function(data){callback(data);},'Error removing application name.');});},aliasEdit:function(record_id,old_value,callback){context_prompt('Application Name','Change name',function(text){telepath.ds.get('/applications/set_application_alias',{'app_id':record_id,'app_alias':text,},function(data){callback(data);},'Error changing application name.');},old_value);}}};telepath.ruleOverlay={addRule:function(){var that=this;var rule_id=1;telepath.ds.get('/rules',{mode:'expand_group',id:rule_id},function(data){that.data=data;that.initUI({id:'new',name:'New Rule',data:data});});},initUI:function(data){if(typeof(data.data)=='string'){data.data=JSON.parse(data.data);}
var that=this;this.data=data;telepath.overlay.init('rule-edit',data.name);$('.tele-overlay').height(800).trigger('resize');var ruleName=$('<div>').teleInput({label:'Name',value:data.id=='new'?'':data.name});telepath.overlay.contentEl.append(ruleName);var ruleDesc=$('<div>').teleInput({label:'Description',value:data.id==''?'':data.desc});telepath.overlay.contentEl.append(ruleDesc);var ruleScore=$('<div>').teleInput({label:'Score',width:30,value:data.score==''?'95':data.score});telepath.overlay.contentEl.append(ruleScore);var title=$('<div>').addClass('tele-title-1').text('Select type and build rule');telepath.overlay.contentEl.append(title);var cond=$('<div>').teleRule({data:data.data});telepath.overlay.contentEl.append(cond);var btnContain=$('<div>').addClass('tele-button-container');var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');btnContain.append(saveBtn).append(cancelBtn);telepath.overlay.contentEl.append(btnContain);saveBtn.click(function(){var json=cond.data('tele-conditionList').getJSON();var name=caseName.data('tele-teleInput').input.val();caseName.removeClass('error');if(name.length==0||name.length>32){caseName.addClass('error');return;}
if(json.length==0){telepath.dialog({title:'Case Editor',msg:'Must have at least one condition'});return;}
$('.tele-icon-rule-edit').append(telepath.loader).css({backgroundColor:'white'});});cancelBtn.click(function(){telepath.overlay.destroy();});}};telepath.dialog=function(options){var that=this;if(!options.title){options.title='Telepath';}
if(!options.msg){return false;}
this.maskEl=$('<div>').addClass('tele-overlay-mask').addClass('tele-overlay-mask-dialog');this.overlayEl=$('<div>').addClass('tele-overlay').addClass('tele-overlay-dialog');this.headerEl=$('<div>').addClass('tele-overlay-header');this.contentEl=$('<div>').addClass('tele-overlay-content');this.titleEl=$('<div>').addClass('tele-overlay-title').html(options.title);this.closeEl=$('<a>').attr('href','#').addClass('tele-overlay-close').addClass('tele-icon').addClass('tele-icon-close');this.textEl=$('<div>').addClass('tele-dialog-text').html(options.msg);$('body').append(this.maskEl);$('body').append(this.overlayEl);this.overlayEl.append(this.headerEl).append(this.contentEl);this.headerEl.append(this.titleEl).append(this.closeEl);this.closeEl.click(function(){that.maskEl.remove();that.overlayEl.remove();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$(this.overlayEl).draggable({handle:this.headerEl});this.btnContain=$('<div>').addClass('tele-button-container');this.contentEl.append(this.textEl).append(this.btnContain);switch(options.type){case'prompt':if(!options.value){options.value='';}
var inputEl=$('<div>').teleInput({value:options.value}).css({margin:15});if(options.error){$('input',inputEl).css({borderColor:'red'});}
var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Ok</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');this.textEl.after(inputEl);this.btnContain.append(saveBtn).append(cancelBtn);saveBtn.click(function(){if($('input',inputEl).val()==''){$('input',inputEl).css({borderColor:'red'});}else{that.maskEl.remove();that.overlayEl.remove();options.callback($('input',inputEl).val());}});cancelBtn.click(function(){that.maskEl.remove();that.overlayEl.remove();});break;case'dialog':var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Ok</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');this.btnContain.append(saveBtn).append(cancelBtn);saveBtn.click(function(){that.maskEl.remove();that.overlayEl.remove();options.callback();});cancelBtn.click(function(){that.maskEl.remove();that.overlayEl.remove();});break;case'success':case'debug':default:case'alert':var closeBtn=$('<a href="#" class="tele-button tele-button-apply">Close</a>');this.btnContain.append(closeBtn);closeBtn.click(function(){that.maskEl.remove();that.overlayEl.remove();});break;}};$.widget("tele.ip",{getIP:function(){var result='';for(var i=0;i<4;i++){result+=$(this.segments[i]).val()+'.';}
result=result.substring(0,result.length-1);return this.ip2long(result)!==false?result:false;},options:{data:'',},_create:function(){this.element.addClass("tele-ip");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.segments=[];if(this.options.data){this.options.data=this.options.data.split('.');}
for(var i=0;i<4;i++){var segment=$('<input>').addClass('tele-ip-segment').attr('rel',i);this.element.append(segment);this.segments.push(segment);if(this.options.data[i]){segment.val(this.options.data[i]);}}
this.bindEvents();},bindEvents:function(){var that=this;for(var i=0;i<4;i++){$(this.segments[i]).change(function(e){if(that.options.skipEvents){return;}
that.options.skipEvents=true;var val=$(this).val().replace(/[^-.0-9]/g,'').split('.');if(val.length>1){for(var z=0;z<4;z++){if(typeof(val[z])!='undefined'){$(that.segments[z]).val(val[z]);}}}
that.options.skipEvents=false;});$(this.segments[i]).keydown(function(e){var i=parseInt($(this).attr('rel'));var key=e.charCode||e.keyCode||0;if(key>=96&&key<=105)
{key=key-48;}
if(e.ctrlKey&&key==86){return;}
if(($(this).val()=='0'||$(e.target).val()==''&&String.fromCharCode(key)=='0')&&(key>=48&&key<=57)){$(this).val('0');if(i<3){$(that.segments[i+1]).focus();}else{}
return false;}
if((parseInt($(this).val()+parseInt(String.fromCharCode(key)))>255)){if(i<3){$(that.segments[i+1]).focus();}else{return false;}}
if($(this).val().length>2&&(key>=48&&key<=57)){if(i<3){$(that.segments[i+1]).focus().val(String.fromCharCode(key));}
return false;}
if(key==110||key==190){if(i<3){$(that.segments[i+1]).focus();}
return false;}
if(key==8&&$(e.target).val()==''){if(i>0){$(that.segments[i-1]).focus();return false;}}
if(key==9&&$(e.target).val()==''){$(this).val('0');}
if(key==8||key==9||key==46||(key>=35&&key<=40)||(key>=48&&key<=57)||(key>=96&&key<=105)){}else{return false;}});}},ip2long:function(IP){var i=0;IP=IP.match(/^([1-9]\d*|0[0-7]*|0x[\da-f]+)(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?(?:\.([1-9]\d*|0[0-7]*|0x[\da-f]+))?$/i);if(!IP){return false;}
IP[0]=0;for(i=1;i<5;i+=1){IP[0]+=!!((IP[i]||'').length);IP[i]=parseInt(IP[i])||0;}
IP.push(256,256,256,256);IP[4+IP[0]]*=Math.pow(256,4-IP[0]);if(IP[1]>=IP[5]||IP[2]>=IP[6]||IP[3]>=IP[7]||IP[4]>=IP[8]){return false;}
return IP[1]*(IP[0]===1||16777216)+IP[2]*(IP[0]<=2||65536)+IP[3]*(IP[0]<=3||256)+IP[4]*1;}});;$.widget("tele.condition",{options:{type:false,data:{value:[],negate:false},selected:[],negate:false,},_create:function(){this.element.addClass("tele-condition");this._update();},_setOption:function(key,value){this.options[key]=value;this._update();},getCondition:function(){var result=[];switch(this.options.type){case'rules':result=this.options.data.value.trim();if(result.length>1){if(result.substr(0,1)==','){result=result.substr(1);}
if(result.substr(result.length-1,1)==','){result=result.substr(0,result.length-1);}}
break;case'application':result='';$('input',this.element).each(function(){result=result+$(this).val().trim()+',';});result=result.substr(0,result.length-1);break;case'country':result=$('.tele-country-list',this.element).data('tele-teleCountry').getSelected();break;case'time':var eventsToSave=[];$('.wc-cal-event',this.options.element).each(function(){if(typeof($(this).data('calEvent'))=='object'){eventsToSave.push($(this).data('calEvent'));}});var weekday=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var result={};for(var i=0;i<7;i++){result[weekday[i]]=[];for(var x=0;x<24;x++){result[weekday[i]][x]=0;}}
$.each(eventsToSave,function(i,event){for(var i=event.start.getHours();i<(((event.end.getHours()==23&&event.end.getMinutes()==59)||event.end.getHours()==0)?24:event.end.getHours());i++){result[weekday[event.start.getDay()]][i]=1;}});break;case'IP':result='';$('.tele-ip-wrap',this.options.element).each(function(){if($('.tele-mini-toggle',this).data('tele-toggleFlip')){var is_range=$('.tele-mini-toggle',this).data('tele-toggleFlip').options.flipped;var ip_start=$('.tele-ip:first',this).data('tele-ip').getIP();var ip_end=$('.tele-ip:last',this).data('tele-ip').getIP();if(is_range){if(ip_start&&ip_end&&ip2long(ip_start)<ip2long(ip_end)){result=result+ip_start+'-'+ip_end+',';}}else{if(ip_start){result=result+ip_start+',';}}}});result=result.substr(0,result.length-1);break;case'parameter':result='';$('input',this.element).each(function(){result=result+$(this).val().trim()+',';});result=result.substr(0,result.length-1);break;}
return{type:this.options.type,negate:this.options.negate,value:result};},_update:function(){var that=this;this.element.empty();this.element.addClass('tele-condition-'+this.options.type);var negates=true;switch(this.options.type){case'advanced':negates=false;function get_slider(className,title,value,min,max){var slider_val=$('<div>').addClass('tele-condition-slider-value');var wrap=$('<div>').addClass('tele-condition-slider').addClass(className);var title=$('<div>').addClass('tele-title-2').html(title);function refreshValue(){var value=slider.slider('value');slider_val.html(value);}
var slider=$('<div>').slider({orientation:"horizontal",range:"min",max:max,value:value,min:min,slide:refreshValue,change:refreshValue});refreshValue();wrap.append(title).append(slider).append(slider_val);return wrap;}
this.element.append(get_slider('reputation','User Reputation',0,0,100));this.element.append(get_slider('score','Average Score',0,0,100));var checked=false;this.cbVelocity=$('<div>').teleCheckbox({checked:checked,label:'Geographic change of position velocity',callback:function(el,v){var checked=this.checked;}});this.element.append(this.cbVelocity);this.element.append(get_slider('time','Time (Seconds)',0,0,3600));this.element.append(get_slider('time','Distance (Km\'s)',0,0,1000));break;case'rules':this.ruleTree=$('<div>').teleTree({type:'rules',grid:{columns:[{width:380},{value:function(node){if(node.type!=='group'){return;}
var checked=false;var opts=that.options.data.value.split(',');for(x in opts){var opt=opts[x].split('::');if(opt.length==2){if(node.category==opt[0].trim()&&node.id==opt[1].trim()){checked=true;}}}
var cb=$('<div>').teleCheckbox({checked:checked,callback:function(el,v){var checked=this.checked;var found=false;if(that.options.data.value==[]){that.options.data.value='';}
var opts=that.options.data.value.split(',');for(x in opts){var opt=opts[x].split('::');if(opt.length==2){if(node.category==opt[0].trim()&&node.id==opt[1].trim()){found=true;}}}
if(found&&!checked){that.options.data.value=that.options.data.value.replace(node.category+'::'+node.id,'');that.options.data.value=that.options.data.value.replace(',,',',');}
if(!found&&checked){if(that.options.data.value.length>0&&that.options.data.value.substr(that.options.data.value.length-1,1)!==','){that.options.data.value=that.options.data.value+',';}
that.options.data.value=that.options.data.value+node.category+'::'+node.id;}
if(that.options.data.value.substr(that.options.data.value.length-1,1)==','){that.options.data.value=that.options.data.value.substr(0,that.options.data.value.length-1);}}});return cb;},width:50}],resizable:true},callback:function(e,data){if(data.node.data.type=='rule'){}}});this.element.append(this.ruleTree);break;case'application':var values=that.options.data.value.split(',');if(values.length){for(var x in values){var filterApps=$('<div>').teleSelect({type:'subdomain',values:[{text:values[x],id:'-1',sub_id:'-1',root:true}],click:function(){}});this.element.append(filterApps);}}
else{var filterApps=$('<div>').teleSelect({type:'subdomain',values:[{text:'All',id:'-1',sub_id:'-1',root:true}],click:function(){}});this.element.append(filterApps);}
break;case'country':var values=that.options.data.value.split(',');var cList=$('<ul>').addClass('tele-country-list').teleCountry({values:values});this.element.append(cList);break;case'IP':$.each(that.options.data.value.split(','),function(i,ip){that.element.append(old_getRangeUI(ip));});this.element.append(getRangeUI('last'));break;case'velocity':this.element.append('Velocity Condition');break;case'user':this.element.append('User Condition');break;case'time':var calendar=$('<div>').addClass('tele-condition-calendar');this.element.append(calendar);var eventData=[];$(calendar).weekCalendar({timeslotsPerHour:1,timeslotHeight:15,defaultEventLength:1,data:eventData,height:function($calendar){return 365;}});break;case'parameter':var paramBrowse=$('<div>').teleBrowse({label:'Select Parameter',mode:'param',value:that.options.data.value});this.element.append(paramBrowse);break;}
if(negates){var notWrap=$('<div>').addClass('tele-condition-not-wrap');that.options.negate=that.options.data.negate;var notCb=$('<span>').teleCheckbox({inputFirst:true,checked:this.options.data.negate,label:'Negate (not selected)',callback:function(){that.options.negate=this.checked;}}).addClass('tele-condition-not');notWrap.append(notCb);this.element.prepend(notWrap);}}});;telepath.formatConditionBrief=function(container,data){var result='';if(!data.value)
{if(container)
{container.html('');}
return'';}
if(data.negate){result='Not ';}
switch(data.type){case'rules':result=data.value.replace(',',', ');break;case'IP':result=data.value.replace(',',', ');break;case'application':result=data.value.replace(',',', ');break;case'country':$.each(data.value.split(','),function(i,v){result+=telepath.countries.map[v]+', ';});result=result.substr(0,result.length-2);break;case'time':break;case'parameter':result=data.value.replace(',',', ');break;}
if(container){container.html(result);}else{return result;}}
$.widget("tele.conditionList",{getOpt:function(type){for(x in this.options.data){if(this.options.data[x].type==type){return this.options.data[x];}}
return{type:type,value:'',negate:false};},getJSON:function(){var parent=this.element.parent();var conditions=$('.tele-condition',parent);var widgets=[];var skip={};$.each(conditions,function(i,condition){var data=$(condition).data('tele-condition').getCondition();if(data.value.length>0){widgets.push(data);}else{skip[data.type]=true;}});if(this.options.data.length>0){for(x in this.options.data){var found=false;var type=this.options.data[x].type;for(y in widgets){if(widgets[y].type==type){found=true;}}
if(!found&&!skip[type]){widgets.push(this.options.data[x]);}}}
return widgets;},options:{data:[],},_create:function(){this.element.addClass("tele-condition-select");this._update();return this;},_setOption:function(key,value){this.options[key]=value;this._update();},_update:function(){var that=this;this.element.empty();this.conditionTypes=['application','rules','IP','country','parameter',];this.accordion=$('<div>').addClass('tele-condition-accordion');this.element.append(this.accordion);$.each(this.conditionTypes,function(i,condition){var headerEl=$('<h3>').text(condition).css('text-transform','capitalize');var containerEl=$('<div>').attr('rel',condition);that.accordion.append(headerEl).append(containerEl);headerEl.append('<span class="brief"></span>');telepath.formatConditionBrief($('.brief',headerEl),that.getOpt(condition));$('.brief',headerEl).css('text-transform','none');});this.accordion.accordion({heightStyle:'fill',collapsible:true,active:false,autoHeight:false,animate:false,activate:function(event,ui){if($('.tele-condition',ui.oldPanel).size()>0){var data=$('.tele-condition',ui.oldPanel).data('tele-condition').getCondition();telepath.formatConditionBrief($('.brief',ui.oldHeader),data);}
var container=$(ui.newPanel);if(!container.hasClass('loaded')){var type=container.attr('rel');var conditionEl=$('<div>').condition({type:type,data:that.getOpt(type)});container.append(conditionEl).addClass('loaded');}}});}});;telepath.contextMenu=function(obj){if(obj.data.type=='application'||obj.data.type=='page'||obj.data.type=='param'){var items={};if(obj.data.raw.alias==''){items.createAlias={label:"Create Alias",icon:'tele-icon tele-icon-alias_edit',action:function(){switch(obj.data.type){case'application':telepath.handlers.app.aliasAdd(obj.data.id,function(data){$('.jstree').jstree("rename_node",obj,data.app.display_name);obj.data.raw.alias=data.app.display_name;});break;case'page':telepath.handlers.page.aliasAdd(obj.data.id,function(data){$('.jstree').jstree("rename_node",obj,data.page.title);obj.data.raw.alias=data.page.title;});break;case'param':telepath.handlers.param.aliasAdd(obj.data.id,function(data){$('.jstree').jstree("rename_node",obj,data.param.att_alias);obj.data.raw.alias=data.param.att_alias;});break;}}}}else{items.editAlias={label:"Edit Alias",icon:'tele-icon tele-icon-alias_edit',action:function(){switch(obj.data.type){case'application':telepath.handlers.app.aliasEdit(obj.data.id,obj.data.raw.alias,function(data){$('.jstree').jstree("rename_node",obj,data.app.display_name);obj.data.raw.alias=data.app.display_name;});break;case'page':telepath.handlers.page.aliasEdit(obj.data.id,obj.data.raw.alias,function(data){$('.jstree').jstree("rename_node",obj,data.page.title);obj.data.raw.alias=data.page.title;});break;case'param':telepath.handlers.param.aliasEdit(obj.data.id,obj.data.raw.alias,function(data){$('.jstree').jstree("rename_node",obj,data.param.att_alias);obj.data.raw.alias=data.param.att_alias;});break;}}}
items.deleteAlias={label:"Remove Alias",icon:'tele-icon tele-icon-delete',action:function(){switch(obj.data.type){case'application':telepath.handlers.app.aliasRemove(obj.data.id,function(data){$('.jstree').jstree("rename_node",obj,data.app.app_domain);obj.data.raw.alias='';});break;case'page':telepath.handlers.page.aliasRemove(obj.data.id,function(data){$('.jstree').jstree("rename_node",obj,data.page.text);obj.data.raw.alias='';});break;case'param':telepath.handlers.param.aliasRemove(obj.data.id,function(data){$('.jstree').jstree("rename_node",obj,data.param.att_name);obj.data.raw.alias='';});break;}}}}
if(obj.data.type=='param'){if(obj.data.raw.mask=='0'){items.maskAdd={label:"Mask Parameter",icon:'tele-icon tele-icon-alias_edit',action:function(){telepath.handlers.param.maskAdd(obj.data.id,obj.data.text,function(data){});}}}else{items.maskAdd={label:"Unmask Parameter",icon:'tele-icon tele-icon-alias_edit',action:function(){telepath.handlers.param.maskRemove(obj.data.id,obj.data.text,function(data){});}}}}
if(obj.data.type=='application'&&obj.data.context=='applications'){items.uploadLogs={label:"Upload Logs",icon:'tele-icon tele-icon-uploadLogs',action:function(){logmode_init(obj.data.id);}}}
return items;}else{return false;}};var logmode_timer=false;var loadedResources={};function loadResources(resources,completeCallback){resources=processResources(resources,completeCallback);yepnope({load:resources,complete:completeCallback});}
function processResources(resources,completeCallback){var notLoaded=[];for(var i=0;i<resources.length;i++)
{if(!loadedResources[resources[i]])
{notLoaded.push(resources[i]);}
loadedResources[resources[i]]=true;}
if(notLoaded.length==0){completeCallback();}
return notLoaded;}
function logmode_init(app_id){var that=this;this.maskEl=$('<div>').addClass('tele-overlay-mask').addClass('tele-overlay-mask-dialog');this.overlayEl=$('<div>').addClass('tele-overlay').addClass('tele-overlay-logmode');this.headerEl=$('<div>').addClass('tele-overlay-header');this.contentEl=$('<div>').addClass('tele-overlay-content');this.titleEl=$('<div>').addClass('tele-overlay-title').html("Upload Logs");this.closeEl=$('<a>').attr('href','#').addClass('tele-overlay-close').addClass('tele-icon').addClass('tele-icon-close');this.textEl=$('<div>').addClass('tele-dialog-text').html('');$('body').append(this.maskEl);$('body').append(this.overlayEl);this.overlayEl.append(this.headerEl).append(this.contentEl);this.headerEl.append(this.titleEl).append(this.closeEl);this.closeEl.click(function(){that.maskEl.remove();that.overlayEl.remove();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');});$(this.overlayEl).draggable({handle:this.headerEl});var container=this.contentEl;$(container).bind('drop dragover',function(e){e.preventDefault();});$('.fileupload-dragcontainer').on('dragleave',function(e){$('.fileupload-dragcontainer').css('border','2px dashed #ccc');});container.append(telepath.loader);$.get(telepath.controllerPath+'/logmode',function(html){loadResources(["js/lib/jquery.iframe-transport.js","js/lib/jquery.fileupload.js","js/lib/jquery.fileupload-process.js","js/lib/jquery.fileupload-tmpl.min.js","js/lib/jquery.fileupload-ui.js","css/uploader.css"],function(){container.html(html);var url=telepath.controllerPath+'/logmode/upload';$('#fileupload').fileupload({url:url,dropZone:$('.fileupload-dragcontainer'),dragover:function(e,data){$('.fileupload-dragcontainer').css('border','2px dashed black');data.dropEffect='move';data.preventDefault=false;}}).bind('fileuploadadd',function(e,data){$('.fileupload-dragcontainer').css('height','auto');}).bind('fileuploadcompleted',function(e,data){if(!logmode_timer){logmode_timer=setTimeout(function(){logmode_parser_status_tick();},5000);}}).bind('fileuploadsubmit',function(e,data){var logtype=Ext.getCmp('c_logmode_type').value;var new_url=url+'?logtype='+logtype+'&app_id='+app_id;$("#fileupload").fileupload({url:new_url});});setTimeout(function(){$('.upload-loader').remove();},500);});});}
function logmode_start(){$(".fileupload-buttonbar .start").click();}
function logmode_populate_apps(){}
function logmode_parser_status_tick(){$.getJSON('index.php/logmode/status',function(data){var files_uploaded=data.length;var processed_current=0;var processed_total=data.length*100;$.each(data,function(i,file){processed_current=processed_current+parseInt(file.processed);});console.log(processed_current+' / '+processed_total);if(processed_current/processed_total==1){$.getJSON('index.php/logmode/cleanup',function(data){location.reload();});}});};telepath.config.account={data:[],init:function(id,container){this.container=container;if(id!='new'){this.loadData(id);}},loadData:function(id){var that=this;telepath.ds.get('/users/get_user',{id:id},function(data){that.showData(data.items);});},showData:function(data){var that=this;this.data=data;this.form=$('<div>');this.form.teleForm({title:'User Editor',data:data.user,items:[{type:'checkbox',label:'Enabled',dataIndex:'active'},{type:'text',label:'Login',dataIndex:'login'},{type:'text',label:'Email',dataIndex:'email'},{type:'text',label:'First Name',dataIndex:'first_name'},{type:'text',label:'Last Name',dataIndex:'last_name'},{type:'text',label:'Company',dataIndex:'company'},{type:'text',label:'Phone',dataIndex:'phone'},{type:'password',label:'Password',dataIndex:'password'}],callback:function(){}});this.container.empty().append(this.form);$(".tele-button-cancel",this.container).click(function(){telepath.config.accounts.getUsers();});$(".tele-button-apply",this.container).click(function(){var userData={user:{},perm:[],groups:[],apps:[],ranges:[]};$("input",that.container).css({borderColor:'#999'});userData.user.active=$("[rel='active'] .tele-checkbox-checkbox",that.container).hasClass('checked');userData.user['id']=that.data.user.id;var fields=['login','email','first_name','last_name','company','phone'];$.each(fields,function(i,field){userData.user[field]=$("[rel='"+field+"'] input",that.container).val();});var pass_1=$(".tele-password input:first",that.container).val();var pass_2=$(".tele-password input:last",that.container).val();if(pass_1!=''&&pass_2!=''){if(pass_1!=pass_2){$(".tele-password input",that.container).css({borderColor:'red'});telepath.dialog({msg:'Password change mismatch.'});return;}
userData.user.password=pass_1;}
if(userData.user.id=='new'&&pass_1==''){telepath.dialog({msg:'Must provide password for new user.'});return;}
if(userData.user.login==''){telepath.dialog({msg:'User login cant be blank.'});return;}
if(userData.user.email!=''){function validateEmail(email){return/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*$/.test(email);}
if(!validateEmail(userData.user.email)){$("[rel='email'] input",that.container).css({borderColor:'red'});telepath.dialog({msg:'Bad email address.'});return;}}
userData.user.mode=$('.tele-radio-knob',that.toggleType).parent().attr('rel');$('.tele-user-permissions .tele-checkbox-checkbox.checked').each(function(){userData.perm.push($(this).attr('dataid'));});$('.tele-user-groups .tele-checkbox-checkbox.checked').each(function(){userData.groups.push($(this).attr('dataid'));});switch(userData.user.mode){case'hosts':result='';$('input',that.limitApps).each(function(){userData.apps.push($(this).val().trim());});break;case'ranges':$('.tele-ip-wrap',that.limitRanges).each(function(){if($('.tele-mini-toggle',this).data('tele-toggleFlip')){var is_range=$('.tele-mini-toggle',this).data('tele-toggleFlip').options.flipped;var ip_start=$('.tele-ip:first',this).data('tele-ip').getIP();var ip_end=$('.tele-ip:last',this).data('tele-ip').getIP();if(is_range){if(ip_start&&ip_end&&ip2long(ip_start)<ip2long(ip_end)){userData.ranges.push(ip_start+'-'+ip_end);}}else{if(ip_start){userData.ranges.push(ip_start);}}}});break;}
if(userData.user.id=='new'){telepath.ds.get('/users/add_user',{items:userData},function(data){telepath.config.accounts.loadData();});}else{telepath.ds.get('/users/set_user',{items:userData},function(data){telepath.config.accounts.loadData();});}});var apps_data=[];$.each(that.data.apps,function(i,app){apps_data.push({text:app});});var userGroupsContainer=$('<div>').addClass('tele-user-groups-container');that.container.append(userGroupsContainer);that.groupsContainer=$('<div>').addClass('tele-user-groups');userGroupsContainer.append('<div class="tele-title-1">User Groups</div>').append(that.groupsContainer);$.each(telepath.config.accounts.groups,function(i,group){var checked=false;$.each(that.data.groups,function(i,user_group){if(user_group.id==group.id){checked=true;}});var cb=$('<div>').teleCheckbox({checked:checked,label:group.name,dataID:group.id,callback:function(el,v){}});that.groupsContainer.append(cb);});userGroupsContainer.append(that.groupsContainer);that.permissions=$('<div>').addClass('tele-user-permissions').append(telepath.loader).append('<div class="tele-title-1">Permissions</div>');that.perm_tabs=$('<div>').addClass('tele-perm-tabs');that.tabsEl=$('<div>').addClass('tabs');that.tabsUl=$('<ul>');that.perm_tabs.append(that.tabsUl).append(that.tabsEl);var tabs=[{id:'get',text:'Retrieve'},{id:'set',text:'Modify'}];for(x in tabs){var tab=tabs[x];var tabEl=$('<div>').attr('id','tele-perm-'+tab.id);var tabLi=$('<li>');var tabA=$('<a>').attr('href','#tele-perm-'+tab.id).text(tab.text);tabLi.append(tabA);that.tabsUl.append(tabLi);that.tabsEl.append(tabEl);}
telepath.ds.get('/permissions/get_list',{},function(data){$('.tele-loader',that.permissions).remove();$.each(data.items,function(i,row){var checked=false;$.each(that.data.perm,function(i,perm){if(perm.id==row.id){checked=true;return false;}});var cb=$('<div>').teleCheckbox({checked:checked,label:row.description,dataID:row.id,callback:function(el,v){}});$('#tele-perm-'+row['function']).append(cb);});that.perm_tabs.tabs({activate:function(event,ui){}});});that.permissions.append(that.perm_tabs);that.container.append(that.permissions);that.limitApps=$('<div>').teleSelect({type:'subdomain',values:apps_data,click:function(){}}).hide();that.limitRanges=$('<div>').addClass('tele-limit-ranges').hide();that.toggleType=$('<div>').teleRadios({title:'Configure applications access limits',radios:[{key:'none',label:'None',checked:that.data.apps.length==0&&that.data.ranges.length==0},{key:'ranges',label:'IP Ranges',checked:that.data.apps.length==0&&that.data.ranges.length>0},{key:'hosts',label:'Specific hostnames',checked:that.data.apps.length>0&&that.data.ranges.length==0},],callback:function(radio){that.limitApps.hide();that.limitRanges.hide();switch(radio.key){case'none':break;case'ranges':that.limitRanges.show();break;case'hosts':that.limitApps.show();break;}}}).addClass('tele-limit-type');that.container.append(that.toggleType);that.container.append(that.limitApps);if(that.data.ranges.length){$.each(that.data.ranges,function(i,ip){that.limitRanges.append(old_getRangeUI(ip));});}
else{that.limitRanges.append(getRangeUI(''));}
that.limitRanges.append(getRangeUI('last'));that.container.append(that.limitRanges);}};telepath.config.accounts={selectedGroup:'All',editGroup:function(group_id){var that=this;telepath.ds.get('/groups/get_group',{id:group_id},function(data){data=data.items;that.showGroup(data);});},showGroup:function(data){var that=this;that.contentRight.empty();that.data=data;that.groupLeftWrap=$('<div>').addClass('tele-group-wrap-left');that.groupRightWrap=$('<div>').addClass('tele-group-wrap-right');that.contentRight.append(that.groupLeftWrap);that.contentRight.append(that.groupRightWrap);that.groupInputs=$('<div>').addClass('group-input')
that.groupName=$('<div>').teleInput({label:'Group name',value:data.group.name});that.groupDesc=$('<div>').teleInput({label:'Group description',value:data.group.description});that.groupInputs.append(that.groupName);that.groupInputs.append(that.groupDesc);that.groupLeftWrap.append(that.groupInputs);var btnContain=$('<div>').addClass('tele-button-container-group');var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');cancelBtn.click(function(){that.getUsers();});btnContain.append(saveBtn).append(cancelBtn);var apps_data=[];$.each(that.data.apps,function(i,app){apps_data.push({text:app});});that.limitApps=$('<div>').teleSelect({type:'subdomain',values:apps_data,click:function(){}}).hide();that.limitRanges=$('<div>').addClass('tele-limit-ranges-group').hide();that.toggleType=$('<div>').teleRadios({title:'Configure applications access limits',radios:[{key:'none',label:'None',checked:that.data.apps.length==0&&that.data.ranges.length==0},{key:'ranges',label:'IP Ranges',checked:that.data.apps.length==0&&that.data.ranges.length>0},{key:'hosts',label:'Specific hostnames',checked:that.data.apps.length>0&&that.data.ranges.length==0},],callback:function(radio){that.limitApps.hide();that.limitRanges.hide();switch(radio.key){case'none':break;case'ranges':that.limitRanges.show();break;case'hosts':that.limitApps.show();break;}}}).addClass('tele-limit-type-group');that.groupLeftWrap.append(that.toggleType);that.groupLeftWrap.append(that.limitApps);that.permissions=$('<div>').addClass('tele-group-permissions').append('<div class="tele-title-1">Permissions</div>');that.perm_tabs=$('<div>').addClass('tele-perm-tabs');that.tabsEl=$('<div>').addClass('tabs');that.tabsUl=$('<ul>');that.perm_tabs.append(that.tabsUl).append(that.tabsEl);var tabs=[{id:'get',text:'Retrieve'},{id:'set',text:'Modify'}];for(x in tabs){var tab=tabs[x];var tabEl=$('<div>').attr('id','tele-perm-'+tab.id);var tabLi=$('<li>');var tabA=$('<a>').attr('href','#tele-perm-'+tab.id).text(tab.text);tabLi.append(tabA);that.tabsUl.append(tabLi);that.tabsEl.append(tabEl);}
telepath.ds.get('/permissions/get_list',{},function(data){$.each(data.items,function(i,row){var checked=false;$.each(that.data.perm,function(i,perm){if(perm.id==row.id){checked=true;return false;}});var cb=$('<div>').teleCheckbox({checked:checked,label:row.description,dataID:row.id,callback:function(el,v){}});$('#tele-perm-'+row['function']).append(cb);});that.perm_tabs.tabs({activate:function(event,ui){}});});that.permissions.append(that.perm_tabs);that.groupRightWrap.append(that.permissions);$.each(that.data.ranges,function(i,ip){that.limitRanges.append(getRangeUI(ip));});that.limitRanges.append(getRangeUI(''));that.groupLeftWrap.append(that.limitRanges);that.contentRight.append(btnContain);saveBtn.click(function(){var groupData={group:{},perm:[],apps:[],ranges:[]};groupData.group.id=data.group.id;groupData.group.name=$('input',that.groupName).val();groupData.group.description=$('input',that.groupDesc).val();groupData.mode=$('.tele-radio-knob',that.toggleType).parent().attr('rel');$('.tele-group-permissions .tele-checkbox-checkbox.checked').each(function(){groupData.perm.push($(this).attr('dataid'));});switch(groupData.mode){case'hosts':result='';$('input',that.limitApps).each(function(){groupData.apps.push($(this).val().trim());});break;case'ranges':$('.tele-ip-wrap',that.limitRanges).each(function(){if($('.tele-mini-toggle',this).data('tele-toggleFlip')){var is_range=$('.tele-mini-toggle',this).data('tele-toggleFlip').options.flipped;var ip_start=$('.tele-ip:first',this).data('tele-ip').getIP();var ip_end=$('.tele-ip:last',this).data('tele-ip').getIP();if(is_range){if(ip_start&&ip_end&&ip2long(ip_start)<ip2long(ip_end)){groupData.ranges.push(ip_start+'-'+ip_end);}}else{if(ip_start){groupData.ranges.push(ip_start);}}}});break;}
if(groupData.group.id=='new'){telepath.ds.get('/groups/add_group',{items:groupData},function(data){that.loadData();});}else{telepath.ds.get('/groups/set_group',{items:groupData},function(data){that.loadData();});}});},deleteGroup:function(id){var that=this;telepath.ds.get('/groups/del_group',{id:id},function(data){that.loadData();});},init:function(){var that=this;var leftTitle=$('<div>').addClass('tele-panel-subtitle-text').html('Groups');var rightTitle=$('<div>').addClass('tele-panel-subtitle-text').html('Users');this.cmdNewGroup=$('<div>').btn({icon:'plus',text:'New Group'});this.cmdImportGroup=$('<div>').btn({icon:'import',text:'Import Group'});this.cmdNewUser=$('<div>').btn({icon:'plus',text:'New User'});this.barLeft.append(leftTitle).append(this.cmdNewGroup);this.cmdDeleteUsers=$('<div>').btn({icon:'delete',text:'Delete',callback:function(){var selected=that.list.data('tele-teleList').getSelected();var data=telepath.config.accounts.data;var to_delete=[];$.each(data,function(d_index,d_val){$.each(selected,function(s_index,s_val){var user_id=d_val['id'];if(s_val==user_id){if(d_val['login']!='admin'){to_delete.push(user_id);}else{};}});});telepath.dialog({type:'dialog',msg:'This operation will delete the selected user(s). Are you sure?',callback:function(){telepath.ds.get('/users/del_user',{id:to_delete},function(data){that.loadData();})}});}});this.barRight.append(this.cmdDeleteUsers).append(rightTitle).append(this.cmdNewUser);this.contentLeft.append(telepath.loader);this.contentRight.append(telepath.loader);this.loadData();this.cmdNewGroup.click(function(){that.showGroup({group:{id:'new',name:'',description:'',mode:'none'},perm:[],apps:[],ranges:[]});});this.cmdNewUser.click(function(){telepath.config.account.init('new',that.contentRight);telepath.config.account.showData({user:{id:'new',active:true},perm:[],apps:[],ranges:[],groups:[]});});},loadData:function(){this.getGroups();this.getUsers();},getGroups:function(){var that=this;telepath.ds.get('/groups/get_list',{},function(data){that.groups=data.items;var treeData=[];treeData.push({text:'All',data:{id:'All',description:'',name:'All'},id:'tele_group_all'});$.each(data.items,function(i,row){treeData.push({text:row.name,data:{id:row.id,description:row.description,name:row.name}});});that.groupsTree=$('<div>');that.groupsTree.jstree({'core':{'data':treeData},plugins:["grid","wholerow","theme"],grid:{columns:[{width:390},{value:function(node){if(node.name!=='All'){return $('<div>').btn({icon:'edit',callback:function(){if(node.name=='admin'){telepath.dialog({msg:'Admin is a built in group which cannot be modified.'});return;}
telepath.config.accounts.editGroup(node.id);}});}else{return'';}},width:40},{value:function(node){if(node.name!=='All'){return $('<div>').btn({icon:'delete',callback:function(){if(node.name=='admin'){telepath.dialog({msg:'Admin is a built in group which cannot be removed.'});return;}else{telepath.dialog({type:'dialog',msg:'This operation will delete the selected group. Are you sure?',callback:function(){telepath.config.accounts.deleteGroup(node.id);}});};}});}else{return'';}},width:40}],resizable:true},}).on('changed.jstree',function(e,data){data.instance.element.find('.jstree-wholerow').css('background-color','#FFFFFF');data.instance.element.find('.jstree-wholerow-hovered').css("background-color","rgba(189, 189, 189, 0.85)");telepath.config.accounts.selectedGroup=data.node.data.id;telepath.config.accounts.getUsers();});that.contentLeft.empty().append(that.groupsTree);that.groupsTree.jstree("select_node","#tele_group_all");},'Error loading group list.');},getUsers:function(){var that=this;telepath.ds.get('/users/get_list',{group:this.selectedGroup},function(data){that.data=data.items;that.list=$('<div>');that.contentRight.empty().append(that.list);that.list.teleList({data:that.data,formatter:function(item){var title=(item.first_name?(item.first_name+' '):'');title+=(item.last_name?(item.last_name+' '):'');title+=(item.login?('('+item.login+')'):'');var result={dataID:item.id,checkable:true,time:item.last_login,timeLabel:'Last Login:',icon:'user',title:title,count:item.count,details:[{key:'Active',value:item.active},{key:'Email',value:item.email}]};return result;},callbacks:{click:function(el,id){telepath.config.account.init(el.options.dataID,that.contentRight);},hover_in:function(el,id){},hover_out:function(el,id){},}});},'Error loading users list.');}};telepath.action={};telepath.action.recorder={new_flow:true,requests:[],paused:false,ts_offset:0,timer:false,id:false,initRecordingTools:function(action_name){var that=this;this.recordTools=$('<div>').addClass('tele-record-tools');if(!action_name){action_name='';}
this.actionName=$('<div>').teleInput({value:action_name,label:'Name:',labelCSS:{width:48,'margin-left':23},width:220});this.recordTools.append(this.actionName);var controls=['stop','pause'];$.each(controls,function(i,control){var controlEl=$('<div>').addClass('tele-control').addClass('tele-control-'+control).html('<div></div>').click(function(){switch(control){case'stop':clearInterval(that.timer);telepath.action.recorder.init();break;case'pause':$(this).toggleClass('tele-control-pause');$(this).toggleClass('tele-control-record');that.paused=!that.paused;break;}});that.recordTools.append(controlEl);});this.container.parent().prepend(this.recordTools);},processRequests:function(requests){var that=this;if(requests.length>0){$.each(requests,function(i,request){if(!that.paused){request.el=$('<div>').teleRequest({data:request});$('.mCSB_container',that.container).append(request.el);that.requests.push(request);}});}},startRecording:function(type){var that=this;this.timer=true;this.timerValue=0;this.recordType=type;clearInterval(this.timer);that.progbarInner.css({width:0});if(type=='s'){var value=$('input',this.input).data('sha256_sid')}
else{var value=$('input',this.input).val();}
$('input',this.input).css({borderColor:'#999'});if(type=='u'){value=$('a',this.input).attr('href');value=value.split('=')[1];}
if((type=='i'||type=='s')&&value==''){$('input',this.input).css({borderColor:'red'});telepath.dialog({type:'alert',title:'Business Action',msg:'Missing value'});return;}
this.recordValue=value;function tick(id){that.timerValue+=5;that.progbarInner.css({width:that.timerValue+'%'});telepath.ds.get('/actions/get_requests',{id:id},function(data){if(data.total>0){if(!that.dataLoaded){that.dataLoaded=true;that.container.empty();var tmp=$('<div>').addClass('tele-action-container');that.container.append(tmp);that.container=tmp;that.initRecordingTools();$('.tele-action-container').css({padding:0,height:400}).mCustomScrollbar({scrollButtons:{enable:false},scrollInertia:150,advanced:{updateOnContentResize:true}});that.showSaveLoad=telepath.config.action.showSaveLoad;that.showSaveLoad();if(type!='u'){that.processRequests(data.items);}}
else{that.processRequests(data.items);}}});if(that.timerValue>99&&!that.dataLoaded){clearInterval(that.timer);that.timer=false;telepath.dialog({type:'alert',title:'Business Action',msg:'No matching requests, tracking timed out.'});that.endRecord();}}
telepath.ds.get('/actions/start_recording',{mode:that.recordType,value:that.recordValue,host:telepath.action.currentApp},function(data){if(data.total>0){that.id=data.items;that.dataLoaded=false;tick(that.id);that.timer=setInterval(function(){tick(that.id);},3000);}});},endRecord:function(){var that=this;if(that.id){telepath.ds.get('/actions/end_record',{id:that.id},function(data){that.id=false;});}},init:function(){$('.popover').remove();if(this.timer){this.endRecord();this.timer=false;}
this.trackers=[{type:'u',title:'URL',desc:'Record all activity from URL'},{type:'s',title:'Username',desc:'Record all activity of a speciﬁc user'},{type:'i',title:'IP',desc:'Record all activity of a speciﬁc device'},];this.container=telepath.config.actions.contentRight;this.toolbar=telepath.config.actions.barRight;this.container.addClass('tele-workflow-recorder');this.container.empty();this.toolbar.empty();this.barTitle=$('<div>').addClass('tele-panel-subtitle-text').html('Record New Business Action');this.toolbar.append(this.barTitle);this.trackersTitle=$('<div>').addClass('tele-title-1').html('Select recording source:');this.container.append(this.trackersTitle);this.printTrackers();this.container.mCustomScrollbar({advanced:{updateOnContentResize:true}});},initDebugger:function(){this.container.append('<div>Active sessions in last 5 minutes ::</div>');var that=this;telepath.ds.get('/actions/get_top_active_sessions',{host:telepath.action.currentApp.trim()},function(data){if(data.items){$.each(data.items,function(i,item){var item_el=$('<div>');item_el.append('<span>'+new Date(item.ts*1000).toString()+'<span>');item_el.append('<span>'+item.sid+'</span>');item_el.click(function(){$(this).css({paddingBottom:20});if(telepath.action.recorder.timer){clearInterval(telepath.action.recorder.timer);}
telepath.action.recorder.timer=setInterval(function(){telepath.ds.get('/actions/track_session_by_sid',{sid:item.sid,time:item.ts},function(data){if(data.items&&data.items.length>0){item_el.append($('<div>').html(JSON.stringify(data)));}});},3000);});that.container.append(item_el);});}});},trackerClick:function(el,type){var that=this;var trackerInfo=$('<div>').addClass('tele-workflow-tracker-info').addClass('tele-rounded-box').hide();var application_ssl=false;var application_subdomain='';var application_domain=telepath.action.currentApp;var hybrid_record='hybridrecord';var hybrid_record_id=Math.floor(Math.random()*(999999-100000+1))+99999;var hybrid_link=(application_ssl?'https://':'http://')+
(application_subdomain!=''?application_subdomain+'.':'')+
application_domain+'/?'+hybrid_record+'='+hybrid_record_id;switch(type){case'i':var input=$('<div>').teleInput({label:'Target IP:'});trackerInfo.append(input);break;case's':var input=$('<div>').teleInput({label:'Target Username:'});trackerInfo.append(input);break;case'u':var input=$('<div>').teleInput({label:'Target URL:',value:hybrid_link,link:true});trackerInfo.append(input);break;}
input.addClass('tele-workflow-tracker-input-'+type);if(type!=='u'){$('.tele-input-input',input).autocomplete({autoFocus:true,source:function(request,response){telepath.ds.get('/actions/get_suggest',{mode:type,host:application_domain},function(data){if(data.total>0){response(data.items);}
else{if(type=='s'&&!$('.tele-overlay-dialog').is(':visible')){telepath.dialog({type:'alert',title:'Business Actions',msg:'You need to login before you start recording'});}}});},minLength:0,change:function(event,ui){if(ui.item==null&&type=='s'){$(this).val('');$(this).focus();}},select:function(event,ui){if(type=='s'){$(this).data('sha256_sid',ui.item.sha256_sid);}}}).focus(function(){$(this).autocomplete('search',$(this).val());});}
that.input=input;var record_cmd=$('<div>').addClass('tele-control-record-cmd').hover(function(){$('*',this).addClass('hover');},function(){$('*',this).removeClass('hover');}).click(function(){if(record_lbl.html()=='Start Recording'){that.startRecording(type,$('input',that.input).val());record_lbl.html('Stop Recording');record_ico.toggleClass('tele-control-record');record_ico.toggleClass('tele-control-stop');}else{clearInterval(that.timer);that.progbarInner.css({width:0});that.timer=false;record_lbl.html('Start Recording');record_ico.toggleClass('tele-control-stop');record_ico.toggleClass('tele-control-record');that.endRecord();}});var record_lbl=$('<div>').addClass('tele-control-record-cmd-lbl').html('Start Recording');var record_ico=$('<div>').addClass('tele-control').addClass('tele-control-record');var record_div=$('<div>');record_ico.append(record_div);record_cmd.append(record_ico).append(record_lbl);var progbar=$('<div>');progbar.addClass('tele-listitem-bigprogbar');this.progbarInner=$('<div>').addClass('tele-listitem-progbar-inner').css({width:0});progbar.append(this.progbarInner);trackerInfo.append(record_cmd);trackerInfo.append(progbar);$(el).animate({marginBottom:100},'fast',function(){$(this).append(trackerInfo);trackerInfo.fadeIn();});},printTrackers:function(){var that=this;var container=this.container;$.each(this.trackers,function(i,tracker){var trackerEl=$('<div>').addClass('tele-workflow-tracker').addClass('tele-rounded-box');var trackerTitle=$('<div>').addClass('tele-title-1').html(tracker.title);var trackerDesc=$('<div>').addClass('tele-text').html(tracker.desc);trackerEl.append(trackerTitle).append(trackerDesc);trackerEl.hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover');}).click(function(){if($(this).hasClass('selected')){return;}
$('.tele-workflow-tracker.tele-rounded-box.selected').each(function(){$(this).animate({marginBottom:10},'fast',function(){}).removeClass('selected');$('.tele-workflow-tracker-info',this).fadeOut('fast',function(){$(this).remove();});});$(this).addClass('selected');that.trackerClick(this,tracker.type);});container.append(trackerEl);});},};telepath.config.action={new_flow:false,editAction:function(action_data){this.container=telepath.config.actions.contentRight;this.toolbar=telepath.config.actions.barRight;this.container.empty();this.toolbar.empty();this.tabsEl=$('<div>').addClass('tabs');this.tabsUl=$('<ul>');this.tabsEl.append(this.tabsUl);telepath.action.currentApp=action_data.application;this.action_data=action_data;this.showAction();},showAction:function(action_name){var that=this;that.container.empty();$('.popover').remove();if(!action_name){action_name='';}
if(that.action_data){var tmp=$('<div>').addClass('tele-action-container');that.container.append(tmp);that.container=tmp;$.each(that.action_data.business,function(i,request){request.el=$('<div>').teleRequest({data:request});that.container.append(request.el);});that.showSaveLoad();}},showSaveLoad:function(){var that=this;this.buttonsEl=$('<div>').addClass('tele-form-buttons');this.applyBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');this.cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');this.buttonsEl.append(this.applyBtn).append(this.cancelBtn);this.container.append(this.buttonsEl);this.applyBtn.click(function(){var actionData=[];$('.tele-action-container .tele-request').each(function(){actionData.push($(this).data('tele-tele-request').options.data);});var cleanData=[];$.each(actionData,function(i,action){var jsonNode={pagename:action.uri?action.uri:action.pagename};if(action.parameters&&action.parameters.length>0){jsonNode.params=[];$.each(action.parameters,function(i,param){jsonNode.params.push({name:param.name,data:param.data});});}
cleanData.push(jsonNode);});var flow_name=that.action_data&&that.action_data.action_name?that.action_data.action_name:$('input',telepath.action.recorder.actionName).val();if(!flow_name||flow_name==''){telepath.dialog({type:'alert',title:'Business Actions',msg:'Missing action name'});return;}
telepath.ds.get('/actions/check_existing_action_name',{host:telepath.action.currentApp,name:flow_name},function(data){if(data.items){telepath.dialog({type:'dialog',title:'Business Actions',msg:'This action name already exists. Do you want to override it?',callback:function(){telepath.config.action.postToServer(flow_name,cleanData);}});}
else{telepath.config.action.postToServer(flow_name,cleanData);}});});this.cancelBtn.click(function(){clearInterval(telepath.action.recorder.timer);telepath.action.recorder.init();});},postToServer:function(flow_name,cleanData){telepath.ds.get('/actions/set_flow',{app:telepath.action.currentApp,flow_name:flow_name,json:JSON.stringify(cleanData)},function(data){clearInterval(telepath.action.recorder.timer);telepath.dialog({type:'alert',title:'Business Actions',msg:'The Business Action was successfully recorded'});telepath.config.actions.reload();telepath.action.recorder.init();});}};function RecordFlow(container){this.itemWidth=330;this.container=container;}
RecordFlow.prototype.clear=function(){$('.flowContainer',this.container).remove();}
RecordFlow.prototype.refresh=function(data){$('.flowContainer',this.container).remove();this.flowContainer=$('<div>').addClass('flowContainer');this.container.append(this.flowContainer);var totalPrinted=0;var totalLimit=data.length;for(var i=0;i<totalLimit;i++){var requestTable=this.getRequestTable(data[i]);this.flowContainer.append(requestTable);totalPrinted++;}
$(this.flowContainer).append('<div class="clear"></div>');}
RecordFlow.prototype.getRequestTable=function(request){var table=$('<table>').addClass('record-flow-table');function getCell(html,className){var result=$('<td>').html(html);if(className){result.addClass(className);}
return result;}
var row=$('<tr>');if(request.date){var date=new Date(request.date*1000);var hours=date.getHours();var minutes=date.getMinutes();var seconds=date.getSeconds();row.clone().append(getCell('Time')).append(getCell(hours+':'+minutes+':'+seconds)).appendTo(table);}
if(request.params&&request.params.length>0){for(var i=0;i<request.params.length;i++){var z=request.params[i];var cell=$('<td>');if(z['att_id']=='18'||z['att_name']=='hybridrecord'){continue;}
var link=$('<a>').attr('href','#').text(decodeURIComponent(z['att_name'])).attr('rel',z['att_id']);var valueCell=$('<td>');var valueEdit=$('<span>').addClass('icon-edit').attr('rel',z['att_id']);var valueLink=$('<span>').attr('href','#').text(z['data']).attr('rel',z['att_id']);if(!z.include){valueLink.addClass('excluded');}
link.click(function(){var id=$(this).attr('rel');$.each(pageNode.childNodes,function(i,record){var recordID=record.data.id.split('_')[2];if(id==recordID){pageNode.expand();telepath.workflow.apptree.getSelectionModel().select(record);}});});valueEdit.click(function(){var id=parseInt($(this).attr('rel'));$(this).parent().find('span').hide();var valueInput=$('<input>').val($(this).parent().find('span:last').text()).attr('rel',id);valueInput.blur(function(){var id=parseInt($(this).attr('rel'));var value=$(this).val();if(value=='')value='*';$(this).parent().find('span').show();$(this).parent().find('span:last').text(value).removeClass('excluded');$(this).remove();$.each(request.params,function(i,param){if(param.att_id==id){param.data=value;param.include=true;}});});$(this).parent().append(valueInput);valueInput.focus();}).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover')});cell.append(link);valueCell.append(valueEdit).append(valueLink);row.clone().append(cell).append(valueCell).appendTo(table);}}
$('tr:even',table).addClass('even');$('tr:odd',table).addClass('odd');var app='';var ssl='';var url=(ssl==1?"https":"http")+"://"+app+request.path;var link=$('<a>').addClass('icon-link').text('').attr('href',escapeHtml(url)).attr('target','_blank').hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover')});var span=$('<span>').text(request.page_name!=""?request.page_name:request.path).hover(function(){$(this).addClass('hover');},function(){$(this).removeClass('hover')}).css('text-decoration','underline');span.click(function(){pageNode.expand();telepath.workflow.apptree.getSelectionModel().select(pageNode);});var wrap=$('<div>').addClass('record-flow-wrap');var inner_wrap=$('<div>').addClass('record-flow-inner-wrap');var table_wrap=$('<div>').addClass('record-flow-table-wrap');var title_wrap=$('<div>').addClass('record-flow-title-wrap');title_wrap.append(span).append(link);table_wrap.append(table);inner_wrap.append(title_wrap).append(table_wrap);wrap.append(inner_wrap);return wrap;};telepath.config.actions={list:[],sort:'host',dir:true,getList:function(){var that=this;telepath.ds.get('/workflow/groups_get_general_cb',{},function(data){that.list=data.items;});},expand:function(obj,callback){var that=this;var type=obj.data&&obj.data.type?obj.data.type:'root';var url='';var postData={};switch(type){default:case'root':url='/applications/get_expand';postData.type='root';postData.actions=true;postData.sort=telepath.config.actions.sort;postData.dir=telepath.config.actions.dir;postData.size=150;postData.offset=telepath.config.actions.offset;if(telepath.config.actions.searchString){postData.search=telepath.config.actions.searchString;}
break;case'app':url='/actions/get_app_actions';postData.host=obj.data.id;postData.type='application';postData.context='actions';postData.domain=obj.data.domain;break;}
telepath.ds.get(url,postData,function(data){var treeData=[];if(!data.items||data.items.length==0){callback.call(that,treeData);$(telepath.config.actions.contentLeftWrap).mCustomScrollbar('update');return;}
data=data.items;switch(postData.type){case'root':telepath.config.actions.offset=(data.finished)?'finished':telepath.config.actions.offset+data.data.length;$.each(data.data,function(i,row){var text=row.host;var childrens=[];if(typeof row.actions!="undefined"&&row.actions!=null&&row.actions.length>0){$.each(row.actions,function(i,action){var flow_obj={children:false,text:action.action_name,icon:"tele-icon tele-icon-actions",data:{id:action.action_name,type:"action",raw:action}};childrens.push(flow_obj);});}
if(typeof row.subdomains!="undefined"&&row.subdomains!=null&&row.subdomains.length>0&&typeof row.open!="undefined"&&row.open){$.each(row.subdomains,function(i,subdomain){var flow_obj={children:true,text:subdomain,data:{id:subdomain,type:"app",domain:"subdomain"}};childrens.push(flow_obj);});}
var obj={children:(childrens.length>0)?childrens:true,state:{opened:(childrens.length>0)?true:false},text:text,data:{id:row.host,type:'app',ssl:row.ssl_flag,domain:"root"}}
treeData.push(obj);});telepath.config.actions.loading=false;break;case'application':if(data.actions.length>0){$.each(data.actions,function(i,action){var flow_obj={children:false,text:action.action_name,icon:"tele-icon tele-icon-actions",data:{id:action.action_name,type:"action",raw:action}};treeData.push(flow_obj);});}
if(data.subdomains.length>0){$.each(data.subdomains,function(i,subdomain){var flow_obj={children:true,text:subdomain,data:{id:subdomain,type:"app",domain:"subdomain"}};treeData.push(flow_obj);});}
break;default:break;}
callback.call(that,treeData);$(telepath.config.actions.contentLeftWrap).mCustomScrollbar('update');});},data:[],deleteFlow:function(node){var that=this;telepath.ds.get('/actions/set_delete_action',{uid:node.uid,action:node.action_name,application:node.application},function(data){that.reload();});},input:function(){var that=this;var icon=$("#search-button");if(that.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.reload();},reload:function(){if(telepath.action.recorder.timer){clearInterval(telepath.action.recorder.timer);telepath.action.recorder.timer=false;telepath.action.recorder.endRecord();}
var that=this;that.offset=0;that.appTree=$('<div>');var treedata=telepath.config.actions.expand;that.createTree(that.appTree,treedata);that.contentLeft.empty().append(that.appTree);$(that.contentLeft).mCustomScrollbar({callbacks:{onTotalScroll:function(){if(that.loading||that.offset=='finished'){return;}
that.loading=true;$('.mCSB_container',that.list).append($(telepath.loader).css({float:'left',clear:'both','bottom':30,position:'absolute'}));var anotherData=telepath.config.actions.expand;var anotherTree=$('<div>');that.createTree(anotherTree,anotherData);that.appTree.parent().append(anotherTree);},},scrollButtons:{enable:false},scrollInertia:150,onTotalScrollOffset:200,alwaysTriggerOffsets:false,advanced:{updateOnContentResize:true}});},init:function(){this.data=null;this.initTools();this.reload();window.onbeforeunload=function(){if(telepath.action.recorder.timer){telepath.action.recorder.endRecord();}}},initTools:function(){var that=this;var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'host',icon:'arrow',tip:'ABC'},{id:'learning_so_far',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.reload();}});var rightPanel=$('<div>').attr('id','sort-radio').css('float','right').append(sortRadios);$('.tele-panel-topbar').append(rightPanel);this.search=$('<div>').teleSearch({callback:function(e,txt){that.searchString=txt;}});this.barLeft.append(this.search);$("#search-button").on("click",function(event){that.searchString='';$(".tele-config-bar-left .tele-search-input").prop("value",that.searchString);that.input();});if(typeof that.searchString!='undefined'){$(".tele-config-bar-left .tele-search-input").prop("value",that.searchString);that.input();}
var typingTimer;var doneTypingInterval=1000;$(".tele-config-bar-left .tele-search-input").keyup('input',function(){clearTimeout(typingTimer);if($(".tele-config-bar-left .tele-search-input").val()){typingTimer=setTimeout(function(){that.searchString=$(".tele-config-bar-left .tele-search-input").val();that.input();},doneTypingInterval);}});},createTree:function(div,treedata){var that=this;div.jstree({core:{data:treedata},plugins:["json_data","wholerow","theme","grid","search"],grid:{columns:[{width:370},{value:function(node){},width:40},{value:function(node){if(node.type=='action'){return $('<div>').btn({icon:'delete',callback:function(){telepath.config.actions.deleteFlow(node.raw);}});}},width:40}],resizable:true,}}).on('changed.jstree',function(e,data){if(telepath.action.recorder.timer){telepath.dialog({type:'dialog',title:'Business Actions',msg:'Are you sure thay you want to stop the Business Action record?',callback:function(){clearInterval(telepath.action.recorder.timer);telepath.action.recorder.endRecord();telepath.action.recorder.timer=false;that.appTree.trigger("restart",data);}});}
else{$(this).trigger("restart",data);}}).on('restart',function(e,data){data.instance.element.find('.jstree-wholerow').css('background-color','#FFFFFF');data.instance.element.find('#'+data.selected[0]).children(":first").css("background-color","rgba(189, 189, 189, 0.85)");telepath.config.actions.contentRight.empty();telepath.config.actions.barRight.empty();if(data.node.data.type=='action'){telepath.config.action.editAction(data.node.data.raw);}
if(data.node.data.type=='app'){telepath.action.currentApp=data.node.data.id;telepath.action.recorder.init();}});},checkNotFinishedRecord:function(){if(telepath.action.recorder.timer){clearInterval(telepath.action.recorder.timer);telepath.action.recorder.endRecord();telepath.action.recorder.timer=false;}}};;telepath.config.application={validate:function(){var that=this;var app_data={};$('#tele-app-details').click();app_data.host=$('input',this.AD_app_domain).val();$('input',this.AD_app_domain).css({borderColor:'#555'});if(app_data.host.length>256){telepath.dialog({type:'alert',title:'Application Settings',msg:'Application host too long'});$('input',this.AD_app_domain).css({borderColor:'red'});return false;}
if(app_data.host==''){telepath.dialog({type:'alert',title:'Application Settings',msg:'Application host cant be empty'});$('input',this.AD_app_domain).css({borderColor:'red'});return false;}
app_data.top_level_domain=this.TopLevelDomainAppToggle.data('tele-toggleFlip').options.flipped?1:0;var selected_opmod=this.opmod.data('tele-teleRadios').options.checked;switch(selected_opmod){case'training':app_data.operation_mode=1;break;case'production':app_data.operation_mode=2;break;case'hybrid':app_data.operation_mode=3;break;}
app_data.move_to_production=$('input',this.move_to_production).val();app_data.AppCookieName=[];$('input',this.app_cookies).each(function(){if($(this).val()!=''){app_data.AppCookieName.push($(this).val());}});app_data.AppCookieName=app_data.AppCookieName.filter(function(elem,pos){return app_data.AppCookieName.indexOf(elem)==pos;});app_data.AppCookieName=app_data.AppCookieName.join(',');app_data.app_ips=[];$('input',this.app_ips).each(function(){if($(this).val()!=''){app_data.app_ips.push($(this).val());}});app_data.app_ips=app_data.app_ips.filter(function(elem,pos){return app_data.app_ips.indexOf(elem)==pos;});app_data.app_ips=app_data.app_ips.join(',');$('#tele-app-auth').click();app_data.ntlm=0;app_data.basic_flag=0;app_data.form_flag=0;app_data.digest_flag=0;var mode=this.userIdentification.data('teleTeleRadios').options.checked;switch(mode){case'NTLM':app_data.ntlm=1;break;case'Basic':app_data.basic_flag=1;break;case'Form':app_data.form_flag=1;app_data.form_param_name=this.usernameParameter.teleBrowse('option','text');$('input',this.usernameParameter).css({borderColor:'#555'});if(!app_data.form_param_name||app_data.form_param_name==''||app_data.form_param_name.length>64||parseInt(app_data.form_param_id)==0){$('input',this.usernameParameter).css({borderColor:'red'});telepath.dialog({type:'alert',title:'Application Settings',msg:'Application authentication username parameter is missing.'});return false;}
break;case'Digest':app_data.digest_flag=1;break;}
app_data.ssl_flag=this.app_ssl_toggle.data('teleTeleRadios').options.checked=="On"?1:0;app_data.app_ssl_certificate=$('input',this.app_ssl_certificate).data('file');app_data.app_ssl_private=$('input',this.app_ssl_private).data('file');app_data.cookie_mode=this.SC_cookie_toggle.data('teleTeleRadios').options.checked=="On"?1:0;app_data.cookie_name=$('input',this.SC_cookie_name).val();app_data.cookie_value=$('input',this.SC_cookie_value).val();app_data.cookie_value_appearance=this.SC_cookie_flag.data('teleTeleRadios').options.checked=='appears'?1:0;app_data.body_value_mode=this.SC_body_toggle.data('teleTeleRadios').options.checked=="On"?1:0;app_data.body_value_html=this.SC_body_input.data('tele-teleInput').input.val();if(that.app_id=='new'){app_data.learning_so_far='0';app_data.subdomains='';app_data.eta='1d 0h 0m';}
telepath.ds.get('/applications/set_app',app_data,function(data){telepath.config.applications.reload();});},createApp:function(){this.editApp('new');},editApp:function(app_id,$nodeParent){var that=this;this.nodeParent=$nodeParent;this.container=telepath.config.applications.contentRight;this.toolbar=telepath.config.applications.barRight;this.container.empty();this.toolbar.empty();this.tabsEl=$('<div>').addClass('tabs');this.tabsUl=$('<ul>');this.tabsEl.append(this.tabsUl);var tabs=[{id:'details',text:'Application Details'},{id:'auth',text:'Authentication'},{id:'ssl',text:'SSL'},];for(x in tabs){var tab=tabs[x];var tabEl=$('<div>').attr('id','tele-app-'+tab.id);var tabLi=$('<li>');var tabA=$('<a>').attr('href','#tele-app-'+tab.id).text(tab.text);tabLi.append(tabA);this.tabsUl.append(tabLi);this.tabsEl.append(tabEl);if(app_id=='new'&&tab.id!='details'){}}
this.buttonsEl=$('<div>').addClass('tele-form-buttons');this.applyBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');this.cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');this.buttonsEl.append(this.applyBtn).append(this.cancelBtn);this.container.append(this.buttonsEl);this.applyBtn.click(function(){that.validate(that);});this.cancelBtn.click(function(){that.editApp(that.app_id);});this.container.append(this.tabsEl);this.container.append(this.buttonsEl);this.tabsEl.tabs({heightStyle:'fill',autoHeight:false,animate:false,activate:function(event,ui){if(ui.newPanel.selector=="#tele-app-params"){that.showPagesParams();}}});this.toolbar.append(this.tabsUl);this.app_id=app_id;this.app_data={app_domain:'',display_name:'',app_ips:'',form_param_name:'',form_param_id:'',ntlm:0,basic_flag:0,form_flag:0,digest_flag:0,cookie_mode:0,cookie_name:'',cookie_value:'',ssl_flag:0,AppCookieName:'',operation_mode:'1',eta:'1d 0h 0m',top_level_domain:'1'};if(app_id=='new'){this.showApp();}else{this.loadApp(app_id);}},loadApp:function(app_host){var that=this;this.app_data.app_domain=app_host;this.app_data.host=app_host;telepath.dsync.get('/applications/get_app',{host:app_host},function(data){if(data.items){that.app_data=data.items;}});that.showApp();},showPagesParams:function(){$("#tele-app-params").html('');this.teleBrowser=$('<div>').teleBrowser({root:{type:'application',id:this.app_id}});this.teleBrowserTitle=$('<div>').addClass('tele-title-1').html('Pages and Parameters List');$("#tele-app-params").append(this.teleBrowserTitle).append(this.teleBrowser);},showApp:function(){var that=this;var title=$('<div>').addClass('tele-title-1').html('Application Details').appendTo('#tele-app-details');this.AD_app_domain=$('<div>').teleInput({label:'Application Host',value:that.app_data.host});$('#tele-app-details').append(this.AD_app_domain);this.c_mode=$('<div>').addClass('tele-config-system-tab tele-config-system-mode');this.container.append(this.c_mode);$('<div>').addClass('tele-title-1 ').html('Top Level Domain').appendTo('#tele-app-details');this.TopLevelDomainAppToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:that.app_data.top_level_domain=='1'}).addClass('tele-TopLevelDomainApp-toggle').appendTo('#tele-app-details');$('<div>').addClass('tele-title-1').html('Operation Mode').appendTo('#tele-app-details');var selected_opmod='';switch(that.app_data.operation_mode){case'1':selected_opmod='training';break;case'2':selected_opmod='production';break;case'3':selected_opmod='hybrid';break;}
this.app_operation=$('<div>').appendTo('#tele-app-details').css({'width':'300px'});this.eta=$('<div>').html('ETA: '+that.app_data.eta);this.opmod=$('<div>').teleRadios({checked:selected_opmod,radios:[{key:'training',label:'Training'},{key:'hybrid',label:'Hybrid'},{key:'production',label:'Production'}],callback:function(radio){if(radio.key=='training'){that.eta.show();}else{that.eta.hide();}}}).addClass('tele-config-opmod').appendTo(this.app_operation);this.eta.appendTo(this.app_operation).css({float:'left',clear:'both','margin-top':'5px'});this.move_to_production=$('<div>').teleInput({label:'Move to production per application after',suffix:'requests',width:70,value:that.app_data.move_to_production}).addClass('tele-config-mv2prod').appendTo('#tele-app-details');var cookie_val=that.app_data.AppCookieName.split(',');this.app_cookies=$('<div>').teleMulti({values:cookie_val,title:'Application Cookies',template:function(element,value){element.teleInput({value:value});$('.tele-input-input',element).autocomplete({autoFill:true,source:that.app_data.cookie_suggestion,minLength:0,appendTo:'#tele-app-details'}).focus(function(){$(this).autocomplete('search',"");});}}).appendTo('#tele-app-details');var ips_val=that.app_data.app_ips.split(',');this.app_ips=$('<div>').teleMulti({values:ips_val,title:'Application IP Addresses',template:function(element,value){element.teleInput({value:value});$('.tele-input-input',element).autocomplete({autoFill:true,source:that.app_data.ip_suggestion,minLength:0,appendTo:'#tele-app-details'}).focus(function(){$(this).autocomplete('search',"");}).keydown(function(e){var key=e.charCode||e.keyCode||0;if(key>=96&&key<=105)
{key=key-48;}
if(e.ctrlKey&&key==86)
return;if(key==8||key==9||key==46||key==190||(key>=35&&key<=40)||(key>=48&&key<=57)||(key>=96&&key<=105)){}else{return false;}});}}).appendTo('#tele-app-details');this.usernameParameter=$('<div>').teleBrowse({label:'Username Parameter',value:that.app_data.form_param_name,id:that.app_data.host,mode:'param'}).appendTo('#tele-app-auth').hide().css({position:'absolute',top:100,left:300});var userID_val='';if(telepath.config.application.app_data.form_flag=='1'){userID_val='Form';this.usernameParameter.show();}
if(telepath.config.application.app_data.ntlm=='1'){userID_val='NTLM';}
if(telepath.config.application.app_data.basic_flag=='1'){userID_val='Basic';}
if(telepath.config.application.app_data.digest_flag=='1'){userID_val='Digest';}
this.userIdentification=$('<div>').teleRadios({title:'Authentication',checked:userID_val,radios:[{key:'Form',label:'Form'},{key:'Basic',label:'Basic'},{key:'Digest',label:'Digest'},{key:'NTLM',label:'NTLM'},{key:'',label:'None'}],callback:function(radio){that.usernameParameter.hide();switch(radio.key){case'Form':that.usernameParameter.show();break;}}}).css({'float':'left',clear:'both',width:300,inputFirst:true}).appendTo('#tele-app-auth');var SC_wrap=$('<div>');this.SC_cookie_name=$('<div>').teleInput({label:'Name',value:that.app_data.cookie_name});this.SC_cookie_value=$('<div>').teleInput({label:'Value',value:that.app_data.cookie_value});this.SC_cookie_flag_val=that.app_data.cookie_value_appearance=='1'?'appears':'missing';this.SC_cookie_flag=$('<div>').teleRadios({checked:this.SC_cookie_flag_val,radios:[{key:'missing',label:'Value is missing'},{key:'appears',label:'Value appears'}],callback:function(radio){switch(radio.key){}}});this.SC_cookie_toggle=$('<div>').teleRadios({title:'Cookie',checked:that.app_data.cookie_mode=='1'?'On':'Off',radios:[{key:'On',label:'On'},{key:'Off',label:'Off'}],callback:function(radio){that.SC_cookie_name.hide();that.SC_cookie_value.hide();that.SC_cookie_flag.hide();switch(radio.key){case'On':that.SC_cookie_name.show();that.SC_cookie_value.show();that.SC_cookie_flag.show();break;}}}).css({clear:'both','float':'left'}).addClass('tele-radio-on-off').appendTo('#tele-app-auth');$('.tele-input-input',this.SC_cookie_name).autocomplete({autoFill:true,source:that.app_data.cookie_suggestion,minLength:0,appendTo:'#tele-app-details'}).focus(function(){$(this).autocomplete('search','');});SC_wrap.append('<div class="tele-form-hr">');SC_wrap.append(this.SC_cookie_toggle).append(this.SC_cookie_name).append(this.SC_cookie_value).append(this.SC_cookie_flag);SC_wrap.append('<div class="tele-form-hr">');this.SC_body_input=$('<div>').teleInput({label:'Value to search in HTML body',value:that.app_data.body_value_html}).addClass('tele-app-auth-body');this.SC_body_toggle=$('<div>').teleRadios({title:'Body Value',checked:that.app_data.body_value_mode=='1'?'On':'Off',radios:[{key:'On',label:'On'},{key:'Off',label:'Off'},],callback:function(radio){that.SC_body_input.hide();switch(radio.key){case'On':that.SC_body_input.show();break;}}}).css({clear:'both','float':'left'}).addClass('tele-radio-on-off').appendTo('#tele-app-auth');SC_wrap.append(this.SC_body_toggle).append(this.SC_body_input);SC_wrap.appendTo('#tele-app-auth');var app_ssl_wrap=$('<div>').addClass('tele-app-ssl-wrap');var app_ssl_toggle_val=that.app_data.ssl_flag=='1'?'On':'Off';this.app_ssl_toggle=$('<div>').teleRadios({title:'SSL',checked:app_ssl_toggle_val,radios:[{key:'On',label:'On'},{key:'Off',label:'Off'},],callback:function(radio){app_ssl_wrap.hide();switch(radio.key){case'On':app_ssl_wrap.show();break;}}}).appendTo('#tele-app-ssl');var got_cert=that.app_data.ssl_data&&that.app_data.ssl_data.subject;this.app_ssl_certificate=$('<div>').teleFile({label:'Certificate',value:got_cert?'Uploaded':'',type:'certificate'}).appendTo(app_ssl_wrap);this.app_ssl_private=$('<div>').teleFile({label:'Private Key',value:got_cert?'Uploaded':'',type:'privatekey'}).appendTo(app_ssl_wrap);this.app_ssl_port=$('<div>').teleInput({label:'Server Port',value:that.app_data.ssl_server_port}).appendTo(app_ssl_wrap);this.app_ssl_password=$('<div>').teleInput({label:'Certificate Password',value:'',pass:true}).appendTo(app_ssl_wrap);$('#tele-app-ssl').append('<div class="tele-form-hr">');app_ssl_wrap.appendTo('#tele-app-ssl');$(app_ssl_wrap).append('<div class="tele-form-hr">');if(that.app_data.ssl_data&&that.app_data.ssl_data.subject){$.each(that.app_data.ssl_data.subject,function(key,val){$('<div style="clear:both;">').html(key+' = '+val).appendTo(app_ssl_wrap);});}
if(that.nodeParent){that.nodeParent.parent().find(".jstree-wholerow").css('background-color','#FFFFFF');that.nodeParent.find('.jstree-wholerow').css("background-color","rgba(189, 189, 189, 0.85)");}},deleteApp:function(app_id,$nodeParent){context_confirm('Delete Application','Are you sure you want to delete this application?',function(){telepath.ds.get('/applications/del_app',{app_id:app_id},function(data){if(data.success){$nodeParent.remove();}},'Error deleting application');});},initToolBar:function(){}};telepath.config.applications={sort:'host',dir:true,formatSearchData:function(data,mode){var treeData=[];$.each(data,function(host,row){var children=true;var opened=false;if(row){opened=true;children=[];$.each(row,function(name,b){var obj=(mode=='page')?{type:mode,host:host,path:name}:{type:mode,name:name};children.push({data:obj,text:name,icon:'tele-icon-'+mode});});}
var obj={children:children,name:host,text:host,data:{type:'app',text:host},icon:'tele-icon-app',state:{opened:opened}};treeData.push(obj);});return treeData;},oldFormatSearchData:function(data){var treeData=[];$.each(data,function(i,row){var children=false;if(row.type=='app'){children=true;}
var obj={children:children,name:row.text,text:row.text,data:row,'icon':'tele-icon-'+row.type};if(row.type=='page'){obj.text=row.host+obj.text;}
if(row.type=='param'){obj.data.host=row.host;obj.data.uri=row.uri;obj.text=row.host+row.uri+" - "+row.text+"&nbsp;("+row.param_type+")";}
treeData.push(obj);});return treeData;},formatData:function(data,count,root){if(!root){root=''}
if(!data)return;count=count!==false;var that=this;var treeData=[];$.each(data,function(i,row){var text=row.host;var children=false;if(count){if(typeof row.subdomains!="undefined"&&row.subdomains!=null&&row.subdomains.length>0){children=[];$.each(row.subdomains,function(i,subdomain){children.push({text:subdomain,state:{disabled:true}});})}else{children=false;}}
var obj={children:children,state:{opened:(typeof row.open!="undefined"&&row.open)?true:false},text:text,data:{type:'app',host:row.host,count:row.learning_so_far},icon:'tele-icon-app'};treeData.push(obj);});return treeData;},formatDataPages:function(data,i,host){if(!data){return;}
var that=this;var treeData=[];$.each(data,function(i,row){if(typeof(row)=='object'){var obj={children:that.formatDataPages(row,i,host),text:i,data:{type:'dir',text:i},'icon':'tele-icon-dir'};treeData.push(obj);}else{var obj={children:true,text:i,data:{type:'page',path:row,host:host},'icon':'tele-icon-page'};treeData.push(obj);}});return treeData;},expand:function(obj,callback){var that=this;telepath.ds.get('/applications/get_expand',{search:telepath.config.applications.searchString,learning_so_far:true,sort:telepath.config.applications.sort,dir:telepath.config.applications.dir,size:150,offset:telepath.config.applications.offset},function(data){var treeData=telepath.config.applications.formatData(data.items.data);callback.call(that,treeData);telepath.config.applications.offset=(data.items.finished)?'finished':telepath.config.applications.offset+data.items.data.length;telepath.config.applications.loading=false;$(".tele-search-input").attr("disabled",false);});},input:function(){var that=this;var icon=$("#search-button");if(that.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.reload();},data:[],reload:function(){var that=this;that.offset=0;that.appTree=$('<div>');that.contentLeftWrap=$('<div>').css({padding:0,height:$(that.contentLeft).parent().height()-20});that.contentLeft.empty().append(that.contentLeftWrap);that.contentLeftWrap.append(that.appTree);$(that.contentLeftWrap).mCustomScrollbar({callbacks:{onTotalScroll:function(){if(that.loading||that.offset=='finished'){return;}
that.loading=true;var anotherTree=$('<div>');var treedata=telepath.config.applications.expand;that.createTree(anotherTree,treedata);that.appTree.parent().append(anotherTree);$(".tele-search-input").attr("disabled",false);}},scrollButtons:{enable:false},scrollInertia:150,onTotalScrollOffset:200,alwaysTriggerOffsets:false,advanced:{updateOnContentResize:true}});that.data=telepath.config.applications.expand;that.createTree(that.appTree,that.data);},init:function(){this.data=null;this.initTools();$(".tele-config-bar-left .tele-search-input").attr("disabled",true);this.reload();},initTools:function(){var that=this;var sortRadios=$('<div>').radios({title:'Sort By',items:[{id:'host',icon:'arrow',tip:'ABC'},{id:'learning_so_far',icon:'bars',tip:'Count'}],selected:this.sort,callback:function(e,id){if(that.sort==id){that.dir=!that.dir;}
that.sort=id;that.reload();}});var rightPanel=$('<div>').attr('id','sort-radio').css('float','right').append(sortRadios);$('.tele-panel-topbar').append(rightPanel);this.search=$('<div>').teleSearch({callback:function(e,txt){that.searchString=txt;}});this.create=$('<div>').btn({icon:'plus',text:'New',callback:function(){telepath.config.application.createApp();}});this.barLeft.append(this.search).append(this.create);var typingTimer;var doneTypingInterval=1000;$(".tele-config-bar-left .tele-search-input").keyup('input',function(){clearTimeout(typingTimer);if($(".tele-config-bar-left .tele-search-input").val()){typingTimer=setTimeout(function(){that.searchString=$(".tele-config-bar-left .tele-search-input").val();that.input();},doneTypingInterval);}});$("#search-button").on("click",function(event){that.searchString='';$(".tele-config-bar-left .tele-search-input").prop("value",that.searchString);that.input();});if(typeof that.searchString!='undefined'){$(".tele-config-bar-left .tele-search-input").prop("value",that.searchString);that.input();}},createTree:function(div,treedata){div.jstree({core:{data:treedata,progressive_render:true,check_callback:true},plugins:["json_data","wholerow","theme","grid","contextmenu","search"],contextmenu:{items:telepath.contextMenu},grid:{columns:[{width:320},{width:50,value:"count",cellClass:"learning-so-far"},{value:function(node){return $('<div>').btn({icon:'edit',callback:function(tree){$nodeParent=tree.element.parents('[role="treeitem"]');telepath.config.application.editApp(node.host,$nodeParent);}});},width:40},{value:function(node){return $('<div>').btn({icon:'delete',callback:function(tree){$nodeParent=tree.element.parents('[role="treeitem"]');telepath.config.application.deleteApp(node.host,$nodeParent)}});},width:40}],resizable:true}}).on('changed.jstree',function(e,data){if(data&&data.node){data.instance.element.find('.jstree-wholerow').css('background-color','#FFFFFF');data.instance.element.find('.jstree-wholerow-hovered').css("background-color","rgba(189, 189, 189, 0.85)");telepath.config.application.editApp(data.node.data.host);}}).on('hover_node.jstree',function(e,data){$("#"+data.node.id+' a').prop('title',data.node.text);$("#"+data.node.id+' .learning-so-far').prop('title','Overall Transactions');});}};;telepath.config.notifications={init:function(){this.contentLeft.hide();this.contentRight.css({minWidth:'100%',width:'100%',height:'700px'});this.contentRight.append(telepath.loader);this.load();},load:function(){var that=this;$('.tele-loader',this.contentRight).remove();this.wrap=$('<div>').css({padding:20,height:80});this.contentRight.append(this.wrap);this.wrap.append($('<div>').addClass('tele-title-1').html('Notification Settings'));var poll_interval_slider=$('<div>').addClass('poll-interval-slider');this.wrap.append(poll_interval_slider);poll_interval_slider.slider({orientation:"horizontal",label:"Poll interval of ",suffix:" seconds.",range:false,max:60,step:5,value:30});this.settings=[{id:'alerts',label:'Alerts',desc:'Notify of new alerts',icon:'alerts'},{id:'alerts',label:'Case Alerts',desc:'Notify of new case alerts',icon:'case'},{id:'suspects',label:'Suspects',desc:'Notify of new suspects above',icon:'suspect',limit:true,limit_min:0,limit_max:100,limit_val:90,limit_step:1,limit_label_suffix:' average score.'},{id:'applications',label:'Applications',desc:'Telepath detects new applications',icon:'application'},{id:'requests',label:'Network',desc:'Incoming request rates exceeding',icon:'config',limit:true,limit_step:100,limit_min:0,limit_max:10000,limit_val:1000,limit_label_suffix:'req/minute.'},{id:'pages',label:'System',desc:'Telepath detects new pages',icon:'config'},{id:'updates',label:'Updates',desc:'System updates',icon:'config'},{id:'upgrades',label:'Upgrades',desc:'Check for new version',icon:'config'},];$.each(this.settings,function(i,setting){var box=$('<div>').addClass('tele-rounded-box').addClass('tele-notification-setting');var wrap=$('<div>').addClass('tele-rounded-wrap');var icon=$('<div>').addClass('tele-icon tele-icon-'+setting.icon);var cb=$('<div>').teleCheckbox({label:setting.label});var desc=$('<div>').html(setting.desc).addClass('tele-notification-desc');wrap.append(icon).append(cb);box.append(wrap).append(desc);that.contentRight.append(box);if(setting.limit){var range=$('<input>').addClass('notifications-intervals');box.append(range);range.slider({orientation:"horizontal",range:false,max:setting.limit_max,min:setting.limit_min,step:setting.limit_step,value:setting.limit_val,label:setting.limit_label_suffix});}else{desc.css({paddingTop:10});}});this.buttonsEl=$('<div>').addClass('tele-form-buttons');this.applyBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');this.cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');this.buttonsEl.append(this.applyBtn).append(this.cancelBtn);that.contentRight.append(this.buttonsEl);}};telepath.config.rule={delRule:function(rule_name,rule_category){telepath.dialog({type:'dialog',msg:'This operation will delete the selected rule group. Are you sure?',callback:function(){telepath.ds.get('/rules/del_rule',{name:rule_name,category:rule_category},function(data){telepath.config.rules.init();});}});},editRule:function(id){var that=this;this.container=$('<div>').css({padding:20}).addClass('tele-rule-editor');telepath.config.rules.contentRight.empty();telepath.config.rules.contentRight.append(this.container);telepath.config.rules.contentRight.mCustomScrollbar({advanced:{updateOnContentResize:true}});this.toolbar=telepath.config.rules.barRight;this.container.empty();$('.tele-panel-subtitle-text').hide();if(id=='new'){this.data={enable:true,name:'',desc:'',owner:'',score:0,criteria:[],action_email_field:'',alert_param_ids:[],action_notifications:true,action_syslog:false,action_injection:false,action_email:false,disable_db_save:false,action_email_owner:true,category:telepath.config.rules.selectedCategory,new_rule:true};this.showRule();}else{this.loadRule(id);}},loadRule:function(id){var that=this;telepath.ds.get('/rules/get_rule',{id:id},function(data){that.data=data.items[0];that.data.id=id
that.showRule();});},showRule:function(){var that=this;this.container.empty();var ruleName=$('<div>').teleInput({label:'Name',value:this.data['name']=='new'?'':this.data['name']}).addClass('tele-rule-name');this.container.append(ruleName);var ruleDesc=$('<div>').teleInput({label:'Description',value:this.data['desc']==''?'':this.data['desc']}).addClass('tele-rule-desc');this.container.append(ruleDesc);var ruleScore=$('<div>').teleInput({label:'Score',width:30,value:this.data['score']==''?'95':this.data['score']}).addClass('tele-rule-score');this.container.append(ruleScore);if(!this.data['builtin_rule'])
{var title1=$('<div>').addClass('tele-title-1').text('Select type and build rule');this.container.append(title1);}else{var title1=$('<div>').addClass('tele-title-1').text('Built in system rule');this.container.append(title1);$('input',ruleName).prop("disabled",true);$('input',ruleDesc).prop("disabled",true);}
var cond=$('<div>').teleRule({data:this.data});this.container.append(cond);var title2=$('<div>').addClass('tele-title-1').text('Actions');this.container.append(title2);this.action_notifications=$('<div>').teleCheckbox({label:'Notification',checked:this.data.action_notifications}).appendTo(this.container);this.action_syslog=$('<div>').teleCheckbox({label:'Syslog',checked:this.data.action_syslog}).appendTo(this.container);this.action_email=$('<div>').teleCheckbox({label:'Email',checked:this.data.action_email}).appendTo(this.container);this.action_email_owner=$('<div>').teleCheckbox({label:'Email rule owner',checked:this.data.action_email_owner}).appendTo(this.container);var cmd_captcha_checked=false;var cmd_block_checked=false;if(this.data.cmd&&this.data.cmd.length>0){$.each(this.data.cmd,function(i,x){if(x=='captcha'){cmd_captcha_checked=true;}
if(x=='block'){cmd_block_checked=true;}});}
this.cmd_captcha=$('<div>').teleCheckbox({label:'Captcha Challenge',checked:cmd_captcha_checked}).appendTo(this.container);this.cmd_block=$('<div>').teleCheckbox({label:'Block Access',checked:cmd_block_checked}).appendTo(this.container);this.disable_db_save=$('<div>').teleCheckbox({label:'Disable DB saving',checked:this.data.disable_db_save}).appendTo(this.container);if(!this.data.action_email_field){this.data.action_email_field='';}
this.email_notifications=$('<div>').teleMulti({validator:'email',values:this.data.action_email_field.split(','),title:'Email Notifications',template:function(element,value){element.teleInput({value:value});}}).addClass('tele-rule-email-notif').appendTo(this.container);var title1=$('<div>').addClass('tele-title-1').text('Limit rule by IP').appendTo(this.container);if(!this.data.ip){this.data.ip=''}
var is_range=this.data.ip.split('-').length>1;var ipWrap=$('<div>').addClass('tele-ip-wrap');var ipStart=$('<div>').addClass('tele-ip').ip({data:this.data.ip.split('-')[0]});var ipDash=$('<div>').addClass('tele-ip-dash').html('_');var ipEnd=$('<div>').addClass('tele-ip').ip({data:is_range?this.data.ip.split('-')[1]:''});if(!is_range){ipDash.hide();ipEnd.hide();}
var ipToggle=$('<div>').toggleFlip({left_value:'Single',right_value:'Range',flip:function(){ipEnd.toggle();ipDash.toggle();},flipped:is_range,});ipWrap.append(ipToggle).append(ipStart).append(ipDash).append(ipEnd).appendTo(this.container);var title1=$('<div>').addClass('tele-title-1').text('Limit rule by Application').appendTo(this.container);if(!this.data.domain){this.data.domain=''}
var app_filter_data=[{text:this.data.domain}];var filterApps=$('<div>').teleSelect({type:'subdomain',values:app_filter_data,click:function(){}}).appendTo(this.container);$('.tele-multi-control',filterApps).hide();this.cmd_wrap=$('<div>').addClass('tele-rule-cmd-wrap').appendTo(this.container);this.command_exec_list=$('<div>').addClass('tele-rule-cmd-list').hide();if(this.data.cmd&&this.data.cmd.length>0){this.command_exec_list.show();}
$.each(telepath.rule_cmds,function(i,x){if(x!='block'&&x!='captcha'){var checked=false;if(that.data.cmd&&that.data.cmd.length>0){$.each(that.data.cmd,function(tmp1,tmp2){if(x==tmp2){checked=true;}});}
var cb=$('<div>').teleCheckbox({label:x,checked:checked,}).appendTo(that.command_exec_list);}});this.command_exec_toggle=$('<div>').teleCheckbox({label:'<b>Execute commands</b>',checked:this.data.cmd&&this.data.cmd.length>0,callback:function(val){that.command_exec_list.toggle();}}).addClass('tele-rule-cmd-toggle').appendTo(this.cmd_wrap);this.command_exec_list.appendTo(this.cmd_wrap);var btnContain=$('<div>').addClass('tele-button-container');var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');btnContain.append(saveBtn).append(cancelBtn);this.container.append(btnContain);saveBtn.click(function(){var ruleData={name:$('.tele-rule-name input').val(),desc:$('.tele-rule-desc input').val(),score:parseInt($('.tele-rule-score input').val()),category:that.data.category};if(ruleData.name.length==0||ruleData.name.length>32){telepath.dialog({title:'Case Editor',msg:'Must specify rule name'});return;}
if(ruleData.score<0||ruleData.score>100){telepath.dialog({title:'Case Editor',msg:'Must specify score between 0 and 100'});return;}
ruleData.criteria=$('.tele-ruletype-select').data('teleTeleRule').getValues();if($('.tele-overlay-dialog').is(':visible')){return;}
if(ruleData.criteria.length==0){telepath.dialog({title:'Case Editor',msg:'Must have at least one condition'});return;}
if(that.action_notifications.data('teleTeleCheckbox').options.checked){ruleData.action_notifications=true;}
if(that.action_syslog.data('teleTeleCheckbox').options.checked){ruleData.action_syslog=true;}
if(that.action_email.data('teleTeleCheckbox').options.checked){ruleData.action_email=true;}
if(that.action_email_owner.data('teleTeleCheckbox').options.checked){ruleData.action_email_owner=true;}
ruleData.cmd=[];if(that.command_exec_toggle.data('teleTeleCheckbox').options.checked){$('.tele-checkbox',that.command_exec_list).each(function(){var opt=$(this).data('teleTeleCheckbox').options;if(opt.checked){ruleData.cmd.push(opt.label);}});}
if(that.cmd_captcha.data('teleTeleCheckbox').options.checked){ruleData.cmd.push('captcha');}
if(that.cmd_block.data('teleTeleCheckbox').options.checked){ruleData.cmd.push('block');}
if(that.disable_db_save.data('teleTeleCheckbox').options.checked){ruleData.disable_db_save=true;}
$('.tele-icon-rule-edit').append(telepath.loader).css({backgroundColor:'white'});if(that.data.new_rule){var found=false;$.each(telepath.config.rules.categories,function(i,val){if(ruleData.name==val.name){telepath.dialog({title:'Case Editor',msg:'Rule name already exists'});found=true}});if(found){return}
telepath.ds.get('/rules/add_rule',{ruleData:ruleData},function(data){that.data=data.items;that.showRule();telepath.config.rules.init();telepath.dialog({msg:'Successfully created a rule'});});}else{ruleData.id=that.data.id;var found=false;$.each(telepath.config.rules.categories,function(i,val){if(val.id!="Login Brute-Force"&&val.id!="Credential-Stuffing"&&val.id!="Web shell"&&ruleData.name==val.name&&ruleData.id!=val.id){telepath.dialog({title:'Case Editor',msg:'Rule name already exists'});found=true}});if(found){return}
telepath.ds.get('/rules/set_rule',{ruleData:ruleData,builtin_rule:that.data.builtin_rule},function(data){that.data=data.items;that.showRule();if(data.success){$('.jstree-clicked').text(ruleData.name);telepath.dialog({msg:'Successfully updated a rule'});telepath.config.rule.editRule(ruleData.id);telepath.config.rules.init();}});}});cancelBtn.click(function(){that.showRule();});},debug:function(){for(key in this.rule_data){var value=this.rule_data[key];$('<div>').css({'clear':'both','float':'left','width':'400'}).html(key+' : '+value).appendTo(this.container);}}};telepath.config.rules={searchString:'',init:function(){var that=this;this.barLeft.empty();this.cmdNewRule=$('<div>').btn({icon:'plus',text:'New Rule',callback:function(){if(telepath.access.admin||telepath.access.perm.Rules_add){telepath.config.rule.editRule('new');}else{telepath.dialog({msg:'Access denied. No permissions to create a new Rule.'});};}}).hide();this.cmdNewCategory=$('<div>').btn({icon:'plus',text:'New Category',callback:function(){if(telepath.access.admin||telepath.access.perm.Rules_add){telepath.config.rules.addCategory();}else{telepath.dialog({msg:'Access denied. No permissions to create a new Category.'});};}});this.barLeft.append(this.cmdNewRule).append(this.cmdNewCategory);this.barRight.empty();var rightTitle=$('<div>').addClass('tele-panel-subtitle-text').html('Editor');this.search=$('<div>').teleSearch({callback:function(e,txt){that.searchString=txt;}});this.barRight.append(rightTitle).append(this.search);$("#search-button").on("click",function(event){that.searchString='';$(".tele-config-bar-right .tele-search-input").prop("value",that.searchString);that.input();});if(typeof(that.searchString)!='undefined'){$(".tele-config-bar-right .tele-search-input").prop("value",that.searchString);that.input();}
$(".tele-config-bar-right .tele-search-input").keyup('input',function(){that.searchString=$(this).val();that.input();});},reload:function(){var that=this;this.contentLeft.empty();this.contentRight.empty();that.cmdNewRule.hide();var leftTitle=$('<div>').addClass('tele-panel-subtitle-text').html('Rules');this.ruleTree=$('<div>').teleTree({type:'rules',callback:function(e,data){if(data.node.data.type=='category'){that.cmdNewRule.show();that.selectedCategory=data.node.data.name;}else{that.cmdNewRule.hide();}
if(data.node.data.type=='group'){telepath.config.rule.editRule(data.node.data.id);}}}).css({height:this.contentLeft.css('height')});this.contentLeft.append(this.ruleTree);},input:function(){var that=this;var icon=$("#search-button");if(that.searchString.length>0)
icon.addClass('icon-delete-input2').removeClass("tele-search-button");else
icon.removeClass('icon-delete-input2').addClass("tele-search-button");that.reload();that.ruleTree.teleTree('option','searchString',that.searchString);},delCategory:function(value){telepath.dialog({type:'dialog',msg:'This operation will delete the selected rule category. Are you sure?',callback:function(){telepath.ds.get('/rules/del_category',{cat:value},function(data){telepath.config.rules.init();});}});},addCategory:function(msg,error){if(!error){error=false;}
if(!msg){msg='New category name:'}
telepath.dialog({type:'prompt',title:'Create new category',error:false,msg:msg,callback:function(value){var found=false;$.each(telepath.config.rules.categories,function(i,v){if(v.name.toLowerCase()==value.toLowerCase()){found=true;};});if(found){telepath.config.rules.addCategory('Choose a different name:',true);return;}
telepath.ds.get('/rules/add_category',{cat:value},function(data){telepath.config.rules.init();});}});}};telepath.user={showWindow:function(){Ext.define('MyApp.view.simpleuserWindow',{extend:'Ext.window.Window',height:310,width:270,layout:{type:'absolute'},title:'User Editor',modal:true,initComponent:function(){var me=this;Ext.applyIf(me,{dockedItems:[{xtype:'toolbar',dock:'top',items:[{xtype:'button',text:'Save User',listeners:{click:{fn:telepath.user.save,scope:me}}}]}],items:[{xtype:'textfield',x:10,y:10,id:'s_user_email',fieldLabel:'E-Mail'},{xtype:'textfield',x:10,y:40,id:'s_user_first_name',fieldLabel:'First Name'},{xtype:'textfield',x:10,y:70,id:'s_user_last_name',fieldLabel:'Last Name'},{xtype:'textfield',x:10,y:100,id:'s_user_company',fieldLabel:'Company'},{xtype:'textfield',x:10,y:130,id:'s_user_phone',fieldLabel:'Phone'},{xtype:'textfield',x:10,y:180,id:'s_user_password_1',fieldLabel:'Password',inputType:'password'},{xtype:'textfield',x:10,y:210,id:'s_user_password_2',fieldLabel:'Password (again)',inputType:'password'}]});me.callParent(arguments);}});telepath.user.editWindow=Ext.create('MyApp.view.simpleuserWindow');telepath.user.editWindow.show();telepath.user.getData();},getData:function(){telepath.util.request('/users/get_self',{},function(data){var userdata=data.items.user;Ext.getCmp('s_user_email').setValue(userdata.email);Ext.getCmp('s_user_first_name').setValue(userdata.first_name);Ext.getCmp('s_user_last_name').setValue(userdata.last_name);Ext.getCmp('s_user_company').setValue(userdata.company);Ext.getCmp('s_user_phone').setValue(userdata.phone);},'Error retreiving user information');},save:function(){var params={};var fields=['email','first_name','last_name','company','phone'];$.each(fields,function(i,field){params[field]=Ext.getCmp('s_user_'+field).value;});var email=params['email'];var email_regex=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(email!=''&&!email_regex.test(email)){Ext.Msg.alert('Error','Incorrect email');return;}
var pass_1=Ext.getCmp('s_user_password_1').value;var pass_2=Ext.getCmp('s_user_password_2').value;if(pass_1!=''&&pass_2!=''&&pass_1!==pass_2){Ext.Msg.alert('Error','Password Mismatch');return;}
if(pass_1!=''&&pass_2!=''&&pass_1===pass_2){params['password']=pass_1;}
telepath.user.user_mask=new Ext.LoadMask(telepath.user.editWindow.body.el,{msg:"Please wait..."});telepath.user.user_mask.show();$.post(telepath.controllerPath+'/users/set_self',params,function(data){if(data.success){telepath.user.editWindow.destroy();}else{telepath.user.user_mask.destroy();Ext.Msg.alert('Error',data.error);}},'json');}};telepath.users={toggle:function(what){telepath.users.perm_sel=Ext.getCmp('user_permissions').getSelectionModel();var selection=[];$.each(Ext.getStore('permissionsStore').data.items,function(i,perm_perm){var bool=Ext.getCmp('user_toggle_'+perm_perm.data['function']).pressed;if(bool){selection.push(perm_perm);}});telepath.users.perm_sel.select(selection);},showWindow:function(){if(!telepath.users.window){telepath.users.window=Ext.create('MyApp.view.usersWindow');}
telepath.users.window.show();telepath.users.loadStore();},loadStore:function(callback){$.post(telepath.controllerPath+'/users/get_list',{},function(data){Ext.getStore('usersStore').loadData(data.items);if(typeof callback=='function'){callback();}},'json');},edit:function(record){telepath.users.editWindow=Ext.create('MyApp.view.userWindow');telepath.users.editWindow.show();telepath.users.user_mask=new Ext.LoadMask(telepath.users.editWindow.body.el,{msg:"Please wait..."});telepath.users.user_mask.show();$.post(telepath.controllerPath+'/users/get_user',{id:record.data.id},function(data){telepath.users.editData=data;var fields=['login','active','email','first_name','last_name','company','phone'];$.each(fields,function(i,field){Ext.getCmp('user_'+field).setValue(data['items']['user'][field]);});telepath.users.user_mask.destroy();telepath.groups.loadStore(function(){telepath.users.group_sel=Ext.getCmp('user_groups').getSelectionModel();var selection=[];$.each(Ext.getStore('groupsStore').data.items,function(i,groups_group){$.each(telepath.users.editData['items']['groups'],function(x,user_group){if(groups_group.data.id==user_group.id){selection.push(groups_group);}});});telepath.users.group_sel.select(selection);});telepath.permissions.loadStore(function(){telepath.users.perm_sel=Ext.getCmp('user_permissions').getSelectionModel();var selection=[];$.each(Ext.getStore('permissionsStore').data.items,function(i,perm_perm){$.each(telepath.users.editData['items']['perm'],function(x,user_perm){if(perm_perm.data.id==user_perm.id){selection.push(perm_perm);}});});telepath.users.perm_sel.select(selection);});telepath.applications.get_list(function(data){Ext.getStore('applicationsStore').loadData(data.items);telepath.users.apps_sel=Ext.getCmp('user_applications').getSelectionModel();if(!telepath.users.editData['items']['apps']||telepath.users.editData['items']['apps'].length==0){telepath.users.editData['items']['apps']=[-1];}
var selection=[];$.each(Ext.getStore('applicationsStore').data.items,function(i,apps_app){$.each(telepath.users.editData['items']['apps'],function(r_id,app_id){if(apps_app.data.id==parseInt(app_id)){selection.push(apps_app);}});});telepath.users.apps_sel.select(selection);telepath.users.apps_sel.addListener('selectionchange',function(e,o){if(e.lastSelected&&e.lastSelected.data){if(e.lastSelected.data.id==-1){e.select(e.lastSelected);}}});});},'json');},save:function(){var params=telepath.users.editData;var user_groups=[];$.each(Ext.getCmp('user_groups').getSelectionModel().selected.items,function(i,user_group){user_groups.push(user_group.data.id);});var user_permissions=[];$.each(Ext.getCmp('user_permissions').getSelectionModel().selected.items,function(i,user_perm){user_permissions.push(user_perm.data.id);});var user_applications=[];$.each(Ext.getCmp('user_applications').getSelectionModel().selected.items,function(i,user_app){user_applications.push(user_app.data.id);});params['items']['groups']=user_groups;params['items']['perm']=user_permissions;params['items']['apps']=user_applications;var fields=['login','active','email','first_name','last_name','company','phone'];$.each(fields,function(i,field){params['items']['user'][field]=Ext.getCmp('user_'+field).value;});var login=params['items']['user']['login'];if(login==''||typeof login=='undefined'){Ext.Msg.alert('Error','Login can\'t be blank');return;}
var email=params['items']['user']['email'];var email_regex=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(email!=''&&!email_regex.test(email)){Ext.Msg.alert('Error','Incorrect email');return;}
var pass_1=Ext.getCmp('user_password_1').value;var pass_2=Ext.getCmp('user_password_2').value;if(pass_1!=''&&pass_2!=''&&pass_1!==pass_2){Ext.Msg.alert('Error','Password Mismatch');return;}
if(pass_1!=''&&pass_2!=''&&pass_1===pass_2){params['items']['user']['password']=pass_1;}
if(params['items']['user']['id']=='new'&&(pass_1==''||typeof pass_1=='undefined')){Ext.Msg.alert('Error','New user must have password');return;}
telepath.users.user_mask=new Ext.LoadMask(telepath.users.editWindow.body.el,{msg:"Please wait..."});telepath.users.user_mask.show();var path=params['items']['user']['id']=='new'?'add_user':'set_user';$.post(telepath.controllerPath+'/users/'+path,params,function(data){if(data.success){telepath.users.editWindow.destroy();telepath.users.loadStore();telepath.users.edit({data:{id:data.items.user_id}});}else{telepath.users.user_mask.destroy();Ext.Msg.alert('Error',data.error);}},'json');},create:function(){telepath.users.editWindow=Ext.create('MyApp.view.userWindow');telepath.users.editWindow.show();Ext.getCmp('user_delete').disable();Ext.getCmp('user_activity').disable();telepath.users.editData={items:{user:{id:'new',login:'',email:''},perm:[],groups:[],apps:[]}};telepath.groups.loadStore();},deleteClick:function(){var id=telepath.users.editData.items.user.id;telepath.users.user_mask=new Ext.LoadMask(telepath.users.editWindow.body.el,{msg:"Please wait..."});telepath.users.user_mask.show();$.post(telepath.controllerPath+'/users/del_user',{id:id},function(data){if(data.success){telepath.users.editWindow.destroy();telepath.users.loadStore();}else{telepath.users.user_mask.destroy();Ext.Msg.alert('Error',data.error);}},'json');}};telepath.groups={showWindow:function(){if(!telepath.groups.window){telepath.groups.window=Ext.create('MyApp.view.groupsWindow');}
telepath.groups.window.show();telepath.groups.loadStore();},loadStore:function(callback){telepath.util.request('/groups/get_list',{},function(data){Ext.getStore('groupsStore').loadData(data.items);if(typeof callback=='function'){callback();}},'Error loading group list.');},edit:function(record){telepath.groups.editWindow=Ext.create('MyApp.view.groupWindow');telepath.groups.editWindow.show();telepath.groups.group_mask=new Ext.LoadMask(telepath.groups.editWindow.body.el,{msg:"Please wait..."});telepath.groups.group_mask.show();telepath.util.request('/groups/get_group',{id:record.data.id},function(data){telepath.groups.editData=data;var fields=['name','description'];$.each(fields,function(i,field){Ext.getCmp('group_'+field).setValue(data['items']['group'][field]);});telepath.groups.group_mask.destroy();telepath.users.loadStore(function(){telepath.groups.group_sel=Ext.getCmp('group_users').getSelectionModel();var selection=[];$.each(Ext.getStore('usersStore').data.items,function(i,users_user){$.each(telepath.groups.editData['items']['users'],function(x,group_user){if(users_user.data.id==group_user.id){selection.push(users_user);}});});telepath.groups.group_sel.select(selection);});telepath.permissions.loadStore(function(){telepath.groups.group_sel=Ext.getCmp('group_permissions').getSelectionModel();var selection=[];$.each(Ext.getStore('permissionsStore').data.items,function(i,perm_perm){$.each(telepath.groups.editData['items']['perm'],function(x,group_perm){if(perm_perm.data.id==group_perm.id){selection.push(perm_perm);}});});telepath.groups.group_sel.select(selection);});},'Error loading group information.');},save:function(){telepath.groups.group_mask=new Ext.LoadMask(telepath.groups.editWindow.body.el,{msg:"Please wait..."});telepath.groups.group_mask.show();var params=telepath.groups.editData;var group_users=[];$.each(Ext.getCmp('group_users').getSelectionModel().selected.items,function(i,group_user){group_users.push(group_user.data.id);});var group_permissions=[];$.each(Ext.getCmp('group_permissions').getSelectionModel().selected.items,function(i,group_perm){group_permissions.push(group_perm.data.id);});params['items']['users']=group_users;params['items']['perm']=group_permissions;var fields=['name','description'];$.each(fields,function(i,field){params['items']['group'][field]=Ext.getCmp('group_'+field).value;});var path='/groups/'+(params['items']['group']['id']=='new'?'add':'set')+'_group';telepath.util.request(path,params,function(data){telepath.groups.editWindow.destroy();telepath.groups.loadStore();telepath.groups.edit({data:{id:data.items.group_id}});},function(){telepath.groups.group_mask.destroy();Ext.Msg.alert('Error',data.error);});},create:function(){telepath.groups.editWindow=Ext.create('MyApp.view.groupWindow');telepath.groups.editWindow.show();Ext.getCmp('group_delete').disable();Ext.getCmp('group_activity').disable();telepath.groups.editData={items:{group:{id:'new'},perm:[],users:[]}};telepath.users.loadStore();},deleteClick:function(){var id=telepath.groups.editData.items.group.id;telepath.groups.group_mask=new Ext.LoadMask(telepath.groups.editWindow.body.el,{msg:"Please wait..."});telepath.groups.group_mask.show();telepath.util.request('/groups/del_group',{id:id},function(data){telepath.groups.editWindow.destroy();telepath.groups.loadStore();},function(){telepath.groups.group_mask.destroy();Ext.Msg.alert('Error',data.error);});}};telepath.config.system={init:function(){this.contentRight.addClass('tele-stacked');this.contentLeft.addClass('tele-stacked');this.contentLeft.css({width:'100%',minWidth:'100%',height:100,maxHeight:100});this.contentRight.css({width:'100%',minWidth:'100%'});this.contentRight.append(telepath.loader);this.loadConfig();this.showConfigSteps();this.contentRight.mCustomScrollbar({advanced:{updateOnContentResize:true},scrollButtons:{enable:false}});},loadConfig:function(){var that=this;telepath.ds.get('/config/get_config',{},function(data){that.data=data;that.showConfig();},'Error loading configuration.');},showConfigSteps:function(){var that=this;this.steps=[{id:'mode',label:'Operation Mode'},{id:'reports',label:'Reports'},{id:'network',label:'Network'},{id:'whitelist',label:'Whitelists'},{id:'ext_ignore',label:'Extension Ignore List'},];this.stepContainer=$('<div>').addClass('tele-config-system-steps');this.contentLeft.append(this.stepContainer);$.each(this.steps,function(i,stepData){var step=$('<div>').addClass('tele-config-system-step').attr('id','tele-config-step-'+stepData.id);var index=$('<div>').addClass('tele-config-system-step-index').html(i+1);var lbl=$('<div>').addClass('tele-config-system-step-label').html(stepData.label);step.append(index).append(lbl);that.stepContainer.append(step);var arrow=$('<div>').addClass('tele-config-system-step-arrow');if(i==0){step.addClass('active');}
if(i!==that.steps.length-1){that.stepContainer.append(arrow);}
step.click(function(){var stepId=$(this).attr('id').split('-')[3];$('.tele-config-system-tab').hide();$("#file-upload").hide();$('.tele-config-system-'+stepId).show();if(stepId=="mode"){$("#file-upload").show();}
$('.active',that.stepContainer).removeClass('active');$(this).addClass('active');$(this).prevAll().addClass('active');$('.tele-config-content-right').mCustomScrollbar('update');});});$(window).resize(function(){if($('.tele-config-system-steps').size()>0){setTimeout(function(){telepath.config.system.updWidth();},100);}});this.updWidth();},updWidth:function(){var mid_width=($('.tele-config-system-step').outerWidth()*(this.steps.length))/2;var mid_screen=this.stepContainer.parent().width()/2;this.stepContainer.css({marginLeft:mid_screen-mid_width-40});},saveConfig:function(){var that=this;var data={};var t_engine=this.telepathEngineToggle.data('tele-toggleFlip').options.flipped;var t_inline=this.reverseProxyToggle.data('tele-toggleFlip').options.flipped;var t_sniffer=this.snifferToggle.data('tele-toggleFlip').options.flipped;data.engine_mode_id=(t_engine)?1:0;data.sniffer_mode_id=(t_sniffer)?1:0;data.reverse_proxy_mode_id=(t_inline)?1:0;data.input_mode='off';if(t_sniffer&&t_inline){data.input_mode='both';}else{if(t_inline){data.input_mode='inline';}
if(t_sniffer){data.input_mode='sniffer';}}
data.move_to_production_id=$('input',this.move_to_production_id).val();data.add_unknown_applications_id=this.addUnknownAppToggle.data('tele-toggleFlip').options.flipped?1:0;data.write_to_syslog_id=this.syslogToggle.data('tele-toggleFlip').options.flipped?1:0;data.syslog_ip_id=$('input',this.syslogIP).val();data.proxy_mode_id=this.proxyToggle.data('tele-toggleFlip').options.flipped?1:0;data.proxy_ip_id=$('input',this.proxyIP).val();data.proxy_port_id=$('input',this.proxyPort).val();data.smtp_ip_id=$('input',this.smtpServer).val();data.smtp_port_id=$('input',this.smtp_port_id).val();data.rep_user=$('input',this.smtpUser).val();data.rep_pass_id=$('input',this.smtpPass).val();data.loadbalancer_mode_id=this.ipToggle.data('tele-toggleFlip').options.flipped?1:0;data.header_balances=[];$('.tele-input input',this.headerBalances).each(function(){if($(this).val()!=''){data.header_balances.push($(this).val());}});data.ip_balances=[];$('.tele-config-system-lb .tele-ip-wrap',this.ip_balances).each(function(){if($('.tele-mini-toggle',this).data('tele-toggleFlip')){var is_range=$('.tele-mini-toggle',this).data('tele-toggleFlip').options.flipped;var ip_start=$('.tele-ip:first',this).data('tele-ip').getIP();var ip_end=$('.tele-ip:last',this).data('tele-ip').getIP();if(is_range){if(ip_start&&ip_end&&ip2long(ip_start)<ip2long(ip_end)){data.ip_balances.push({from:ip_start,to:ip_end});}}else{if(ip_start){data.ip_balances.push({from:ip_start,to:ip_start});}}}});data.ip_balances=data.ip_balances.filter(function(elem,pos){return data.ip_balances.indexOf(elem)==pos;});data.whitelist=[];$('.tele-config-system-whitelist .tele-ip-wrap',this.whitelist).each(function(){if($('.tele-mini-toggle',this).data('tele-toggleFlip')){var is_range=$('.tele-mini-toggle',this).data('tele-toggleFlip').options.flipped;var ip_start=$('.tele-ip:first',this).data('tele-ip').getIP();var ip_end=$('.tele-ip:last',this).data('tele-ip').getIP();if(is_range){if(ip_start&&ip_end&&ip2long(ip_start)<ip2long(ip_end)){data.whitelist.push({from:ip_start,to:ip_end});}}else{if(ip_start){data.whitelist.push({from:ip_start,to:ip_start});}}}});data.whitelist=data.whitelist.filter(function(elem,pos){return data.whitelist.indexOf(elem)==pos;});data.agents=[];$('.tele-network-wrap',this.interfaces).each(function(){var NAME=$('.tele-network-name input',this).val();var ETH=$('.tele-network-select',this).val();var MASK=$('.tele-network-filter input',this).val();data.agents.push({agent_name:NAME,interface_name:ETH,pcap_filter:MASK});});data.regex={headers:'',URL:''};var useragents=[];$('.tele-input input',this.useragents).each(function(){if($(this).val()!=''){useragents.push($(this).val());}});var URL=[];$('.tele-input input',this.extentsions).each(function(){if($(this).val()!=''){URL.push($(this).val());}});if(useragents.length>0){useragents=useragents.join(")|(");useragents="(User-Agent:)(.*)(("+useragents+"))";data.regex.headers=useragents;}
if(URL.length>0){data.regex.URL=URL;}
data.scheduler={};var Events=$(that.cal).weekCalendar("serializeEvents");var weekday=new Array(7);weekday[0]="Sunday";weekday[1]="Monday";weekday[2]="Tuesday";weekday[3]="Wednesday";weekday[4]="Thursday";weekday[5]="Friday";weekday[6]="Saturday";$.each(weekday,function(i,val){data.scheduler[val]=[];});$.each(Events,function(i,val){var from=new Date(val.start);var to=new Date(val.end);var dey=weekday[from.getDay()];data.scheduler[dey].push({from:parseInt(from.getHours()),to:parseInt(to.getHours())});});data.app_list_was_changed_id='1';telepath.ds.get('/config/set_config',data,function(data){telepath.dialog({msg:'Configuration Saved'});},'Error saving configuration.');},updateEngineStatus:function(){if($(telepath.config.system.telepathEngineToggle).size()>0){telepath.ds.get('/telepath/get_engine_status',{},function(data){if($(telepath.config.system.telepathEngineToggle).data('teleToggleFlip').options)
{$(telepath.config.system.telepathEngineToggle).data('teleToggleFlip').options.flipped=data.status;}
$(telepath.config.system.telepathEngineToggle).data('teleToggleFlip')._update();});}},parseRanges:function(eventsData){var events=[];function GetDaysOfWeek(date){var days=new Array();for(var i=0;i<7;i++)
{var tmp=new Date(date);days[i]=new Date(tmp.setDate(tmp.getDate()-tmp.getDay()+i));}
return days;}
var weekday=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var today=new Date();today.setMinutes(0);today.setSeconds(0);var days=GetDaysOfWeek(today);var index=0;$.each(days,function(i,date){var n=weekday[date.getDay()];var current_to='';var current_from='';$.each(eventsData,function(num,value){if(n==value._id){$.each(value._source.times,function(j,val){date.setHours(val.from);date.setMinutes(0);date.setSeconds(0);current_from=new Date(date);date.setHours(val.to);current_to=new Date(date);events.push({id:index,start:current_from,end:current_to,title:''});index++;});}});});var that=this;that.index=index;return events;},showConfig:function(){var that=this;this.contentRight.empty();this.container=$('<div>').addClass('tele-config-container').appendTo(this.contentRight);this.c_mode=$('<div>').addClass('tele-config-system-tab tele-config-system-mode');this.container.append(this.c_mode);$('<div>').addClass('tele-title-1').html('Hybrid Mode Schedule').appendTo(this.c_mode);this.scheduler=$('<div>').addClass('tele-scheduler').appendTo(this.c_mode);telepath.ds.get('/config/get_scheduler',{mode:"get_schedule"},function(data){var eventData={events:that.parseRanges(data.scheduler)};that.cal=$(that.scheduler).weekCalendar({timeslotsPerHour:1,timeslotHeight:15,defaultEventLength:1,data:eventData,height:function($calendar){return 400;},resizable:function(calEvent,element){return false;},draggable:function(calEvent,element){return false;},eventNew:function(calEvent,element,dayFreeBusyManager,calendar,mouseupEvent){calEvent.id=that.index;that.index++;},eventDelete:function(calEvent,element,dayFreeBusyManager,calendar,clickEvent){calendar.weekCalendar('removeEvent',calEvent.id);},eventDrop:function(newCalEvent,oldCalEvent,element){}});},'Error while trying to get the scheduler.');this.move_to_production_id=$('<div>').teleInput({label:'Default learning threshold per application',suffix:'Requests',width:70,value:this.data.move_to_production_id}).addClass('tele-config-mv2prod').appendTo(this.c_mode);$('<div>').addClass('tele-title-1 ').html('Learn New Applications').appendTo(this.c_mode);this.addUnknownAppToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:this.data.add_unknown_applications_id=='1'}).addClass('tele-addUnknownApp-toggle').appendTo(this.c_mode);this.engineControls=$('<div>').addClass('tele-engine-controls').appendTo(this.c_mode);$('<div>').addClass('tele-title-2').html('Telepath Engine').appendTo(this.engineControls);this.telepathEngineToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:this.data.engine_mode_id=='1',flip:function(value){telepath.ds.get('/telepath/set_engine_'+(value?'start':'restart'),{},function(data){});}}).appendTo(this.engineControls);$('<div>').addClass('tele-title-2').html('Reverse Proxy').appendTo(this.engineControls);this.reverseProxyToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:this.data.reverse_proxy_mode_id=="1"}).appendTo(this.engineControls);$('<div>').addClass('tele-title-2').html('Sniffer').appendTo(this.engineControls);this.snifferToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:this.data.sniffer_mode_id=="1"}).appendTo(this.engineControls);$('<div>').addClass('tele-title-2').html('Webservice').appendTo(this.engineControls).css({opacity:0.3});this.webserviceToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',disabled:true}).appendTo(this.engineControls);if(!$("#file-upload").length){this.fileUpload=$('<div>').attr('id','file-upload').appendTo($('.tele-content'));this.dragandrophandler=$('<div>').attr('id','dragandrophandler').appendTo(this.fileUpload);$('<div>').addClass('dragandroptext').html('Drag & drop files you want to upload here').prependTo(this.dragandrophandler);$('<div>').addClass('statusbar-container').appendTo(this.dragandrophandler);$('<input>').attr('id','input').attr('type','file').attr('multiple','true').css({width:'0px',height:'0px',overflow:'hidden'}).appendTo(this.fileUpload);this.buttonContainer=$('<div>').addClass('tele-button-container').appendTo(this.fileUpload);$('<a href="#" class="tele-button tele-button-apply disabled">Process</a>').click(function(e){$(this).addClass('disabled');telepath.ds.get('/config/upload_to_db',{},function(data){$('#file-upload .statusbar').remove();},function(){uploadError.show();var interval=setInterval(function(){telepath.ds.get('/config/upload_to_db',{},function(data){$('#file-upload .statusbar').remove();uploadError.hide();clearInterval(interval);},'Load to database error.');},60000);});}).appendTo(this.buttonContainer);var uploadError=$('<div>').addClass('upload-error').html('An error occurred during the loading. An automatic process will be triggered in a minute.').appendTo(this.fileUpload).hide();$(document).ready(function()
{var handler=$("#dragandrophandler");var text=$(".dragandroptext");var container=$(".statusbar-container");$('#input').change(function(e){var files=e.currentTarget.files;handleFileUpload(files,container);})
text.on('click',function(e){$('#input').click();});handler.on('dragenter',function(e)
{e.stopPropagation();e.preventDefault();$(this).css('border','5px solid rgb(193, 193, 193)');});handler.on('dragover',function(e)
{e.stopPropagation();e.preventDefault();});handler.on('drop',function(e)
{$(this).css('border','5px dotted rgb(193, 193, 193)');e.preventDefault();var files=e.originalEvent.dataTransfer.files;handleFileUpload(files,container);});$(document).on('dragenter',function(e)
{e.stopPropagation();e.preventDefault();});$(document).on('dragover',function(e)
{e.stopPropagation();e.preventDefault();handler.css('border','5px dotted rgb(193, 193, 193)');});$(document).on('drop',function(e)
{e.stopPropagation();e.preventDefault();});window.onbeforeunload=function(e){if($('#file-upload .statusbar').length){e.returnValue='The upload process is not finished yet. You will lost the data.';}};window.onunload=function(){if($('#file-upload .statusbar').length){telepath.ds.get('/config/empty_folder',{},function(data){});}};});}
else{$("#file-upload").show();}
function handleFileUpload(files,obj)
{for(var i=0;i<files.length;i++)
{var fd=new FormData();fd.append('file',files[i]);var status=new createStatusbar(obj);status.setFileNameSize(files[i].name,files[i].size);sendFileToServer(fd,status);}}
function sendFileToServer(formData,status)
{var uploadURL=telepath.controllerPath+"/config/do_upload";var extraData={};var jqXHR=$.ajax({xhr:function(){var xhrobj=$.ajaxSettings.xhr();if(xhrobj.upload){xhrobj.upload.addEventListener('progress',function(event){var percent=0;var position=event.loaded||event.position;var total=event.total;if(event.lengthComputable){percent=Math.ceil(position/total*100);}
status.setProgress(percent);},false);}
return xhrobj;},url:uploadURL,type:"POST",contentType:false,processData:false,cache:false,data:formData,success:function(data){if(data.success){status.setProgress(100,data.loader_mode);}
else{status.displayError(data.error);}}});status.setAbort(jqXHR);status.setDelete();}
that.rowCount=0;function createStatusbar(obj)
{that.rowCount++;var row="odd";if(that.rowCount%2==0)row="even";this.statusbar=$("<div class='statusbar "+row+"'></div>");this.filename=$("<div class='filename'></div>").appendTo(this.statusbar);this.progressBar=$("<div class='progressBar'><div></div></div>").appendTo(this.statusbar);this.size=$("<div class='filesize'></div>").appendTo(this.statusbar);this.abort=$("<div class='abort'>Abort</div>").appendTo(this.statusbar);this.delete=$("<div class='abort'>Delete</div>").appendTo(this.statusbar).hide();obj.prepend(this.statusbar);this.setFileNameSize=function(name,size)
{var sizeStr="";var sizeKB=size/1024;if(parseInt(sizeKB)>1024)
{var sizeMB=sizeKB/1024;sizeStr=sizeMB.toFixed(2)+" MB";}
else
{sizeStr=sizeKB.toFixed(2)+" KB";}
this.filename.html(name);this.size.html(sizeStr);}
this.setProgress=function(progress,loader_mode)
{var progressBarWidth=progress*this.progressBar.width()/100;this.progressBar.find('div').animate({width:progressBarWidth},10).html(progress+"% ");if(parseInt(progress)>=100)
{this.abort.hide();this.delete.show();if(!loader_mode){$("#file-upload .tele-button").removeClass('disabled');}}}
this.setAbort=function(jqxhr)
{var sb=this.statusbar;this.abort.click(function()
{jqxhr.abort();sb.hide();});}
this.setDelete=function()
{var sb=this.statusbar;var fn=this.filename.html();this.delete.click(function()
{telepath.ds.get('/config/delete_file',{file_name:fn},function(data){sb.hide();},'The file was not deleted');});}
this.displayError=function(message)
{this.progressBar.hide().after("<div class='error'>"+message+"</div>");}}
this.c_reports=$('<div>').addClass('tele-config-system-tab tele-config-system-reports');this.container.append(this.c_reports);$('<div>').addClass('tele-title-1').html('Syslog').appendTo(this.c_reports).addClass('tele-title-syslog');this.syslogToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:this.data.write_to_syslog_id=='1'}).addClass('tele-syslog-toggle').appendTo(this.c_reports);this.syslogIP=$('<div>').teleInput({label:'Server',width:120,value:this.data.syslog_ip_id}).addClass('tele-config-syslog-host').appendTo(this.c_reports);$('<div>').addClass('tele-title-1').html('SMTP').appendTo(this.c_reports);this.smtpServer=$('<div>').teleInput({label:'Server',width:200,value:this.data.smtp_ip_id}).addClass('tele-config-smtp-host').appendTo(this.c_reports);this.smtp_port_id=$('<div>').teleInput({label:'Port',width:70,value:this.data.smtp_port_id}).addClass('tele-config-smtp-port').appendTo(this.c_reports);this.smtpUser=$('<div>').teleInput({label:'Username',width:200,value:this.data.rep_user}).addClass('tele-config-smtp-username').appendTo(this.c_reports);this.smtpPass=$('<div>').teleInput({label:'Password',width:200,value:this.data.rep_pass_id,pass:true}).addClass('tele-config-smtp-password').appendTo(this.c_reports);this.smtpTestEmail=$('<div>').teleInput({label:'Test Email',width:200}).css({'marginTop':20}).addClass('tele-config-smtp-test').appendTo(this.c_reports);var testSMTP=$('<a href="#" class="tele-button tele-button-apply">Test</a>').click(function(){var email=$('input',that.smtpTestEmail).val();function validateEmail(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email);}
if(validateEmail(email)){if($('input',that.smtpServer).val()==''){telepath.dialog({msg:'SMTP Server cant be blank.'});return;}
telepath.ds.get('/config/testmail',{'smtp_ip_id':$('input',that.smtpServer).val(),'smtp_port_id':$('input',that.smtp_port_id).val(),'smtp_user':$('input',that.smtpUser).val(),'smtp_pass':$('input',that.smtpPass).val(),'test_mail':email},function(data){telepath.dialog({msg:'Test mail was sent.'});},'Error while trying to send test mail');$('input',that.smtpTestEmail).val('');}else{telepath.dialog({msg:'Invalid mail supplied.'});}}).css({'float':'left','padding':'4px 10px','margin-top':'26px'}).h().appendTo(this.c_reports);this.c_whitelist=$('<div>').addClass('tele-config-system-tab tele-config-system-whitelist');this.container.append(this.c_whitelist);if(this.data.whitelist.length){$.each(this.data.whitelist,function(i,ip){that.c_whitelist.append(getRangeUI(ip));});}
else{that.c_whitelist.append(getRangeUI(''));}
this.c_whitelist.append(getRangeUI('last'));this.c_network=$('<div>').addClass('tele-config-system-tab tele-config-system-network');this.container.append(this.c_network);this.row=$('<div class="wrap-network-interfaces">').appendTo(this.c_network);this.col1=$('<div class="tele-network-interfaces-wrap">').appendTo(this.row);this.interfaces=$('<div class="interfaces">').teleMulti({values:this.data.agents,title:'Network Interfaces',template:function(element,value){element.addClass('tele-network-wrap');var Wrap=element;var Name=$('<div>').teleInput({label:'Name',width:120,value:value.agent_name}).addClass('tele-network-name');var Filter=$('<div>').teleInput({label:'Filter Expression',width:120,value:value.pcap_filter}).addClass('tele-network-filter');var Interface=$('<select>').addClass('tele-network-select');Wrap.append(Name).append(Filter).append(Interface);$.each(telepath.config.system.data.interfaces,function(i,interfaceName){var selected=interfaceName==value.interface_name?'selected="selected"':'';Interface.append('<option '+selected+' value='+interfaceName+'>'+interfaceName+'</option>');});element.append(Wrap);}}).appendTo(this.col1);this.col2=$('<div class="tele-balancer-wrap">').appendTo(this.row);$('<div>').addClass('tele-title-1').html('Load Balancer').appendTo(this.col2);var header_balances=this.data.header_balances?this.data.header_balances:'';var headerbalances=this.headerBalances=$('<div>').teleMulti({values:header_balances,template:function(element,value){element.teleInput({value:value});}});this.c_lb=$('<div>').addClass('tele-config-system-lb');if(this.data.ip_balances.length){$.each(this.data.ip_balances,function(i,ip){that.c_lb.append(getRangeUI(ip));});}
else{that.c_lb.append(getRangeUI());}
var another_ip_balancesthis=this.c_lb.append(getRangeUI('last'));var state;this.data.loadbalancer_mode_id=='0'?state=false:state=true;if(!state){another_ip_balancesthis.hide();headerbalances.hide();}
this.ipToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flip:function(){another_ip_balancesthis.toggle();headerbalances.toggle();},flipped:state});this.col2.append(this.ipToggle).append(headerbalances).append(another_ip_balancesthis).append(this.c_lb);$('<div>').addClass('tele-title-1').html('Proxy').appendTo(this.row).addClass('tele-title-proxy');this.proxyToggle=$('<div>').toggleFlip({left_value:'Off',right_value:'On',flipped:this.data.proxy_mode_id=='1'}).appendTo(this.row);this.proxyIP=$('<div>').teleInput({label:'Server',width:120,value:this.data.proxy_ip_id}).addClass('tele-config-proxy-host').appendTo(this.row);this.proxyPort=$('<div>').teleInput({label:'Port',width:70,value:this.data.proxy_port_id}).addClass('tele-config-proxy-port').appendTo(this.row);this.c_ext=$('<div>').addClass('tele-config-system-tab tele-config-system-ext_ignore');this.container.append(this.c_ext);var regex=this.data.regex?this.data.regex:'';this.extentsions=$('<div>').teleMulti({values:regex,title:'Extension Ignore List',template:function(element,value){element.teleInput({value:value});}}).appendTo(this.c_ext);var btnContain=$('<div>').addClass('tele-button-container').appendTo(this.contentLeft);var saveBtn=$('<a href="#" class="tele-button tele-button-apply">Save</a>');var cancelBtn=$('<a href="#" class="tele-button tele-button-cancel">Cancel</a>');btnContain.append(saveBtn).append(cancelBtn);saveBtn.click(function(e){e.preventDefault();that.saveConfig();});cancelBtn.click(function(e){e.preventDefault();that.loadConfig();});$('.tele-config-system-tab').hide();$('.tele-config-system-mode').show();}}